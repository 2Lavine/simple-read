<h1>A+ æ‰‹å†™Promise</h1><p>ä¸‰ä¸ªçŸ¥è¯†ç‚¹** ğŸ‘‡ï¼š</p>
<ul>
<li>1ã€Promise çš„åˆå§‹çŠ¶æ€æ˜¯<code>pending</code></li>
<li>2ã€Promise é‡Œæ²¡æœ‰æ‰§è¡Œ<code>resolve()</code>ã€<code>reject()</code>ä»¥åŠ<code>throw</code>çš„è¯ï¼Œè¿™ä¸ª <strong>promise çš„çŠ¶æ€ä¹Ÿæ˜¯<code>pending</code></strong></li>
<li>3ã€åŸºäºä¸Šä¸€æ¡ï¼Œ<code>pending</code>çŠ¶æ€ä¸‹çš„ promise ä¸ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°<code>then()</code></li>
</ul>
<p><strong>â—¾ æœ€åä¸€ç‚¹ï¼š</strong></p>
<pre><code>let myPromise0 = new Promise();
console.log('myPromise0 :&gt;&gt; ', myPromise0);

</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b95ce2e9ddc74e4eae9eb80d8dd54ba8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<ul>
<li>è§„å®šå¿…é¡»ç»™<code>Promise</code>å¯¹è±¡ä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œå¦åˆ™å°†ä¼šæŠ¥é”™ã€‚</li>
</ul>
<h1>äºŒã€å®ç° resolve å’Œ reject</h1>
<p>å¤§å®¶éƒ½çŸ¥é“éœ€è¦ä¸ºè¿™ä¸ªå‡½æ•°å‚æ•°ä¼ å…¥å®ƒè‡ªå·±çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>resolve()</code>å’Œ<code>reject()</code></p>
<p>åŸç”Ÿçš„ promise é‡Œé¢å¯ä»¥ä¼ å…¥<code>resolve</code>å’Œ<code>reject</code>ä¸¤ä¸ªå‚æ•°</p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {})

</code></pre>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¾—å…è®¸æ‰‹å†™è¿™è¾¹å¯ä»¥ä¼ å…¥è¿™ä¸¤ä¸ªå‚æ•°ï¼š</p>
<pre><code>class myPromise {
    constructor(func) {
+       func(this.resolve, this.reject);
    }
    resolve() {}
    reject() {}
}

</code></pre>
<h2>1.ç®¡ç†çŠ¶æ€å’Œç»“æœ</h2>
<p>ç”¨<code>static</code>æ¥åˆ›å»º<code>é™æ€å±æ€§</code>ï¼š</p>
<pre><code>+   static PENDING = 'pending';
+   static FULFILLED = 'fulfilled';
+   static REJECTED = 'rejected';
</code></pre>
<p>ç”¨ <code>this.PromiseState</code> æ¥ä¿å­˜å®ä¾‹çš„çŠ¶æ€å±æ€§ï¼Œ</p>
<pre><code>+       this.PromiseState = myPromise.PENDING;
</code></pre>
<p>é‚£ä¹ˆåœ¨æ‰§è¡Œ<code>resolve()</code>çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸º <code>å¾…å®š pending</code>ï¼Œå¦‚æœæ˜¯ <code>å¾…å®š pending</code>çš„è¯å°±æŠŠçŠ¶æ€æ”¹ä¸º <code>æˆåŠŸ fulfilled</code>:</p>
<pre><code>class myPromise {
    resolve() {
+       if (this.PromiseState === myPromise.PENDING) {
+           this.PromiseState = myPromise.FULFILLED;
+       }
    }
}

</code></pre>
<h2>2.this æŒ‡å‘é—®é¢˜</h2>
<p>æˆ‘ä»¬æ¥<code>new</code>ä¸€ä¸ªå®ä¾‹ ğŸŒ° æ‰§è¡Œä¸€ä¸‹ä»£ç å°±çŸ¥é“æœ‰æ²¡æœ‰é—®é¢˜äº†</p>
<pre><code>// æµ‹è¯•ä»£ç 
+  let promise1 = new myPromise((resolve, reject) =&gt; {
+      resolve('è¿™æ¬¡ä¸€å®š');
+  })

</code></pre>
<p>è¿è¡Œä¸Šé¢ä»£ç ï¼ŒæŠ¥é”™ ğŸ¦ï¼š
<code>Uncaught TypeError: Cannot read property 'PromiseState ' of undefined</code>
<code>resolve()</code>å’Œ<code>reject()</code>æ–¹æ³•é‡Œè°ƒç”¨<code>PromiseState</code> ï¼Œå‰é¢æ˜¯æœ‰<code>this</code>å…³é”®å­—çš„</p>
<pre><code>	resolve(result) {
â¡      if (this.PromiseState === myPromise.PENDING) {
â¡          this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
    reject(reason) {
â¡      if (this.PromiseState === myPromise.PENDING) {
â¡          this.PromiseState = myPromise.REJECT;
            this.PromiseResult = reason;
        }
    }

</code></pre>
<p>å› ä¸ºç°åœ¨æˆ‘ä»¬æ˜¯åœ¨æ–°å®ä¾‹è¢«åˆ›å»ºåå†åœ¨å¤–éƒ¨ç¯å¢ƒä¸‹æ‰§è¡Œ<code>resolve()</code>æ–¹æ³•çš„ï¼Œè¿™é‡Œçš„<code>resolve()</code>çœ‹ç€åƒæ˜¯å’Œå®ä¾‹ä¸€èµ·æ‰§è¡Œçš„ï¼Œå…¶å®ä¸ç„¶ï¼Œä¹Ÿå°±<strong>ç›¸å½“äºä¸åœ¨<code>class</code>å†…éƒ¨ä½¿ç”¨è¿™ä¸ª<code>this</code></strong>ï¼Œè€Œ<strong>æˆ‘ä»¬æ²¡æœ‰åœ¨å¤–éƒ¨å®šä¹‰ä»»ä½•<code>PromiseState</code> å˜é‡ï¼Œå› æ­¤è¿™é‡Œä¼šæŠ¥é”™</strong></p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>bind</code>æ¥ç»‘å®š<code>this</code>å°±å¯ä»¥äº† ğŸ˜º:</p>
<pre><code>    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
+       func(this.resolve.bind(this), this.reject.bind(this));
</code></pre>
<p>å¯¹äº<code>resolve</code>æ¥è¯´ï¼Œè¿™é‡Œå°±æ˜¯ç»™å®ä¾‹çš„<code>resolve()</code>æ–¹æ³•ç»‘å®šè¿™ä¸ª<code>this</code>ä¸ºå½“å‰çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”æ‰§è¡Œ<code>this.resolve()</code>æ–¹æ³•ï¼š <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c4f15ab1711462892c301caee12191b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<h1>ä¸‰ã€å®ç° then æ–¹æ³•</h1>
<p><strong>å› ä¸º<code>then</code>æ˜¯åœ¨åˆ›å»ºå®ä¾‹åå†è¿›è¡Œè°ƒç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ª ç±»æ–¹æ³•ï¼Œå¯åƒä¸‡ä¸è¦åˆ›å»ºåœ¨ <code>constructor</code> é‡Œé¢äº†~</strong>
æˆ‘æƒ³åº”è¯¥æœ‰äº›åŒå­¦çªç„¶å¤±å¿†ğŸ˜¶ï¼Œä¸è®°å¾—<code>then</code>æ€ä¹ˆç”¨äº†ï¼Œæˆ‘ä»¬å°±æ¥ç¨å¾®å†™ä¸€ä¸‹åŸç”Ÿçš„<code>then</code>æ–¹æ³•ï¼š</p>
<pre><code>let promise = new Promise((resolve, reject) =&gt; {
    resolve('è¿™æ¬¡ä¸€å®š')
})

+  promise.then(
+      result =&gt; {
+          console.log(result);
+      },
+      reason =&gt; {
+          console.log(reason.message);
+      }
+  )

</code></pre>
<p><code>then</code>æ–¹æ³•å¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å‡½æ•°ï¼Œ
ä¸€ä¸ªæ˜¯å½“çŠ¶æ€ä¸º<code>fulfilled æˆåŠŸ</code> æ—¶æ‰§è¡Œçš„ä»£ç ï¼Œ
å¦ä¸€ä¸ªæ˜¯å½“çŠ¶æ€ä¸º <code>rejected æ‹’ç»</code> æ—¶æ‰§è¡Œçš„ä»£ç ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å°±å¯ä»¥å…ˆç»™æ‰‹å†™çš„<code>then</code>é‡Œé¢æ·»åŠ  <strong>ä¸¤ä¸ªå‚æ•°</strong>ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯ <code>onFulfilled</code> è¡¨ç¤º <code>â€œå½“çŠ¶æ€ä¸ºæˆåŠŸæ—¶â€</code></li>
<li>å¦ä¸€ä¸ªæ˜¯ <code>onRejected</code> è¡¨ç¤º <code>â€œå½“çŠ¶æ€ä¸ºæ‹’ç»æ—¶â€</code></li>
</ul>
<pre><code>class myPromise {
+   then(onFulfilled, onRejected) {}
}

</code></pre>
<ol>
<li>çŠ¶æ€ä¸å¯å˜</li>
</ol>
<hr>
<p><code>Promise</code> åªä»¥ <code>ç¬¬ä¸€æ¬¡ä¸ºå‡†</code>ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±<code>æ°¸ä¹…</code>ä¸º<code>fulfilled</code>ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±<code>æ°¸è¿œ</code>çŠ¶æ€ä¸º<code>rejected</code></p>
<p>å› æ­¤æˆ‘ä»¬åœ¨æ‰‹å†™çš„æ—¶å€™å°±å¿…é¡»è¿›è¡Œåˆ¤æ–­ ğŸ¤–ï¼š</p>
<p>â—¾ å¦‚æœå½“å‰å®ä¾‹çš„ <code>PromiseState</code> çŠ¶æ€å±æ€§ä¸º <code>fulfilled æˆåŠŸ</code> çš„è¯ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œä¼ è¿›æ¥çš„ <code>onFulfilled</code> å‡½æ•°ï¼Œå¹¶ä¸”ä¸º<code>onFulfilled</code>å‡½æ•°ä¼ å…¥å‰é¢ä¿ç•™çš„<code>PromiseResult</code>å±æ€§å€¼ï¼š</p>
<pre><code>class myPromise {
    then(onFulfilled, onRejected) {
+       if (this.PromiseState === myProise.FULFILLED) {
+           onFulfilled(this.PromiseResult);
+       }
    }
}

</code></pre>
<ol start="2">
<li>æ‰§è¡Œå¼‚å¸¸ throw</li>
</ol>
<hr>
<p>åœ¨<code>new Promise</code>çš„æ—¶å€™ï¼Œæ‰§è¡Œå‡½æ•°é‡Œé¢å¦‚æœæŠ›å‡ºé”™è¯¯ï¼Œæ˜¯ä¼šè§¦å‘<code>then</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³å³<code>rejected</code>çŠ¶æ€çš„å›è°ƒå‡½æ•°å¯ä»¥æŠŠé”™è¯¯çš„ä¿¡æ¯ä½œä¸ºå†…å®¹è¾“å‡ºå‡ºæ¥</p>
<p>åˆ°è¿™é‡Œï¼Œæœ‰çš„åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œæ‰§è¡Œå¼‚å¸¸æŠ›é”™ï¼Œä¸æ˜¯ç”¨<code>catch()</code>æ–¹æ³•å»æ¥å—ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œåˆè¯´ <code>æ˜¯ä¼šè§¦å‘thenæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³rejectedçŠ¶æ€çš„å›è°ƒå‡½æ•°</code>ï¼ŸğŸ˜µ
äº‹å®ä¸Š, calling <code>obj.catch(onRejected)</code> å†…éƒ¨ calls <code>obj.then(undefined, onRejected)</code>ã€‚(è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬æ˜¾å¼ä½¿ç”¨<code>obj.catch(onRejected)</code>ï¼Œå†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯<code>obj.then(undefined, onRejected)</code>)</p>
<p>â—¾ æ³¨æ„çœ‹ä¸‹é¢çš„ä¾‹å­ ğŸŒ°ï¼š</p>
<pre><code>const promise = new Promise(function(resolve, reject) {
  throw new Error('test');
});
promise.catch(function(error) {
  console.log(error);
});
// Error: test
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œpromise æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°±è¢«<code>catch()</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œä¸Šé¢çš„å†™æ³•ä¸ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ã€‚</p>
<pre><code>// å†™æ³•ä¸€
const promise = new Promise(function(resolve, reject) {
  try {
    throw new Error('test');
  } catch(e) {
    reject(e);
  }
});
promise.catch(function(error) {
  console.log(error);
});
// å†™æ³•äºŒ
const promise = new Promise(function(resolve, reject) {
  reject(new Error('test'));
});
promise.catch(function(error) {
  console.log(error);
});

</code></pre>
<p>æ¯”è¾ƒä¸Šé¢ä¸¤ç§å†™æ³•ï¼Œå¯ä»¥å‘ç°<code>reject()</code>æ–¹æ³•çš„ä½œç”¨ï¼Œç­‰åŒäºæŠ›å‡ºé”™è¯¯ã€‚
è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬æ‰‹å†™ Promise å°±æ˜¯ç”¨<code>try/catch</code>æ¥å¤„ç†å¼‚å¸¸ï¼Œç”¨çš„å°±æ˜¯ä¸Šé¢çš„æ€æƒ³ã€‚</p>
<p>â—¾ <strong>ä¸€èˆ¬æ¥è¯´ï¼Œä¸è¦åœ¨<code>then()</code>æ–¹æ³•é‡Œé¢å®šä¹‰ Reject çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆå³<code>then</code>çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨<code>catch</code>æ–¹æ³•ã€‚</strong></p>
<pre><code>// bad
promise
  .then(function(data) {
    // success
  }, function(err) {
    // error
  });
  
// good
promise
  .then(function(data) { //cb
    // success
  })
  .catch(function(err) {
    // error
  });

</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒç§å†™æ³•è¦å¥½äºç¬¬ä¸€ç§å†™æ³•ï¼Œ
ç†ç”±æ˜¯ç¬¬äºŒç§å†™æ³•å¯ä»¥æ•è·å‰é¢<code>then</code>æ–¹æ³•æ‰§è¡Œä¸­çš„é”™è¯¯ï¼Œä¹Ÿæ›´æ¥è¿‘åŒæ­¥çš„å†™æ³•ï¼ˆ<code>try/catch</code>ï¼‰ã€‚
å› æ­¤ï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨<code>catch()</code>æ–¹æ³•ï¼Œè€Œä¸ä½¿ç”¨<code>then()</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<p><strong>å›åˆ°æ­£é¢˜</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/315d46ffbd8b4a9cb4959ad4437e43b3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<blockquote>
<p><code>Uncaught</code> æœªæ•è·</p>
</blockquote>
<p>å¯ä»¥å‘ç°æŠ¥é”™äº†ğŸ˜°ï¼Œæ²¡æœ‰æ•è·åˆ°é”™è¯¯ï¼Œæ²¡æœ‰æŠŠå†…å®¹è¾“å‡ºå‡ºæ¥</p>
<p>â—¾ æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œ<code>resolve()</code>å’Œ<code>reject()</code>ä¹‹å‰ç”¨<code>try/catch</code>è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨<code>æ„é€ å‡½æ•° constructor</code>é‡Œé¢å®Œå–„ä»£ç ï¼Œåˆ¤æ–­ç”Ÿæˆå®ä¾‹çš„æ—¶å€™æ˜¯å¦æœ‰æŠ¥é”™ ğŸ”ï¼š</p>
<ul>
<li>å¦‚æœæ²¡æœ‰æŠ¥é”™çš„è¯ï¼Œå°±æŒ‰ç…§æ­£å¸¸æ‰§è¡Œ<code>resolve()</code>å’Œ<code>reject()</code>æ–¹æ³•</li>
<li>å¦‚æœæŠ¥é”™çš„è¯ï¼Œå°±æŠŠé”™è¯¯ä¿¡æ¯ä¼ å…¥ç»™<code>reject()</code>æ–¹æ³•ï¼Œå¹¶ä¸”ç›´æ¥æ‰§è¡Œ<code>reject()</code>æ–¹æ³•</li>
</ul>
<pre><code>class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
+       try {
            func(this.resolve.bind(this), this.reject.bind(this));
+       } catch (error) {
+           this.reject(error)
+       }
    }
}

</code></pre>
<p>â—¾ <strong>æ³¨æ„è¿™é‡Œä¸éœ€è¦ç»™<code>reject()</code>æ–¹æ³•è¿›è¡Œ<code>this</code>çš„ç»‘å®šäº†ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ç›´æ¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯åˆ›å»ºå®ä¾‹åå†æ‰§è¡Œã€‚</strong></p>
<p>â–ª <code>func(this.resolve.bind(this), this.reject.bind(this));</code> è¿™é‡Œçš„<code>this.reject</code>æ„æ€æ˜¯ï¼šæŠŠç±»æ–¹æ³•<code>reject()</code>ä½œä¸ºå‚æ•° ä¼ åˆ°æ„é€ å‡½æ•°<code>constructor</code> é‡Œè¦æ‰§è¡Œçš„<code>func()</code>æ–¹æ³•é‡Œï¼Œåªæ˜¯ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸æ‰§è¡Œï¼Œåªæœ‰åˆ›å»ºå®ä¾‹åè°ƒç”¨<code>reject()</code>æ–¹æ³•çš„æ—¶å€™æ‰æ‰§è¡Œï¼Œæ­¤æ—¶<code>this</code>çš„æŒ‡å‘å·²ç»å˜äº†ï¼Œæ‰€ä»¥æƒ³è¦æ­£ç¡®è°ƒç”¨<code>myPromise</code>çš„<code>reject()</code>æ–¹æ³•å°±è¦é€šè¿‡<code>.bind(this))</code>æ”¹å˜<code>this</code>æŒ‡å‘ã€‚
â–ª <code>this.reject(error)</code>ï¼Œè¿™é‡Œçš„<code>this.reject()</code>ï¼Œæ˜¯ç›´æ¥åœ¨æ„é€ å‡½æ•°é‡Œæ‰§è¡Œç±»æ–¹æ³•ï¼Œ<code>this</code>æŒ‡å‘ä¸å˜ï¼Œ<code>this.reject()</code>å°±æ˜¯ç›´æ¥è°ƒç”¨ç±»æ–¹æ³•<code>reject()</code>ï¼Œæ‰€ä»¥ä¸ç”¨å†è¿›è¡Œ<code>this</code>ç»‘å®šã€‚</p>
<ol start="3">
<li>å‚æ•°æ ¡éªŒ</li>
</ol>
<hr>
<p>åŸç”Ÿ Promise é‡Œ<strong>è§„å®š<code>then</code>æ–¹æ³•é‡Œé¢çš„ä¸¤ä¸ªå‚æ•°å¦‚æœä¸æ˜¯å‡½æ•°çš„è¯å°±è¦è¢«å¿½ç•¥</strong>ï¼Œæˆ‘ä»¬å°±æ•…æ„åœ¨åŸç”Ÿä»£ç è¿™é‡Œä¸ä¼ å…¥å‡½æ•°ä½œä¸ºå‚æ•°ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/840804fc6bab4c71b95f75d9c99f1de3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>ç»“æœå°±æ˜¯ <code>Uncaught TypeError: onFulfilled is not a function</code>ã€‚æµè§ˆå™¨å¸®ä½ æŠ¥é”™äº†ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„~ğŸ˜¥ æˆ‘ä»¬åªæƒ³è¦è‡ªå·±æ¥æŠ›å‡ºé”™è¯¯ï¼Œå†æ¥çœ‹çœ‹åˆšåˆšçš„æ‰‹å†™<code>then</code>éƒ¨åˆ†ï¼š</p>
<pre><code>then(onFulfilled, onRejected) {
    if (this.PromiseState === myPromise.FULFILLED) {
        onFulfilled(this.PromiseResult);
    }
    if (this.PromiseState === myPromise.REJECTED) {
        onRejected(this.PromiseResult);
    }
}

</code></pre>
<p>æˆ‘ä»¬ä¼šåœ¨é‡Œé¢åˆ†åˆ«æ‰§è¡ŒæˆåŠŸå’Œæ‹’ç»ä¸¤ä¸ªå‚æ•°ï¼Œå¯æ˜¯æˆ‘ä»¬ä¸æƒ³ä¿®æ”¹è¿™é‡Œçš„ä»£ç ï¼Œé‚£ä¹ˆå°±åªèƒ½æŠŠä¸æ˜¯å‡½æ•°çš„å‚æ•°æ”¹ä¸ºå‡½æ•°</p>
<p><strong><code>Promise</code> è§„èŒƒå¦‚æœ <code>onFulfilled</code> å’Œ <code>onRejected</code> ä¸æ˜¯å‡½æ•°ï¼Œå°±å¿½ç•¥ä»–ä»¬</strong>ã€‚
æ‰€è°“ â€œå¿½ç•¥â€ å¹¶ä¸æ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œ</p>
<ul>
<li>å¯¹äº<code>onFulfilled</code>æ¥è¯´ â€œå¿½ç•¥â€ å°±æ˜¯å°†<code>value</code>åŸå°ä¸åŠ¨çš„è¿”å›ï¼Œ</li>
<li>å¯¹äº<code>onRejected</code>æ¥è¯´å°±æ˜¯è¿”å›<code>reason</code>ï¼Œ<code>onRejected</code>å› ä¸ºæ˜¯é”™è¯¯åˆ†æ”¯ï¼Œæˆ‘ä»¬è¿”å›<code>reason</code>åº”è¯¥<code>throw</code>ä¸€ä¸ª<code>Error</code>:</li>
</ul>
<p>è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ <code>æ¡ä»¶è¿ç®—ç¬¦</code>ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œ<code>if</code>åˆ¤æ–­ä¹‹å‰è¿›è¡Œé¢„å…ˆåˆ¤æ–­ï¼š</p>
<p>â–ª å¦‚æœ<code>onFulfilled</code>å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠåŸæ¥çš„<code>onFulfilled</code>å†…å®¹é‡æ–°èµ‹å€¼ç»™å®ƒï¼Œå¦‚æœ<code>onFulfilled</code>å‚æ•°ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±å°†<code>value</code>åŸå°ä¸åŠ¨çš„è¿”å›</p>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {
+       onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value =&gt; value;
    }
}

</code></pre>
<p>â–ª å¦‚æœ<code>onRejected</code>å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠåŸæ¥çš„<code>onRejected</code>å†…å®¹é‡æ–°èµ‹å€¼ç»™å®ƒï¼Œå¦‚æœ<code>onRejected</code>å‚æ•°ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±<code>throw</code>ä¸€ä¸ª<code>Error</code></p>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {
+       onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; {
            throw reason;
        };
    }
}

</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š</p>
<pre><code>class myPromise {
	...
}

let promise1 = new myPromise((resolve, reject) =&gt; {
    resolve('è¿™æ¬¡ä¸€å®š');
})
promise1.then(
    undefined,
    reason =&gt; {
        console.log('rejected:', reason)
    }
)

</code></pre>
<h1>å››ã€å®ç°å¼‚æ­¥</h1>
<ol>
<li>æ·»åŠ å®šæ—¶å™¨</li>
</ol>
<hr>
<p>å¯ä»¥è¯´æˆ‘ä»¬åœ¨æ‰‹å†™çš„ä»£ç é‡Œé¢ä¾æ—§æ²¡æœ‰æ¤å…¥å¼‚æ­¥åŠŸèƒ½ï¼Œæ¯•ç«Ÿæœ€åŸºæœ¬çš„<code>setTimeout</code>æˆ‘ä»¬éƒ½æ²¡æœ‰ä½¿ç”¨ï¼Œ</p>
<p>å…ˆäº†è§£ä¸€ä¸‹åŸç”Ÿ Promise çš„ä¸€äº›<code>è¿è¡Œé¡ºåºè§„åˆ™</code>ã€‚
åœ¨è¿™é‡Œæˆ‘ä¸ºåŸç”Ÿä»£ç æ·»åŠ ä¸Šæ­¥éª¤ä¿¡æ¯ï¼š</p>
<pre><code>console.log(1);

let promise = new Promise((resolve, reject) =&gt; {
    console.log(2);
    resolve('è¿™æ¬¡ä¸€å®š');
})

promise.then(
    result =&gt; {
        console.log('fulfilled:', result);
    },
    reason =&gt; {
        console.log('rejected:', reason)
    }
)

console.log(3);

</code></pre>
<ul>
<li>é¦–å…ˆæ‰§è¡Œ<code>console.log(1)</code>ï¼Œè¾“å‡º<code>1</code></li>
<li>æ¥ç€åˆ›å»º<code>promiseå®ä¾‹</code>ï¼Œè¾“å‡º<code>2</code>ï¼Œå› ä¸ºè¿™é‡Œä¾æ—§æ˜¯åŒæ­¥</li>
<li>ç„¶åç¢°åˆ°<code>resolve</code>çš„æ—¶å€™ï¼Œä¿®æ”¹ç»“æœå€¼</li>
<li>åˆ°äº†<code>promise.then</code>ä¼šè¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ <strong>éœ€è¦å…ˆæŠŠæ‰§è¡Œæ ˆçš„å†…å®¹æ¸…ç©º</strong>ï¼Œäºæ˜¯å°±æ‰§è¡Œ<code>console.log(3)</code>ï¼Œè¾“å‡º<code>3</code></li>
<li>æ¥ç€æ‰ä¼šæ‰§è¡Œ<code>promise.then</code>é‡Œé¢çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æœ€åè¾“å‡º<code>â€œfulfilled: è¿™æ¬¡ä¸€å®šâ€</code></li>
</ul>
<p>â–ª æˆ‘ä»¬ç”¨åŒæ ·çš„æµ‹è¯•ä»£ç åº”ç”¨åœ¨ <strong>æ‰‹å†™ä»£ç </strong> ä¸Šé¢ï¼š
è¿™æ¬¡æˆ‘ä»¬å‘ç°æœ‰äº›ä¸åŒäº†ğŸ˜¯ï¼Œè¾“å‡ºé¡ºåºä¸ºï¼š
<code>1</code> å’Œ <code>2</code> éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜å°±æ˜¯<code>â€œfulfilled: è¿™æ¬¡ä¸€å®šâ€</code>å’Œ<code>3</code>è¿™é‡Œçš„é¡ºåºä¸å¯¹
â—¾ å…¶å®é—®é¢˜å¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬åˆšåˆšè¯´çš„ <strong>æ²¡æœ‰è®¾ç½®å¼‚æ­¥æ‰§è¡Œ</strong> ğŸ˜¶</p>
<p>æˆ‘ä»¬äºŒè¯ä¸è¯´ç›´æ¥ç»™<code>then</code>æ–¹æ³•é‡Œé¢æ·»åŠ <code>setTimeout</code>å°±å¯ä»¥äº†ğŸ˜ï¼Œ
<strong>éœ€è¦åœ¨è¿›è¡Œ<code>if</code>åˆ¤æ–­ä»¥åå†æ·»åŠ <code>setTimeout</code>ï¼Œè¦ä¸ç„¶çŠ¶æ€ä¸ç¬¦åˆæ·»åŠ å¼‚æ­¥ä¹Ÿæ˜¯æ²¡æœ‰æ„ä¹‰çš„</strong>ï¼Œç„¶ååœ¨<code>setTimeout</code>é‡Œæ‰§è¡Œä¼ å…¥çš„å‡½æ•°å‚æ•°ï¼š</p>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value =&gt; value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; {
            throw reason;
        };
        if (this.PromiseState === myPromise.FULFILLED) {
+           setTimeout(() =&gt; {
                onFulfilled(this.PromiseResult);
+           });
        }
        if (this.PromiseState === myPromise.REJECTED) {
+           setTimeout(() =&gt; {
                onRejected(this.PromiseResult);
+           });
        }
    }
}

</code></pre>
<p><strong>åœ¨è¿™é‡Œæˆ‘ä»¬è§£å†³å¼‚æ­¥çš„æ–¹æ³•æ˜¯ç»™<code>onFulfilled</code>å’Œ<code>onRejected</code>æ·»åŠ <code>setTimeout</code>ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ</strong></p>
<p>â—¾ è¿™å°±è¦è®²åˆ° <a href="https://link.juejin.cn?target=https%3A%2F%2Fpromisesaplus.com%2F%23notes" title="https://promisesaplus.com/#notes"><strong><code>Promises/A+</code> è§„èŒƒ</strong></a> äº†</p>
<p>è§„èŒƒ <code>2.2.4</code> ï¼š</p>
<blockquote>
<p><code>onFulfilled</code> or <code>onRejected</code> must not be called until the <code>execution context</code> stack contains only platform code. [3.1].</p>
</blockquote>
<p>è¯‘æ–‡ï¼š</p>
<p>2.2.4 <code>onFulfilled</code> å’Œ <code>onRejected</code> åªæœ‰åœ¨<code>æ‰§è¡Œç¯å¢ƒ</code>å †æ ˆä»…åŒ…å«å¹³å°ä»£ç æ—¶æ‰å¯è¢«è°ƒç”¨ <code>æ³¨1</code></p>
<p>è§„èŒƒå¯¹ 2.2.4 åšäº†æ³¨é‡Šï¼š</p>
<blockquote>
<p>3.1 Here â€œplatform codeâ€ means engine, environment, and promise implementation code. In practice, this requirement ensures that <code>onFulfilled</code> and <code>onRejected</code> execute asynchronously, after the event loop turn in which <code>then</code> is called, and with a fresh stack. This can be implemented with either a â€œmacro-taskâ€ mechanism such as setTimeout or <code>setImmediate</code>, or with a â€œmicro-taskâ€ mechanism such as MutationObserver or process.nextTick. Since the promise implementation is considered platform code, it may itself contain a task-scheduling queue or â€œtrampolineâ€ in which the handlers are called.</p>
</blockquote>
<p>è¯‘æ–‡ï¼š</p>
<p><strong>3.1 è¿™é‡Œçš„å¹³å°ä»£ç æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç ã€‚å®è·µä¸­è¦ç¡®ä¿ <code>onFulfilled</code> å’Œ <code>onRejected</code> æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ <code>then</code> æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚è¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—å¯ä»¥é‡‡ç”¨ â€œå®ä»»åŠ¡ï¼ˆmacro-taskï¼‰â€ æœºåˆ¶ï¼Œæ¯”å¦‚<code>setTimeout</code> æˆ–è€… <code>setImmediate</code>ï¼› ä¹Ÿå¯ä»¥é‡‡ç”¨ â€œå¾®ä»»åŠ¡ï¼ˆmicro-taskï¼‰â€ æœºåˆ¶æ¥å®ç°ï¼Œ æ¯”å¦‚ <code>MutationObserver</code> æˆ–è€…<code>process.nextTick</code>ã€‚</strong> ç”±äº promise çš„å®æ–½ä»£ç æœ¬èº«å°±æ˜¯å¹³å°ä»£ç ï¼ˆè¯‘è€…æ³¨ï¼š å³éƒ½æ˜¯ JavaScriptï¼‰ï¼Œæ•…ä»£ç è‡ªèº«åœ¨å¤„ç†åœ¨å¤„ç†ç¨‹åºæ—¶å¯èƒ½å·²ç»åŒ…å«ä¸€ä¸ªä»»åŠ¡è°ƒåº¦é˜Ÿåˆ—æˆ–ã€è·³æ¿ã€)ã€‚</p>
<p><strong>è¿™é‡Œæˆ‘ä»¬ç”¨çš„å°±æ˜¯è§„èŒƒé‡Œè®²åˆ°çš„ â€œå®ä»»åŠ¡â€ <code>setTimeout</code></strong>ã€‚</p>
<ol start="2">
<li>å›è°ƒä¿å­˜</li>
</ol>
<hr>
<p>å¼‚æ­¥çš„é—®é¢˜çœŸçš„è§£å†³äº†å—ï¼Ÿç°åœ¨åˆè¦è¿›å…¥ Promise å¦ä¸€ä¸ªéš¾ç‚¹äº†ï¼Œå¤§å®¶åŠ¡å¿…ç«–èµ·è€³æœµå•¦ğŸ˜›</p>
<p>æˆ‘ä»¬æ¥ç»™åŸç”Ÿçš„ Promise é‡Œæ·»åŠ <code>setTimeout</code>ï¼Œä½¿å¾—<code>resolve</code>ä¹Ÿå¼‚æ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜äº†ï¼Œ<code>resolve</code>æ˜¯å¼‚æ­¥çš„ï¼Œ<code>then</code>ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œç©¶ç«Ÿè°ä¼šå…ˆè¢«è°ƒç”¨å‘¢ï¼Ÿ</p>
<pre><code>console.log(1);
let promise = new Promise((resolve, reject) =&gt; {
    console.log(2);
+   setTimeout(() =&gt; {
        resolve('è¿™æ¬¡ä¸€å®š');
+       console.log(4);
+   });
})
promise.then(
    result =&gt; {
        console.log('fulfilled:', result);
    },
    reason =&gt; {
        console.log('rejected:', reason)
    }
)
console.log(3);

</code></pre>
<p>ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯å½“é‡åˆ°<code>setTimeout</code>çš„æ—¶å€™è¢«å¼‚æ­¥æ‰§è¡Œäº†ï¼Œè€Œ<code>resolve('è¿™æ¬¡ä¸€å®š')</code>æ²¡æœ‰è¢«é©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯å…ˆæ‰§è¡Œ<code>console.log(4)</code>ï¼Œç­‰åˆ°<code>then</code>çš„æ—¶å€™å†æ‰§è¡Œ<code>resolve</code>é‡Œä¿å­˜çš„å€¼ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº†æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯ï¼Œ<code>promise.then()</code> å’Œ <code>setTimeout()</code> éƒ½æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œä½†å®é™…ä¸Šå¼‚æ­¥ä»»åŠ¡ä¹‹é—´å¹¶ä¸ç›¸åŒï¼Œå› æ­¤ä»–ä»¬çš„æ‰§è¡Œä¼˜å…ˆçº§ä¹Ÿæœ‰åŒºåˆ«ã€‚
ä¸åŒçš„å¼‚æ­¥ä»»åŠ¡è¢«åˆ†ä¸ºä¸¤ç±»ï¼š<code>å¾®ä»»åŠ¡ (micro task)</code> å’Œ <code>å®ä»»åŠ¡ (macro task</code>)ã€‚</p>
<ul>
<li><code>setTimeout()</code>å±äºå®ä»»åŠ¡</li>
<li><code>promise.then()</code>å±äºå¾®ä»»åŠ¡</li>
</ul>
<p>åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œå¼‚æ­¥äº‹ä»¶è¿”å›ç»“æœåä¼šè¢«æ”¾åˆ°ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚
ç„¶è€Œï¼Œæ ¹æ®è¿™ä¸ªå¼‚æ­¥äº‹ä»¶çš„ç±»å‹ï¼Œè¿™ä¸ªäº‹ä»¶å®é™…ä¸Šä¼šè¢«å¯¹åº”çš„å®ä»»åŠ¡é˜Ÿåˆ—æˆ–è€…å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ã€‚å¹¶ä¸”åœ¨å½“å‰æ‰§è¡Œæ ˆä¸ºç©ºçš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹ä¼š æŸ¥çœ‹å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰äº‹ä»¶å­˜åœ¨ã€‚
å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶å¹¶æŠŠå¯¹åº”çš„å›åˆ°åŠ å…¥å½“å‰æ‰§è¡Œæ ˆï¼›
å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šä¾æ¬¡æ‰§è¡Œé˜Ÿåˆ—ä¸­äº‹ä»¶å¯¹åº”çš„å›è°ƒï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œç„¶åå»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„ä¸€ä¸ªäº‹ä»¶ï¼ŒæŠŠå¯¹åº”çš„å›è°ƒåŠ å…¥å½“å‰æ‰§è¡Œæ ˆâ€¦ å¦‚æ­¤åå¤ï¼Œè¿›å…¥å¾ªç¯ã€‚</p>
<p>æˆ‘ä»¬åªéœ€è®°ä½ <strong>å½“ å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•æ—¶ä¼šç«‹åˆ»å…ˆå¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œç„¶åå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ã€‚åŒä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡æ°¸è¿œåœ¨å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚</strong></p>
<p><strong>å›åˆ°æ­£æ–‡</strong></p>
<p>æˆ‘ä»¬ç”¨åŒæ ·çš„ä»£ç åº”ç”¨åˆ°æ‰‹å†™çš„éƒ¨åˆ†ï¼š</p>
<pre><code>// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) =&gt; {
    console.log(2);
    setTimeout(() =&gt; {
        resolve('è¿™æ¬¡ä¸€å®š');
        console.log(4);
    });
})
promise1.then(
    result =&gt; {
        console.log('fulfilled:', result);
    },
    reason =&gt; {
        console.log('rejected:', reason)
    }
)
console.log(3);

</code></pre>
<p>å¯ä»¥å‘ç° <code>fulfilled: è¿™æ¬¡ä¸€å®š</code> å¹¶æ²¡æœ‰è¾“å‡º</p>
<p>æˆ‘ä»¬å¯ä»¥å…ˆçŒœæµ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰è¾“å‡ºçš„åŸå› å¾ˆå¯èƒ½æ˜¯å› ä¸º<code>then</code>æ–¹æ³•æ²¡æœ‰è¢«æ‰§è¡Œï¼Œçœ‹çœ‹<code>then</code>æ–¹æ³•é‡Œé¢æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­æ¥æ‰§è¡Œä»£ç çš„ï¼šä¹Ÿå°±æ˜¯è¯´å¾ˆå¯èƒ½æ²¡æœ‰ç¬¦åˆçš„æ¡ä»¶ï¼Œå†æ¢å¥è¯è¯´å¯èƒ½æ²¡æœ‰ç¬¦åˆçš„çŠ¶æ€</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±åœ¨ä¸‰ä¸ªä½ç½®åˆ†åˆ«è¾“å‡ºå½“å‰çš„çŠ¶æ€ï¼Œè¿™æ ·åˆ†åˆ«æ¥åˆ¤æ–­å“ªä¸ªä½ç½®å‡ºäº†é—®é¢˜:</p>
<pre><code>class myPromise {
	...
}

// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) =&gt; {
    console.log(2);
    setTimeout(() =&gt; {
+       console.log('A',promise1.PromiseState);
        resolve('è¿™æ¬¡ä¸€å®š');
+       console.log('B',promise1.PromiseState);
        console.log(4);
    });
})
promise1.then(
    result =&gt; {
+       console.log('C',promise1.PromiseState);
        console.log('fulfilled:', result);
    },
    reason =&gt; {
        console.log('rejected:', reason)
    }
)
console.log(3);

</code></pre>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº‹ä»¶å¾ªç¯ï¼Œæˆ‘ä»¬è¯¦ç»†è§£è¯»ä¸€ä¸‹ï¼š</p>
<p>â–ª <strong>é¦–å…ˆ</strong>ï¼Œæ‰§è¡Œ<code>console.log(1)</code>ï¼Œè¾“å‡º<code>1</code></p>
<p>â–ª <strong>ç¬¬äºŒæ­¥</strong>ï¼Œåˆ›å»º promiseï¼Œæ‰§è¡Œå‡½æ•°ä½“é‡Œçš„<code>console.log(2)</code>ï¼Œè¾“å‡º<code>2</code></p>
<p>â–ª <strong>ç¬¬ä¸‰æ­¥</strong>ï¼Œé‡åˆ°<code>setTimeout</code>ï¼Œ<code>setTimeout</code>æ˜¯å®ä»»åŠ¡ï¼Œå°†<code>setTimeout</code>åŠ å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ</p>
<p>â–ª <strong>ç¬¬å››æ­¥</strong>ï¼Œé‡åˆ°<code>promise.then()</code>ï¼Œ<code>promise.then()</code>æ˜¯å¾®ä»»åŠ¡ï¼Œå°†<code>promise.then()</code>åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ</p>
<p>â–ª <strong>ç¬¬äº”æ­¥</strong>ï¼Œæ‰§è¡Œ<code>console.log(3)</code>ï¼Œè¾“å‡º<code>3</code>ï¼Œæ­¤æ—¶å½“å‰æ‰§è¡Œæ ˆå·²ç»æ¸…ç©º</p>
<p>â–ª <strong>ç¬¬å…­æ­¥</strong>ï¼Œå½“å‰æ‰§è¡Œæ ˆå·²ç»æ¸…ç©ºï¼Œå…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ <code>promise.then()</code>ï¼Œå‘ç° promise çš„çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜ï¼Œè¿˜æ˜¯<code>pending</code>ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å‡ºã€‚çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜çš„åŸå› æ˜¯ï¼š<code>resolve('è¿™æ¬¡ä¸€å®š')</code>æ˜¯åœ¨<code>setTimeout</code>é‡Œçš„ï¼Œä½†æ­¤æ—¶è¿˜æ²¡å¼€å§‹æ‰§è¡Œ<code>setTimeout</code>ï¼Œå› ä¸º<code>setTimeout</code>æ˜¯å®ä»»åŠ¡ï¼Œå®ä»»åŠ¡åœ¨å¾®ä»»åŠ¡åé¢æ‰§è¡Œ</p>
<p>â–ª <strong>ç¬¬ä¸ƒæ­¥</strong>ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ¸…ç©ºï¼Œå¼€å§‹æ‰§è¡Œå®ä»»åŠ¡ <code>setTimeout</code>ï¼š</p>
<pre><code>setTimeout(() =&gt; {
     console.log('A',promise1.PromiseState);
     resolve('è¿™æ¬¡ä¸€å®š');
     console.log('B',promise1.PromiseState);
     console.log(4);
 });

</code></pre>
<p>â–ª <strong>ç¬¬å…«æ­¥</strong>ï¼Œæ‰§è¡Œ <code>console.log('A',promise1.PromiseState)</code>ï¼Œæ­¤æ—¶ promise çŠ¶æ€è¿˜æ²¡å‘ç”Ÿå˜åŒ–ï¼Œè¿˜æ˜¯<code>pending</code>ï¼Œæ‰€ä»¥è¾“å‡º <code>A pending</code></p>
<p>â–ª <strong>ç¬¬ä¹æ­¥</strong>ï¼Œæ‰§è¡Œ <code>resolve('è¿™æ¬¡ä¸€å®š');</code>ï¼Œæ”¹å˜ promise çš„çŠ¶æ€ä¸º<code>fulfilled</code></p>
<p>â–ª <strong>ç¬¬åæ­¥</strong>ï¼Œæ‰§è¡Œ <code>console.log('B',promise1.PromiseState)</code>ï¼Œè¾“å‡º <code>B fulfilled</code></p>
<p>â–ª <strong>ç¬¬åä¸€æ­¥</strong>ï¼Œæ‰§è¡Œ <code>console.log(4)</code>ï¼Œè¾“å‡º<code>4</code></p>
<blockquote>
<p>è¿™é‡Œæš‚ä¸”è®¤ä¸ºæˆ‘ä»¬å†™çš„ promise.then() å’ŒåŸç”Ÿä¸€æ ·ï¼Œæ–¹ä¾¿ç†è§£</p>
</blockquote>
<p>â—¾ åˆ†æå®Œä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œå› ä¸ºå…ˆæ‰§è¡Œäº†<code>then</code>æ–¹æ³•ï¼Œä½†å‘ç°è¿™ä¸ªæ—¶å€™çŠ¶æ€ä¾æ—§æ˜¯ <code>pending</code>ï¼Œè€Œæˆ‘ä»¬æ‰‹å†™éƒ¨åˆ†æ²¡æœ‰å®šä¹‰<code>pending</code>å¾…å®šçŠ¶æ€çš„æ—¶å€™åº”è¯¥åšä»€ä¹ˆï¼Œå› æ­¤å°±å°‘äº†<code>fulfilled: è¿™æ¬¡ä¸€å®š</code> è¿™å¥è¯çš„è¾“å‡º</p>
<p>æ‰€ä»¥æˆ‘ä»¬å°± <strong>ç›´æ¥ç»™<code>then</code>æ–¹æ³•é‡Œé¢æ·»åŠ å¾…å®šçŠ¶æ€çš„æƒ…å†µå°±å¯ä»¥äº†</strong>ï¼Œä¹Ÿå°±æ˜¯ç”¨<code>if</code>è¿›è¡Œåˆ¤æ–­:</p>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {
+       if (this.PromiseState === myPromise.PENDING) {
+ 		
+ 		}
    }
}

</code></pre>
<p>â—¾ ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œå½“<code>then</code>é‡Œé¢åˆ¤æ–­åˆ° <code>pending</code> å¾…å®šçŠ¶æ€æ—¶æˆ‘ä»¬è¦å¹²ä»€ä¹ˆï¼Ÿ</p>
<p>å› ä¸ºè¿™ä¸ªæ—¶å€™<code>resolve</code>æˆ–è€…<code>reject</code>è¿˜æ²¡è·å–åˆ°ä»»ä½•å€¼ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è®©<code>then</code>é‡Œçš„å‡½æ•°ç¨åå†æ‰§è¡Œï¼Œç­‰<code>resolve</code>æ‰§è¡Œäº†ä»¥åï¼Œå†æ‰§è¡Œ<code>then</code></p>
<p>ä¸ºäº†ä¿ç•™<code>then</code>é‡Œçš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º <code>æ•°ç»„</code> æ¥ <strong>ä¿å­˜å‡½æ•°</strong>ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆç”¨ <code>æ•°ç»„</code> æ¥ä¿å­˜è¿™äº›å›è°ƒå‘¢ï¼Ÿå› ä¸ºä¸€ä¸ª promise å®ä¾‹å¯èƒ½ä¼šå¤šæ¬¡ <code>then</code>ï¼Œä¹Ÿå°±æ˜¯ç»å…¸çš„ <code>é“¾å¼è°ƒç”¨</code></strong>ï¼Œè€Œä¸”æ•°ç»„æ˜¯å…ˆå…¥å…ˆå‡ºçš„é¡ºåº</p>
<p>åœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™å°±è®©æ¯ä¸ªå®ä¾‹éƒ½æœ‰è¿™ä¸¤ä¸ªæ•°ç»„ï¼š</p>
<ul>
<li><code>onFulfilledCallbacks</code> ï¼šç”¨æ¥ <strong>ä¿å­˜æˆåŠŸå›è°ƒ</strong></li>
<li><code>onRejectedCallbacks</code> ï¼šç”¨æ¥ <strong>ä¿å­˜å¤±è´¥å›è°ƒ</strong></li>
</ul>
<pre><code>class myPromise {
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
+       this.onFulfilledCallbacks = []; // ä¿å­˜æˆåŠŸå›è°ƒ
+       this.onRejectedCallbacks = []; // ä¿å­˜å¤±è´¥å›è°ƒ
    }
}

</code></pre>
<p>â—¾ æ¥ç€å°±å®Œå–„<code>then</code>é‡Œé¢çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯å½“åˆ¤æ–­åˆ°çŠ¶æ€ä¸º <code>pending</code> å¾…å®šæ—¶ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒï¼Œä¹Ÿå°±æ˜¯è¯´æš‚ä¸”æŠŠ<code>then</code>é‡Œçš„ä¸¤ä¸ªå‡½æ•°å‚æ•°åˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªæ•°ç»„é‡Œé¢ï¼š</p>
<pre><code>class myPromise {
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : () =&gt; {};
        onRejected = typeof onRejected === 'function' ? onRejected : () =&gt; {};
        if (this.PromiseState === myPromise.PENDING) {
+           this.onFulfilledCallbacks.push(onFulfilled);
+           this.onRejectedCallbacks.push(onRejected);
        }
    }
}

</code></pre>
<p>â—¾ æ•°ç»„é‡Œé¢æ”¾å®Œå‡½æ•°ä»¥åï¼Œå°±å¯ä»¥å®Œå–„<code>resolve</code>å’Œ<code>reject</code>çš„ä»£ç äº†</p>
<p><strong>åœ¨æ‰§è¡Œ<code>resolve</code>æˆ–è€…<code>reject</code>çš„æ—¶å€™ï¼Œéå†è‡ªèº«çš„<code>callbacks</code>æ•°ç»„</strong>ï¼Œçœ‹çœ‹æ•°ç»„é‡Œé¢æœ‰æ²¡æœ‰<code>then</code>é‚£è¾¹ <strong>ä¿ç•™</strong> è¿‡æ¥çš„ <strong>å¾…æ‰§è¡Œå‡½æ•°</strong>ï¼Œ<strong>ç„¶åé€ä¸ªæ‰§è¡Œæ•°ç»„é‡Œé¢çš„å‡½æ•°</strong>ï¼Œæ‰§è¡Œçš„æ—¶å€™ä¼šä¼ å…¥ç›¸åº”çš„å‚æ•°ï¼š</p>
<pre><code>class myPromise {
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
+           this.onFulfilledCallbacks.forEach(callback =&gt; {
+               callback(result)
+           })
        }
    }
}

</code></pre>
<p><strong>ä½†æ˜¯</strong>ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼Œä»£ç è¾“å‡ºé¡ºåºè¿˜æ˜¯ä¸å¤ªå¯¹ï¼ŒåŸç”Ÿ Promise ä¸­ï¼Œ<code>fulfilled: è¿™æ¬¡ä¸€å®š</code> æ˜¯æœ€åè¾“å‡ºçš„</p>
<p>â—¾ è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå¤šäººå¿½ç•¥çš„å°ç»†èŠ‚ï¼Œ<strong>è¦ç¡®ä¿ onFulfilled å’Œ onRejected æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ then æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œ</strong>ã€‚å› æ­¤ï¼Œ<strong>åœ¨ä¿å­˜æˆåŠŸå’Œå¤±è´¥å›è°ƒæ—¶ä¹Ÿè¦æ·»åŠ  <code>setTimeout</code></strong></p>
<pre><code>class myPromise {
    ...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value =&gt; value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; {
            throw reason;
        };
        if (this.PromiseState === myPromise.PENDING) {
+           this.onFulfilledCallbacks.push(() =&gt; {
+               setTimeout(() =&gt; {
+                   onFulfilled(this.PromiseResult);
+               });
+           });
+           this.onRejectedCallbacks.push(() =&gt; {
+               setTimeout(() =&gt; {
+                   onRejected(this.PromiseResult);
+               });
+           });
        }
        if (this.PromiseState === myPromise.FULFILLED) {
            setTimeout(() =&gt; {
                onFulfilled(this.PromiseResult);
            });
        }
        if (this.PromiseState === myPromise.REJECTED) {
            setTimeout(() =&gt; {
                onRejected(this.PromiseResult);
            });
        }
    }
}

</code></pre>
<h1>äº”ã€å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨</h1>
<p><strong>æˆ‘ä»¬å¸¸å¸¸ç”¨åˆ° <code>new Promise().then().then()</code>ï¼Œè¿™å°±æ˜¯é“¾å¼è°ƒç”¨ï¼Œç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±</strong></p>
<p>æˆ‘ä»¬å…ˆè¯•ä¸€ä¸‹å½“å‰çš„<code>myPromise</code>æ˜¯å¦å¯ä»¥å®ç°é“¾å¼è°ƒç”¨ï¼š</p>
<pre><code>class myPromise {
    ...
}

// æµ‹è¯•ä»£ç 
let p1 = new myPromise((resolve, reject) =&gt; {
    resolve(10)
})
p1.then(res =&gt; {
    console.log('fulfilled', res);
    return 2 * res
}).then(res =&gt; {
    console.log('fulfilled', res)
}) 

</code></pre>
<p>æ¯«æ— ç–‘é—®åœ¨æ§åˆ¶å°é‡Œé¢æ˜¯ä¼šæŠ¥é”™çš„ï¼Œæç¤º <code>then</code> æ–¹æ³•æ²¡æœ‰å®šä¹‰ï¼š
<code>Uncaught TypeError: Cannot read property 'then' of undefined</code></p>
<p><strong><code>Promise.prototype.then()</code> æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯åŸæ¥é‚£ä¸ª<code>Promise</code>å®ä¾‹ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³ then æ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ª then æ–¹æ³•ã€‚</strong></p>
<ol>
<li>Promises/A+ è§„èŒƒçš„ç†è§£</li>
</ol>
<hr>
<p><strong>è§„èŒƒåœ¨<code>2.2.7</code>ä¸­è¿™æ ·æè¿° ğŸ‘‡ï¼š</strong></p>
<p>â—¾ <strong>2.2.7 then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡</strong></p>
<pre><code>promise2 = promise1.then(onFulfilled, onRejected);
</code></pre>
<ul>
<li><strong>2.2.7.1</strong> å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ <strong>Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code></strong></li>
<li><strong>2.2.7.2</strong> å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ <code>e</code> ï¼Œåˆ™ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  <code>e</code></li>
<li><strong>2.2.7.3</strong> å¦‚æœ <code>onFulfilled</code> ä¸æ˜¯å‡½æ•°ä¸” <code>promise1</code> æˆåŠŸæ‰§è¡Œï¼Œ <code>promise2</code> å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼</li>
<li><strong>2.2.7.4</strong> å¦‚æœ <code>onRejected</code> ä¸æ˜¯å‡½æ•°ä¸” <code>promise1</code> æ‹’ç»æ‰§è¡Œï¼Œ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„æ®å› </li>
</ul>
<p>ç†è§£ä¸Šé¢çš„<code>â€œè¿”å›â€</code>éƒ¨åˆ†éå¸¸é‡è¦ï¼Œå³ï¼š<strong>ä¸è®º promise1 è¢« reject è¿˜æ˜¯è¢« resolve æ—¶ promise2 éƒ½ä¼šæ‰§è¡Œ Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code>ï¼Œåªæœ‰å‡ºç°å¼‚å¸¸æ—¶æ‰ä¼šè¢« rejectedã€‚</strong></p>
<p>æ³¨æ„ <strong>2.2.7.1</strong> ï¼š</p>
<blockquote>
<p>If either onFulfilled or onRejected returns a value x, <strong><code>run the Promise Resolution Procedure [[Resolve]](promise2, x).</code></strong></p>
</blockquote>
<p>å³ï¼šå¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ <strong>Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code></strong></p>
<p>è§„èŒƒåœ¨ <strong>2.3</strong> ä¸­è¯¦ç»†æè¿° <strong>Promise è§£å†³è¿‡ç¨‹</strong> <code>The Promise Resolution Procedure</code> ğŸ‘‡
â—¾ <strong>2.3 Promise è§£å†³è¿‡ç¨‹</strong></p>
<p><strong>Promise è§£å†³è¿‡ç¨‹</strong> æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ“ä½œï¼Œå…¶éœ€è¾“å…¥ä¸€ä¸ª <code>promise</code> å’Œä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬è¡¨ç¤ºä¸º <code>[[Resolve]](promise, x)</code>ï¼Œå¦‚æœ <code>x</code> æœ‰ <code>then</code> æ–¹æ³•ä¸”çœ‹ä¸Šå»åƒä¸€ä¸ª <code>Promise</code> ï¼Œè§£å†³ç¨‹åºå³å°è¯•ä½¿ <code>promise</code> æ¥å— <code>x</code> çš„çŠ¶æ€ï¼›å¦åˆ™å…¶ç”¨ <code>x</code> çš„å€¼æ¥æ‰§è¡Œ <code>promise</code> ã€‚</p>
<p>è¿™ç§ <code>thenable</code> çš„ç‰¹æ€§ä½¿å¾— <code>Promise</code> çš„å®ç°æ›´å…·æœ‰é€šç”¨æ€§ï¼š<strong>åªè¦å…¶æš´éœ²å‡ºä¸€ä¸ªéµå¾ª <code>Promises/A+</code> åè®®çš„ <code>then</code> æ–¹æ³•å³å¯ï¼›è¿™åŒæ—¶ä¹Ÿä½¿éµå¾ª <code>Promises/A+</code> è§„èŒƒçš„å®ç°å¯ä»¥ä¸é‚£äº›ä¸å¤ªè§„èŒƒä½†å¯ç”¨çš„å®ç°èƒ½è‰¯å¥½å…±å­˜ã€‚</strong></p>
<p><strong>è¿è¡Œ <code>[[Resolve]](promise, x)</code> éœ€éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</strong></p>
<p>â–ª <strong>2.3.1 <code>x</code> ä¸ promise ç›¸ç­‰</strong></p>
<p>å¦‚æœ <code>promise</code> å’Œ <code>x</code> æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ <code>TypeError</code> ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ <code>promise</code></p>
<p>â–ª <strong>2.3.2 <code>x</code> ä¸º Promise</strong></p>
<p>å¦‚æœ <code>x</code> ä¸º Promise ï¼Œåˆ™ä½¿ <code>promise</code> æ¥å— <code>x</code> çš„çŠ¶æ€</p>
<ul>
<li>2.3.2.1 å¦‚æœ <code>x</code> å¤„äºç­‰å¾…æ€ï¼Œ <code>promise</code> éœ€ä¿æŒä¸ºç­‰å¾…æ€ç›´è‡³ <code>x</code> è¢«æ‰§è¡Œæˆ–æ‹’ç»</li>
<li>2.3.2.2 å¦‚æœ <code>x</code> å¤„äºæ‰§è¡Œæ€ï¼Œç”¨ç›¸åŒçš„å€¼æ‰§è¡Œ <code>promise</code></li>
<li>2.3.2.3 å¦‚æœ <code>x</code> å¤„äºæ‹’ç»æ€ï¼Œç”¨ç›¸åŒçš„æ®å› æ‹’ç» <code>promise</code></li>
</ul>
<p>â–ª <strong>2.3.3 <code>x</code> ä¸ºå¯¹è±¡æˆ–å‡½æ•°</strong></p>
<p>å¦‚æœ x ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼š</p>
<ul>
<li>
<p>2.3.3.1 æŠŠ <code>x.then</code> èµ‹å€¼ç»™ <code>then</code></p>
</li>
<li>
<p>2.3.3.2 å¦‚æœå– <code>x.then</code> çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ <code>e</code> ï¼Œåˆ™ä»¥ <code>e</code> ä¸ºæ®å› æ‹’ç» <code>promise</code></p>
</li>
<li>
<p>2.3.3.3 å¦‚æœ <code>then</code> æ˜¯å‡½æ•°ï¼Œå°† <code>x</code> ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ <code>this</code> è°ƒç”¨ä¹‹ã€‚ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å«åš <code>resolvePromise</code> ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš <code>rejectPromise</code>:</p>
<ul>
<li>
<p>2.3.3.3.1 å¦‚æœ <code>resolvePromise</code> ä»¥å€¼ <code>y</code> ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ <code>[[Resolve]](promise, y)</code></p>
</li>
<li>
<p>2.3.3.3.2 å¦‚æœ <code>rejectPromise</code> ä»¥æ®å›  <code>r</code> ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  <code>r</code> æ‹’ç» <code>promise</code></p>
</li>
<li>
<p>2.3.3.3.3 å¦‚æœ <code>resolvePromise</code> å’Œ <code>rejectPromise</code> å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨</p>
</li>
<li>
<p>2.3.3.3.4 å¦‚æœè°ƒç”¨ <code>then</code> æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ <code>e</code>ï¼š</p>
<ul>
<li>2.3.3.3.4.1 å¦‚æœ <code>resolvePromise</code> æˆ– <code>rejectPromise</code> å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹</li>
<li>2.3.3.3.4.2 å¦åˆ™ä»¥ <code>e</code> ä¸ºæ®å› æ‹’ç» <code>promise</code></li>
</ul>
</li>
<li>
<p>2.3.3.4 å¦‚æœ <code>then</code> ä¸æ˜¯å‡½æ•°ï¼Œä»¥ <code>x</code> ä¸ºå‚æ•°æ‰§è¡Œ <code>promise</code></p>
</li>
</ul>
</li>
</ul>
<p><strong>â–ª 2.3.4 å¦‚æœ <code>x</code> ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ <code>x</code> ä¸ºå‚æ•°æ‰§è¡Œ <code>promise</code></strong></p>
<p>å¦‚æœä¸€ä¸ª <code>promise</code> è¢«ä¸€ä¸ªå¾ªç¯çš„ <code>thenable</code> é“¾ä¸­çš„å¯¹è±¡è§£å†³ï¼Œè€Œ <code>[[Resolve]](promise, thenable)</code> çš„é€’å½’æ€§è´¨åˆä½¿å¾—å…¶è¢«å†æ¬¡è°ƒç”¨ï¼Œæ ¹æ®ä¸Šè¿°çš„ç®—æ³•å°†ä¼šé™·å…¥æ— é™é€’å½’ä¹‹ä¸­ã€‚ç®—æ³•è™½ä¸å¼ºåˆ¶è¦æ±‚ï¼Œä½†ä¹Ÿé¼“åŠ±æ–½è€…æ£€æµ‹è¿™æ ·çš„é€’å½’æ˜¯å¦å­˜åœ¨ï¼Œè‹¥æ£€æµ‹åˆ°å­˜åœ¨åˆ™ä»¥ä¸€ä¸ªå¯è¯†åˆ«çš„ <code>TypeError</code> ä¸ºæ®å› æ¥æ‹’ç» <code>promise</code>ã€‚</p>
<ol start="2">
<li>Promises/A+ è§„èŒƒçš„æ€»ç»“</li>
</ol>
<hr>
<p>åŸºäºè§„èŒƒçš„æè¿°ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<p><strong>â—¾ 1.</strong> <code>then</code>æ–¹æ³•æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæ–°çš„<code>Promise</code>å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Promise ä»¥åå®ƒå°±æœ‰è‡ªå·±çš„<code>then</code>æ–¹æ³•ï¼Œè¿™æ ·å°±èƒ½å®ç°æ— é™çš„é“¾å¼</p>
<p><strong>â—¾ 2.</strong> ä¸è®º <code>promise1</code> è¢« <code>resolve()</code> è¿˜æ˜¯è¢« <code>reject()</code> æ—¶ <code>promise2</code> éƒ½ä¼šæ‰§è¡Œ <strong><code>Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)</code></strong></p>
<p>åœ¨æ‰‹å†™è¿™é‡Œæˆ‘ä»¬æŠŠè¿™ä¸ª <strong><code>Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)</code></strong> å‘½åä¸º <code>resolvePromise()</code> æ–¹æ³•ï¼Œå‚æ•°ä¸º <code>(promise2, x, resolve, reject)</code> å³ï¼š</p>
<pre><code>function resolvePromise(promise2, x, resolve, reject) {}
</code></pre>
<p><code>resolvePromise()</code>å„å‚æ•°çš„æ„ä¹‰ï¼š</p>
<pre><code>/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {}

</code></pre>
<p>å…¶å®ï¼Œè¿™ä¸ª<code>resolvePromise(promise2, x, resolve, reject)</code> å³ <code>Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)</code> å°±æ˜¯å¯¹<code>resolve()ã€reject()</code> è¿›è¡Œ<strong>æ”¹é€ å¢å¼º</strong>ï¼Œ é’ˆå¯¹<code>resolve()</code>å’Œ<code>reject()</code>ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†ã€‚</p>
<p><code>resolve()</code>å’Œ<code>reject()</code> è¿”å›çš„ <code>x</code> å€¼çš„å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>
<p>æ™®é€šå€¼</p>
</li>
<li>
<p>Promise å¯¹è±¡</p>
</li>
<li>
<p>thenable å¯¹è±¡ / å‡½æ•°</p>
</li>
<li>
<p>then æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ Promise</p>
</li>
</ol>
<hr>
<p>â—¾ <strong>2.2.7 è§„èŒƒ then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡</strong></p>
<p>æˆ‘ä»¬åœ¨<code>then</code>æ–¹æ³•é‡Œé¢è¿”å›ä¸€ä¸ª <strong><code>æ–°çš„æ‰‹å†™Promiseå®ä¾‹</code></strong>ï¼Œå†æŠŠåŸæ¥çš„ä»£ç å¤åˆ¶ä¸Šå»ï¼š</p>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value =&gt; value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; {
            throw reason;
        };
        
+       const promise2 = new myPromise((resolve, reject) =&gt; {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() =&gt; {
                    onFulfilled(this.PromiseResult);
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() =&gt; {
                    onRejected(this.PromiseResult);
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() =&gt; {
                    setTimeout(() =&gt; {
                        onFulfilled(this.PromiseResult);
                    });
                });
                this.onRejectedCallbacks.push(() =&gt; {
                    setTimeout(() =&gt; {
                        onRejected(this.PromiseResult);
                    });
                });
            }
+       })
        
+       return promise2
    }
}

</code></pre>
<p><strong>â—¾ 2.2.7.1 è§„èŒƒ</strong> å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ <strong>Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code></strong></p>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {
        const promise2 = new myPromise((resolve, reject) =&gt; {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() =&gt; {
+                   let x = onFulfilled(this.PromiseResult);
+                   resolvePromise(promise2, x, resolve, reject);
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() =&gt; {
+                   let x = onRejected(this.PromiseResult);
+                   resolvePromise(promise2, x, resolve, reject);
                });
            } 
        })

        return promise2
    }
}

+/**
+ * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
+ * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
+ * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
+ * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
+ * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
+ */
+ function resolvePromise(promise2, x, resolve, reject) {}

</code></pre>
<p>æˆ‘ä»¬åœ¨ <code>myPromise</code> ç±»å¤–é¢å£°æ˜äº†ä¸€ä¸ª <strong>Promise è§£å†³è¿‡ç¨‹</strong>ï¼š</p>
<p><strong>â—¾ 2.2.7.2 å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ <code>e</code> ï¼Œåˆ™ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  <code>e</code></strong></p>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {

        const promise2 = new myPromise((resolve, reject) =&gt; {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() =&gt; {
+                   try {
                        let x = onFulfilled(this.PromiseResult);
                        resolvePromise(promise2, x, resolve, reject);
+                   } catch (e) {
+                       reject(e); // æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸
+                   }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() =&gt; {
+                   try {
                        let x = onRejected(this.PromiseResult);
                        resolvePromise(promise2, x, resolve, reject);
+                   } catch (e) {
+                       reject(e)
+                   }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() =&gt; {
                    setTimeout(() =&gt; {
                        onFulfilled(this.PromiseResult);
                    });
                });
                this.onRejectedCallbacks.push(() =&gt; {
                    setTimeout(() =&gt; {
                        onRejected(this.PromiseResult);
                    });
                });
            }
        })

        return promise2
    }
}

</code></pre>
<p><strong>â—¾ <code>fulfilled</code> å’Œ <code>rejected</code> çŠ¶æ€å¤„ç†å®Œï¼Œä¸è¦å¿˜äº† <code>pending</code> çŠ¶æ€çš„æƒ…å†µ</strong></p>
<p>æˆ‘ä»¬åœ¨ <code>pending</code> çŠ¶æ€ä¿å­˜çš„ <code>resolve()</code> å’Œ <code>reject()</code> å›è°ƒä¹Ÿè¦ç¬¦åˆ <code>2.2.7.1 å’Œ 2.2.7.2 è§„èŒƒ</code>ï¼š</p>
<blockquote>
<p>å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œ Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code>
å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ <code>e</code> ï¼Œåˆ™ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  <code>e</code></p>
</blockquote>
<pre><code>class myPromise {
	...
    then(onFulfilled, onRejected) {
        const promise2 = new myPromise((resolve, reject) =&gt; {
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() =&gt; {
                    setTimeout(() =&gt; {
+                       try {
+                           let x = onFulfilled(this.PromiseResult);
+                           resolvePromise(promise2, x, resolve, reject)
+                       } catch (e) {
+                           reject(e);
+                       }
                    });
                });
                this.onRejectedCallbacks.push(() =&gt; {
                    setTimeout(() =&gt; {
+                       try {
+                           let x = onRejected(this.PromiseResult);
+                           resolvePromise(promise2, x, resolve, reject);
+                       } catch (e) {
+                           reject(e);
+                       }
                    });
                });
            }
        })

        return promise2
    }
}

</code></pre>
<p><strong>â—¾ 2.2.7.3Â å¦‚æœÂ <code>onFulfilled</code>Â ä¸æ˜¯å‡½æ•°ä¸”Â <code>promise1</code>Â æˆåŠŸæ‰§è¡Œï¼ŒÂ <code>promise2</code>Â å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼</strong></p>
<pre><code>class myPromise {
    ...
    then(onFulfilled, onRejected) {
        const promise2 = new myPromise((resolve, reject) =&gt; {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() =&gt; {
                    try {
+                       if (typeof onFulfilled !== 'function') {
+                           resolve(this.PromiseResult);
+                       } else {
                            let x = onFulfilled(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
+                       }
                    } catch (e) {
                        reject(e);
                    }
                });
        })

        return promise2
    }
}
</code></pre>
<p><strong>â—¾ 2.2.7.4Â å¦‚æœÂ <code>onRejected</code>Â ä¸æ˜¯å‡½æ•°ä¸”Â <code>promise1</code>Â æ‹’ç»æ‰§è¡Œï¼ŒÂ <code>promise2</code>Â å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„æ®å› </strong></p>
<pre><code>class myPromise {
    ...
    then(onFulfilled, onRejected) {
        const promise2 = new myPromise((resolve, reject) =&gt; {
	        else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() =&gt; {
                    try {
+                       if (typeof onRejected !== 'function') {
+                           reject(this.PromiseResult);
+                       } else {
                            let x = onRejected(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
+                       }
                    } catch (e) {
                        reject(e)
                    }
                });
            } 
        })

        return promise2
    }
}
</code></pre>
<p>è§„èŒƒ <strong>2.2.7.3</strong> å’Œ <strong>2.2.7.4</strong> å¯¹ <code>onFulfilled</code> å’Œ <code>onRejected</code> ä¸æ˜¯å‡½æ•°çš„æƒ…å†µåšäº†æ›´è¯¦ç»†çš„æè¿°ï¼Œæ ¹æ®æè¿°æˆ‘ä»¬å¯¹ <code>onFulfilled</code> å’Œ <code>onRejected</code> å¼•å…¥äº†æ–°çš„å‚æ•°æ ¡éªŒï¼Œæ‰€ä»¥ä¹‹å‰çš„å‚æ•°æ ¡éªŒå°±å¯ä»¥é€€å½¹äº†ï¼š</p>
<pre><code>class myPromise {
    ...
    then(onFulfilled, onRejected) {
-       onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value =&gt; value;
-       onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; {
-           throw reason;
-       };
    
    ...
    }
}


</code></pre>
<p>`**</p>
<h1>å…­ã€å®ç° resolvePromise æ–¹æ³•</h1>
<p><strong>â—¾ 2.3.1 å¦‚æœ <code>promise</code> å’Œ <code>x</code> æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ <code>TypeError</code> ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ <code>promise</code></strong></p>
<p>å¦‚æœä» <code>onFulfilled</code> æˆ– <code>onRejected</code> ä¸­è¿”å›çš„ x å°±æ˜¯ promise2ï¼Œä¼šå¯¼è‡´ <strong>å¾ªç¯å¼•ç”¨æŠ¥é”™</strong>ï¼Œè¿™éƒ¨åˆ†çš„å¤„ç†å°±æ˜¯è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<pre><code>function resolvePromise(promise2, x, resolve, reject) {
+   if (x === promise2) {
+       throw new TypeError('Chaining cycle detected for promise');
+   }
}

</code></pre>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦æŠ›å‡ºä¸€ä¸ª <code>TypeError</code> çš„å¼‚å¸¸å³å¯ï¼Œå› ä¸ºè°ƒç”¨ <code>resolvePromise</code> æ–¹æ³•å¤–å±‚çš„ <code>try...catch</code> ä¼šæŠ“ä½è¿™ä¸ªå¼‚å¸¸ï¼Œç„¶å <strong>ä»¥ TypeError ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ promiseã€‚</strong></p>
<p>ä¸¾ä¸€ä¸ª <strong>å¾ªç¯å¼•ç”¨</strong> çš„ä¾‹å­ğŸŒ°ï¼š</p>
<pre><code>const promise = new Promise((resolve, reject) =&gt; {
  resolve(100)
})
const p1 = promise.then(value =&gt; {
  console.log(value)
  return p1
})

</code></pre>
<p>ä½¿ç”¨åŸç”Ÿ Promise æ‰§è¡Œè¿™ä¸ªä»£ç ï¼Œä¼šæŠ¥ç±»å‹é”™è¯¯ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ce362aa04d1474899056757d69c2a80~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p><strong>â—¾ 2.3.2 å¦‚æœ <code>x</code> ä¸º Promise ï¼Œåˆ™ä½¿ <code>promise</code> æ¥å— <code>x</code> çš„çŠ¶æ€</strong></p>
<pre><code>function resolvePromise(promise2, x, resolve, reject) {
    if (x === promise2) {
        throw new TypeError('Chaining cycle detected for promise');
    }

+   if (x instanceof myPromise) {
+       /**
+        * 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€
+        *       ä¹Ÿå°±æ˜¯ç»§ç»­æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy
+        */
+       x.then(y =&gt; {
+           resolvePromise(promise2, y, resolve, reject)
+       }, reject);
+   }
}

</code></pre>
<p><strong>â—¾ 2.3.3 å¦‚æœ <code>x</code> ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°</strong> <strong>â—¾ 2.3.4 å¦‚æœ <code>x</code> ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ <code>x</code> ä¸ºå‚æ•°æ‰§è¡Œ <code>promise</code></strong></p>
<p>åœ¨åˆ¤æ–­<code>x</code>æ˜¯å¯¹è±¡æˆ–å‡½æ•°æ—¶ï¼Œ<code>x</code> ä¸èƒ½æ˜¯ <code>null</code>ï¼Œå› ä¸º <code>typeof null</code>çš„å€¼ä¹Ÿä¸º <code>object</code></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1976a2fb1142468185be97771c418c3c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>æˆ‘ä»¬åº”è¯¥æ˜¾å¼çš„å£°æ˜ <code>x != null</code>ï¼Œè¿™æ · å½“ <code>x</code> ä¸º <code>null</code> æ—¶ï¼Œç›´æ¥æ‰§è¡Œ<code>resolve(x)</code>ï¼Œå¦åˆ™ï¼Œå¦‚æœä¸è¿™æ ·ä¸å£°æ˜ï¼Œ<code>x</code> ä¸º <code>null</code> æ—¶å°±ä¼šèµ°åˆ°<code>catch</code>ç„¶å<code>reject</code>ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬è¦çš„ï¼Œæ‰€ä»¥éœ€è¦æ£€æµ‹ä¸‹<code>null</code>ï¼š</p>
<pre><code>if (x != null &amp;&amp; ((typeof x === 'object' || (typeof x === 'function'))))
</code></pre>
<p><strong>â—¾ 2.3.3 å’Œ 2.3.4 è§„èŒƒå®ç°å¦‚ä¸‹ï¼š</strong></p>
<pre><code>function resolvePromise(promise2, x, resolve, reject) {
    if (x === promise2) {
        throw new TypeError('Chaining cycle detected for promise');
    }

    if (x instanceof myPromise) {
        x.then(y =&gt; {
            resolvePromise(promise2, y, resolve, reject)
        }, reject);
+   } else if (x !== null &amp;&amp; ((typeof x === 'object' || (typeof x === 'function')))) {
+       // 2.3.3 å¦‚æœ x ä¸ºå¯¹è±¡æˆ–å‡½æ•°
+       try {
+           // 2.3.3.1 æŠŠ x.then èµ‹å€¼ç»™ then
+           var then = x.then;
+       } catch (e) {
+           // 2.3.3.2 å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ e ï¼Œåˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
+           return reject(e);
+       }
+
+       /**
+        * 2.3.3.3 
+        * å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚
+        * ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ
+        * ç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`
+        */
+       if (typeof then === 'function') {
+           // 2.3.3.3.3 å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨
+           let called = false; // é¿å…å¤šæ¬¡è°ƒç”¨
+           try {
+               then.call(
+                   x,
+                   // 2.3.3.3.1 å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)
+                   y =&gt; {
+                       if (called) return;
+                       called = true;
+                       resolvePromise(promise2, y, resolve, reject);
+                   },
+                   // 2.3.3.3.2 å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise
+                   r =&gt; {
+                       if (called) return;
+                       called = true;
+                       reject(r);
+                   }
+               )
+           } catch (e) {
+               /**
+                * 2.3.3.3.4 å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ e
+                * 2.3.3.3.4.1 å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹
+                */
+               if (called) return;
+               called = true;
+
+               /**
+                * 2.3.3.3.4.2 å¦åˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
+                */
+               reject(e);
+           }
+       } else {
+           // 2.3.3.4 å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
+           resolve(x);
+       }
+   } else {
+       // 2.3.4 å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
+       return resolve(x);
+   }
}
</code></pre>
<hr>
<h1>ES6 æ–°ç‰¹æ€§ Class ç±»çš„å…¨æ–¹é¢ç†è§£</h1><h1>ç±»çš„ç”±æ¥</h1>
<p>ç”Ÿæˆå®ä¾‹å¯¹è±¡çš„ä¼ ç»Ÿæ–¹æ³•æ˜¯é€šè¿‡æ„é€ å‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p>
<pre><code>function Point(x, y) {
  this.x = x;
  this.y = y;
}

Point.prototype.toString = function () {
  return '(' + this.x + ', ' + this.y + ')';
};

var p = new Point(1, 2);
</code></pre>
<p>ES6 æä¾›äº†æ›´æ¥è¿‘ä¼ ç»Ÿè¯­è¨€çš„å†™æ³•ï¼Œå¼•å…¥äº† Classï¼ˆç±»ï¼‰è¿™ä¸ªæ¦‚å¿µï¼Œä½œä¸ºå¯¹è±¡çš„æ¨¡æ¿ã€‚
åŸºæœ¬ä¸Šï¼ŒES6 çš„<code>class</code>å¯ä»¥çœ‹ä½œåªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œå®ƒçš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½ï¼ŒES5 éƒ½å¯ä»¥åšåˆ°
ç”¨ ES6 çš„<code>class</code>æ”¹å†™ï¼Œå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚</p>
<pre><code>class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }

  toString() {
    return '(' + this.x + ', ' + this.y + ')';
  }
}
</code></pre>
<p>ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ª â€œç±»â€ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ª<code>constructor()</code>æ–¹æ³•ï¼Œè¿™å°±æ˜¯æ„é€ æ–¹æ³•ï¼Œè€Œ<code>this</code>å…³é”®å­—åˆ™ä»£è¡¨å®ä¾‹å¯¹è±¡ã€‚</p>
<p>â—¾ <code>Point</code>ç±»é™¤äº†æ„é€ æ–¹æ³•ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ª<code>toString()</code>æ–¹æ³•ã€‚
<strong>æ³¨æ„ï¼Œå®šä¹‰<code>toString()</code>æ–¹æ³•çš„æ—¶å€™ï¼Œå‰é¢ä¸éœ€è¦åŠ ä¸Š<code>function</code>è¿™ä¸ªå…³é”®å­—ï¼Œç›´æ¥æŠŠå‡½æ•°å®šä¹‰æ”¾è¿›å»äº†å°±å¯ä»¥äº†ã€‚
å¦å¤–ï¼Œæ–¹æ³•ä¸æ–¹æ³•ä¹‹é—´ä¸éœ€è¦é€—å·åˆ†éš”ï¼ŒåŠ äº†ä¼šæŠ¥é”™ã€‚</strong></p>
<h2>ES6 çš„ç±»ï¼Œå®Œå…¨å¯ä»¥çœ‹ä½œæ„é€ å‡½æ•°çš„å¦ä¸€ç§å†™æ³•ã€‚</h2>
<pre><code>class Point {
  // ...
}
typeof Point // &quot;function&quot;
Point === Point.prototype.constructor // true
</code></pre>
<p>ä¸Šé¢ä»£ç è¡¨æ˜ï¼Œç±»çš„æ•°æ®ç±»å‹å°±æ˜¯å‡½æ•°ï¼Œç±»æœ¬èº«å°±æŒ‡å‘æ„é€ å‡½æ•°ã€‚
ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ç›´æ¥å¯¹ç±»ä½¿ç”¨<code>new</code>å‘½ä»¤ï¼Œè·Ÿæ„é€ å‡½æ•°çš„ç”¨æ³•å®Œå…¨ä¸€è‡´ã€‚</p>
<pre><code>class Bar {
  doStuff() {
    console.log('stuff');
  }
}

const b = new Bar();
b.doStuff() // &quot;stuff&quot;
</code></pre>
<p>æ„é€ å‡½æ•°çš„<code>prototype</code>å±æ€§ï¼Œåœ¨ ES6 çš„ â€œç±»â€ ä¸Šé¢ç»§ç»­å­˜åœ¨ã€‚äº‹å®ä¸Šï¼Œç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½å®šä¹‰åœ¨ç±»çš„<code>prototype</code>å±æ€§ä¸Šé¢ã€‚</p>
<pre><code>class Point {
  constructor() {
    // ...
  }

  toString() {
    // ...
  }

  toValue() {
    // ...
  }
}

// ç­‰åŒäº

Point.prototype = {
  constructor() {},
  toString() {},
  toValue() {},
};
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>constructor()</code>ã€<code>toString()</code>ã€<code>toValue()</code>è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶å®éƒ½æ˜¯å®šä¹‰åœ¨<code>Point.prototype</code>ä¸Šé¢ã€‚
å› æ­¤ï¼Œåœ¨ç±»çš„å®ä¾‹ä¸Šé¢è°ƒç”¨æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨åŸå‹ä¸Šçš„æ–¹æ³•ã€‚</p>
<pre><code>class B {}
const b = new B();

b.constructor === B.prototype.constructor // true
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>b</code>æ˜¯<code>B</code>ç±»çš„å®ä¾‹ï¼Œå®ƒçš„<code>constructor()</code>æ–¹æ³•å°±æ˜¯<code>B</code>ç±»åŸå‹çš„<code>constructor()</code>æ–¹æ³•ã€‚
ç”±äºç±»çš„æ–¹æ³•éƒ½å®šä¹‰åœ¨<code>prototype</code>å¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥ç±»çš„æ–°æ–¹æ³•å¯ä»¥æ·»åŠ åœ¨<code>prototype</code>å¯¹è±¡ä¸Šé¢ã€‚<code>Object.assign()</code>æ–¹æ³•å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸€æ¬¡å‘ç±»æ·»åŠ å¤šä¸ªæ–¹æ³•ã€‚</p>
<pre><code>class Point {
  constructor(){
    // ...
  }
}

Object.assign(Point.prototype, {
  toString(){},
  toValue(){}
});
</code></pre>
<p><code>prototype</code>å¯¹è±¡çš„<code>constructor()</code>å±æ€§ï¼Œç›´æ¥æŒ‡å‘ â€œç±»â€ çš„æœ¬èº«ï¼Œè¿™ä¸ ES5 çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚</p>
<pre><code>Point.prototype.constructor === Point // true
</code></pre>
<h2>ç±»çš„å†…éƒ¨æ‰€æœ‰å®šä¹‰çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ä¸å¯æšä¸¾çš„ï¼ˆnon-enumerableï¼‰ã€‚</h2>
<pre><code>class Point {
  constructor(x, y) {
    // ...
  }

  toString() {
    // ...
  }
}

Object.keys(Point.prototype)
// []
Object.getOwnPropertyNames(Point.prototype)
// [&quot;constructor&quot;,&quot;toString&quot;]
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>toString()</code>æ–¹æ³•æ˜¯<code>Point</code>ç±»å†…éƒ¨å®šä¹‰çš„æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸å¯æšä¸¾çš„ã€‚è¿™ä¸€ç‚¹ä¸ ES5 çš„è¡Œä¸ºä¸ä¸€è‡´ã€‚</p>
<pre><code>var Point = function (x, y) {
  // ...
};

Point.prototype.toString = function () {
  // ...
};

Object.keys(Point.prototype)
// [&quot;toString&quot;]
Object.getOwnPropertyNames(Point.prototype)
// [&quot;constructor&quot;,&quot;toString&quot;]
</code></pre>
<p>ä¸Šé¢ä»£ç é‡‡ç”¨ ES5 çš„å†™æ³•ï¼Œ<code>toString()</code>æ–¹æ³•å°±æ˜¯å¯æšä¸¾çš„ã€‚</p>
<p><em>æ³¨ï¼šåœ¨ JavaScript ä¸­ï¼Œå¯¹è±¡çš„å±æ€§åˆ†ä¸ºå¯æšä¸¾å’Œä¸å¯æšä¸¾ä¹‹åˆ†ã€‚å¯æšä¸¾æ€§å†³å®šäº†è¿™ä¸ªå±æ€§èƒ½å¦è¢« forâ€¦in æŸ¥æ‰¾éå†åˆ°ã€‚</em></p>
<blockquote>
<p>å¯æšä¸¾å±æ€§æ˜¯æŒ‡é‚£äº›å†…éƒ¨ â€œå¯æšä¸¾â€ æ ‡å¿—è®¾ç½®ä¸ºÂ <code>true</code>Â çš„å±æ€§ï¼Œå¯¹äºé€šè¿‡ç›´æ¥çš„èµ‹å€¼å’Œå±æ€§åˆå§‹åŒ–çš„å±æ€§ï¼Œè¯¥æ ‡è¯†å€¼é»˜è®¤ä¸ºå³ä¸ºÂ <code>true</code>ï¼Œå¯¹äºé€šè¿‡Â <code>Object.defineProperty</code> ç­‰å®šä¹‰çš„å±æ€§ï¼Œè¯¥æ ‡è¯†å€¼é»˜è®¤ä¸ºÂ <code>false</code>ã€‚å¯æšä¸¾çš„å±æ€§å¯ä»¥é€šè¿‡Â <code>for...in</code>Â å¾ªç¯è¿›è¡Œéå†ï¼ˆé™¤éè¯¥å±æ€§åæ˜¯ä¸€ä¸ªÂ Symbolï¼‰ã€‚</p>
</blockquote>
<p>å±æ€§çš„æšä¸¾æ€§ä¼šå½±å“ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°çš„ç»“æœï¼š</p>
<ul>
<li>
<p>forâ€¦in</p>
</li>
<li>
<p>Object.keys()</p>
</li>
<li>
<p>JSON.stringify</p>
</li>
</ul>
<h1>æ„é€ å‡½æ•° constructor</h1>
<p><strong><code>constructor</code></strong> æ˜¯ä¸€ç§ç”¨äºåˆ›å»ºå’Œåˆå§‹åŒ–<code>class</code>åˆ›å»ºçš„å¯¹è±¡çš„ç‰¹æ®Šæ–¹æ³•ã€‚</p>
<pre><code>class Polygon {
  constructor() {
    this.name = 'Polygon';
  }
}

const poly1 = new Polygon();

console.log(poly1.name);
// expected output: &quot;Polygon&quot;
</code></pre>
<p><code>constructor()</code>æ–¹æ³•æ˜¯ç±»çš„é»˜è®¤æ–¹æ³•ï¼Œ<strong>é€šè¿‡<code>new</code>å‘½ä»¤ç”Ÿæˆå¯¹è±¡å®ä¾‹æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•</strong>ã€‚ä¸€ä¸ªç±»å¿…é¡»æœ‰<code>constructor()</code>æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼å®šä¹‰ï¼Œä¸€ä¸ªç©ºçš„<code>constructor()</code>æ–¹æ³•ä¼šè¢«é»˜è®¤æ·»åŠ ã€‚</p>
<pre><code>class Point {
}

// ç­‰åŒäº
class Point {
  constructor() {}
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªç©ºçš„ç±»<code>Point</code>ï¼ŒJavaScript å¼•æ“ä¼šè‡ªåŠ¨ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªç©ºçš„<code>constructor()</code>æ–¹æ³•ã€‚</p>
<p><code>constructor()</code>æ–¹æ³•é»˜è®¤è¿”å›å®ä¾‹å¯¹è±¡ï¼ˆå³<code>this</code>ï¼‰ï¼Œå®Œå…¨å¯ä»¥æŒ‡å®šè¿”å›å¦å¤–ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<pre><code>class Foo {
  constructor() {
    return Object.create(null);
  }
}

new Foo() instanceof Foo
// false
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>constructor()</code>å‡½æ•°è¿”å›ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œç»“æœå¯¼è‡´å®ä¾‹å¯¹è±¡ä¸æ˜¯<code>Foo</code>ç±»çš„å®ä¾‹ã€‚</p>
<p>ç±»å¿…é¡»ä½¿ç”¨<code>new</code>è°ƒç”¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å®ƒè·Ÿæ™®é€šæ„é€ å‡½æ•°çš„ä¸€ä¸ªä¸»è¦åŒºåˆ«ï¼Œåè€…ä¸ç”¨<code>new</code>ä¹Ÿå¯ä»¥æ‰§è¡Œã€‚</p>
<pre><code>class Foo {
  constructor() {
    return Object.create(null);
  }
}

Foo()
// TypeError: Class constructor Foo cannot be invoked without 'new'
</code></pre>
<p>åœ¨ä¸€ä¸ªç±»ä¸­åªèƒ½æœ‰ä¸€ä¸ªåä¸º â€œconstructorâ€ çš„ç‰¹æ®Šæ–¹æ³•ã€‚ ä¸€ä¸ªç±»ä¸­å‡ºç°å¤šæ¬¡æ„é€ å‡½æ•° (<code>constructor)</code>æ–¹æ³•å°†ä¼šæŠ›å‡ºä¸€ä¸ªÂ <code>SyntaxError</code>é”™è¯¯ã€‚</p>
<p>åœ¨ä¸€ä¸ªæ„é€ æ–¹æ³•ä¸­å¯ä»¥ä½¿ç”¨<code>super</code>å…³é”®å­—æ¥è°ƒç”¨ä¸€ä¸ªçˆ¶ç±»çš„æ„é€ æ–¹æ³•ã€‚</p>
<p>å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šæ„é€ æ–¹æ³•ï¼Œåˆ™ä¼šæ·»åŠ é»˜è®¤çš„ constructor æ–¹æ³•ã€‚</p>
<p>å¦‚æœä¸æŒ‡å®šä¸€ä¸ªæ„é€ å‡½æ•° (constructor) æ–¹æ³•, åˆ™ä½¿ç”¨ä¸€ä¸ªé»˜è®¤çš„æ„é€ å‡½æ•°(constructor)ã€‚</p>
<p><strong>â—¾ ä½¿ç”¨ constructor æ–¹æ³•</strong></p>
<pre><code>class Square extends Polygon {
    constructor(length) {
        // åœ¨è¿™é‡Œ, å®ƒè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°, å¹¶å°† lengths æä¾›ç»™ Polygon çš„&quot;width&quot;å’Œ&quot;height&quot;
        super(length, length);
        // æ³¨æ„: åœ¨æ´¾ç”Ÿç±»ä¸­, å¿…é¡»å…ˆè°ƒç”¨ super() æ‰èƒ½ä½¿ç”¨ &quot;this&quot;ã€‚
        // å¿½ç•¥è¿™ä¸ªï¼Œå°†ä¼šå¯¼è‡´ä¸€ä¸ªå¼•ç”¨é”™è¯¯ã€‚
        this.name = 'Square';
    }
    get area() {
        return this.height * this.width;
    }
    set area(value) {
        // æ³¨æ„ï¼šä¸å¯ä½¿ç”¨ this.area = value
        // å¦åˆ™ä¼šå¯¼è‡´å¾ªç¯call setteræ–¹æ³•å¯¼è‡´çˆ†æ ˆ
        this._area = value;
    }
}
</code></pre>
<p>è¿™é‡ŒåŒ…å«ä¸¤ä¸ªé‡è¦çŸ¥è¯†ç‚¹ï¼š</p>
<ul>
<li>æ³¨æ„: åœ¨æ´¾ç”Ÿç±»ä¸­, å¿…é¡»å…ˆè°ƒç”¨ super() æ‰èƒ½ä½¿ç”¨ &quot;this&quot;ã€‚å¿½ç•¥è¿™ä¸ªï¼Œå°†ä¼šå¯¼è‡´ä¸€ä¸ªå¼•ç”¨é”™è¯¯ã€‚</li>
<li>æ³¨æ„ï¼šåœ¨ <code>set area(value)</code>ä¸­ ä¸å¯ä½¿ç”¨ <code>this.area = value</code>ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¾ªç¯ call setter æ–¹æ³•å¯¼è‡´çˆ†æ ˆ</li>
</ul>
<p><strong>â—¾ é»˜è®¤æ„é€ æ–¹æ³•</strong></p>
<p>å¦‚å‰æ‰€è¿°ï¼Œå¦‚æœä¸æŒ‡å®šæ„é€ æ–¹æ³•ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ã€‚å¯¹äºåŸºç±»ï¼Œé»˜è®¤æ„é€ å‡½æ•°æ˜¯ï¼š</p>
<pre><code>constructor() {}
</code></pre>
<p>Copy to Clipboard</p>
<p>å¯¹äºæ´¾ç”Ÿç±»ï¼Œé»˜è®¤æ„é€ å‡½æ•°æ˜¯ï¼š</p>
<pre><code>constructor(...args) {
  super(...args);
}
</code></pre>
<h1>ç±»çš„å®ä¾‹åŒ–</h1>
<p>class çš„å®ä¾‹åŒ–å¿…é¡»é€šè¿‡ new å…³é”®å­—ã€‚</p>
<pre><code>class Example {} 
let exam1 = Example(); 
// Class constructor Example cannot be invoked without 'new'
</code></pre>
<p><strong>â—¾ å®ä¾‹åŒ–å¯¹è±¡</strong></p>
<p>ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ä¸€ä¸ªåŸå‹å¯¹è±¡ã€‚</p>
<pre><code>class Example {
    constructor(a, b) {
        this.a = a;
        this.b = b;
        console.log('Example');
    }
    sum() {
        return this.a + this.b;
    }
}
let exam1 = new Example(2, 1);
let exam2 = new Example(3, 1);
console.log(exam1._proto_ == exam2._proto_); // true 

exam1._proto_.sub = function () {
    return this.a - this.b;
}
console.log(exam1.sub()); // 1 
console.log(exam2.sub()); // 2
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>exam1</code>å’Œ<code>exam2</code>éƒ½æ˜¯<code>Example</code>çš„å®ä¾‹ï¼Œå®ƒä»¬çš„åŸå‹éƒ½æ˜¯<code>Example.prototype</code>ï¼Œæ‰€ä»¥<code>__proto__</code>å±æ€§æ˜¯ç›¸ç­‰çš„ã€‚</p>
<p>è¿™ä¹Ÿæ„å‘³ç€ï¼Œå¯ä»¥é€šè¿‡å®ä¾‹çš„<code>__proto__</code>å±æ€§ä¸º â€œç±»â€ æ·»åŠ æ–¹æ³•ã€‚</p>
<blockquote>
<p><code>__proto__</code>Â å¹¶ä¸æ˜¯è¯­è¨€æœ¬èº«çš„ç‰¹æ€§ï¼Œè¿™æ˜¯å„å¤§å‚å•†å…·ä½“å®ç°æ—¶æ·»åŠ çš„ç§æœ‰å±æ€§ï¼Œè™½ç„¶ç›®å‰å¾ˆå¤šç°ä»£æµè§ˆå™¨çš„ JS å¼•æ“ä¸­éƒ½æä¾›äº†è¿™ä¸ªç§æœ‰å±æ€§ï¼Œä½†ä¾æ—§ä¸å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¯¥å±æ€§ï¼Œé¿å…å¯¹ç¯å¢ƒäº§ç”Ÿä¾èµ–ã€‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Â <code>Object.getPrototypeOf</code>Â æ–¹æ³•æ¥è·å–å®ä¾‹å¯¹è±¡çš„åŸå‹ï¼Œç„¶åå†æ¥ä¸ºåŸå‹æ·»åŠ æ–¹æ³• / å±æ€§ã€‚</p>
</blockquote>
<p>ä½¿ç”¨å®ä¾‹çš„<code>__proto__</code>å±æ€§æ”¹å†™åŸå‹ï¼Œå¿…é¡»ç›¸å½“è°¨æ…ï¼Œä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºè¿™ä¼šæ”¹å˜ â€œç±»â€ çš„åŸå§‹å®šä¹‰ï¼Œå½±å“åˆ°æ‰€æœ‰å®ä¾‹ã€‚</p>
<h1>å–å€¼å‡½æ•° (getter) å’Œå­˜å€¼å‡½æ•° (setter)</h1>
<p>åœ¨ â€œç±»â€ çš„å†…éƒ¨å¯ä»¥ä½¿ç”¨<code>get</code>å’Œ<code>set</code>å…³é”®å­—ï¼Œå¯¹æŸä¸ªå±æ€§è®¾ç½®å­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°ï¼Œæ‹¦æˆªè¯¥å±æ€§çš„å­˜å–è¡Œä¸ºã€‚</p>
<pre><code>class MyClass {
  constructor() {
    // ...
  }
  get prop() {
    return 'getter';
  }
  set prop(value) {
    console.log('setter: '+value);
  }
}

let inst = new MyClass();

inst.prop = 123;
// setter: 123

inst.prop
// 'getter'
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>prop</code>å±æ€§æœ‰å¯¹åº”çš„å­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°ï¼Œå› æ­¤èµ‹å€¼å’Œè¯»å–è¡Œä¸ºéƒ½è¢«è‡ªå®šä¹‰äº†ã€‚</p>
<p>å­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°æ˜¯è®¾ç½®åœ¨å±æ€§çš„ Descriptor å¯¹è±¡ä¸Šçš„ã€‚</p>
<pre><code>class CustomHTMLElement {
  constructor(element) {
    this.element = element;
  }

  get html() {
    return this.element.innerHTML;
  }

  set html(value) {
    this.element.innerHTML = value;
  }
}

var descriptor = Object.getOwnPropertyDescriptor(
  CustomHTMLElement.prototype, &quot;html&quot;
);

&quot;get&quot; in descriptor  // true
&quot;set&quot; in descriptor  // true
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°æ˜¯å®šä¹‰åœ¨<code>html</code>å±æ€§çš„æè¿°å¯¹è±¡ä¸Šé¢ï¼Œè¿™ä¸ ES5 å®Œå…¨ä¸€è‡´ã€‚</p>
<pre><code>class Example {
    constructor(a, b) {
        this.a = a; // å®ä¾‹åŒ–æ—¶è°ƒç”¨ set æ–¹æ³•
        this.b = b;
    }
    get a() {
        console.log('getter');
        return this.a;
    }
    set a(a) {
        console.log('setter');
        this.a = a; // è‡ªèº«é€’å½’è°ƒç”¨
    }
}
let exam = new Example(1, 2); // ä¸æ–­è¾“å‡º setter ï¼Œæœ€ç»ˆå¯¼è‡´ RangeError
class Example1 {
    constructor(a, b) {
        this.a = a;
        this.b = b;
    }
    get a() {
        console.log('getter');
        return this._a;
    }
    set a(a) {
        console.log('setter');
        this._a = a;
    }
}
let exam1 = new Example1(1, 2); // åªè¾“å‡º setter , ä¸ä¼šè°ƒç”¨ getter æ–¹æ³•
console.log(exam1._a); // 1, å¯ä»¥ç›´æ¥è®¿é—®
</code></pre>
<p><strong>â—¾ getter ä¸å¯å•ç‹¬å‡ºç°</strong></p>
<pre><code>class Example {
    constructor(a) {
        this.a = a;
    }
    get a() {
        return this.a;
    }
}
let exam = new Example(1); 
// Uncaught TypeError: Cannot set property a of #&lt;Example&gt; which has only a getter
</code></pre>
<p><strong>â—¾ getter ä¸ setter å¿…é¡»åŒçº§å‡ºç°</strong></p>
<pre><code>class Father {
    constructor() {}
    get a() {
        return this._a;
    }
}
class Child extends Father {
    constructor() {
        super();
    }
    set a(a) {
        this._a = a;
    }
}
let test = new Child();
test.a = 2;
console.log(test.a); // undefined
</code></pre>
<p><strong>æ­£ç¡®å†™æ³•ï¼šåˆ›å»ºç±»çš„æ—¶å€™åŒæ—¶å£°æ˜<code>get</code> å’Œ<code>set</code>ï¼Œæˆ–è€…æŠŠ <code>get</code> å’Œ<code>set</code>éƒ½æ”¾åœ¨å­ç±»ä¸­</strong></p>
<pre><code>class Father1 {
    constructor() {}
    // æˆ–è€…éƒ½æ”¾åœ¨å­ç±»ä¸­
    get a() {
        return this._a;
    }
    set a(a) {
        this._a = a;
    }
}
class Child1 extends Father1 {
    constructor() {
        super();
    }
}
let test1 = new Child1();
test1.a = 2;
console.log(test1.a); // 2
</code></pre>
<h1>é™æ€æ–¹æ³• static</h1>
<p>ç±»ï¼ˆclassï¼‰é€šè¿‡Â <strong>static</strong> å…³é”®å­—å®šä¹‰é™æ€æ–¹æ³•ã€‚ä¸èƒ½åœ¨ç±»çš„å®ä¾‹ä¸Šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œè€Œåº”è¯¥é€šè¿‡ç±»æœ¬èº«è°ƒç”¨ã€‚è¿™
äº›é€šå¸¸æ˜¯å®ç”¨ç¨‹åºæ–¹æ³•ï¼Œä¾‹å¦‚åˆ›å»ºæˆ–å…‹éš†å¯¹è±¡çš„åŠŸèƒ½ã€‚</p>
<p>ç±»ç›¸å½“äºå®ä¾‹çš„åŸå‹ï¼Œæ‰€æœ‰åœ¨ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œéƒ½ä¼šè¢«å®ä¾‹ç»§æ‰¿ã€‚å¦‚æœåœ¨ä¸€ä¸ªæ–¹æ³•å‰ï¼ŒåŠ ä¸Š<code>static</code>å…³é”®å­—ï¼Œå°±è¡¨ç¤ºè¯¥æ–¹æ³•ä¸ä¼šè¢«å®ä¾‹ç»§æ‰¿ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ç±»æ¥è°ƒç”¨ï¼Œè¿™å°±ç§°ä¸º â€œé™æ€æ–¹æ³•â€ã€‚</p>
<pre><code>class Foo {
  static classMethod() {
    return 'hello';
  }
}

Foo.classMethod() // 'hello'

var foo = new Foo();
foo.classMethod()
// TypeError: foo.classMethod is not a function
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>Foo</code>ç±»çš„<code>classMethod</code>æ–¹æ³•å‰æœ‰<code>static</code>å…³é”®å­—ï¼Œè¡¨æ˜è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥åœ¨<code>Foo</code>ç±»ä¸Šè°ƒç”¨ï¼ˆ<code>Foo.classMethod()</code>ï¼‰ï¼Œè€Œä¸æ˜¯åœ¨<code>Foo</code>ç±»çš„å®ä¾‹ä¸Šè°ƒç”¨ã€‚å¦‚æœåœ¨å®ä¾‹ä¸Šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¡¨ç¤ºä¸å­˜åœ¨è¯¥æ–¹æ³•ã€‚</p>
<p>â—¾ æ³¨æ„ï¼Œå¦‚æœé™æ€æ–¹æ³•åŒ…å«<code>this</code>å…³é”®å­—ï¼Œè¿™ä¸ª<code>this</code>æŒ‡çš„æ˜¯ç±»ï¼Œè€Œä¸æ˜¯å®ä¾‹ã€‚</p>
<pre><code>class Foo {
  static bar() {
    this.baz();
  }
  static baz() {
    console.log('hello');
  }
  baz() {
    console.log('world');
  }
}

Foo.bar() // hello
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œé™æ€æ–¹æ³•<code>bar</code>è°ƒç”¨äº†<code>this.baz</code>ï¼Œè¿™é‡Œçš„<code>this</code>æŒ‡çš„æ˜¯<code>Foo</code>ç±»ï¼Œè€Œä¸æ˜¯<code>Foo</code>çš„å®ä¾‹ï¼Œç­‰åŒäºè°ƒç”¨<code>Foo.baz</code>ã€‚å¦å¤–ï¼Œä»è¿™ä¸ªä¾‹å­è¿˜å¯ä»¥çœ‹å‡ºï¼Œé™æ€æ–¹æ³•å¯ä»¥ä¸éé™æ€æ–¹æ³•é‡åã€‚</p>
<p>â—¾ çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼Œå¯ä»¥è¢«å­ç±»ç»§æ‰¿ã€‚</p>
<pre><code>class Foo {
  static classMethod() {
    return 'hello';
  }
}

class Bar extends Foo {
}

Bar.classMethod() // 'hello'
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œçˆ¶ç±»<code>Foo</code>æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå­ç±»<code>Bar</code>å¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p>
<p>â—¾ é™æ€æ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥ä»<code>super</code>å¯¹è±¡ä¸Šè°ƒç”¨çš„ã€‚</p>
<pre><code>class Foo {
  static classMethod() {
    return 'hello';
  }
}

class Bar extends Foo {
  static classMethod() {
    return super.classMethod() + ', too';
  }
}

Bar.classMethod() // &quot;hello, too&quot;
</code></pre>
<h1>å…³é”®å­— super</h1>
<p><strong>super</strong> å…³é”®å­—ç”¨äºè®¿é—®å’Œè°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„çˆ¶å¯¹è±¡ä¸Šçš„å‡½æ•°ã€‚</p>
<p><strong>åœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨æ—¶ï¼Œ<code>super</code>å…³é”®å­—å°†å•ç‹¬å‡ºç°</strong>ï¼Œå¹¶ä¸”<strong>å¿…é¡»åœ¨ä½¿ç”¨<code>this</code>å…³é”®å­—ä¹‹å‰ä½¿ç”¨ã€‚<code>super</code>å…³é”®å­—ä¹Ÿå¯ä»¥ç”¨æ¥è°ƒç”¨çˆ¶å¯¹è±¡ä¸Šçš„å‡½æ•°</strong>ã€‚</p>
<p><strong>â—¾ è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</strong></p>
<pre><code>class Polygon {
  constructor(height, width) {
    this.name = 'Rectangle';
    this.height = height;
    this.width = width;
  }
  sayName() {
    console.log('Hi, I am a ', this.name + '.');
  }
  get area() {
    return this.height * this.width;
  }
  set area(value) {
    this._area = value;
  }
}

class Square extends Polygon {
  constructor(length) {
    this.height; // è¿™æ ·ç›´æ¥ this.heigh tä¼šæŠ¥é”™ï¼šReferenceErrorï¼Œå› ä¸º super éœ€è¦å…ˆè¢«è°ƒç”¨ï¼

    // è¿™é‡Œï¼Œå®ƒè°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°çš„,
    // ä½œä¸ºPolygon çš„ height, width
    super(length, length);

    // æ³¨æ„: åœ¨æ´¾ç”Ÿçš„ç±»ä¸­, åœ¨ä½ å¯ä»¥ä½¿ç”¨'this'ä¹‹å‰, å¿…é¡»å…ˆè°ƒç”¨super()ã€‚
    // å¿½ç•¥è¿™, è¿™å°†å¯¼è‡´å¼•ç”¨é”™è¯¯ã€‚
    this.name = 'Square';
  }
}
</code></pre>
<p><strong>â—¾ è°ƒç”¨çˆ¶ç±»ä¸Šçš„é™æ€æ–¹æ³•</strong></p>
<pre><code>class Rectangle {
  constructor() {}
  static logNbSides() {
    return 'I have 4 sides';
  }
}

class Square extends Rectangle {
  constructor() {}
  static logDescription() {
    return super.logNbSides() + ' which are all equal';
  }
}
Square.logDescription(); // 'I have 4 sides which are all equal'
</code></pre>
<p><strong>â—¾ å­ç±» constructor æ–¹æ³•ä¸­å¿…é¡»æœ‰ super ï¼Œä¸”å¿…é¡»å‡ºç°åœ¨ this ä¹‹å‰ã€‚</strong></p>
<p>ä¸‹é¢æ˜¯ä¸¤ä¸ªé”™è¯¯å†™æ³•ï¼š</p>
<pre><code>class Father {
    constructor() {}
}
class Child extends Father {
    constructor() {}
}
let test = new Child();
// Uncaught ReferenceError: Must call super constructor in derived class before accessing 'this' or returning from derived constructor
</code></pre>
<pre><code>class Father {
    constructor() {}
}
class Child extends Father {
    or
    constructor(a) {
        this.a = a;
        super();
    }
}
let test = new Child();
// Uncaught ReferenceError: Must call super constructor in derived class before accessing 'this' or returning from derived constructor
</code></pre>
<p><strong>â—¾ è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°, åªèƒ½å‡ºç°åœ¨å­ç±»çš„æ„é€ å‡½æ•°ã€‚</strong></p>
<pre><code>class Father {
    test() {
        return 0;
    }
    static test1() {
        return 1;
    }
}
class Child extends Father {
    constructor() {
        super();
    }
}
class Child1 extends Father {
    test2() {
        super(); // Uncaught SyntaxError: 'super' keyword unexpected     
        // here
    }
}
</code></pre>
<p><strong>â—¾ è°ƒç”¨çˆ¶ç±»æ–¹æ³•, super ä½œä¸ºå¯¹è±¡ï¼Œåœ¨æ™®é€šæ–¹æ³•ä¸­ï¼ŒæŒ‡å‘çˆ¶ç±»çš„åŸå‹å¯¹è±¡ï¼Œåœ¨é™æ€æ–¹æ³•ä¸­ï¼ŒæŒ‡å‘çˆ¶ç±»ã€‚</strong></p>
<pre><code>class Child2 extends Father {
    constructor(){
        super();
        // è°ƒç”¨çˆ¶ç±»æ™®é€šæ–¹æ³•
        console.log(super.test()); // 0
    }
    static test3(){
        // è°ƒç”¨çˆ¶ç±»é™æ€æ–¹æ³•
        return super.test1+2;
    }
}
Child2.test3(); // 3
</code></pre>
<h1>ç»§æ‰¿ extends</h1>
<p>Class å¯ä»¥é€šè¿‡<code>extends</code>å…³é”®å­—å®ç°ç»§æ‰¿ï¼Œè¿™æ¯” ES5 çš„é€šè¿‡ä¿®æ”¹åŸå‹é“¾å®ç°ç»§æ‰¿ï¼Œè¦æ¸…æ™°å’Œæ–¹ä¾¿å¾ˆå¤šã€‚</p>
<pre><code>class Point {
}

class ColorPoint extends Point {
}
</code></pre>
<p>ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ª<code>ColorPoint</code>ç±»ï¼Œè¯¥ç±»é€šè¿‡<code>extends</code>å…³é”®å­—ï¼Œç»§æ‰¿äº†<code>Point</code>ç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚ä½†æ˜¯ç”±äºæ²¡æœ‰éƒ¨ç½²ä»»ä½•ä»£ç ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªç±»å®Œå…¨ä¸€æ ·ï¼Œç­‰äºå¤åˆ¶äº†ä¸€ä¸ª<code>Point</code>ç±»ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬åœ¨<code>ColorPoint</code>å†…éƒ¨åŠ ä¸Šä»£ç ã€‚</p>
<pre><code>class ColorPoint extends Point {
  constructor(x, y, color) {
    super(x, y); // è°ƒç”¨çˆ¶ç±»çš„constructor(x, y)
    this.color = color;
  }

  toString() {
    return this.color + ' ' + super.toString(); // è°ƒç”¨çˆ¶ç±»çš„toString()
  }
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>constructor</code>æ–¹æ³•å’Œ<code>toString</code>æ–¹æ³•ä¹‹ä¸­ï¼Œéƒ½å‡ºç°äº†<code>super</code>å…³é”®å­—ï¼Œå®ƒåœ¨è¿™é‡Œè¡¨ç¤ºçˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œç”¨æ¥æ–°å»ºçˆ¶ç±»çš„<code>this</code>å¯¹è±¡ã€‚</p>
<p>â—¾ å­ç±»å¿…é¡»åœ¨<code>constructor</code>æ–¹æ³•ä¸­è°ƒç”¨<code>super</code>æ–¹æ³•ï¼Œå¦åˆ™æ–°å»ºå®ä¾‹æ—¶ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºå­ç±»è‡ªå·±çš„<code>this</code>å¯¹è±¡ï¼Œå¿…é¡»å…ˆé€šè¿‡çˆ¶ç±»çš„æ„é€ å‡½æ•°å®Œæˆå¡‘é€ ï¼Œå¾—åˆ°ä¸çˆ¶ç±»åŒæ ·çš„å®ä¾‹å±æ€§å’Œæ–¹æ³•ï¼Œç„¶åå†å¯¹å…¶è¿›è¡ŒåŠ å·¥ï¼ŒåŠ ä¸Šå­ç±»è‡ªå·±çš„å®ä¾‹å±æ€§å’Œæ–¹æ³•ã€‚å¦‚æœä¸è°ƒç”¨<code>super</code>æ–¹æ³•ï¼Œå­ç±»å°±å¾—ä¸åˆ°<code>this</code>å¯¹è±¡ã€‚</p>
<pre><code>class Point { /* ... */ }

class ColorPoint extends Point {
  constructor() {
  }
}

let cp = new ColorPoint(); // ReferenceError
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>ColorPoint</code>ç»§æ‰¿äº†çˆ¶ç±»<code>Point</code>ï¼Œä½†æ˜¯å®ƒçš„æ„é€ å‡½æ•°æ²¡æœ‰è°ƒç”¨<code>super</code>æ–¹æ³•ï¼Œå¯¼è‡´æ–°å»ºå®ä¾‹æ—¶æŠ¥é”™ã€‚</p>
<p>ES5 çš„ç»§æ‰¿ï¼Œå®è´¨æ˜¯å…ˆåˆ›é€ å­ç±»çš„å®ä¾‹å¯¹è±¡<code>this</code>ï¼Œç„¶åå†å°†çˆ¶ç±»çš„æ–¹æ³•æ·»åŠ åˆ°<code>this</code>ä¸Šé¢ï¼ˆ<code>Parent.apply(this)</code>ï¼‰ã€‚ES6 çš„ç»§æ‰¿æœºåˆ¶å®Œå…¨ä¸åŒï¼Œå®è´¨æ˜¯å…ˆå°†çˆ¶ç±»å®ä¾‹å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ï¼ŒåŠ åˆ°<code>this</code>ä¸Šé¢ï¼ˆæ‰€ä»¥å¿…é¡»å…ˆè°ƒç”¨<code>super</code>æ–¹æ³•ï¼‰ï¼Œç„¶åå†ç”¨å­ç±»çš„æ„é€ å‡½æ•°ä¿®æ”¹<code>this</code>ã€‚</p>
<p>å¦‚æœå­ç±»æ²¡æœ‰å®šä¹‰<code>constructor</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢«é»˜è®¤æ·»åŠ ï¼Œä»£ç å¦‚ä¸‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æ˜¾å¼å®šä¹‰ï¼Œä»»ä½•ä¸€ä¸ªå­ç±»éƒ½æœ‰<code>constructor</code>æ–¹æ³•ã€‚</p>
<pre><code>class ColorPoint extends Point {
}

// ç­‰åŒäº
class ColorPoint extends Point {
  constructor(...args) {
    super(...args);
  }
}
</code></pre>
<p>å¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œåœ¨å­ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œåªæœ‰è°ƒç”¨<code>super</code>ä¹‹åï¼Œæ‰å¯ä»¥ä½¿ç”¨<code>this</code>å…³é”®å­—ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºå­ç±»å®ä¾‹çš„æ„å»ºï¼ŒåŸºäºçˆ¶ç±»å®ä¾‹ï¼Œåªæœ‰<code>super</code>æ–¹æ³•æ‰èƒ½è°ƒç”¨çˆ¶ç±»å®ä¾‹ã€‚</p>
<pre><code>class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
}

class ColorPoint extends Point {
  constructor(x, y, color) {
    this.color = color; // ReferenceError
    super(x, y);
    this.color = color; // æ­£ç¡®
  }
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå­ç±»çš„<code>constructor</code>æ–¹æ³•æ²¡æœ‰è°ƒç”¨<code>super</code>ä¹‹å‰ï¼Œå°±ä½¿ç”¨<code>this</code>å…³é”®å­—ï¼Œç»“æœæŠ¥é”™ï¼Œè€Œæ”¾åœ¨<code>super</code>æ–¹æ³•ä¹‹åå°±æ˜¯æ­£ç¡®çš„ã€‚</p>
<p>ä¸‹é¢æ˜¯ç”Ÿæˆå­ç±»å®ä¾‹çš„ä»£ç ã€‚</p>
<pre><code>let cp = new ColorPoint(25, 8, 'green');

cp instanceof ColorPoint // true
cp instanceof Point // true
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå®ä¾‹å¯¹è±¡<code>cp</code>åŒæ—¶æ˜¯<code>ColorPoint</code>å’Œ<code>Point</code>ä¸¤ä¸ªç±»çš„å®ä¾‹ï¼Œè¿™ä¸ ES5 çš„è¡Œä¸ºå®Œå…¨ä¸€è‡´ã€‚</p>
<p>æœ€åï¼Œçˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼Œä¹Ÿä¼šè¢«å­ç±»ç»§æ‰¿ã€‚</p>
<pre><code>class A {
  static hello() {
    console.log('hello world');
  }
}

class B extends A {
}

B.hello()  // hello world
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>hello()</code>æ˜¯<code>A</code>ç±»çš„é™æ€æ–¹æ³•ï¼Œ<code>B</code>ç»§æ‰¿<code>A</code>ï¼Œä¹Ÿç»§æ‰¿äº†<code>A</code>çš„é™æ€æ–¹æ³•ã€‚</p>
<h1>ä¸å­˜åœ¨å˜é‡æå‡</h1>
<p>ç±»ä¸å­˜åœ¨å˜é‡æå‡ï¼ˆhoistï¼‰ï¼Œè¿™ä¸€ç‚¹ä¸ ES5 å®Œå…¨ä¸åŒã€‚</p>
<pre><code>new Foo(); // ReferenceError
class Foo {}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>Foo</code>ç±»ä½¿ç”¨åœ¨å‰ï¼Œå®šä¹‰åœ¨åï¼Œè¿™æ ·ä¼šæŠ¥é”™ï¼Œå› ä¸º ES6 ä¸ä¼šæŠŠç±»çš„å£°æ˜æå‡åˆ°ä»£ç å¤´éƒ¨ã€‚è¿™ç§è§„å®šçš„åŸå› ä¸ä¸‹æ–‡è¦æåˆ°çš„ç»§æ‰¿æœ‰å…³ï¼Œå¿…é¡»ä¿è¯å­ç±»åœ¨çˆ¶ç±»ä¹‹åå®šä¹‰ã€‚</p>
<pre><code>{
  let Foo = class {};
  class Bar extends Foo {
  }
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸º<code>Bar</code>ç»§æ‰¿<code>Foo</code>çš„æ—¶å€™ï¼Œ<code>Foo</code>å·²ç»æœ‰å®šä¹‰äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœå­˜åœ¨<code>class</code>çš„æå‡ï¼Œä¸Šé¢ä»£ç å°±ä¼šæŠ¥é”™ï¼Œå› ä¸º<code>class</code>ä¼šè¢«æå‡åˆ°ä»£ç å¤´éƒ¨ï¼Œè€Œ<code>let</code>å‘½ä»¤æ˜¯ä¸æå‡çš„ï¼Œæ‰€ä»¥å¯¼è‡´<code>Bar</code>ç»§æ‰¿<code>Foo</code>çš„æ—¶å€™ï¼Œ<code>Foo</code>è¿˜æ²¡æœ‰å®šä¹‰ã€‚</p>
<hr>
<h1>JS ä¸­çš„ this åˆ°åº•æŒ‡å‘å•¥ï¼Ÿ</h1><h2><strong>this åˆ°åº•æ˜¯å•¥</strong></h2>
<p>å…¶å® this å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡ç¤ºçš„å°±æ˜¯å½“å‰çš„ä¸€ä¸ªæ‰§è¡Œç¯å¢ƒï¼Œå¯ä»¥ç”¨æ¥å¯¹å½“å‰æ‰§è¡Œç¯å¢ƒè¿›è¡Œä¸€äº›æ“ä½œã€‚
å› ä¸ºå®ƒæŒ‡ç¤ºçš„æ˜¯æ‰§è¡Œç¯å¢ƒï¼Œæ‰€ä»¥åœ¨å®šä¹‰è¿™ä¸ªå˜é‡æ—¶ï¼Œå…¶å®æ˜¯ä¸çŸ¥é“å®ƒçœŸæ­£çš„å€¼çš„ï¼Œåªæœ‰è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šä»–çš„å€¼ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œåªæ˜¯ç»™ this æ·»åŠ äº†ä¸€ä¸ª name å±æ€§ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ–¹æ³•å¤åˆ¶åˆ° Chrome è°ƒè¯•å·¥å…·çœ‹ä¸‹ç»“æœï¼š</p>
<p><img src="https://dl-harmonyos.51cto.com/images/202101/b3ee817353af7143689614be5f879048a42df6.png" alt="">ä¸Šå›¾ä¸­æˆ‘ä»¬ç›´æ¥è°ƒç”¨äº† func()ï¼Œå‘ç° this æŒ‡å‘çš„æ˜¯ windowï¼Œname å±æ€§æ·»åŠ åˆ°äº† window ä¸Šã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¢ä¸€ç§è°ƒç”¨æ–¹å¼ï¼Œæˆ‘ä»¬æ¢æˆ new func() æ¥è°ƒç”¨ï¼š</p>
<p><img src="https://dl-harmonyos.51cto.com/images/202101/b1d7c6308dadd68d9529020c1fb620f78617f0.png" alt="">æˆ‘ä»¬çœ‹åˆ°è¾“å‡ºäº†ä¸¤ä¸ª func {name: &quot;å°å°é£&quot;}ï¼Œä¸€ä¸ªæ˜¯æˆ‘ä»¬ new è¿”å›çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªæ˜¯æ–¹æ³•é‡Œé¢çš„ consoleã€‚è¿™ä¸¤ä¸ªå€¼æ˜¯ä¸€æ ·çš„ï¼Œè¯´æ˜è¿™æ—¶å€™æ–¹æ³•é‡Œé¢ this å°±æŒ‡å‘äº† new è¿”å›çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯å‰é¢ä¾‹å­çš„ window äº†ã€‚
è¿™æ˜¯å› ä¸ºå½“ä½ ä½¿ç”¨ new å»è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±ä½œä¸ºæ„é€ å‡½æ•°ä½¿ç”¨äº†ï¼Œè¿™æ—¶å€™çš„ this æŒ‡å‘çš„æ˜¯ new å‡ºæ¥çš„å¯¹è±¡ã€‚</p>
<h2>åˆ†åˆ«è®²è§£ä¸‹å‡ ç§æƒ…å†µ</h2>
<h3><strong>ä½¿ç”¨ new è°ƒç”¨æ—¶ï¼Œthis æŒ‡å‘ new å‡ºæ¥çš„å¯¹è±¡</strong></h3>
<p>å½“ä½ ç”¨ new æ¥æ‰§è¡Œä¸€ä¸ªå‡½æ•°æ—¶ï¼Œè¿™ä¸ªå‡½æ•°å°±å˜æˆäº†ä¸€ä¸ªç±»ï¼Œnew å…³é”®å­—ä¼šè¿”å›ä¸€ä¸ªç±»çš„å®ä¾‹ç»™ä½ ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå……å½“æ„é€ å‡½æ•°çš„è§’è‰²ã€‚ä½œä¸ºé¢å‘å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œå¿…é¡»è¦æœ‰èƒ½å¤Ÿç»™å®ä¾‹åˆå§‹åŒ–å±æ€§çš„èƒ½åŠ›ï¼Œæ‰€ä»¥æ„é€ å‡½æ•°é‡Œé¢å¿…é¡»è¦æœ‰æŸç§æœºåˆ¶æ¥æ“ä½œç”Ÿæˆçš„å®ä¾‹ï¼Œè¿™ç§æœºåˆ¶å°±æ˜¯ thisã€‚è®© this æŒ‡å‘ç”Ÿæˆçš„å®ä¾‹å°±å¯ä»¥é€šè¿‡ this æ¥æ“ä½œå®ä¾‹äº†ã€‚</p>
<p>this çš„è¿™ç§ç‰¹æ€§è¿˜æœ‰ä¸€äº›å¦™ç”¨ã€‚</p>
<p>ä¸€ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨ new è°ƒç”¨ï¼Œé‚£å‡å¦‚æˆ‘åªæƒ³ä½¿ç”¨è€…é€šè¿‡ new è°ƒç”¨æœ‰æ²¡æœ‰åŠæ³•å‘¢ï¼Ÿä¸‹å›¾æˆªå–è‡ª Vue æºç ï¼š</p>
<p><img src="https://dl-harmonyos.51cto.com/images/202101/b7c881854b442e3736d479885887141be4533b.png" alt="">Vue å·§å¦™åˆ©ç”¨äº† this çš„ç‰¹æ€§ï¼Œé€šè¿‡æ£€æŸ¥ this æ˜¯ä¸æ˜¯ Vue çš„ä¸€ä¸ªå®ä¾‹æ¥æ£€æµ‹ä½¿ç”¨è€…æ˜¯é€šè¿‡ new è°ƒç”¨çš„è¿˜æ˜¯ç›´æ¥è°ƒç”¨çš„ã€‚</p>
<h3><strong>æ²¡æœ‰æ˜ç¡®è°ƒç”¨è€…æ—¶ï¼Œthis æŒ‡å‘ window</strong></h3>
<p>è¿™ä¸ªå…¶å®åœ¨æœ€å¼€å§‹çš„ä¾‹å­å°±è®²è¿‡äº†ï¼Œé‚£é‡Œæ²¡æœ‰æ˜ç¡®è°ƒç”¨è€…ï¼Œthis æŒ‡å‘çš„æ˜¯ windowã€‚
æˆ‘ä»¬è¿™é‡Œè®²å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œå‡½æ•°é‡Œé¢çš„å‡½æ•°ï¼Œthis æŒ‡å‘è°ï¼Ÿæˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹çœ‹çœ‹ï¼š</p>
<p><img src="https://dl-harmonyos.51cto.com/images/202101/787cd4c711315c740ff279c067f9a41ab4e344.png" alt="">ä½¿ç”¨ new æ‰§è¡Œï¼š</p>
<p><img src="https://dl-harmonyos.51cto.com/images/202101/226a98518ebe5af82809364610bc69e6037898.png" alt="">æˆ‘ä»¬å‘ç°æ— è®ºæ˜¯ç›´æ¥æ‰§è¡Œï¼Œè¿˜æ˜¯ä½¿ç”¨ new æ‰§è¡Œï¼Œthis çš„å€¼éƒ½æŒ‡å‘çš„ windowã€‚ç›´æ¥æ‰§è¡Œæ—¶å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºæ²¡æœ‰æ˜ç¡®è°ƒç”¨è€…ï¼Œé‚£ this è‡ªç„¶å°±æ˜¯ windowã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨ new æ—¶ï¼Œåªæœ‰è¢« new çš„ func æ‰æ˜¯æ„é€ å‡½æ•°ï¼Œä»–çš„ this æŒ‡å‘ new å‡ºæ¥çš„å¯¹è±¡ï¼Œä»–é‡Œé¢çš„å‡½æ•°çš„ this è¿˜æ˜¯æŒ‡å‘ windowã€‚</p>
<h3><strong>æœ‰æ˜ç¡®è°ƒç”¨è€…æ—¶ï¼Œthis æŒ‡å‘è°ƒç”¨è€…</strong></h3>
<p>ä¸Šè¿°ä¾‹å­å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºè°ƒç”¨è€…æ˜¯ objï¼Œæ‰€ä»¥ func é‡Œé¢çš„ this å°±æŒ‡å‘ objï¼Œthis.myName å°±æ˜¯ obj.myNameã€‚å…¶å®è¿™ä¸€æ¡å’Œä¸Šä¸€æ¡å¯ä»¥åˆåœ¨ä¸€èµ·ï¼Œæ²¡æœ‰æ˜ç¡®è°ƒç”¨è€…æ—¶å…¶å®éšå«çš„è°ƒç”¨è€…å°±æ˜¯ windowï¼Œæ‰€ä»¥ç»å¸¸æœ‰äººè¯´ this æ€»æ˜¯æŒ‡å‘è°ƒç”¨è€…ã€‚</p>
<h3><strong>ç®­å¤´å‡½æ•°å¹¶ä¸ä¼šç»‘å®š this</strong></h3>
<p>ç®­å¤´å‡½æ•°åœ¨ç”³æ˜æ—¶ this ç¡®å®šä¸ºå½“å‰ä½œç”¨åŸŸçš„ thisï¼Œåœ¨è¿™é‡Œå°±æ˜¯ func çš„ä½œç”¨åŸŸï¼Œè·Ÿ func çš„ this ä¸€æ ·æŒ‡å‘ new å‡ºæ¥çš„å®ä¾‹ã€‚å¦‚æœä¸ç”¨ newï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ï¼Œè¿™é‡Œçš„ this å°±æŒ‡å‘ windowã€‚</p>
<h3><strong>DOM äº‹ä»¶å›è°ƒé‡Œé¢ï¼Œthis æŒ‡å‘ç»‘å®šäº‹ä»¶çš„å¯¹è±¡</strong></h3>
<p>currentTarget æŒ‡çš„æ˜¯ç»‘å®šäº‹ä»¶çš„ DOM å¯¹è±¡ï¼Œtarget æŒ‡çš„æ˜¯è§¦å‘äº‹ä»¶çš„å¯¹è±¡ã€‚
DOM äº‹ä»¶å›è°ƒé‡Œé¢ this æ€»æ˜¯æŒ‡å‘ currentTargetï¼Œå¦‚æœè§¦å‘äº‹ä»¶çš„å¯¹è±¡åˆšå¥½æ˜¯ç»‘å®šäº‹ä»¶çš„å¯¹è±¡ï¼Œå³ target === currentTargetï¼Œthis ä¹Ÿä¼šé¡ºä¾¿æŒ‡å‘ targetã€‚
å¦‚æœå›è°ƒæ˜¯ç®­å¤´å‡½æ•°ï¼Œthis æ˜¯ç®­å¤´å‡½æ•°ç”³æ˜æ—¶ä½œç”¨åŸŸçš„ thisã€‚</p>
<h3><strong>ä¸¥æ ¼æ¨¡å¼ä¸‹ this æ˜¯ undefined</strong></h3>
<p>æ³¨æ„è¿™é‡Œè¯´çš„ä¸¥æ ¼æ¨¡å¼ä¸‹ this æ˜¯ undefined æ˜¯æŒ‡åœ¨å‡½æ•°ä½“å†…éƒ¨ï¼Œå¦‚æœæœ¬èº«å°±åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œthis è¿˜æ˜¯æŒ‡å‘ windowã€‚</p>
<hr>
<h1>JavaScript åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—çš„å‡ ç§æ–¹å¼</h1><h2>1. typeofã€instanceofã€Number.isInteger</h2>
<p>=====================================</p>
<p><code>typeof</code>åˆ¤æ–­å€¼æ˜¯ä¸æ˜¯åŸºæœ¬ç±»å‹<code>number</code>ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code>let num = 1;
typeof num === 'number'; // true

</code></pre>
<p><code>instanceof</code>åˆ¤æ–­å€¼æ˜¯ä¸æ˜¯<a href="https://so.csdn.net/so/search?q=%E5%8C%85%E8%A3%85%E7%B1%BB&amp;spm=1001.2101.3001.7020">åŒ…è£…ç±»</a><code>Number</code>ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code>let num = new Number(1);
num instanceof Number; // true

</code></pre>
<p><code>Number.isInteger</code>åˆ¤æ–­å€¼æ˜¯å¦æ˜¯æ•´æ•°ï¼š</p>
<pre><code>Number.isInteger(1);   // true
Number.isInteger('1'); // false
Number.isInteger(1.1); // false

</code></pre>
<p>è¿™å‡ ç§æ–¹å¼çš„ç¼ºç‚¹ï¼Œéƒ½æ˜¯åªèƒ½åŸºäºç±»å‹åˆ¤æ–­ï¼Œæ— æ³•åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦æ˜¯æ•°å€¼ã€‚</p>
<h2>. parseIntã€<a href="https://so.csdn.net/so/search?q=parseFloat&amp;spm=1001.2101.3001.7020">parseFloat</a></h2>
<p>è¿™ä¸ªæ–¹æ³•çš„ç‰¹ç‚¹ï¼Œä¸€å¥è¯ï¼Œè¿”å›å­—ç¬¦ä¸²å¼€å¤´æœ€é•¿çš„æœ‰æ•ˆæ•°å­—ã€‚
æˆ‘ä»¬å¯ä»¥ç”¨<code>!isNaN(parseFloat(value))</code>æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦æ˜¯æ•°å€¼ã€‚</p>
<pre><code>let str1 = '123';
let str2 = 'abc';
!isNaN(parseFloat(str1)); // trueï¼Œæ˜¯æ•°å­—
!isNaN(parseFloat(str2)); // falseï¼Œä¸æ˜¯æ•°å­—

</code></pre>
<p><code>parseInt</code>å’Œ<code>parseFloat</code>è§£æçš„æ—¶å€™é‡åˆ°éæ³•å­—ç¬¦ç»“æŸï¼Œè¿”å›è§£æåˆ°çš„æ•°å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´åªè¦å­—ç¬¦ä¸²å¤´éƒ¨æ˜¯åˆæ³•æ•°å€¼ï¼Œé‚£ä¹ˆå°±èƒ½è§£æå‡ºæ•°å€¼ï¼Œå“ªæ€•æ•´ä½“ä¸æ˜¯æ•°å€¼ã€‚æ¯”å¦‚<code>123abc</code>ï¼Œä¼šè¢«è§£æç¨‹<code>123</code>ã€‚</p>
<p>å› æ­¤ï¼Œä¸Šé¢çš„åˆ¤æ–­æ–¹å¼è¿˜ä¸å¤Ÿä¸¥è°¨ï¼Œä¸‹é¢çš„ç»ˆææ–¹æ¡ˆæ˜¯æ¯”è¾ƒä¸¥è°¨çš„æ–¹å¼ã€‚</p>
<h2>. <a href="https://so.csdn.net/so/search?q=isNaN&amp;spm=1001.2101.3001.7020">isNaN</a>ã€isFinite</h2>
<p>åœ¨ä»‹ç»è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œå…ˆè®²ä¸‹<code>NaN</code>ï¼Œå®ƒè¡¨ç¤º<code>Not-a-Number</code>ã€‚ä¸¤ä¸ª<code>NaN</code>æ— æ³•ç›´æ¥æ¯”è¾ƒç›¸ç­‰ï¼Œå› ä¸ºæˆ‘ä»¬åªçŸ¥é“å®ƒä¸æ˜¯æ•°å€¼ï¼Œæ˜¯å•¥ä¸ç¡®å®šï¼Œä¹Ÿå°±æ— æ³•æ¯”è¾ƒç›¸ç­‰ã€‚</p>
<pre><code>NaN === NaN;         // false
NaN == NaN;          // false
Object.is(NaN, NaN); // false

</code></pre>
<ul>
<li><code>isNaN(value)</code>ï¼Œå¦‚æœ<code>ToNumber(value)</code>çš„ç»“æœä¸º<code>NaN</code>è¿”å›<code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code>ã€‚</li>
<li><code>isFinite(value)</code>ï¼Œå¦‚æœ<code>ToNumber(value)</code>çš„ç»“æœä¸ºæ•°å€¼ï¼Œä¸”ä¸ç­‰äº<code>Infinity</code>æˆ–<code>-Infinity</code>è¿”å›<code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code>ã€‚</li>
</ul>
<p><code>isNaN</code>å’Œ<code>isFinite</code>éƒ½ä¼šå…ˆå°†ä¼ å…¥çš„å€¼è½¬æˆæ•°å€¼ï¼Œå†è¿›è¡Œåˆ¤æ–­ã€‚<code>ToNumber</code>çš„è§„åˆ™è·Ÿç›´æ¥ä½¿ç”¨<code>Number</code>å‡½æ•°ä¸€æ ·ã€‚ä¸€äº›éæ•°å€¼åœ¨ç±»å‹è½¬æ¢çš„æ—¶å€™éƒ½èƒ½è½¬æˆæ•°å€¼ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code>Number(true);         // 1
Number(false);        // 0
Number(null);         // 0
Number('');           // 0

</code></pre>
<p>å¯¹<code>null</code>ã€<code>true</code>ã€<code>false</code>ã€<code>''</code>ä½¿ç”¨<code>isNaN</code>ç»“æœéƒ½æ˜¯<code>false</code>ï¼Œä½†æ˜¯å®ƒä»¬æœ¬èº«ä¸æ˜¯æ•°å€¼ï¼Œå› æ­¤ä¸èƒ½å•ç‹¬ä½¿ç”¨<code>isNaN</code>ã€‚</p>
<h2>Number.isNaNã€Number.isFinite</h2>
<p>===============================</p>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•è·Ÿå¯¹åº”çš„å…¨å±€æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<ul>
<li><code>Number.isNaN(value)</code>ï¼Œå¦‚æœ<code>value</code>ä¸º<code>NaN</code>è¿”å›<code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code>ã€‚</li>
<li><code>Number.isFinite(value)</code>ï¼Œå¦‚æœ<code>value</code>ä¸ºæ•°å€¼ï¼Œä¸”ä¸ç­‰äº<code>Infinity</code>æˆ–<code>-Infinity</code>è¿”å›<code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code>ã€‚</li>
</ul>
<p>åŒºåˆ«æ˜¯å…¨å±€æ–¹æ³•ä¼šæœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè€Œè¿™ä¸¤ä¸ªæ–¹æ³•æ²¡æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼š</p>
<pre><code>Number.isNaN(null);      // true
Number.isNaN(true);      // true
Number.isNaN(false);     // true
Number.isNaN('');        // true

</code></pre>
<p>å¯ä»¥çœ‹ï¼Œç”±äºæ²¡æœ‰ç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥<code>Number.isNaN</code>åˆ¤æ–­<code>null</code>ã€<code>true</code>ã€<code>false</code>ã€<code>''</code>çš„ç»“æœéƒ½æ˜¯<code>true</code>ã€‚</p>
<p>ä½†æ˜¯ â€œå‰¯ä½œç”¨â€ æ˜¯æ•°å­—å­—ç¬¦ä¸²ä¹Ÿä¼šå¾—åˆ°<code>true</code>ï¼š</p>
<pre><code>Number.isNaN('123');    // true

</code></pre>
<p><code>Number.isNaN</code>ç­‰ä»·ä¸ï¼š</p>
<pre><code>Number.isNaN = Number.isNaN || function(value) {
    return typeof value === &quot;number&quot; &amp;&amp; isNaN(value);
}

</code></pre>
<p>è€Œ<code>Number.isFinite</code>ç­‰ä»·äºï¼š</p>
<pre><code>if (Number.isFinite === undefined) Number.isFinite = function(value) {
    return typeof value === 'number' &amp;&amp; isFinite(value);
}

</code></pre>
<p>å› æ­¤ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æœ¬è´¨ä¸Šä¹Ÿæ˜¯åŸºäºç±»å‹çš„ï¼Œæ²¡æ³•åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºæ•°å€¼ã€‚</p>
<h2>æ­£åˆ™è¡¨è¾¾å¼</h2>
<p>========</p>
<pre><code>let exp = /^[+-]?\d*(\.\d*)?(e[+-]?\d+)?$/;
exp.test('+1.9');   // true
exp.test('-.1e11'); // true

</code></pre>
<p>è¿™ä¸ªæ­£åˆ™å¯ä»¥åˆ¤æ–­æ•´æ•°ã€æµ®ç‚¹æ•°ã€æ­£è´Ÿæ•°å’Œç§‘å­¦è®¡æ•°æ³•ã€‚</p>
<p>ä¸è¿‡æˆ‘è§‰å¾—åˆ¤æ–­æ˜¯å¦æ˜¯æ•°å€¼ç”¨æ­£åˆ™ï¼Œæœ‰ç‚¹å°é¢˜å¤§åšäº†ã€‚</p>
<h2>. ç»ˆææ–¹æ¡ˆï¼ˆæ¨èï¼‰</h2>
<p>===========</p>
<p>æˆ‘ä»¬å…ˆçœ‹æ–¹æ¡ˆï¼š</p>
<pre><code>!isNaN(parseFloat(value)) &amp;&amp; isFinite(value);

</code></pre>
<p>è¿™å…¶å®æ˜¯ jquery ä¸­<code>$.isNumeric</code>çš„æºç ï¼Œå¤šä¹ˆç®€æ´ä¸”ä¼˜é›…ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å®ƒçš„åŸç†ï¼Œæˆ‘ä»¬ä»¥å­—ç¬¦ä¸²<code>123abc</code>ä¸ºä¾‹ï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°<code>false</code>ã€‚</p>
<ol>
<li><code>parseFloat('123abc')</code>å¾—åˆ°<code>123</code>ï¼›</li>
<li><code>!isNaN(123)</code>å¾—åˆ°<code>true</code>ï¼›</li>
<li><code>isFinite('123abc')</code>å¾—åˆ°<code>false</code>ï¼›</li>
<li>æœ€ç»ˆç»“æœä¸º<code>false</code>ã€‚</li>
</ol>
<p>å•ç‹¬ä½¿ç”¨<code>!isNaN(parseFloat(value))</code>ä¼šå°†<code>123abc</code>å½“æˆæ•°å€¼ï¼Œæ‰€ä»¥ç”¨<code>isFinite</code>é¢å¤–åˆ¤æ–­ä¸€æ¬¡ï¼Œ<code>isFinite</code>çš„å¦ä¸€ä¸ªä½œç”¨æ˜¯æ’é™¤æ— ç©·æ•°ã€‚</p>
<pre><code>!isNaN(parseFloat(Infinity));  // true
!isNaN(parseFloat(Infinity)) &amp;&amp; isFinite(Infinity); // false

</code></pre>
<p>è€Œä¸”ï¼Œå› ä¸º<code>parseFloat</code>çš„è§£ææ˜¯çº¯å­—ç¬¦ä¸²è§£æï¼Œæ²¡æœ‰ç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥ä¸ä¼šå°†<code>null</code>ã€<code>true</code>ã€<code>false</code>ã€<code>''</code>å½“æˆæ•°å€¼ã€‚</p>
<pre><code>!isNaN(parseFloat(null)) &amp;&amp; isFinite(null);   // false
!isNaN(parseFloat(true)) &amp;&amp; isFinite(true);   // false
!isNaN(parseFloat(false)) &amp;&amp; isFinite(false); // false
!isNaN(parseFloat('')) &amp;&amp; isFinite('');       // false

</code></pre>
<hr>
<h1>ä¸ºä»€ä¹ˆç”¨ GIF åšåŸ‹ç‚¹ï¼Ÿ</h1><blockquote>
<p>ä»€ä¹ˆæ˜¯å‰ç«¯ç›‘æ§ï¼Ÿ</p>
<p>å®ƒæŒ‡çš„æ˜¯é€šè¿‡ä¸€å®šçš„æ‰‹æ®µæ¥è·å–ç”¨æˆ·è¡Œä¸ºä»¥åŠè·Ÿè¸ªäº§å“åœ¨ç”¨æˆ·ç«¯çš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶ä»¥ç›‘æ§æ•°æ®ä¸ºåŸºç¡€ï¼Œä¸ºäº§å“ä¼˜åŒ–æŒ‡æ˜æ–¹å‘ï¼Œä¸ºç”¨æˆ·æä¾›æ›´åŠ ç²¾ç¡®ã€å®Œå–„çš„æœåŠ¡ã€‚</p>
</blockquote>
<p><strong>æ‰€ä»¥å‰ç«¯ç›‘æ§ä¸€èˆ¬ä¹Ÿåˆ†ä¸ºä¸‰å¤§ç±»ï¼š</strong></p>
<h3>æ•°æ®ç›‘æ§ï¼ˆç›‘æ§ç”¨æˆ·è¡Œä¸ºï¼‰</h3>
<ul>
<li>PV(page view)ï¼šå³é¡µé¢æµè§ˆé‡æˆ–ç‚¹å‡»é‡ï¼›</li>
<li>UVï¼šæŒ‡è®¿é—®æŸä¸ªç«™ç‚¹æˆ–ç‚¹å‡»æŸæ¡æ–°é—»çš„ä¸åŒ IP åœ°å€çš„äººæ•°</li>
<li>ç”¨æˆ·åœ¨æ¯ä¸€ä¸ªé¡µé¢çš„åœç•™æ—¶é—´</li>
<li>ç”¨æˆ·é€šè¿‡ä»€ä¹ˆå…¥å£æ¥è®¿é—®è¯¥ç½‘é¡µ</li>
<li>ç”¨æˆ·åœ¨ç›¸åº”çš„é¡µé¢ä¸­è§¦å‘çš„è¡Œä¸ºï¼Œç­‰...</li>
</ul>
<h3>æ€§èƒ½ç›‘æ§ï¼ˆç›‘æ§é¡µé¢æ€§èƒ½ï¼‰</h3>
<ul>
<li>ä¸åŒç”¨æˆ·ï¼Œä¸åŒæœºå‹å’Œä¸åŒç³»ç»Ÿä¸‹çš„é¦–å±åŠ è½½æ—¶é—´</li>
<li>ç™½å±æ—¶é—´</li>
<li>http ç­‰è¯·æ±‚çš„å“åº”æ—¶é—´</li>
<li>é™æ€èµ„æºæ•´ä½“ä¸‹è½½æ—¶é—´</li>
<li>é¡µé¢æ¸²æŸ“æ—¶é—´</li>
<li>é¡µé¢äº¤äº’åŠ¨ç”»å®Œæˆæ—¶é—´ï¼Œç­‰...</li>
</ul>
<h3>å¼‚å¸¸ç›‘æ§ï¼ˆç›‘æ§äº§å“ã€ç³»ç»Ÿå¼‚å¸¸ï¼‰</h3>
<p>åŠæ—¶çš„ä¸ŠæŠ¥å¼‚å¸¸æƒ…å†µï¼Œå¯ä»¥é¿å…çº¿ä¸Šæ•…éšœçš„å‘ä¸Šã€‚
è™½ç„¶å¤§éƒ¨åˆ†å¼‚å¸¸å¯ä»¥é€šè¿‡ <code>try catch</code> çš„æ–¹å¼æ•è·ï¼Œä½†æ˜¯æ¯”å¦‚å†…å­˜æ³„æ¼ä»¥åŠå…¶ä»–å¶ç°çš„å¼‚å¸¸éš¾ä»¥æ•è·ã€‚å¸¸è§çš„éœ€è¦ç›‘æ§çš„å¼‚å¸¸åŒ…æ‹¬ï¼š</p>
<ul>
<li>Javascript çš„å¼‚å¸¸ç›‘æ§</li>
<li>æ ·å¼ä¸¢å¤±çš„å¼‚å¸¸ç›‘æ§</li>
</ul>
<h2>åŸ‹ç‚¹ä¸ŠæŠ¥</h2>
<p>å®ç°å‰ç«¯ç›‘æ§ï¼Œ</p>
<ul>
<li>ç¬¬å°†è¦ç›‘æ§çš„äº‹é¡¹ï¼ˆæ•°æ®ï¼‰ç»™æ”¶é›†èµ·æ¥ï¼Œ</li>
<li>æäº¤ç»™åå°è¿›è¡Œå…¥åº“ï¼Œ</li>
<li>æ•°æ®åˆ†æï¼Œ</li>
<li>åŒæ­¥ç»™è¿è¥æˆ–è€…æ˜¯äº§å“ã€‚</li>
</ul>
<p>ç°åœ¨å¸¸è§çš„åŸ‹ç‚¹ä¸ŠæŠ¥æ–¹æ³•æœ‰ä¸‰ç§ï¼šæ‰‹åŠ¨åŸ‹ç‚¹ã€å¯è§†åŒ–åŸ‹ç‚¹ã€æ— åŸ‹ç‚¹</p>
<h3>æ‰‹åŠ¨åŸ‹ç‚¹</h3>
<p>æ‰‹åŠ¨åŸ‹ç‚¹ï¼Œä¹Ÿå«ä»£ç åŸ‹ç‚¹ï¼Œå³çº¯æ‰‹åŠ¨å†™ä»£ç ï¼Œè°ƒç”¨åŸ‹ç‚¹ SDK çš„å‡½æ•°ï¼Œåœ¨éœ€è¦åŸ‹ç‚¹çš„ä¸šåŠ¡é€»è¾‘åŠŸèƒ½ä½ç½®è°ƒç”¨æ¥å£ï¼Œä¸ŠæŠ¥åŸ‹ç‚¹æ•°æ®ï¼Œ
åƒ <strong>[å‹ç›Ÿ]</strong>ã€<strong>[ç™¾åº¦ç»Ÿè®¡]</strong> ç­‰ç¬¬ä¸‰æ–¹æ•°æ®ç»Ÿè®¡æœåŠ¡å•†å¤§éƒ½é‡‡ç”¨è¿™ç§æ–¹æ¡ˆã€‚</p>
<p>æ‰‹åŠ¨åŸ‹ç‚¹è®©ä½¿ç”¨è€…å¯ä»¥æ–¹ä¾¿åœ°è®¾ç½®è‡ªå®šä¹‰å±æ€§ã€è‡ªå®šä¹‰äº‹ä»¶ï¼›
æ‰€ä»¥å½“ä½ éœ€è¦æ·±å…¥ä¸‹é’»ï¼Œå¹¶ç²¾ç»†åŒ–è‡ªå®šä¹‰åˆ†ææ—¶ï¼Œæ¯”è¾ƒé€‚åˆä½¿ç”¨æ‰‹åŠ¨åŸ‹ç‚¹ã€‚</p>
<p>æ‰‹åŠ¨åŸ‹ç‚¹çš„ç¼ºé™·å°±æ˜¯ï¼Œé¡¹ç›®å·¥ç¨‹é‡å¤§ï¼Œéœ€è¦åŸ‹ç‚¹çš„ä½ç½®å¤ªå¤šï¼Œ</p>
<h3>å¯è§†åŒ–åŸ‹ç‚¹</h3>
<p>é€šè¿‡å¯è§†åŒ–äº¤äº’çš„æ‰‹æ®µï¼Œä»£æ›¿ä¸Šè¿°çš„ä»£ç åŸ‹ç‚¹ã€‚</p>
<p>å°†ä¸šåŠ¡ä»£ç å’ŒåŸ‹ç‚¹ä»£ç åˆ†ç¦»ï¼Œæä¾›ä¸€ä¸ªå¯è§†åŒ–äº¤äº’çš„é¡µé¢ï¼Œè¾“å…¥ä¸ºä¸šåŠ¡ä»£ç ï¼Œé€šè¿‡è¿™ä¸ªå¯è§†åŒ–ç³»ç»Ÿï¼Œ
å¯ä»¥åœ¨ä¸šåŠ¡ä»£ç ä¸­è‡ªå®šä¹‰çš„å¢åŠ åŸ‹ç‚¹äº‹ä»¶ç­‰ç­‰ï¼Œ
æœ€åè¾“å‡ºçš„ä»£ç è€¦åˆäº†ä¸šåŠ¡ä»£ç å’ŒåŸ‹ç‚¹ä»£ç ã€‚</p>
<p>å¯è§†åŒ–åŸ‹ç‚¹çš„ç¼ºé™·å°±æ˜¯å¯ä»¥åŸ‹ç‚¹çš„æ§ä»¶æœ‰é™ï¼Œä¸èƒ½æ‰‹åŠ¨å®šåˆ¶ã€‚</p>
<h3>æ— åŸ‹ç‚¹</h3>
<p>æ— åŸ‹ç‚¹åˆ™æ˜¯å‰ç«¯è‡ªåŠ¨é‡‡é›†å…¨éƒ¨äº‹ä»¶ï¼Œä¸ŠæŠ¥åŸ‹ç‚¹æ•°æ®ï¼Œç”±åç«¯æ¥è¿‡æ»¤å’Œè®¡ç®—å‡ºæœ‰ç”¨çš„æ•°æ®ã€‚
ä¼˜ç‚¹æ˜¯å‰ç«¯åªè¦ä¸€æ¬¡åŠ è½½åŸ‹ç‚¹è„šæœ¬ï¼Œç¼ºç‚¹æ˜¯æµé‡å’Œé‡‡é›†çš„æ•°æ®è¿‡äºåºå¤§ï¼ŒæœåŠ¡å™¨æ€§èƒ½å‹åŠ›å±±å¤§ã€‚</p>
<h2>ä¸ºä»€ä¹ˆç”¨ GIF æ¥åšåŸ‹ç‚¹ï¼Ÿ</h2>
<p>å‘æœåŠ¡å™¨ç«¯ä¸ŠæŠ¥æ•°æ®ï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚æ¥å£ï¼Œè¯·æ±‚æ™®é€šæ–‡ä»¶ï¼Œæˆ–è€…è¯·æ±‚å›¾ç‰‡èµ„æºçš„æ–¹å¼è¿›è¡Œã€‚
åªè¦èƒ½ä¸ŠæŠ¥æ•°æ®ï¼Œæ— è®ºæ˜¯è¯·æ±‚ GIF æ–‡ä»¶è¿˜æ˜¯è¯·æ±‚ js æ–‡ä»¶æˆ–è€…æ˜¯è°ƒç”¨é¡µé¢æ¥å£ï¼ŒæœåŠ¡å™¨ç«¯å…¶å®å¹¶ä¸å…³å¿ƒå…·ä½“çš„ä¸ŠæŠ¥æ–¹å¼ã€‚
é‚£ä¸ºä»€ä¹ˆæ‰€æœ‰ç³»ç»Ÿéƒ½ç»Ÿä¸€ä½¿ç”¨äº†è¯·æ±‚ GIF å›¾ç‰‡çš„æ–¹å¼ä¸ŠæŠ¥æ•°æ®å‘¢ï¼Ÿ</p>
<ul>
<li>é˜²æ­¢è·¨åŸŸ</li>
</ul>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œæ‰“ç‚¹åŸŸåéƒ½ä¸æ˜¯å½“å‰åŸŸåï¼Œæ‰€ä»¥æ‰€æœ‰çš„æ¥å£è¯·æ±‚éƒ½ä¼šæ„æˆè·¨åŸŸã€‚è€Œè·¨åŸŸè¯·æ±‚å¾ˆå®¹æ˜“å‡ºç°ç”±äºé…ç½®ä¸å½“è¢«æµè§ˆå™¨æ‹¦æˆªå¹¶æŠ¥é”™ï¼Œè¿™æ˜¯ä¸èƒ½æ¥å—çš„ã€‚ä½†å›¾ç‰‡çš„ src å±æ€§å¹¶ä¸ä¼šè·¨åŸŸï¼Œå¹¶ä¸”åŒæ ·å¯ä»¥å‘èµ·è¯·æ±‚ã€‚ï¼ˆæ’é™¤æ¥å£ä¸ŠæŠ¥ï¼‰</p>
<ul>
<li>é˜²æ­¢é˜»å¡é¡µé¢åŠ è½½ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ</li>
</ul>
<p>é€šå¸¸ï¼Œåˆ›å»ºèµ„æºèŠ‚ç‚¹ååªæœ‰å°†å¯¹è±¡æ³¨å…¥åˆ°æµè§ˆå™¨ DOM æ ‘åï¼Œæµè§ˆå™¨æ‰ä¼šå®é™…å‘é€èµ„æºè¯·æ±‚ã€‚
åå¤æ“ä½œ DOM ä¸ä»…ä¼šå¼•å‘æ€§èƒ½é—®é¢˜ï¼Œè€Œä¸”è½½å…¥ js/css èµ„æºè¿˜ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚</p>
<p>ä½†æ˜¯å›¾ç‰‡è¯·æ±‚ä¾‹å¤–ã€‚
æ„é€ å›¾ç‰‡æ‰“ç‚¹ä¸ä»…ä¸ç”¨æ’å…¥ DOMï¼Œåªè¦åœ¨ js ä¸­ new å‡º Image å¯¹è±¡å°±èƒ½å‘èµ·è¯·æ±‚ï¼Œè€Œä¸”è¿˜æ²¡æœ‰é˜»å¡é—®é¢˜ï¼Œåœ¨æ²¡æœ‰ js çš„æµè§ˆå™¨ç¯å¢ƒä¸­ä¹Ÿèƒ½é€šè¿‡ img æ ‡ç­¾æ­£å¸¸æ‰“ç‚¹ï¼Œ
è¿™æ˜¯å…¶ä»–ç±»å‹çš„èµ„æºè¯·æ±‚æ‰€åšä¸åˆ°çš„ã€‚ï¼ˆæ’é™¤æ–‡ä»¶æ–¹å¼ï¼‰</p>
<ul>
<li>ç›¸æ¯” PNG/JPGï¼ŒGIF çš„ä½“ç§¯æœ€å°</li>
</ul>
<p>æœ€å°çš„ BMP æ–‡ä»¶éœ€è¦ 74 ä¸ªå­—èŠ‚ï¼ŒPNG éœ€è¦ 67 ä¸ªå­—èŠ‚ï¼Œè€Œåˆæ³•çš„ GIFï¼Œåªéœ€è¦ 43 ä¸ªå­—èŠ‚ã€‚
åŒæ ·çš„å“åº”ï¼ŒGIF å¯ä»¥æ¯” BMP èŠ‚çº¦ 41% çš„æµé‡ï¼Œæ¯” PNG èŠ‚çº¦ 35% çš„æµé‡ã€‚</p>
<p><strong>å¹¶ä¸”å¤§å¤šé‡‡ç”¨çš„æ˜¯ 1*1 åƒç´ çš„é€æ˜ GIF æ¥ä¸ŠæŠ¥</strong>
1x1 åƒç´ æ˜¯æœ€å°çš„åˆæ³•å›¾ç‰‡ã€‚
è€Œä¸”ï¼Œå› ä¸ºæ˜¯é€šè¿‡å›¾ç‰‡æ‰“ç‚¹ï¼Œæ‰€ä»¥å›¾ç‰‡æœ€å¥½æ˜¯é€æ˜çš„ï¼Œè¿™æ ·ä¸€æ¥ä¸ä¼šå½±å“é¡µé¢æœ¬èº«å±•ç¤ºæ•ˆæœï¼ŒäºŒè€…ä¸ç”¨å­˜å‚¨è‰²å½©ç©ºé—´æ•°æ®ï¼Œå¯ä»¥èŠ‚çº¦ä½“ç§¯ã€‚</p>
<hr>
<h1>å‰ç«¯åŸ‹ç‚¹å®ç°æ–¹æ¡ˆâœ”</h1><h2>å‰ç«¯åŸ‹ç‚¹åç§°è§£é‡Š</h2>
<p>UVï¼ˆUnique visitorï¼‰</p>
<p>æ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚è®¿é—®æ‚¨ç½‘ç«™çš„ä¸€å°ç”µè„‘å®¢æˆ·ç«¯ä¸ºä¸€ä¸ªè®¿å®¢ã€‚ä¸€å¤©å†…åŒä¸ªè®¿å®¢å¤šæ¬¡è®¿é—®ä»…è®¡ç®—ä¸€ä¸ª<code>UV</code>ã€‚</p>
<p>IPï¼ˆInternet Protocolï¼‰</p>
<p>ç‹¬ç«‹<code>IP</code>æ˜¯æŒ‡è®¿é—®è¿‡æŸç«™ç‚¹çš„<code>IP</code>æ€»æ•°ï¼Œä»¥ç”¨æˆ·çš„ IP åœ°å€ä½œä¸ºç»Ÿè®¡ä¾æ®ã€‚<code>00:00-24:00</code>å†…ç›¸åŒ<code>IP</code>åœ°å€ä¹‹è¢«è®¡ç®—ä¸€æ¬¡ã€‚</p>
<p>UV ä¸ IP åŒºåˆ«</p>
<blockquote>
<p>å¦‚ï¼šä½ å’Œä½ çš„å®¶äººç”¨å„è‡ªçš„è´¦å·åœ¨åŒä¸€å°ç”µè„‘ä¸Šç™»å½•æ–°æµªå¾®åšï¼Œåˆ™<code>IP</code>æ•° + 1ï¼Œ<code>UV</code>æ•° + 2ã€‚ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€å°ç”µè„‘ï¼Œæ‰€ä»¥<code>IP</code>ä¸å˜ï¼Œä½†ä½¿ç”¨çš„ä¸åŒè´¦å·ï¼Œæ‰€ä»¥<code>UV</code>+2</p>
</blockquote>
<p>PVï¼ˆPage Viewï¼‰</p>
<p>å³é¡µé¢æµè§ˆé‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯ 1 æ¬¡å¯¹ç½‘ç«™ä¸­çš„æ¯ä¸ªç½‘é¡µè®¿é—®å‡è¢«è®°å½• 1 ä¸ª<code>PV</code>ã€‚ç”¨æˆ·å¯¹åŒä¸€é¡µé¢çš„å¤šæ¬¡è®¿é—®ï¼Œè®¿é—®é‡ç´¯è®¡ï¼Œç”¨ä»¥è¡¡é‡ç½‘ç«™ç”¨æˆ·è®¿é—®çš„ç½‘é¡µæ•°é‡ã€‚</p>
<p>VVï¼ˆVisit Viewï¼‰</p>
<p>ç”¨ä»¥ç»Ÿè®¡æ‰€æœ‰è®¿å®¢ 1 å¤©å†…è®¿é—®ç½‘ç«™çš„æ¬¡æ•°ã€‚å½“è®¿å®¢å®Œæˆæ‰€æœ‰æµè§ˆå¹¶æœ€ç»ˆå…³æ‰è¯¥ç½‘ç«™çš„æ‰€æœ‰é¡µé¢æ—¶ä¾¿å®Œæˆäº†ä¸€æ¬¡è®¿é—®ï¼ŒåŒä¸€è®¿å®¢ 1 å¤©å†…å¯èƒ½æœ‰å¤šæ¬¡è®¿é—®è¡Œä¸ºï¼Œè®¿é—®æ¬¡æ•°ç´¯è®¡ã€‚</p>
<p>PV ä¸ VV åŒºåˆ«</p>
<blockquote>
<p>å¦‚ï¼šä½ ä»Šå¤© 10 ç‚¹é’Ÿæ‰“å¼€äº†ç™¾åº¦ï¼Œè®¿é—®äº†å®ƒçš„ä¸‰ä¸ªé¡µé¢ï¼›11 ç‚¹é’Ÿåˆæ‰“å¼€äº†ç™¾åº¦ï¼Œè®¿é—®äº†å®ƒçš„ä¸¤ä¸ªé¡µé¢ï¼Œåˆ™ PV æ•° + 5ï¼ŒVV æ•° + 2.PV æ˜¯æŒ‡é¡µé¢çš„æµè§ˆæ¬¡æ•°ï¼ŒVV æ˜¯æŒ‡ä½ è®¿é—®ç½‘ç«™çš„æ¬¡æ•°ã€‚</p>
</blockquote>
<h2>åŸ‹ç‚¹åˆ†ç±»</h2>
<h3>ä»£ç åŸ‹ç‚¹</h3>
<ul>
<li>ä¼˜ç‚¹ï¼š</li>
</ul>
<blockquote>
<ul>
<li>æ§åˆ¶ç²¾å‡†ï¼Œå¯ä»¥éå¸¸ç²¾ç¡®åœ°é€‰æ‹©ä»€ä¹ˆæ—¶å€™å‘é€æ•°æ®ã€‚</li>
<li>ä¼ é€’å¤šæ ·åŒ–è‡ªå®šä¹‰å±æ€§ã€è‡ªå®šä¹‰äº‹ä»¶ï¼Œä¼ é€’æ¯”è¾ƒä¸°å¯Œçš„æ•°æ®åˆ°æœåŠ¡ç«¯ã€‚</li>
</ul>
</blockquote>
<ul>
<li>ç¼ºç‚¹ï¼š</li>
</ul>
<blockquote>
<ul>
<li>åŸ‹ç‚¹ä»£ä»·æ¯”è¾ƒå¤§ï¼Œæ¯ä¸€ä¸ªæ§ä»¶çš„åŸ‹ç‚¹éƒ½éœ€è¦æ·»åŠ ç›¸åº”çš„ä»£ç ï¼Œä¸ä»…å·¥ä½œé‡å¤§ï¼Œå¿…é¡»æ˜¯æŠ€æœ¯äººå‘˜æ‰èƒ½å®Œæˆã€‚</li>
<li>æ›´æ–°çš„ä»£ä»·æ¯”è¾ƒå¤§ï¼Œæ¯ä¸€æ¬¡æ›´æ–°åŸ‹ç‚¹æ–¹æ¡ˆï¼Œéƒ½å¿…é¡»æ”¹ä»£ç ã€‚</li>
</ul>
</blockquote>
<h3>å¯è§†åŒ–åŸ‹ç‚¹</h3>
<p>ä¸ªäººç†è§£çš„å¯è§†åŒ–åŸ‹ç‚¹åº”è¯¥æ˜¯è‚¯å®šéœ€è¦ç¬¬ä¸‰æ–¹çš„æœåŠ¡å•†æ”¯æŒğŸœï¼Œä¸ä¼šæœ‰åšä¸“é—¨ä¸šåŠ¡çš„å…¬å¸å»åšå¯è§†åŒ–åŸ‹ç‚¹çš„è§£å†³æ–¹æ¡ˆã€‚å¯è§†åŒ–åŸ‹ç‚¹å¼€å‘äººå‘˜é™¤é›†æˆé‡‡é›†å¯è§†åŒ–<code>SDK</code> å¤–ğŸ‘œï¼Œä¸éœ€è¦é¢å¤–å»å†™åŸ‹ç‚¹ä»£ç ğŸ ï¼Œè€Œæ˜¯ç”±ä¸šåŠ¡äººå‘˜æˆ–è¿è¥äººå‘˜é€šè¿‡è®¿é—®åˆ†æå¹³å°çš„åœˆé€‰åŠŸèƒ½ğŸ¤”ï¼Œæ¥ â€œåœˆâ€ å‡ºéœ€è¦å¯¹ç”¨æˆ·è¡Œä¸ºè¿›è¡Œæ•æ‰çš„æ§ä»¶ğŸªï¼Œå¹¶ç»™å‡ºäº‹ä»¶å‘½åğŸš˜ã€‚åœˆé€‰å®Œæ¯•åï¼Œè¿™äº›é…ç½®ä¼šåŒæ­¥åˆ°å„ä¸ªç”¨æˆ·çš„ç»ˆç«¯ä¸ŠğŸ˜®ï¼Œç”±é‡‡é›†<code>SDK</code>æŒ‰ç…§åœˆé€‰çš„é…ç½®è‡ªåŠ¨è¿›è¡Œç”¨æˆ·è¡Œä¸ºæ•°æ®çš„é‡‡é›†å’Œå‘é€ğŸš‡ã€‚</p>
<p>ä¼˜ç‚¹ï¼š</p>
<blockquote>
<ul>
<li>åŸ‹ç‚¹ä»£ä»·å°ï¼Œæ›´æ–°ä»£ä»·å°</li>
<li>åŸ‹ç‚¹åªéœ€ä¸šåŠ¡åŒå­¦æ¥å…¥ï¼Œå¼€å‘åªéœ€å¯¹æ¥å¯è§†åŒ–<code>SDK</code></li>
</ul>
</blockquote>
<p>ç¼ºç‚¹ï¼š</p>
<blockquote>
<ul>
<li>æ— æ³•åšåˆ°è‡ªå®šä¹‰è·å–æ•°æ®</li>
<li>å¯è§†åŒ–åŸ‹ç‚¹è¦†ç›–çš„åŠŸèƒ½æœ‰é™</li>
<li>ä»…æ”¯æŒå®¢æˆ·ç«¯è¡Œä¸º</li>
</ul>
</blockquote>
<h3>æ— ç—•åŸ‹ç‚¹</h3>
<p>æ— ç—•åŸ‹ç‚¹åˆå«å…¨åŸ‹ç‚¹ğŸ¥ªï¼Œç½‘ä¸Šåˆå¾ˆå¤šæ–‡ç« å†™çš„éƒ½æ˜¯æ— ç—•åŸ‹ç‚¹æ˜¯å°†æ‰€æœ‰äº‹ä»¶çš„æ“ä½œå…¨éƒ¨ä¸ŠæŠ¥ğŸ˜€ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®ç°çš„è¿‡ç¨‹ä¸­è‚¯å®šæ˜¯ä¸ä¼šç›‘å¬é‚£ä¹ˆå¤šçš„äº‹ä»¶å§ğŸ˜‹ï¼Œä½†æ˜¯å¥½åƒä¹Ÿæœ‰ç¬¬ä¸‰æ–¹æœåŠ¡å•† sdk é›†æˆäº†æ‰€æœ‰äº‹ä»¶ğŸ˜ã€‚</p>
<blockquote>
<p><strong>æˆ‘çš„ä¸ªäººç†è§£</strong>æ— ç—•åŸ‹ç‚¹æ˜¯é’ˆå¯¹æŸä¸€ä¸ªå•ä¸€äº‹ä»¶ï¼Œåœ¨å…¨å±€å®ç°ç›‘å¬è¾¾åˆ°ä¸ŠæŠ¥ï¼Œè€Œä¸æ˜¯å…¨éƒ¨äº‹ä»¶ä¸ŠæŠ¥æ‰å«æ— ç—•åŸ‹ç‚¹ğŸ¥™ã€‚åªè¦æœ‰æŸä¸ªäº‹ä»¶åœ¨å…¨å±€å®ç°ç›‘å¬ï¼Œé’ˆå¯¹è¿™ä¸ªäº‹ä»¶çš„åŸ‹ç‚¹æ–¹å¼å°±ç§°ä¸ºæ— ç—•åŸ‹ç‚¹ğŸŒ¯</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<blockquote>
<ul>
<li>ç”±äºé‡‡é›†çš„æ˜¯å…¨é‡æ•°æ®ï¼Œæ‰€ä»¥äº§å“è¿­ä»£è¿‡ç¨‹ä¸­æ˜¯ä¸éœ€è¦å…³æ³¨åŸ‹ç‚¹é€»è¾‘çš„ï¼Œä¹Ÿä¸ä¼šå‡ºç°æ¼åŸ‹ã€è¯¯åŸ‹ç­‰ç°è±¡ã€‚</li>
<li>æ— åŸ‹ç‚¹æ–¹å¼å› ä¸ºæ”¶é›†çš„æ˜¯å…¨é‡æ•°æ®ï¼Œå¯ä»¥å¤§å¤§å‡å°‘è¿è¥å’Œäº§å“çš„è¯•é”™æˆæœ¬</li>
<li>å¦‚æœé›†æˆ sdk ä¹‹åæ— éœ€åŸ‹ç‚¹ï¼Œæ–¹ä¾¿å¿«æ·</li>
</ul>
</blockquote>
<p>ç¼ºç‚¹ï¼š</p>
<blockquote>
<ul>
<li>ç¼ºç‚¹ä¸å¯è§†åŒ–åŸ‹ç‚¹ç›¸åŒï¼Œæœªè§£å†³ä¸ªæ€§åŒ–è‡ªå®šä¹‰è·å–æ•°æ®çš„é—®é¢˜ï¼Œç¼ºä¹æ•°æ®è·å–çš„çµæ´»æ€§ï¼›</li>
<li>æ•°æ®é‡è¿‡å¤§ï¼Œå¦‚æœä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡å•†ï¼Œé’ˆå¯¹è‡ªèº«çš„æœåŠ¡å™¨æ˜¯ä¸ªè€ƒéªŒ</li>
</ul>
</blockquote>
<h2>å®ç°æ–¹æ¡ˆæ­¥éª¤ï¼ˆuni-appï¼Œå…¶ä»–é¡¹ç›®é€»è¾‘ç›¸åŒï¼‰</h2>
<h4>ä¸¤æ–¹é¢ä¸ŠæŠ¥: 1. äº‹ä»¶ä¸ŠæŠ¥ (ç›®å‰åªæœ‰ç‚¹å‡»äº‹ä»¶åŸ‹ç‚¹)ï¼Œ2. åœç•™æ—¶é—´ä¸ŠæŠ¥</h4>
<ul>
<li><strong>äº‹ä»¶ä¸ŠæŠ¥</strong>ï¼šé€šè¿‡ç»™å…ƒç´ ç»‘å®šè‡ªå®šä¹‰æŒ‡ä»¤çš„æ–¹å¼å®ç° (å‡å°‘å¯¹åŸæœ‰ä»£ç çš„ä¾µå…¥)ğŸœï¼Œå°†ä¿¡æ¯å­˜å‚¨åœ¨ç¼“å­˜æ± ä¸­å®šæ—¶ä¸ŠæŠ¥ï¼Œä¸ŠæŠ¥ä¹‹åæ¸…ç©ºä¹‹å‰çš„ä¸ŠæŠ¥ä¿¡æ¯ğŸ¥ ã€‚</li>
<li><strong>åœç•™æ—¶é—´ä¸ŠæŠ¥</strong>ï¼šéœ€è¦é‡æ–°å°è£…è·¯ç”±ï¼Œåˆ›å»ºè·¯ç”±æ‹¦æˆªåœ¨è·³è½¬ä¹‹å‰è®°å½•æ¥æº, ä»¥åŠä¸Šä¸€ä¸ªé¡µé¢çš„åœç•™æ—¶é—´ï¼Œå½“æ‹¦æˆªå™¨æ•è·æˆåŠŸä¹‹åğŸŒ¯ï¼Œå¦‚æœå‘ç°åœç•™æ—¶é—´å¤§äº xx ç§’è¿›è¡Œä¸ŠæŠ¥ğŸ¥™ã€‚</li>
</ul>
<p><em>ä¼˜ç‚¹</em>ï¼šæ¸…æ™°åˆç†ï¼Œæ¯”è¾ƒé€‚åˆæ–°é¡¹ç›®ã€‚</p>
<p><em>ç¼ºç‚¹</em>ï¼šé’ˆå¯¹è€é¡¹ç›®éœ€è¦ä¸äº§å“å’Œè¿è¥å¯¹æ¥åŸ‹ç‚¹æ–¹æ¡ˆç»‘å®šè‡ªå®šä¹‰äº‹ä»¶ğŸ¤ªï¼Œå¦‚æœæ˜¯è€é¡¹ç›®éœ€è¦å¯¹<code>uni.navigateTo</code>,<code>uni.redirectTo</code>,<code>uni.reLaunch</code>,<code>uni.switchTab</code> è¿›è¡ŒäºŒæ¬¡å°è£…ã€‚</p>
<blockquote>
<p>é—®ï¼šä¸ºä»€ä¹ˆä½•å°†ä¿¡æ¯å­˜å‚¨ï¼Œè€Œä¸æ˜¯å®æ—¶ä¸ŠæŠ¥ï¼Ÿ<br>
ç­”ï¼šè€ƒè™‘åˆ°æœåŠ¡å™¨çš„å‹åŠ›ï¼Œé‡‡ç”¨äº†å®šæ—¶ä¸ŠæŠ¥çš„æ–¹å¼ã€‚<br>
é—®ï¼šä¸ºä»€ä¹ˆç›‘å¬åœç•™æ—¶é•¿å¤§äº XX ç§’æ‰è¿›è¡Œä¸ŠæŠ¥ï¼Ÿ<br>
ç­”ï¼š1. æœåŠ¡å™¨çš„å‹åŠ›é—®é¢˜ã€‚2 è€ƒè™‘åˆ°ç”¨æˆ·å¯èƒ½åšä¸€äº›æ²¡æ„ä¹‰çš„æ“ä½œï¼Œæ‰€ä»¥åœç•™æ—¶é•¿å¤§äº XX ç§’æ‰å±äºæœ‰æ•ˆé¡µé¢ã€‚</p>
</blockquote>
<hr>
<h1>å‰ç«¯ç›‘æ§å’Œå‰ç«¯åŸ‹ç‚¹æ–¹æ¡ˆè®¾è®¡</h1><h3>ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å‰ç«¯ç›‘æ§</h3>
<p>å‰ç«¯ç›‘æ§çš„ç›®çš„æ˜¯ï¼š</p>
<p><em><strong>è·å–ç”¨æˆ·è¡Œä¸ºä»¥åŠè·Ÿè¸ªäº§å“åœ¨ç”¨æˆ·ç«¯çš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶ä»¥ç›‘æ§æ•°æ®ä¸ºåŸºç¡€ï¼ŒæŒ‡æ˜äº§å“ä¼˜åŒ–çš„æ–¹å‘</strong></em>ã€‚</p>
<p>å‰ç«¯ç›‘æ§å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼šæ•°æ®ç›‘æ§ã€æ€§èƒ½ç›‘æ§å’Œå¼‚å¸¸ç›‘æ§ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€çš„äº†è§£ã€‚</p>
<h3>ä¸‰ã€å‰ç«¯åŸ‹ç‚¹æ–¹æ¡ˆé€‰å‹å’Œå‰ç«¯ä¸ŠæŠ¥æ–¹æ¡ˆè®¾è®¡</h3>
<h4>(1) ç›‘æ§æ•°æ®</h4>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ä¸ªäº§å“æˆ–è€…ç½‘é¡µï¼Œæ™®ééœ€è¦ç›‘æ§å’Œä¸ŠæŠ¥çš„æ•°æ®ã€‚ç›‘æ§çš„åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šç”¨æˆ·è¿›å…¥ç½‘é¡µé¦–é¡µã€ç”¨æˆ·åœ¨ç½‘é¡µå†…éƒ¨äº¤äº’å’Œäº¤äº’ä¸­æŠ¥é”™ã€‚æ¯ä¸€ä¸ªé˜¶æ®µéœ€è¦ç›‘æ§å’Œä¸ŠæŠ¥çš„æ•°æ®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="../_resources/å‰ç«¯ç›‘æ§å’Œå‰ç«¯åŸ‹ç‚¹æ–¹æ¡ˆè®¾è®¡/198e424559d99162965d913cd76e56ab_MD5.png" /></p>
<h4>(2) åŸ‹ç‚¹æ–¹æ¡ˆ</h4>
<p>åœ¨å®é™…é¡¹ç›®ä¸­è€ƒè™‘åˆ°ä¸ŠæŠ¥æ•°æ®çš„çµæ´»å®šåˆ¶ï¼Œä»¥åŠå‡å°‘æ•°æ®ä¼ è¾“å’ŒæœåŠ¡å™¨çš„å‹åŠ›ï¼Œåœ¨æ‰€éœ€åŸ‹ç‚¹å¤„ä¸å¤šçš„æƒ…å†µä¸‹ï¼Œå¸¸ç”¨çš„æ–¹å¼æ˜¯ä»£ç åŸ‹ç‚¹ã€‚</p>
<p>ä»¥ç”¨æˆ·è¿›å…¥é¦–é¡µä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨é¦–é¡µæ¸²æŸ“å®Œæˆåä¼šå‘é€äº‹ä»¶ç±»å‹å’Œç±»å‹ç›¸å…³çš„æ•°æ®ç»™ server ç«¯ï¼Œå‘ŠçŸ¥é¦–é¡µçš„ç›‘æ§ä¿¡æ¯ã€‚</p>
<p><img src="../_resources/å‰ç«¯ç›‘æ§å’Œå‰ç«¯åŸ‹ç‚¹æ–¹æ¡ˆè®¾è®¡/fdbd6819642571008f55abedc645da62_MD5.png" /></p>
<h4>(3) ä¸ŠæŠ¥å‘¨æœŸå’Œä¸ŠæŠ¥æ•°æ®ç±»å‹</h4>
<p>å¦‚æœåŸ‹ç‚¹çš„äº‹ä»¶ä¸æ˜¯å¾ˆå¤šï¼Œä¸ŠæŠ¥å¯ä»¥æ—¶æ—¶è¿›è¡Œï¼Œæ¯”å¦‚ç›‘æ§ç”¨æˆ·çš„äº¤äº’äº‹ä»¶ï¼Œå¯ä»¥åœ¨ç”¨æˆ·è§¦å‘äº‹ä»¶åï¼Œç«‹åˆ»ä¸ŠæŠ¥ç”¨æˆ·æ‰€è§¦å‘çš„äº‹ä»¶ç±»å‹ã€‚å¦‚æœåŸ‹ç‚¹çš„äº‹ä»¶è¾ƒå¤šï¼Œæˆ–è€…è¯´ç½‘é¡µå†…éƒ¨äº¤äº’é¢‘ç¹ï¼Œå¯ä»¥é€šè¿‡æœ¬åœ°å­˜å‚¨çš„æ–¹å¼å…ˆç¼“å­˜ä¸ŠæŠ¥ä¿¡æ¯ï¼Œç„¶åå®šæœŸä¸ŠæŠ¥ã€‚</p>
<p>æ¥ç€æ¥ç¡®å®šéœ€è¦åŸ‹ç‚¹ä¸ŠæŠ¥çš„æ•°æ®ï¼Œä¸ŠæŠ¥çš„ä¿¡æ¯åŒ…æ‹¬ç”¨æˆ·ä¸ªäººä¿¡æ¯ä»¥åŠç”¨æˆ·è¡Œä¸ºï¼Œä¸»è¦æ•°æ®å¯ä»¥åˆ†ä¸ºï¼š</p>
<ul>
<li>
<p>who: appid(ç³»ç»Ÿæˆ–è€…åº”ç”¨çš„ id),userAgent(ç”¨æˆ·çš„ç³»ç»Ÿã€ç½‘ç»œç­‰ä¿¡æ¯)</p>
</li>
<li>
<p>when: timestamp(ä¸ŠæŠ¥çš„æ—¶é—´æˆ³)</p>
</li>
<li>
<p>from where: currentUrl(ç”¨æˆ·å½“å‰ url)ï¼ŒfromUrl(ä»å“ªä¸€ä¸ªé¡µé¢è·³è½¬åˆ°å½“å‰é¡µé¢)ï¼Œtype(ä¸ŠæŠ¥çš„äº‹ä»¶ç±»å‹),element(è§¦å‘ä¸ŠæŠ¥äº‹ä»¶çš„å…ƒç´ ï¼‰</p>
</li>
<li>
<p>what: ä¸ŠæŠ¥çš„è‡ªå®šä¹‰æ‰©å±•æ•°æ® data:{}, æ‰©å±•æ•°æ®ä¸­å¯ä»¥æŒ‰éœ€æ±‚å®šåˆ¶ï¼Œæ¯”å¦‚åŒ…å« uid ç­‰ä¿¡æ¯</p>
</li>
</ul>
<p>ä¸ŠæŠ¥æ•°æ®çš„å¯¹è±¡ä¸ºï¼š</p>
<pre><code>{   
    ----------------ä¸ŠæŠ¥æ¥å£æœ¬èº«æä¾›--------------------
    currentUrl,  
    fromUrl,
    timestamp,
    userAgent:{
       os,
       netWord,
    }
    ----------------ä¸šåŠ¡ä»£ç é…ç½®å’Œè‡ªå®šä¹‰ä¸ŠæŠ¥æ•°æ®------------
    type,
    appid,
    element,
    data:{
        uid,
        uname
    }
}


</code></pre>
<h4>(4) åŸ‹ç‚¹å’Œä¸ŠæŠ¥ä¸¾ä¾‹</h4>
<p>æˆ‘ä»¬ä»¥ä¸ŠæŠ¥é¦–å±åŠ è½½äº‹ä»¶ä¸ºä¾‹ï¼ŒDOM æä¾›äº† document çš„ DOMContentLoaded äº‹ä»¶æ¥ç›‘å¬ dom æŒ‚è½½ï¼Œæä¾›äº† window çš„ load äº‹ä»¶æ¥ç›‘å¬é¡µé¢æ‰€æœ‰èµ„æºåŠ è½½æ¸²æŸ“å®Œæ¯•ã€‚</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
  var start=Date.now();
  document.addEventListener('DOMContentLoaded', function() {
     fetch('some api',{
         type:'dom complete',
         data:{
           domCompletedTime:Date.now()-start
         }
     })
  });
  window.addEventListener('load', function() {
     fetch('some api',{
         type:'load complete',
         data:{
           LoadCompletedTime:Date.now()-start
         }
     })
  });
&lt;/script&gt;


</code></pre>
<h4>(5) å‰ç«¯åŸ‹ç‚¹ç³»ç»Ÿçš„å‰åç«¯é€šä¿¡åŠ å¯†</h4>
<p>åœ¨ä¸ŠæŠ¥æ•°æ®çš„å‰åç«¯é€šä¿¡ä¸­ï¼Œéœ€è¦å’Œ server ç«¯åå•†åŠ å¯†æœºåˆ¶ï¼Œåˆ©ç”¨ OpenSSL åº“æ¥å®ç°çš„åŠ å¯†ï¼ŒOpenSSL å·²ç»æ˜¯ä¸€ä¸ªå¹¿æ³›è¢«é‡‡ç”¨çš„åŠ å¯†ç®—æ³•ã€‚å‰ç«¯å¯ä»¥é‡‡ç”¨ node çš„ crypto æ¨¡å—ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ hash ç®—æ³•ï¼Œcrypto.createHash() æ¥åˆ›å»ºä¸€ä¸ª Hash å®ä¾‹ï¼Œå¯åˆ©ç”¨çš„ hash ç®—æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>md5</p>
</li>
<li>
<p>sha1</p>
</li>
<li>
<p>sha256</p>
</li>
<li>
<p>sha512</p>
</li>
<li>
<p>ripemd160</p>
</li>
</ul>
<p>ä»¥ sha256 ç®—æ³•åŠ å¯†ä¸ºä¾‹ï¼š</p>
<pre><code>const str=&quot;123445&quot;;//éœ€è¦åŠ å¯†çš„å­—æ®µ
const hash=crypto.createHash('sha256');//æŒ‡å®šåŠ å¯†ç®—æ³•
hash.update(str); //é€šè¿‡ç®—æ³•åŠ å¯†ç›¸åº”çš„å­—æ®µ
const result=hash.digest('hex');//è½¬åŒ–æˆåå…­è¿›åˆ¶


</code></pre>
<h3>å››ã€å‰ç«¯ç›‘æ§ç»“æœå¯è§†åŒ–å±•ç¤ºç³»ç»Ÿçš„è®¾è®¡</h3>
<p>å½“åç«¯å¾—åˆ°å‰ç«¯ä¸ŠæŠ¥çš„ä¿¡æ¯ä¹‹åï¼Œç»è¿‡æ•°æ®åˆ†æå’Œå¤„ç†ï¼Œéœ€è¦å‰ç«¯å¯è§†åŒ–çš„å±•ç¤ºæ•°æ®åˆ†æåçš„ç»“æœã€‚</p>
<p>å¯ä»¥åœ¨å¼€æºä¸­åå°ç³»ç»Ÿ ant-design-pro çš„åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œé¦–å…ˆè¦æ˜ç¡®å±•ç¤ºä¿¡æ¯ã€‚å±•ç¤ºçš„ä¿¡æ¯åŒ…æ‹¬å•ä¸ªç”¨æˆ·å’Œæ•´ä½“åº”ç”¨ã€‚</p>
<p>å¯¹äºå•ä¸ªç”¨æˆ·æ¥è¯´éœ€è¦å±•ç¤ºçš„ç›‘æ§ä¿¡æ¯ä¸ºï¼š</p>
<ul>
<li>å•ä¸ªç”¨æˆ·ï¼Œåœ¨äº¤äº’è¿‡ç¨‹ä¸­è§¦å‘å„ä¸ªåŸ‹ç‚¹äº‹ä»¶çš„æ¬¡æ•°</li>
<li>å•ä¸ªç”¨æˆ·ï¼Œåœ¨æŸä¸ªæ—¶é—´å‘¨æœŸå†…ï¼Œè®¿é—®æœ¬ç½‘é¡µçš„å…¥å£æ¥æº</li>
<li>å•ä¸ªç”¨æˆ·ï¼Œåœ¨æ¯ä¸€ä¸ªå­é¡µé¢çš„åœç•™æ—¶é—´</li>
</ul>
<p>å¯¹äºå…¨ä½“ç”¨æˆ·éœ€è¦å±•ç¤ºçš„ä¿¡æ¯ä¸ºï¼š</p>
<ul>
<li>æŸä¸€ä¸ªæ—¶é—´æ®µå†…ç½‘é¡µçš„ PV å’Œ UV</li>
<li>å…¨ä½“ç”¨æˆ·è®¿é—®ç½‘é¡µçš„è®¾å¤‡å’Œæ“ä½œç³»ç»Ÿåˆ†æ</li>
<li>æŸä¸€ä¸ªæ—¶é—´æ®µå†…è®¿é—®æœ¬ç½‘é¡µçš„å…¥å£æ¥æºåˆ†æ</li>
<li>å…¨ä½“ç”¨æˆ·åœ¨è®¿é—®æœ¬ç½‘é¡µæ—¶ï¼Œåœ¨äº¤äº’è¿‡ç¨‹ä¸­è§¦å‘å„ä¸ªåŸ‹ç‚¹äº‹ä»¶çš„æ€»æ¬¡æ•°</li>
<li>å…¨ä½“ç”¨æˆ·åœ¨è®¿é—®æœ¬ç½‘é¡µæ—¶ï¼Œç½‘é¡µä¸ŠæŠ¥å¼‚å¸¸çš„é›†åˆ</li>
</ul>
<p>åˆ é€‰åŠŸèƒ½é›†åˆï¼š</p>
<ul>
<li>æ—¶é—´ç­›é€‰ï¼šæä¾›ä»Šæ—¥ï¼ˆ00 ç‚¹åˆ°å½“å‰æ—¶é—´ï¼‰ã€æœ¬å‘¨ã€æœ¬æœˆå’Œå…¨å¹´</li>
<li>ç”¨æˆ·åˆ é€‰ï¼šæä¾›æ ¹æ®ç”¨æˆ· id åˆ é€‰å‡ºç”¨æˆ·è¡Œä¸ºçš„ç»Ÿè®¡ä¿¡æ¯</li>
<li>è®¾å¤‡åˆ é€‰ï¼šåˆ é€‰ä¸åŒç³»ç»Ÿçš„æ•´ä½“å±•ç¤ºä¿¡æ¯</li>
</ul>
<hr>
<h1>æ‰‹å†™ Promise åŸç†</h1><h2>resolve å’Œ reject</h2>
<p>å››ä¸ªçŸ¥è¯†ç‚¹ï¼š</p>
<ul>
<li>1ã€æ‰§è¡Œäº†<code>resolve</code>ï¼ŒPromise çŠ¶æ€ä¼šå˜æˆ<code>fulfilled</code></li>
<li>2ã€æ‰§è¡Œäº†<code>reject</code>ï¼ŒPromise çŠ¶æ€ä¼šå˜æˆ<code>rejected</code></li>
<li>3ã€Promise åªä»¥<code>ç¬¬ä¸€æ¬¡ä¸ºå‡†</code>ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±<code>æ°¸ä¹…</code>ä¸º<code>fulfilled</code>ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±æ°¸è¿œçŠ¶æ€ä¸º<code>rejected</code></li>
<li>4ã€Promise ä¸­æœ‰<code>throw</code>çš„è¯ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†<code>reject</code></li>
</ul>
<h3>1ã€å®ç° resolve ä¸ reject</h3>
<p>å¤§å®¶è¦æ³¨æ„ï¼šPromise çš„åˆå§‹çŠ¶æ€æ˜¯<code>pending</code></p>
<p>é‡è¦çš„ä¸€æ­¥æ˜¯<code>resolveå’Œrejectçš„ç»‘å®šthis</code></p>
<p>ä¸ºä»€ä¹ˆè¦ç»‘å®š<code>this</code>å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº† resolve å’Œ reject çš„<code>thisæŒ‡å‘</code>æ°¸è¿œæŒ‡å‘å½“å‰çš„<code>MyPromiseå®ä¾‹</code>ï¼Œé˜²æ­¢éšç€å‡½æ•°æ‰§è¡Œç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜</p>
<pre><code>class MyPromise {
    // æ„é€ æ–¹æ³•
    constructor(executor) {

        // åˆå§‹åŒ–å€¼
        this.initValue()
        // åˆå§‹åŒ–thisæŒ‡å‘
        this.initBind()
        // æ‰§è¡Œä¼ è¿›æ¥çš„å‡½æ•°
        executor(this.resolve, this.reject)
    }

    initBind() {
        // åˆå§‹åŒ–this
        this.resolve = this.resolve.bind(this)
        this.reject = this.reject.bind(this)
    }

    initValue() {
        // åˆå§‹åŒ–å€¼
        this.PromiseResult = null // ç»ˆå€¼
        this.PromiseState = 'pending' // çŠ¶æ€
    }

    resolve(value) {
        // å¦‚æœæ‰§è¡Œresolveï¼ŒçŠ¶æ€å˜ä¸ºfulfilled
        this.PromiseState = 'fulfilled'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„å€¼
        this.PromiseResult = value
    }

    reject(reason) {
        // å¦‚æœæ‰§è¡Œrejectï¼ŒçŠ¶æ€å˜ä¸ºrejected
        this.PromiseState = 'rejected'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„reason
        this.PromiseResult = reason
    }
}

</code></pre>
<p>å’±ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç å§ï¼š</p>
<pre><code>const test1 = new MyPromise((resolve, reject) =&gt; {
    resolve('æˆåŠŸ')
})
console.log(test1) // MyPromise { PromiseState: 'fulfilled', PromiseResult: 'æˆåŠŸ' }

const test2 = new MyPromise((resolve, reject) =&gt; {
    reject('å¤±è´¥')
})
console.log(test2) // MyPromise { PromiseState: 'rejected', PromiseResult: 'å¤±è´¥' }

</code></pre>
<h3>2. çŠ¶æ€ä¸å¯å˜</h3>
<p>å…¶å®ä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿçœ‹çœ‹ï¼š</p>
<pre><code>const test1 = new MyPromise((resolve, reject) =&gt; {
    resolve('æˆåŠŸ')
    reject('å¤±è´¥')
})
console.log(test1) // MyPromise { PromiseState: 'rejected', PromiseResult: 'å¤±è´¥' }

</code></pre>
<p>æ­£ç¡®çš„åº”è¯¥æ˜¯çŠ¶æ€ä¸º<code>fulfilled</code>ï¼Œç»“æœæ˜¯<code>æˆåŠŸ</code>ï¼Œè¿™é‡Œæ˜æ˜¾æ²¡æœ‰<code>ä»¥ç¬¬ä¸€æ¬¡ä¸ºå‡†</code></p>
<p>ä¹‹å‰è¯´äº†ï¼ŒPromise åªä»¥<code>ç¬¬ä¸€æ¬¡ä¸ºå‡†</code>ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±<code>æ°¸ä¹…</code>ä¸º<code>fulfilled</code>ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±æ°¸è¿œçŠ¶æ€ä¸º<code>rejected</code></p>
<p>ä¸€æ—¦çŠ¶æ€ä»<code>pending</code>å˜ä¸º<code>fulfilledæˆ–è€…rejected</code>ï¼Œé‚£ä¹ˆæ­¤ Promise å®ä¾‹çš„çŠ¶æ€å°±å®šæ­»äº†ã€‚ ![]</p>
<p>å…¶å®å®ç°èµ·æ¥ä¹Ÿå¾ˆå®¹æ˜“ï¼ŒåŠ ä¸ªåˆ¤æ–­æ¡ä»¶å°±è¡Œï¼š</p>
<pre><code>resolve(value) {
        // stateæ˜¯ä¸å¯å˜çš„
+        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œresolveï¼ŒçŠ¶æ€å˜ä¸ºfulfilled
        this.PromiseState = 'fulfilled'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„å€¼
        this.PromiseResult = value
    }

    reject(reason) {
        // stateæ˜¯ä¸å¯å˜çš„
+        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œrejectï¼ŒçŠ¶æ€å˜ä¸ºrejected
        this.PromiseState = 'rejected'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„reason
        this.PromiseResult = reason
    }

</code></pre>
<h3>3. throw</h3>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa2e17b24a124dadba540e86350f1302~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>Promise ä¸­æœ‰<code>throw</code>çš„è¯ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†<code>reject</code>ã€‚è¿™å°±è¦ä½¿ç”¨<code>try catch</code>äº†</p>
<pre><code>+        try {
            // æ‰§è¡Œä¼ è¿›æ¥çš„å‡½æ•°
            executor(this.resolve, this.reject)
+        } catch (e) {
            // æ•æ‰åˆ°é”™è¯¯ç›´æ¥æ‰§è¡Œreject
+            this.reject(e)
+        }

</code></pre>
<h2>then</h2>
<p>then æ–¹æ³•ä½¿ç”¨çš„ï¼š</p>
<pre><code>// é©¬ä¸Šè¾“å‡º â€æˆåŠŸâ€œ
const p1 = new Promise((resolve, reject) =&gt; {
    resolve('æˆåŠŸ')
}).then(res =&gt; console.log(res), err =&gt; console.log(err))

// 1ç§’åè¾“å‡º â€å¤±è´¥â€œ
const p2 = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        reject('å¤±è´¥')
    }, 1000)
}).then(res =&gt; console.log(res), err =&gt; console.log(err))

// é“¾å¼è°ƒç”¨ è¾“å‡º 200
const p3 = new Promise((resolve, reject) =&gt; {
    resolve(100)
}).then(res =&gt; 2 * res, err =&gt; console.log(err))
  .then(res =&gt; console.log(res), err =&gt; console.log(err))

</code></pre>
<p>å¯ä»¥æ€»ç»“å‡ºè¿™å‡ ç‚¹ï¼š</p>
<ul>
<li>then æ¥æ”¶ä¸¤ä¸ªå›è°ƒï¼Œä¸€ä¸ªæ˜¯<code>æˆåŠŸå›è°ƒ</code>ï¼Œä¸€ä¸ªæ˜¯<code>å¤±è´¥å›è°ƒ</code></li>
<li>å½“ Promise çŠ¶æ€ä¸º<code>fulfilled</code>æ‰§è¡Œ<code>æˆåŠŸå›è°ƒ</code>ï¼Œä¸º<code>rejected</code>æ‰§è¡Œ<code>å¤±è´¥å›è°ƒ</code></li>
<li>å¦‚ resolve æˆ– reject åœ¨å®šæ—¶å™¨é‡Œï¼Œ<code>åˆ™å®šæ—¶å™¨ç»“æŸåå†æ‰§è¡Œthen</code></li>
<li>then æ”¯æŒ<code>é“¾å¼è°ƒç”¨</code>ï¼Œä¸‹ä¸€æ¬¡ then æ‰§è¡Œ<code>å—ä¸Šä¸€æ¬¡thenè¿”å›å€¼çš„å½±å“</code></li>
</ul>
<p>ä¸‹é¢å’±ä»¬å°±ä¸€æ­¥ä¸€æ­¥åœ°å»å®ç°ä»–å§</p>
<h3>1. å®ç° then</h3>
<pre><code>then(onFulfilled, onRejected) {
        // æ¥æ”¶ä¸¤ä¸ªå›è°ƒ onFulfilled, onRejected
        
        // å‚æ•°æ ¡éªŒï¼Œç¡®ä¿ä¸€å®šæ˜¯å‡½æ•°
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : val =&gt; val
        onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; { throw reason }

        if (this.PromiseState === 'fulfilled') {
            // å¦‚æœå½“å‰ä¸ºæˆåŠŸçŠ¶æ€ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå›è°ƒ
            onFulfilled(this.PromiseResult)
        } else if (this.PromiseState === 'rejected') {
            // å¦‚æœå½“å‰ä¸ºå¤±è´¥çŠ¶æ€ï¼Œæ‰§è¡Œç¬¬äºŒå“¥å›è°ƒ
            onRejected(this.PromiseResult)
        }

    }

</code></pre>
<h3>2. å¼‚æ­¥æƒ…å†µ</h3>
<p>é‚£å¦‚æœæ˜¯å¼‚æ­¥æƒ…å†µå‘¢ï¼Ÿ
æ€ä¹ˆæ‰èƒ½ä¿è¯ï¼Œ1 ç§’åæ‰æ‰§è¡Œ then é‡Œçš„å¤±è´¥å›è°ƒå‘¢ï¼Ÿ</p>
<pre><code>// 1ç§’åè¾“å‡º â€æˆåŠŸâ€œ
const p2 = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        reject('å¤±è´¥')
    }, 1000)
}).then(res =&gt; console.log(res), err =&gt; console.log(err))

</code></pre>
<p>æˆ‘ä»¬ä¸èƒ½ç¡®ä¿ 1 ç§’åæ‰æ‰§è¡Œ then å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¿è¯ 1 ç§’åå†æ‰§è¡Œ then é‡Œçš„å›è°ƒï¼Œ</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ba5a2544b1144548cdc63362fa27d23~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>åœ¨è¿™ 1 ç§’æ—¶é—´å†…ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠ then é‡Œçš„ä¸¤ä¸ªå›è°ƒä¿å­˜èµ·æ¥ï¼Œ
ç­‰åˆ° 1 ç§’è¿‡åï¼Œæ‰§è¡Œäº† resolve æˆ–è€… rejectï¼Œå’±ä»¬å†å»åˆ¤æ–­çŠ¶æ€ï¼Œå¹¶ä¸”åˆ¤æ–­è¦å»æ‰§è¡Œåˆšåˆšä¿å­˜çš„ä¸¤ä¸ªå›è°ƒä¸­çš„å“ªä¸€ä¸ªå›è°ƒã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“å½“å‰ 1 ç§’è¿˜æ²¡èµ°å®Œç”šè‡³è¿˜æ²¡å¼€å§‹èµ°å‘¢ï¼Ÿ</p>
<p>å…¶å®å¾ˆå¥½åˆ¤æ–­ï¼Œåªè¦çŠ¶æ€æ˜¯<code>pending</code>ï¼Œé‚£å°±è¯æ˜å®šæ—¶å™¨è¿˜æ²¡è·‘å®Œï¼Œ
å› ä¸ºå¦‚æœå®šæ—¶å™¨è·‘å®Œçš„è¯ï¼Œé‚£çŠ¶æ€è‚¯å®šå°±ä¸æ˜¯<code>pending</code>ï¼Œè€Œæ˜¯<code>fulfilledæˆ–è€…rejected</code></p>
<p>é‚£æ˜¯ç”¨ä»€ä¹ˆæ¥ä¿å­˜è¿™äº›å›è°ƒå‘¢ï¼Ÿ
å»ºè®®ä½¿ç”¨<code>æ•°ç»„</code>ï¼Œå› ä¸ºä¸€ä¸ª promise å®ä¾‹å¯èƒ½ä¼š<code>å¤šæ¬¡then</code>ï¼Œç”¨æ•°ç»„å°±ä¸€ä¸ªä¸€ä¸ªä¿å­˜äº†</p>
<pre><code>initValue() {
        // åˆå§‹åŒ–å€¼
        this.PromiseResult = null // ç»ˆå€¼
        this.PromiseState = 'pending' // çŠ¶æ€
+        this.onFulfilledCallbacks = [] // ä¿å­˜æˆåŠŸå›è°ƒ
+        this.onRejectedCallbacks = [] // ä¿å­˜å¤±è´¥å›è°ƒ
    }

    resolve(value) {
        // stateæ˜¯ä¸å¯å˜çš„
        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œresolveï¼ŒçŠ¶æ€å˜ä¸ºfulfilled
        this.PromiseState = 'fulfilled'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„å€¼
        this.PromiseResult = value
        // æ‰§è¡Œä¿å­˜çš„æˆåŠŸå›è°ƒ
+        while (this.onFulfilledCallbacks.length) {
+            this.onFulfilledCallbacks.shift()(this.PromiseResult)
+        }
    }

    reject(reason) {
        // stateæ˜¯ä¸å¯å˜çš„
        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œrejectï¼ŒçŠ¶æ€å˜ä¸ºrejected
        this.PromiseState = 'rejected'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„reason
        this.PromiseResult = reason
        // æ‰§è¡Œä¿å­˜çš„å¤±è´¥å›è°ƒ
+       while (this.onRejectedCallbacks.length) {
+            this.onRejectedCallbacks.shift()(this.PromiseResult)
+        }
    }
    
    then(onFulfilled, onRejected) {
        // æ¥æ”¶ä¸¤ä¸ªå›è°ƒ onFulfilled, onRejected

        // å‚æ•°æ ¡éªŒï¼Œç¡®ä¿ä¸€å®šæ˜¯å‡½æ•°
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : val =&gt; val
        onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; { throw reason }

        if (this.PromiseState === 'fulfilled') {
            // å¦‚æœå½“å‰ä¸ºæˆåŠŸçŠ¶æ€ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå›è°ƒ
            onFulfilled(this.PromiseResult)
        } else if (this.PromiseState === 'rejected') {
            // å¦‚æœå½“å‰ä¸ºå¤±è´¥çŠ¶æ€ï¼Œæ‰§è¡Œç¬¬äºŒå“¥å›è°ƒ
            onRejected(this.PromiseResult)
+        } else if (this.PromiseState === 'pending') {
+            // å¦‚æœçŠ¶æ€ä¸ºå¾…å®šçŠ¶æ€ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒ
+            this.onFulfilledCallbacks.push(onFulfilled.bind(this))
+            this.onRejectedCallbacks.push(onRejected.bind(this))
+        }

    }


</code></pre>
<p>åŠ å®Œä¸Šé¢çš„ä»£ç ï¼Œå’±ä»¬æ¥çœ‹çœ‹å®šæ—¶å™¨çš„æ•ˆæœå§ï¼š</p>
<pre><code>const test2 = new MyPromise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        resolve('æˆåŠŸ') // 1ç§’åè¾“å‡º æˆåŠŸ
        // resolve('æˆåŠŸ') // 1ç§’åè¾“å‡º å¤±è´¥
    }, 1000)
}).then(res =&gt; console.log(res), err =&gt; console.log(err))

</code></pre>
<h3>3. é“¾å¼è°ƒç”¨</h3>
<p>then æ”¯æŒ<code>é“¾å¼è°ƒç”¨</code>ï¼Œä¸‹ä¸€æ¬¡ then æ‰§è¡Œ<code>å—ä¸Šä¸€æ¬¡thenè¿”å›å€¼çš„å½±å“</code>ï¼Œç»™å¤§å®¶ä¸¾ä¸ªä¾‹å­ï¼š</p>
<ul>
<li>1ã€then æ–¹æ³•æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡</li>
<li>2ã€å¦‚æœè¿”å›å€¼æ˜¯ promise å¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºæˆåŠŸï¼Œæ–° promise å°±æ˜¯æˆåŠŸ</li>
<li>3ã€å¦‚æœè¿”å›å€¼æ˜¯ promise å¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºå¤±è´¥ï¼Œæ–° promise å°±æ˜¯å¤±è´¥</li>
<li>4ã€å¦‚æœè¿”å›å€¼é promise å¯¹è±¡ï¼Œæ–° promise å¯¹è±¡å°±æ˜¯æˆåŠŸï¼Œå€¼ä¸ºæ­¤è¿”å›å€¼</li>
</ul>
<p>å’±ä»¬çŸ¥é“ then æ˜¯ Promise ä¸Šçš„æ–¹æ³•ï¼Œé‚£å¦‚ä½•å®ç° then å®Œè¿˜èƒ½å† then å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œthen æ‰§è¡Œåè¿”å›ä¸€ä¸ª<code>Promiseå¯¹è±¡</code>å°±è¡Œäº†ï¼Œå°±èƒ½ä¿è¯ then å®Œè¿˜èƒ½ç»§ç»­æ‰§è¡Œ thenï¼š</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62a3c3afcf0a4262a1a7e52231c34dbc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>ä»£ç å®ç°ï¼š</p>
<pre><code>then(onFulfilled, onRejected) {
        // æ¥æ”¶ä¸¤ä¸ªå›è°ƒ onFulfilled, onRejected

        // å‚æ•°æ ¡éªŒï¼Œç¡®ä¿ä¸€å®šæ˜¯å‡½æ•°
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : val =&gt; val
        onRejected = typeof onRejected === 'function' ? onRejected : reason =&gt; { throw reason }


        var thenPromise = new MyPromise((resolve, reject) =&gt; {

            const resolvePromise = cb =&gt; {
                try {
                    const x = cb(this.PromiseResult)
                    if (x === thenPromise) {
                        // ä¸èƒ½è¿”å›è‡ªèº«å“¦
                        throw new Error('ä¸èƒ½è¿”å›è‡ªèº«ã€‚ã€‚ã€‚')
                    }
                    if (x instanceof MyPromise) {
                        // å¦‚æœè¿”å›å€¼æ˜¯Promise
                        // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºæˆåŠŸï¼Œæ–°promiseå°±æ˜¯æˆåŠŸ
                        // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºå¤±è´¥ï¼Œæ–°promiseå°±æ˜¯å¤±è´¥
                        // è°çŸ¥é“è¿”å›çš„promiseæ˜¯å¤±è´¥æˆåŠŸï¼Ÿåªæœ‰thençŸ¥é“
                        x.then(resolve, reject)
                    } else {
                        // éPromiseå°±ç›´æ¥æˆåŠŸ
                        resolve(x)
                    }
                } catch (err) {
                    // å¤„ç†æŠ¥é”™
                    reject(err)
                    throw new Error(err)
                }
            }

            if (this.PromiseState === 'fulfilled') {
                // å¦‚æœå½“å‰ä¸ºæˆåŠŸçŠ¶æ€ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå›è°ƒ
                resolvePromise(onFulfilled)
            } else if (this.PromiseState === 'rejected') {
                // å¦‚æœå½“å‰ä¸ºå¤±è´¥çŠ¶æ€ï¼Œæ‰§è¡Œç¬¬äºŒä¸ªå›è°ƒ
                resolvePromise(onRejected)
            } else if (this.PromiseState === 'pending') {
                // å¦‚æœçŠ¶æ€ä¸ºå¾…å®šçŠ¶æ€ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒ
                // å¦‚æœçŠ¶æ€ä¸ºå¾…å®šçŠ¶æ€ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒ
                this.onFulfilledCallbacks.push(resolvePromise.bind(this, onFulfilled))
                this.onRejectedCallbacks.push(resolvePromise.bind(this, onRejected))
            }
        })

        // è¿”å›è¿™ä¸ªåŒ…è£…çš„Promise
        return thenPromise

    }

</code></pre>
<p>ç°åœ¨å¤§å®¶å¯ä»¥è¯•è¯•æ•ˆæœæ€ä¹ˆæ ·äº†ï¼Œå¤§å®¶è¦<strong>è¾¹æ•²è¾¹è¯•</strong>å“¦ï¼š</p>
<pre><code>const test3 = new Promise((resolve, reject) =&gt; {
  resolve(100) // è¾“å‡º çŠ¶æ€ï¼šæˆåŠŸ å€¼ï¼š 200
  // reject(100) // è¾“å‡º çŠ¶æ€ï¼šæˆåŠŸ å€¼ï¼š300
}).then(res =&gt; 2 * res, err =&gt; 3 * err)
  .then(res =&gt; console.log('æˆåŠŸ', res), err =&gt; console.log('å¤±è´¥', err))


  const test4 = new Promise((resolve, reject) =&gt; {
    resolve(100) // è¾“å‡º çŠ¶æ€ï¼šå¤±è´¥ å€¼ï¼š200
    // reject(100) // è¾“å‡º çŠ¶æ€ï¼šæˆåŠŸ å€¼ï¼š300
    // è¿™é‡Œå¯æ²¡æåå“¦ã€‚çœŸçš„ææ‡‚äº†ï¼Œå°±çŸ¥é“äº†ä¸ºå•¥è¿™é‡Œæ˜¯åçš„
  }).then(
		  res =&gt; new Promise((resolve, reject) =&gt; reject(2 * res)), 
		  err =&gt; new Promise((resolve, reject) =&gt; resolve(3 * err))
		  )
    .then(res =&gt; console.log('æˆåŠŸ', res), err =&gt; console.log('å¤±è´¥', err))

</code></pre>
<h3>4. å¾®ä»»åŠ¡</h3>
<p>then æ–¹æ³•æ˜¯<code>å¾®ä»»åŠ¡</code>ï¼Œå•¥å«å¾®ä»»åŠ¡å‘¢ï¼Ÿå…¶å®ä¸çŸ¥é“ä¹Ÿä¸è¦ç´§ï¼Œæˆ‘é€šè¿‡ä¸‹é¢ä¾‹å­è®©ä½ çŸ¥é“ï¼š</p>
<pre><code>const p = new Promise((resolve, reject) =&gt; {
    resolve(1)
}).then(res =&gt; console.log(res), err =&gt; console.log(err))

console.log(2)

è¾“å‡ºé¡ºåºæ˜¯ 2 1

</code></pre>
<p>ä¸ºå•¥ä¸æ˜¯ 1 2 å‘¢ï¼Ÿå› ä¸º then æ˜¯ä¸ªå¾®ä»»åŠ¡å•Š
åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç»™æˆ‘ä»¬çš„ MyPromise åŠ ä¸Šè¿™ä¸ªç‰¹æ€§ (æˆ‘è¿™é‡Œä½¿ç”¨å®šæ—¶å™¨ï¼Œå¤§å®¶åˆ«ä»‹æ„å“ˆ)
åªéœ€è¦è®©<code>resolvePromiseå‡½æ•°</code>å¼‚æ­¥æ‰§è¡Œå°±å¯ä»¥äº†</p>
<pre><code>const resolvePromise = cb =&gt; {
    setTimeout(() =&gt; {
        try {
            const x = cb(this.PromiseResult)
            if (x === thenPromise) {
                // ä¸èƒ½è¿”å›è‡ªèº«å“¦
                throw new Error('ä¸èƒ½è¿”å›è‡ªèº«ã€‚ã€‚ã€‚')
            }
            if (x instanceof MyPromise) {
                // å¦‚æœè¿”å›å€¼æ˜¯Promise
                // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºæˆåŠŸï¼Œæ–°promiseå°±æ˜¯æˆåŠŸ
                // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºå¤±è´¥ï¼Œæ–°promiseå°±æ˜¯å¤±è´¥
                // è°çŸ¥é“è¿”å›çš„promiseæ˜¯å¤±è´¥æˆåŠŸï¼Ÿåªæœ‰thençŸ¥é“
                x.then(resolve, reject)
            } else {
                // éPromiseå°±ç›´æ¥æˆåŠŸ
                resolve(x)
            }
        } catch (err) {
            // å¤„ç†æŠ¥é”™
            reject(err)
            throw new Error(err)
        }
    })
}

</code></pre>
<h3>all</h3>
<ul>
<li>æ¥æ”¶ä¸€ä¸ª Promise æ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰é Promise é¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ</li>
<li>å¦‚æœæ‰€æœ‰ Promise éƒ½æˆåŠŸï¼Œåˆ™è¿”å›æˆåŠŸç»“æœæ•°ç»„</li>
<li>å¦‚æœæœ‰ä¸€ä¸ª Promise å¤±è´¥ï¼Œåˆ™è¿”å›è¿™ä¸ªå¤±è´¥ç»“æœ</li>
</ul>
<pre><code>static all(promises) {
        const result = []
        let count = 0
        return new MyPromise((resolve, reject) =&gt; {
            const addData = (index, value) =&gt; {
                result[index] = value
                count++
                if (count === promises.length) resolve(result)
            }
            promises.forEach((promise, index) =&gt; {
                if (promise instanceof MyPromise) {
                    promise.then(res =&gt; {
                        addData(index, res)
                    }, err =&gt; reject(err))
                } else {
                    addData(index, promise)
                }
            })
        })
    }

</code></pre>
<h3>race</h3>
<ul>
<li>æ¥æ”¶ä¸€ä¸ª Promise æ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰é Promise é¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ</li>
<li>å“ªä¸ª Promise æœ€å¿«å¾—åˆ°ç»“æœï¼Œå°±è¿”å›é‚£ä¸ªç»“æœï¼Œæ— è®ºæˆåŠŸå¤±è´¥</li>
</ul>
<pre><code>static race(promises) {
        return new MyPromise((resolve, reject) =&gt; {
            promises.forEach(promise =&gt; {
                if (promise instanceof MyPromise) {
                    promise.then(res =&gt; {
                        resolve(res)
                    }, err =&gt; {
                        reject(err)
                    })
                } else {
                    resolve(promise)
                }
            })
        })
    }

</code></pre>
<h3>allSettled</h3>
<ul>
<li>æ¥æ”¶ä¸€ä¸ª Promise æ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰é Promise é¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ</li>
<li>æŠŠæ¯ä¸€ä¸ª Promise çš„ç»“æœï¼Œé›†åˆæˆæ•°ç»„ï¼Œè¿”å›</li>
</ul>
<pre><code>static allSettled(promises) {
        return new Promise((resolve, reject) =&gt; {
            const res = []
            let count = 0
            const addData = (status, value, i) =&gt; {
                res[i] = {
                    status,
                    value
                }
                count++
                if (count === promises.length) {
                    resolve(res)
                }
            }
            promises.forEach((promise, i) =&gt; {
                if (promise instanceof MyPromise) {
                    promise.then(res =&gt; {
                        addData('fulfilled', res, i)
                    }, err =&gt; {
                        addData('rejected', err, i)
                    })
                } else {
                    addData('fulfilled', promise, i)
                }
            })
        })
    }

</code></pre>
<h3>any</h3>
<p>any ä¸ all ç›¸å</p>
<ul>
<li>æ¥æ”¶ä¸€ä¸ª Promise æ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰é Promise é¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ</li>
<li>å¦‚æœæœ‰ä¸€ä¸ª Promise æˆåŠŸï¼Œåˆ™è¿”å›è¿™ä¸ªæˆåŠŸç»“æœ</li>
<li>å¦‚æœæ‰€æœ‰ Promise éƒ½å¤±è´¥ï¼Œåˆ™æŠ¥é”™</li>
</ul>
<pre><code>static any(promises) {
        return new Promise((resolve, reject) =&gt; {
            let count = 0
            promises.forEach((promise) =&gt; {
                promise.then(val =&gt; {
                    resolve(val)
                }, err =&gt; {
                    count++
                    if (count === promises.length) {
                        reject(new AggregateError('All promises were rejected'))
                    }
                })
            })
        })
    }
}

</code></pre>
<hr>
<h1>æ¨¡æ‹Ÿé¢˜ - æŠ“ä½ä¸‰ä¸ªæ ¸å¿ƒï¼šâ€œæ—¶é—´â€ã€â€œäº‹ä»¶â€ã€â€œçŠ¶æ€â€ è¿›è¡Œæ¨¡æ‹Ÿ - è¿‡æ¡¥çš„æ—¶é—´ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰</h1><h3>å¦‚ä½•è§£æ¨¡æ‹Ÿé¢˜</h3>
<p>è¿™ä¸ªé¢˜ç›®å±äºä¸€ç±»å…¸å‹çš„æ¨¡æ‹Ÿé¢˜ï¼šè®©ä½ å» <strong>æ¨¡æ‹Ÿä¸€ä¸ªè¿‡ç¨‹</strong>ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹ä¸€èˆ¬æ˜¯æŒ‰ç…§ <strong>æ—¶é—´é¡ºåº</strong> å»æ‰§è¡Œã€‚<br>
å¯¹äºæ­¤ç±»é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æŠ“ä½å…¶å…³é”®ç‚¹ï¼š</p>
<ol>
<li>å½“å‰æˆ‘ä»¬æ­£åœ¨å…³æ³¨çš„ <strong>æ—¶é—´</strong>ï¼›</li>
<li>åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆ <strong>äº‹ä»¶</strong>ï¼›</li>
<li>åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œé¢˜ç›®æ‰€æè¿°çš„ç¯å¢ƒçš„ <strong>çŠ¶æ€</strong>ã€‚</li>
</ol>
<p>æˆ‘åœ¨å½“å‰ ã€Œæ—¶é—´ã€ï¼Œå¤„ç†å®Œè¿™ä¸ªæ—¶é—´ç‚¹åŠå…¶ä¹‹å‰æ‰€å‘ç”Ÿçš„ ã€Œäº‹ä»¶ã€ï¼Œäº‹ä»¶ä¼šå¯¼è‡´ ã€ŒçŠ¶æ€ã€ çš„æ›´æ–°ï¼‰
ç„¶ååŸºäºå½“å‰çš„ ã€ŒçŠ¶æ€ã€ï¼Œå»æŒ‰ç…§è§„åˆ™åšç›¸åº”çš„ ã€Œå†³ç­–ã€ã€‚
å†³ç­–å®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹ä¸´è¿‘çš„ä¸‹ä¸€ä¸ªæ—¶é—´ã€‚</p>
<h3>æœ¬é¢˜è§£æ³•</h3>
<p>å¯¹äºæœ¬é¢˜ï¼Œå…¶å„ä¸ªè¦ç´ å…·ä½“è¡¨ç°å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ—¶é—´ - è¿™ä¸ªæ— éœ€è¿›ä¸€æ­¥è¯´æ˜ï¼›</li>
<li>äº‹ä»¶ - åˆ†æé¢˜ç›®ï¼Œå¯ä»¥å‘ç°æœ‰ 4 ç§å¯èƒ½çš„äº‹ä»¶ï¼š
<ul>
<li>æœ‰å·¥äººåˆ°è¾¾å³å²¸ï¼Œå¼€å§‹æ‹¿æ—§ä»“åº“çš„ç®±å­ï¼›</li>
<li>æœ‰å·¥äººæ‹¿å®Œäº†æ—§ä»“åº“çš„ç®±å­ï¼Œç­‰å¾…å›å·¦å²¸ï¼›</li>
<li>æœ‰å·¥äººåˆ°è¾¾äº†å·¦å²¸ï¼Œå¼€å§‹æ”¾æ–°ä»“åº“çš„ç®±å­ï¼›</li>
<li>æœ‰å·¥äººæŠŠç®±å­æ”¾åˆ°äº†æ–°ä»“åº“ï¼Œå®Œæˆæ¬è¿ï¼Œè¿”å›æ²³å·¦å²¸ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li>
</ul>
</li>
<li>çŠ¶æ€ - åˆ†æé¢˜ç›®ï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜ 5 ä¸ªçŠ¶æ€ï¼š
<ul>
<li>ä½äºæ²³å·¦å²¸ã€ç­‰å¾…è¿‡æ²³åˆ°å³å²¸çš„å·¥äººåˆ—è¡¨ï¼›</li>
<li>ä½äºæ²³å³å²¸ã€ç­‰å¾…è¿‡æ²³åˆ°å·¦å²¸çš„å·¥äººåˆ—è¡¨ï¼›</li>
<li>å½“å‰æ¡¥ä¸Šæ˜¯å¦æœ‰äººæ­£åœ¨è¿‡æ²³ï¼›</li>
<li>å½“å‰å°šéœ€æ¬è¿çš„ç®±å­æ•°ç›®ï¼›</li>
<li>å½“å‰å·²ç»å›åˆ°å·¦å²¸çš„ç®±å­æ•°ç›®ã€‚</li>
</ul>
</li>
<li>å†³ç­– - åœ¨æ¯ä¸ªæ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ® çŠ¶æ€ å’Œé¢˜ç›®è¦æ±‚è¿›è¡Œå†³ç­–ï¼š
<ul>
<li>å¦‚æœå½“å‰æ¡¥ä¸Šæœ‰äººï¼Œæˆ‘ä»¬ä¸èƒ½å®‰æ’äººè¿‡æ²³ï¼›</li>
<li>å¦‚æœå½“å‰æ¡¥ä¸Šæ²¡äººï¼Œä½†æ˜¯æœ‰å³å²¸çš„å·¥äººéœ€è¦è¿‡æ²³ï¼Œé‚£ä¹ˆä»å³å²¸çš„å·¥äººä¸­é€‰æ‹©æ•ˆç‡æœ€ä½çš„å·¥äººï¼ˆç”¨ä¼˜å…ˆé˜Ÿåˆ—é€‰æ‹©ï¼‰ï¼Œä»¤å…¶å›åˆ°å·¦å²¸ï¼›</li>
<li>å¦‚æœå½“å‰æ¡¥ä¸Šæ²¡äººï¼Œä¸”æ²¡æœ‰å³å²¸å·¥äººéœ€è¦è¿‡æ²³ï¼Œä½†æ˜¯æœ‰å·¦å²¸å·¥äººå¯ä»¥è¿‡æ²³ï¼Œä¸”æœ‰å‰©ä½™å°šéœ€æ¬è¿çš„ç®±å­ï¼Œé‚£ä¹ˆä»å·¦å²¸å·¥äººä¸­é€‰æ‹©æ•ˆç‡æœ€ä½çš„å·¥äººï¼ˆç”¨ä¼˜å…ˆé˜Ÿåˆ—é€‰æ‹©ï¼‰ï¼Œä»¤å…¶åˆ°å³å²¸æ¬ç®±å­ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h1>è¯»ã€Šç»æµå­¦åŸç† - å¾®è§‚ç»æµå­¦åˆ†å†Œã€‹</h1><h4>ç»æµå­¦åå¤§åŸç†</h4>
<p><strong>åŸç†ä¸€ï¼š ç¤¾ä¼šé¢ä¸´çš„ä¸€ç§æƒè¡¡å–èˆæ˜¯æ•ˆç‡å’Œå¹³ç­‰ä¹‹é—´çš„é€‰æ‹©
åŸç†äºŒï¼š æŸç§ä¸œè¥¿çš„æˆæœ¬æ˜¯ä¸ºäº†å¾—åˆ°å®ƒæ‰€æ”¾å¼ƒçš„ä¸œè¥¿</strong> ä¸€ç§ä¸œè¥¿çš„æœºä¼šæˆæœ¬æ˜¯ä¸ºäº†å¾—åˆ°è¿™ç§ä¸œè¥¿æ‰€å¿…é¡»æ”¾å¼ƒçš„ä¸œè¥¿ã€‚
<strong>åŸç†ä¸‰ï¼š ç†æ€§äººè€ƒè™‘è¾¹é™…é‡</strong> è¾¹é™…æˆæœ¬ï¼ˆMarginal Costï¼‰
<strong>åŸç†å››ï¼š äººä»¬ä¼šå¯¹æ¿€åŠ±åšå‡ºååº”</strong> åœ¨åˆ†æä»»ä½•ä¸€ç§æ”¿ç­–æ—¶ï¼Œåº”è¯¥è€ƒè™‘å®ƒé€šè¿‡æ¿€åŠ±äº§ç”Ÿçš„ä¸å¤ªæ˜æ˜¾çš„é—´æ¥å½±å“ã€‚
<strong>åŸç†äº”: è´¸æ˜“å¯ä»¥ä½¿æ¯ä¸ªäººçš„çŠ¶å†µéƒ½å˜å¾—æ›´å¥½</strong>
<strong>åŸç†å…­ï¼š å¸‚åœºé€šå¸¸æ˜¯ç»„ç»‡ç»æµæ´»åŠ¨çš„ä¸€ç§å¥½æ–¹æ³•</strong>
<strong>åŸç†ä¸ƒï¼š æ”¿åºœæœ‰æ—¶å¯ä»¥æ”¹å–„å¸‚åœºç»“æœ</strong>
<strong>åŸç†å…«ï¼š ä¸€å›½çš„ç”Ÿæ´»æ°´å¹³å–å†³äºå®ƒç”Ÿäº§ç‰©å“ä¸æœåŠ¡çš„èƒ½åŠ›</strong>
<strong>åŸç†ä¹ï¼š å½“æ”¿åºœå‘è¡Œäº†è¿‡å¤šçš„è´§å¸æ—¶ï¼Œ ç‰©ä»·ä¸Šå‡</strong> åœ¨å¤§å¤šæ•°ä¸¥é‡æˆ–æŒç»­çš„é€šè´§è†¨èƒ€æƒ…å†µä¸‹ï¼Œ ç½ªé­ç¥¸é¦–æ˜¯è´§å¸é‡çš„å¢é•¿ã€‚ (æ„Ÿæƒ³ï¼š è´§å¸è¶…å‘å¼•èµ·çš„é€šè´§è†¨èƒ€å…¶å®æ˜¯ä¸€ç§å…¨é¢å¾ç¨è¡Œä¸º)
<strong>åŸç†åï¼š ç¤¾ä¼šé¢ä¸´é€šè´§è†¨èƒ€ä¸å¤±ä¸šä¹‹é—´çš„çŸ­æœŸæƒè¡¡å–èˆ</strong></p>
<h4>åƒç»æµå­¦å®¶ä¸€æ ·æ€è€ƒ</h4>
<p>æ‰€æœ‰æ”¿ç­–å†³ç­–éƒ½ä¸æ˜¯è½»è€Œæ˜“ä¸¾æˆ–åˆ©å¼Šåˆ†æ˜çš„</p>
<ul>
<li>ä¸€é¡¹èƒ½å¤Ÿæé«˜æ•ˆç‡çš„æ”¿ç­–å¯èƒ½ä¼šä»¥æŸå®³å¹³ç­‰ä¸ºä»£ä»·ã€‚</li>
<li>ä¸€é¡¹æœ‰åˆ©äºå­å­™åä»£çš„æ”¿ç­–å¯èƒ½ä¼šæŸå®³å½“å‰ä¸€ä»£äººçš„åˆ©ç›Šã€‚</li>
</ul>
<p>ç»æµå­¦å®¶æ„è§åˆ†æ­§çš„åŸå› ä¸»è¦æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>ä¸åŒçš„ç†è®º</li>
<li>ä¸åŒçš„ä»·å€¼è§‚ï¼Œ</li>
</ul>
<h4>ç›¸äº’ä¾å­˜æ€§ä¸è´¸æ˜“çš„å¥½å¤„</h4>
<p>ä¸€ä¸ªäººæœ‰å¯èƒ½åœ¨ä¸¤ç§ç‰©å“çš„ç”Ÿäº§ä¸Šéƒ½å…·æœ‰ç»å¯¹ä¼˜åŠ¿ï¼Œ ä½†ä¸å¯èƒ½åœ¨ä¸¤ç§ç‰©å“çš„ç”Ÿäº§ä¸Šéƒ½æœ‰æ¯”è¾ƒä¼˜åŠ¿ã€‚
ä¸€ç§ç‰©å“çš„æœºä¼šæˆæœ¬æ˜¯å¦ä¸€ç§ç‰©å“æœºä¼šæˆæœ¬çš„å€’æ•°ï¼Œ
å¦‚æœä¸€ä¸ªäººç”Ÿäº§ä¸€ç§ç‰©å“çš„æœºä¼šæˆæœ¬è¾ƒé«˜ï¼Œ é‚£ä¹ˆä»–ç”Ÿäº§å¦ä¸€ç§ç‰©å“çš„æœºä¼šæˆæœ¬å¿…ç„¶è¾ƒä½ã€‚ æ¯”è¾ƒä¼˜åŠ¿ååº”äº†ç›¸å¯¹çš„æœºä¼šæˆæœ¬ã€‚</p>
<p>ä¸“ä¸šåŒ–å’Œè´¸æ˜“çš„å¥½å¤„ä¸æ˜¯åŸºäºç»å¯¹ä¼˜åŠ¿ï¼Œ è€Œæ˜¯åŸºäºæ¯”è¾ƒä¼˜åŠ¿ã€‚
å½“æ¯ä¸ªäººéƒ½ä¸“é—¨ç”Ÿäº§è‡ªå·±æœ‰æ¯”è¾ƒä¼˜åŠ¿çš„ç‰©å“æ—¶ï¼Œ ç»æµçš„æ€»é‡å°±å¢åŠ äº†ï¼Œ ç»æµè›‹ç³•çš„å˜å¤§å¯ç”¨äºæ”¹å–„æ¯ä¸ªäººçš„çŠ¶å†µã€‚</p>
<p>è´¸æ˜“çš„åŒæ–¹å› ä¸ºä¸“ä¸šæ€§çš„åŸå› ï¼Œ éƒ½å¯ä»¥åœ¨è‡ªå·±ä¸“ä¸šçš„æœºä¼šæˆæœ¬ä¸Šè¿›è¡Œè®®ä»·å‡ºå”®ï¼Œ åªè¦è¿›è¡Œè´¸æ˜“çš„ä»·æ ¼ä½äº<strong>è‡ªå·±ç”Ÿäº§</strong>æŸç§ç‰©å“çš„æœºä¼šæˆæœ¬ï¼Œ è´¸æ˜“åŒæ–¹éƒ½å¯ä»¥è·ç›Šã€‚</p>
<p>å¦‚æœè´­ä¹°ä¸€ä»¶ä¸œè¥¿æ‰€ä»˜å‡ºçš„ä»£ä»·æ¯”åœ¨å®¶é‡Œç”Ÿäº§æ‰€ä»˜å‡ºçš„ä»£ä»·å°ï¼Œ å°±æ°¸è¿œä¸è¦åœ¨å®¶é‡Œç”Ÿäº§ï¼Œ è¿™æ˜¯æ¯ä¸€ä¸ªç²¾æ˜çš„å®¶é•¿éƒ½çŸ¥é“çš„å‡†åˆ™ã€‚</p>
<p>ä¸ºäº†ä½¿ä½ å®¶åº­çš„æ•ˆç‡å®ç°â€˜æœ€ä¼˜â€™ï¼Œ ä½ åº”è¯¥ä½¿æ¯ä¸ªäºº<strong>æœ€å</strong>æ‰€åšçš„ä¸€é¡¹å·¥ä½œçš„æ•ˆç‡ç›¸ç­‰ã€‚ ä½ çš„é…å¶æ´—ç¢—ã€ å‰ªè‰åªã€ åˆ—å‡ºè´­ç‰©æ¸…å•ï¼Œ ä½ åšé¥­ã€ æ´—è¡£ã€ è´­ç‰©ã€ äº²æ‰«ã€ æ”¯ä»˜è´¦å•ã€‚ è¿™å¯èƒ½çœ‹èµ·æ¥ä¸å¹³è¡¡ï¼Œ ä½†æƒ³ä¸€æƒ³ï¼Œ å½“ä½ çœ‹åˆ°ä½ çš„é…å¶åœ¨åˆ—è´­ç‰©æ¸…å•æ—¶å°±å·²ç»è¡£è¡«ä¸æ•´åœ°ååœ¨é‚£é‡Œå¼€å§‹æ‰“ç›¹äº†ï¼Œ ä½ å°±åº”è¯¥çŸ¥é“ä»–èƒ½æŠŠä½ ä»¬éœ€è¦å¤šå°‘ç‰›å¥¶ç®—å‡ºæ¥å°±å·²ç»å¾ˆä¸é”™äº†ã€‚</p>
<h4>å¸‚åœºå¦‚ä½•è¿è¡Œ</h4>
<p>å½“æ”¶å…¥å‡å°‘æ—¶ï¼Œ å¦‚æœä¸€ç§ç‰©å“çš„éœ€æ±‚é‡å¢åŠ ï¼Œ è¿™ç§ç‰©å“å°±è¢«ç§°ä¸ºä½æ¡£ç‰©å“ã€‚ ä½æ¡£ç‰©å“çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯å…¬å…±æ±½è½¦ã€‚
å½“ä¸€ç§ç‰©å“ä»·æ ¼ä¸‹é™å¼•èµ·å¦å¤–ä¸€ç§ç‰©å“çš„éœ€æ±‚å‡å°‘æ—¶ï¼Œ è¿™ä¸¤ç§ç‰©å“è¢«ç§°ä¸ºæ›¿ä»£å“ã€‚
å½“ä¸€ç§ç‰©å“çš„ä»·æ ¼ä¸‹é™å¼•èµ·å¦å¤–ä¸€ç§ç‰©å“çš„éœ€æ±‚é‡å¢åŠ æ—¶ï¼Œ è¿™ä¸¤ç§ç‰©å“è¢«ç§°ä¸ºäº’è¡¥å“ã€‚</p>
<h4>å¼¹æ€§åŠå…¶åº”ç”¨</h4>
<p>ä¸€ç§ç‰©å“æ—¶å¿…éœ€å“è¿˜æ˜¯å¥¢ä¾ˆå“å¹¶ä¸å–å†³äºç‰©å“æœ¬èº«å›ºæœ‰çš„æ€§è´¨ï¼Œ è€Œå–å†³äºè´­ä¹°è€…çš„åå¥½ã€‚
å¯¹äºä¸€ä¸ªçƒ­è¡·äºèˆªæµ·è€Œä¸å¤ªå…³æ³¨è‡ªèº«å¥åº·çš„æ°´æ‰‹æ¥è¯´ï¼Œ æ¸¸è‰‡å¯èƒ½æ˜¯éœ€æ±‚ç¼ºä¹å¼¹æ€§çš„å¿…éœ€å“ï¼Œ è€Œçœ‹ç—…åˆ™æ˜¯éœ€æ±‚å¯Œæœ‰å¼¹æ€§çš„å¥¢ä¾ˆå“ã€‚</p>
<h4>ä¾›ç»™ã€ éœ€æ±‚ä¸æ”¿åºœæ”¿ç­–</h4>
<p>å½“æ”¿åºœå¯¹ç«äº‰å¸‚åœºå®è¡Œé™åˆ¶æ€§ä»·æ ¼ä¸Šé™æ—¶ï¼Œ å¸‚åœºå°±äº§ç”Ÿäº†ç‰©å“çš„çŸ­ç¼ºï¼Œ è€Œä¸”å–è€…å¿…é¡»åœ¨å¤§é‡æ½œåœ¨çš„ä¹°è€…ä¸­é…ç»™ç¨€ç¼ºç‰©å“ã€‚ è¿™ç§åœ¨ä»·æ ¼ä¸Šé™åˆ¶æ”¿ç­–ä¸‹äº§ç”Ÿçš„é…ç»™æœºåˆ¶å¾ˆå°‘æ˜¯åˆæ„çš„ã€‚ æ’é•¿é˜Ÿæ˜¯æ— æ•ˆç‡çš„ï¼Œ å› ä¸ºè¿™æ ·åšæµªè´¹äº†ä¹°è€…çš„æ—¶é—´ã€‚</p>
<p>ç¨æ”¶çš„è´Ÿæ‹…æ›´å¤šåœ°è½åˆ°ç¼ºä¹å¼¹æ€§çš„å¸‚åœºä¸€æ–¹èº«ä¸Šã€‚ åŠ³åŠ¨çš„ä¾›ç»™è¿œæ¯”åŠ³åŠ¨çš„éœ€æ±‚ç¼ºä¹å¼¹æ€§ã€‚ è¿™å°±æ„å‘³ç€ï¼Œ æ˜¯å·¥äººè€Œä¸æ˜¯ä¼ä¸šæ‰¿æ‹…äº†å¤§éƒ¨åˆ†å·¥è–ªç¨çš„è´Ÿæ‹…ã€‚ æ¢å¥è¯è¯´ï¼Œ å…¶ç¨æ”¶è´Ÿæ‹…çš„åˆ†é…ä¸ç«‹æ³•è€…æ‰€æœŸæœ›çš„ä¸€åŠå¯¹ä¸€åŠç›¸å·®ç”šè¿œã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ 1990 å¹´ï¼Œ å›½ä¼šé€šè¿‡äº†ä¸€é¡¹é’ˆå¯¹æ¸¸è‰‡ã€ ç§äººé£æœºã€ çš®è¡£ã€ ç å®å’Œè±ªåè½¿è½¦è¿™ç±»ç‰©å“çš„æ–°çš„å¥¢ä¾ˆå“ç¨ã€‚ è¯¥ç¨çš„ç›®çš„æ˜¯å¢åŠ é‚£äº›èƒ½è½»è€Œæ˜“ä¸¾åœ°æ‰¿æ‹…ç¨æ”¶è´Ÿæ‹…çš„äººçš„ç¨æ”¶ã€‚ ä½†äº‹ä¸æ„¿è¿ï¼Œ æ¸¸è‰‡çš„éœ€æ±‚æ˜¯æå…¶å¯Œæœ‰å¼¹æ€§çš„ã€‚ ä¸€ä¸ªç™¾ä¸‡å¯Œç¿å¾ˆå®¹æ˜“ä¸ä¹°æ¸¸è‰‡ï¼Œ ä»–å¯ä»¥ç”¨é’±å»ä¹°æ›´å¤§çš„æˆ¿å­ï¼Œ å»æ¬§æ´²åº¦å‡ç­‰ç­‰ã€‚ å› æ­¤ç¨æ”¶è´Ÿæ‹…å°†ä¸»è¦è½åœ¨ä¾›ç»™è€…èº«ä¸Šã€‚ è¿™å°±æ˜¯è¯´ï¼Œ å¯¹æ¸¸è‰‡çš„å¾ç¨çš„è´Ÿæ‹…ä¸»è¦è½åœ¨å»ºé€ æ¸¸è‰‡çš„ä¼ä¸šå’Œå·¥äººèº«ä¸Šï¼Œ å› ä¸ºæœ€åæ˜¯ä»–ä»¬çš„äº§å“ä»·æ ¼å¤§å¹…åº¦ä¸‹é™äº†ã€‚ ä½†æ˜¯ï¼Œ å·¥äººå¹¶ä¸æ˜¯å¯Œäººã€‚ å› æ­¤ï¼Œ è¿™ä¸€å¥¢ä¾ˆç¨çš„ç¨æ”¶è´Ÿæ‹…æ›´å¤šçš„è½åœ¨äº†ä¸­äº§é˜¶çº§èº«ä¸Šï¼Œ è€Œä¸æ˜¯å¯Œäººèº«ä¸Šã€‚</p>
<h4>ç¨æ”¶çš„ä»£ä»·</h4>
<p>ç¨æ”¶åœ¨ä¹°è€…æ”¯ä»˜çš„ä»·æ ¼å’Œå–è€…å¾—åˆ°çš„ä»·æ ¼ä¹‹é—´æ‰“å…¥äº†ä¸€ä¸ªæ¥”å­ã€‚
ç”±äºè¿™ç§ç¨æ”¶æ¥”å­ï¼Œ é”€å”®é‡ä½äºæ²¡æœ‰ç¨æ”¶æ—¶åº”è¯¥è¾¾åˆ°çš„æ°´å¹³ã€‚ æ¢å¥è¯è¯´ï¼Œ å¯¹ä¸€ç§ç‰©å“å¾ç¨ä½¿è¿™ç§ç‰©å“çš„å¸‚åœºè§„æ¨¡ç¼©å°</p>
<h4>å›½é™…è´¸æ˜“</h4>
<p>å„å›½ä¹‹é—´è´¸æ˜“æœ€ç»ˆè¦å»ºç«‹åœ¨æ¯”è¾ƒä¼˜åŠ¿çš„åŸºç¡€ä¹‹ä¸Šã€‚ è¿™å°±æ˜¯è¯´ï¼Œ è´¸æ˜“ä¹‹æ‰€ä»¥æ˜¯äº’æƒ çš„ï¼Œ æ˜¯å› ä¸ºå®ƒä½¿å„å›½å¯ä»¥ä¸“é—¨ä»äº‹è‡ªå·±æœ€æ“…é•¿çš„äº’åŠ¨ã€‚</p>
<p>æ— è®ºæ˜¯å…³ç¨è¿˜æ˜¯è¿›å£é…é¢ï¼Œ å®ƒä»¬éƒ½å‡å°‘äº†è¿›å£å“çš„æ•°é‡ï¼Œ æé«˜äº†è¯¥ç‰©å“çš„å›½å†…ä»·æ ¼ï¼Œ å‡å°‘äº†å›½å†…æ¶ˆè´¹è€…çš„ç¦åˆ©ï¼Œ å¢åŠ äº†å›½å†…ç”Ÿäº§è€…çš„ç¦åˆ©ï¼Œ å¹¶å¼•èµ·æ— ç•æŸå¤±ã€‚ è¿™ä¸¤ç§è´¸æ˜“é™åˆ¶ä¹‹é—´çš„å”¯ä¸€åŒºåˆ«æ˜¯ï¼š å…³ç¨å¢åŠ äº†æ”¿åºœçš„æ”¶å…¥ï¼Œ è€Œè¿›å£é…é¢ä¸ºé‚£äº›å¾—åˆ°è¿›å£è®¸å¯è¯çš„äººåˆ›é€ äº†å‰©ä½™ã€‚</p>
<p>ç»æµå­¦å®¶æ‰¿è®¤ï¼Œ å‡ºäºå¯¹å›½å®¶å®‰å…¨çš„åˆç†è€ƒè™‘ï¼Œ ä¿æŠ¤å…³é”®è¡Œä¸šå¯èƒ½æ˜¯åˆç†çš„ã€‚ ä½†ä»–ä»¬æ‹…å¿ƒï¼Œ è¿™ç§è§‚ç‚¹å¾ˆå¿«ä¼šè¢«é‚£äº›æ¸´æœ›ä»¥æŸå®³æ¶ˆè´¹è€…åˆ©ç›Šä¸ºä»£ä»·è€Œç‰Ÿåˆ©çš„ç”Ÿäº§è€…æ‰€åˆ©ç”¨ã€‚ å½“å›½å®¶å®‰å…¨è®ºçš„è§‚ç‚¹æ˜¯ç”±è¡Œä¸šä»£è¡¨è€Œä¸æ˜¯å›½é˜²æœºæ„æå‡ºæ—¶ï¼Œ å°±åº”è¯¥è°¨æ…çœ‹å¾…ã€‚</p>
<h5>å¹¼ç¨šäº§ä¸šè®º</h5>
<p>æ–°å…´äº§ä¸šæœ‰æ—¶è®¤ä¸ºï¼Œ åº”å®è¡Œæš‚æ—¶æ€§è´¸æ˜“é™åˆ¶ï¼Œ ä»¥æœ‰åŠ©äºè¯¥äº§ä¸šçš„æˆé•¿ã€‚ è¿™ç§è§‚ç‚¹è®¤ä¸ºï¼Œ åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„ä¿æŠ¤æœŸä»¥åï¼Œ è¿™äº›äº§ä¸šæˆç†Ÿäº†ï¼Œ ä¹Ÿå°±èƒ½ä¸å¤–å›½ä¼ä¸šç«äº‰äº†ã€‚ åŒæ ·ï¼Œ è€äº§ä¸šæœ‰æ—¶ä¹Ÿè®¤ä¸ºï¼Œ å®ƒä»¬éœ€è¦æš‚æ—¶æ€§ä¿æŠ¤ï¼Œ ä»¥æœ‰åŠ©äºå®ƒä»¬å¯¹æ–°æƒ…å†µåšå‡ºè°ƒæ•´ã€‚</p>
<p>è®¸å¤šç»æµå­¦å®¶ä»ç†è®ºä¸Šæ€€ç–‘å¹¼ç¨šäº§ä¸šè®ºã€‚ ä¾‹å¦‚ï¼Œ å‡è®¾ä¸€ä¸ªäº§ä¸šæ˜¯æ–°å…´çš„ï¼Œ ä¸èƒ½åœ¨ä¸å¤–å›½ç«äº‰å¯¹æ‰‹çš„ç«äº‰ä¸­è·åˆ©ï¼Œ ä½†ç”±ç†ç”±ç›¸ä¿¡è¯¥äº§ä¸šåœ¨é•¿æœŸä¸­æ˜¯æœ‰åˆ©å¯å›¾çš„ï¼Œ é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ è¿™äº›ä¼ä¸šçš„æ‰€æœ‰è€…åº”è¯¥æ„¿æ„ä¸ºå®ç°æœ€ç»ˆçš„åˆ©æ¶¦è€Œæ‰¿å—æš‚æ—¶çš„äºæŸã€‚ ä¿æŠ¤å¹¶ä¸æ˜¯ä¸€ä¸ªå¹¼ç¨šäº§ä¸šæˆé•¿æ‰€å¿…éœ€çš„ã€‚ å†å²è¡¨æ˜ï¼Œ å³ä½¿æ²¡æœ‰é¿å…ç«äº‰çš„ä¿æŠ¤ï¼Œ åˆåˆ›ä¼ä¸šè™½ç„¶å¾€å¾€ä¼šç»å†æš‚æ—¶çš„äºæŸï¼Œ ä½†åœ¨é•¿æœŸä¸­ä¼šå–å¾—æˆåŠŸã€‚</p>
<h4>å…¬å…±éƒ¨é—¨ç»æµå­¦</h4>
<p>ä¸ºäº†åˆ¶å®šå‡ºè‰¯å¥½çš„è§„åˆ™ï¼Œ æ”¿åºœç®¡åˆ¶è€…éƒ½éœ€è¦äº†è§£æœ‰å…³æŸäº›ç‰¹å®šè¡Œä¸šä»¥åŠè¿™äº›è¡Œä¸šå¯ä»¥é‡‡ç”¨çš„å„ç§æŠ€æœ¯çš„è¯¦ç»†ä¿¡æ¯ï¼Œ ä½†æ”¿åºœç®¡åˆ¶è€…è¦å¾—åˆ°è¿™äº›ä¿¡æ¯å¾€å¾€æ˜¯å›°éš¾çš„ã€‚</p>
<p>äººä»¬é¢ä¸´æƒè¡¡å–èˆï¼Œ æ¸…æ–°çš„ç©ºæ°”å’Œæ¸…æ´çš„æ°´è‚¯å®šæ˜¯æœ‰ä»·å€¼çš„ã€‚
ä½†æ˜¯å¿…é¡»æŠŠå®ƒä»¬çš„ä»·å€¼ä¸å…¶æœºä¼šæˆæœ¬è¿›è¡Œæƒè¡¡å–èˆï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ ä¸ä¸ºäº†å¾—åˆ°å®ƒä»¬è€Œå¿…é¡»æ”¾å¼ƒçš„ä¸œè¥¿ç›¸æ¯”è¾ƒã€‚
æ¶ˆé™¤æ‰€æœ‰æ±¡æŸ“æ˜¯ä¸å¯èƒ½çš„ã€‚ å¦‚æœæƒ³è¦æ¶ˆé™¤æ‰€æœ‰æ±¡æŸ“ï¼Œ å°±ä¸å¾—ä¸æŠŠè®¸å¤šä½¿æˆ‘ä»¬äº«æœ‰é«˜ç”Ÿæ´»æ°´å¹³çš„æŠ€æœ¯è¿›æ­¥å€’é€€å›å»</p>
<p>å¯Œå›½æ¯”ç©·å›½æ›´æœ‰èƒ½åŠ›ç»´æŒæ›´æ¸…æ´çš„ç¯å¢ƒï¼Œ å› æ­¤é€šå¸¸ä¹Ÿæœ‰æ›´ä¸¥æ ¼çš„ç¯å¢ƒä¿æŠ¤ã€‚ç¯å¢ƒä¿æŠ¤çš„ä»·æ ¼è¶Šä½ï¼Œ å…¬ä¼—å°±è¶Šæƒ³è¦ä¿æŠ¤ç¯å¢ƒã€‚</p>
<h4>å…¬å…±ç‰©å“å’Œå…¬å…±èµ„æº</h4>
<p>å¤å¸Œè…Šå“²å­¦å®¶äºšé‡Œå£«å¤šå¾·å°±æŒ‡å‡ºäº†å…¬å…±èµ„æºçš„é—®é¢˜ï¼š å¤§å®¶å…¬æœ‰çš„ä¸œè¥¿æ€»æ˜¯è¢«å…³å¿ƒå¾—æœ€å°‘ï¼Œ å› ä¸ºæ‰€æœ‰äººå¯¹è‡ªå·±ä¸œè¥¿çš„å…³å¿ƒéƒ½å¤§äºå¯¹ä¸å…¶ä»–äººå…±åŒæ‹¥æœ‰çš„ä¸œè¥¿çš„å…³å¿ƒã€‚</p>
<p>å‡ åå¹´æ¥ï¼Œ ç»æµå­¦å®¶å’Œå…¶ä»–äº¤é€šå­¦è€…ä¸€ç›´å»ºè®®æ ¹æ®é“è·¯çš„æ‹¥å µæƒ…å†µè¿›è¡Œä¸åŒç¨‹åº¦çš„æ”¶è´¹ã€‚ ç®€è€Œè¨€ä¹‹ï¼Œ å°±æ˜¯äº¤é€šè¶Šæ‹¥å µï¼Œ æ”¶è´¹å°±è¶Šé«˜ï¼Œ ç›´è‡³æ‹¥å µæ¶ˆå¤±ã€‚</p>
<p>å½“ä½ ä¸ºæŸç§ç‰©å“ - åœ¨æœ¬æ¡ˆä¾‹é‡Œæ˜¯é“è·¯è¡Œé©¶ç©ºé—´ - å‡ºä»·æ—¶ï¼Œ å¦‚æœä½ çš„å‡ºä»·ä½äºç‰©å“çš„çœŸå®ä»·å€¼ï¼Œ å°±ä¼šå‡ºç°çŸ­ç¼ºã€‚ è¿™æ—¶ä¸€ä¸ªåŸºæœ¬çš„ç»æµå­¦ç†è®ºã€‚</p>
<p>æ¢ä¸€ç§æ–¹å¼æ¥æ€è€ƒï¼Œ å»¶è¯¯æ˜¯å¸æœºç»™ä»–çš„åŒè¡Œä»¬å¸¦æ¥çš„ä¸€ç§å¤–éƒ¨æ€§ã€‚ ç”±äºå¼€è½¦è¿›å…¥ç¹å¿™çš„é“è·¯è€Œå¼•èµ·æ‹¥å µï¼Œ å¸æœºä½¿å…¶ä»–äººæ”¾æ…¢äº†é€Ÿåº¦ï¼Œ ä½†ä»–ä»¬ä¸ç”¨ä¸ºæ­¤ä»˜è´¹ï¼Œ è‡³å°‘æ²¡æœ‰ç›´æ¥ä»˜è´¹ã€‚ å½“ç„¶ç»“æœæ˜¯æ¯ä¸ªäººéƒ½ä»˜äº†è´¹ï¼Œ å› ä¸ºåœ¨æˆ‘ä»¬ç»™å…¶ä»–äººå¸¦æ¥æ‹¥å µæ—¶ï¼Œ å…¶ä»–äººä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†æ‹¥å µã€‚ è¿™å°±é™·å…¥äº†ä¸€åœºæ²¡æœ‰èµ¢å®¶çš„åšå¼ˆã€‚</p>
<p>å¤§å¤šæ•°äººå¯¹æ—¶é—´çš„è¯„ä»·åœ¨ä¸åŒæƒ…å†µä¸‹å·®åˆ«å¾ˆå¤§ï¼Œ è¿™å–å†³äºä»–ä»¬é‚£å¤©è¦å¹²ä»€ä¹ˆäº‹ã€‚  æ”¶è´¹èµ‹äºˆäº†ä½ æŒ‰ç…§è‡ªå·±çš„æ—¶é—´è¡¨åˆ¶å®šå‡ºè¡Œæˆæœ¬çš„æƒåˆ©ï¼Œ ä»è€Œç»™ä½ çš„ç”Ÿæ´»å¸¦æ¥æ›´é«˜çš„çµæ´»æ€§å’Œè‡ªç”±åº¦ã€‚</p>
<h4>ç”Ÿäº§æˆæœ¬</h4>
<p>å¦‚æœä¸€ä¸ªä¼ä¸šæƒ³ä½¿è‡ªå·±å·¥äººçš„ç”Ÿäº§ç‡å°½å¯èƒ½åœ°é«˜ï¼Œ é‚£ä¹ˆä¸€èˆ¬æœ€å¥½æ˜¯è®©ä»–ä»¬æ¯ä¸ªäººéƒ½ä»äº‹è‡ªå·±æ‰€ç²¾é€šçš„æœ‰é™å·¥ä½œã€‚ ä½†åªæœ‰åœ¨ä¸€ä¸ªä¼ä¸šé›‡ä½£äº†å¤§é‡å·¥äººå¹¶ç”Ÿäº§å¤§é‡äº§å“æ—¶ï¼Œ è¿™ç§å·¥ä½œçš„ç»„ç»‡æ–¹å¼æ‰æ˜¯å¯èƒ½çš„ã€‚</p>
<h4>ç«äº‰å¸‚åœºä¸Šçš„ä¼ä¸š</h4>
<p>è¾¹é™…æˆæœ¬æ›²çº¿ï¼ˆMarginal Cost Curveï¼‰æ˜¯ä¸€ç§å›¾å½¢è¡¨ç¤ºï¼Œ ç”¨äºæè¿°åœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œ éšç€äº§é‡å¢åŠ ï¼Œ è¾¹é™…æˆæœ¬çš„å˜åŒ–æƒ…å†µã€‚
å®ƒæ˜¯ä¸€æ¡åœ¨äºŒç»´å¹³é¢ä¸Šçš„æ›²çº¿ï¼Œ æ¨ªåæ ‡è¡¨ç¤ºäº§é‡ï¼ˆQuantityï¼‰ï¼Œ çºµåæ ‡è¡¨ç¤ºè¾¹é™…æˆæœ¬ï¼ˆMarginal Costï¼‰ã€‚ è¾¹é™…æˆæœ¬æ›²çº¿é€šå¸¸ç”¨äºå¾®è§‚ç»æµå­¦å’Œä¼ä¸šå†³ç­–ä¸­ï¼Œ å¸®åŠ©åˆ†æç”Ÿäº§è¿‡ç¨‹ä¸­æˆæœ¬çš„å˜åŒ–ç‰¹å¾å’Œæœ€ä¼˜äº§é‡æ°´å¹³ã€‚</p>
<p>è¾¹é™…æˆæœ¬æ›²çº¿çš„å½¢çŠ¶å¯èƒ½å› äº§ä¸šã€ ç”Ÿäº§æŠ€æœ¯ã€ æˆæœ¬ç»“æ„ç­‰å› ç´ è€Œæœ‰æ‰€ä¸åŒã€‚ ç„¶è€Œï¼Œ é€šå¸¸æƒ…å†µä¸‹ï¼Œ è¾¹é™…æˆæœ¬æ›²çº¿å‘ˆç°ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>è¾¹é™…æˆæœ¬æ›²çº¿åˆå§‹é˜¶æ®µï¼Œ éšç€äº§é‡çš„å¢åŠ ï¼Œ è¾¹é™…æˆæœ¬å…ˆä¸‹é™ï¼Œ è¿™æ˜¯ç”±äºè§„æ¨¡ç»æµã€ åˆ†å·¥å’Œä¸“ä¸šåŒ–å¸¦æ¥çš„æˆæœ¬èŠ‚çº¦æ•ˆåº”ã€‚</li>
<li>è¾¹é™…æˆæœ¬æ›²çº¿æŸä¸€ç‚¹åå¼€å§‹ä¸Šå‡ï¼Œ éšç€äº§é‡çš„å¢åŠ ï¼Œ è¾¹é™…æˆæœ¬ä¸Šå‡ï¼Œ è¿™æ˜¯ç”±äºç”Ÿäº§è¿‡ç¨‹ä¸­çš„é€’å‡æŠ¥é…¬ã€ èµ„æºçº¦æŸå’Œæ•ˆç‡é™ä½ç­‰å› ç´ å¯¼è‡´çš„ã€‚</li>
</ol>
<p>è¾¹é™…æˆæœ¬æ›²çº¿é€šå¸¸å‘ˆç°å‡ºå…ˆä¸‹é™åä¸Šå‡çš„å½¢çŠ¶ï¼Œ å½¢è±¡åœ°åæ˜ äº†ç”Ÿäº§è¿‡ç¨‹ä¸­è¾¹é™…æˆæœ¬çš„å˜åŒ–è§„å¾‹ã€‚</p>
<p>æœ¬è´¨ä¸Šï¼Œ ç”±äºä¼ä¸šçš„è¾¹é™…æˆæœ¬æ›²çº¿å†³å®šäº†ä¼ä¸šåœ¨ä»»ä½•ä¸€ç§ä»·æ ¼æ—¶æ„¿æ„ä¾›ç»™çš„ç‰©å“æ•°é‡ï¼Œ å› æ­¤è¾¹é™…æˆæœ¬æ›²çº¿ä¹Ÿæ˜¯ç«äº‰ä¼ä¸šçš„ä¾›ç»™æ›²çº¿ã€‚</p>
<h4>å„æ–­ç«äº‰</h4>
<p>ä¼ä¸šå‡ºå”®çš„æ˜¯ç›¸åŒçš„äº§å“è¿˜æ˜¯æœ‰å·®å¼‚æ€§çš„äº§å“ï¼Ÿ å¦‚æœè¿™äº›ä¼ä¸šå‡ºå”®ç›¸åŒçš„äº§å“ï¼Œ é‚£ä¹ˆè¯¥å¸‚åœºå°±æ˜¯å®Œå…¨ç«äº‰çš„ï¼› å¦‚æœè¿™äº›ä¼ä¸šå‡ºå”®æœ‰å·®å¼‚çš„äº§å“ï¼Œ é‚£ä¹ˆè¯¥å¸‚åœºå°±æ˜¯å„æ–­ç«äº‰çš„ã€‚</p>
<p>å¹¿å‘Šçš„å†…å®¹æ˜¯æ— å…³ç´§è¦çš„ã€‚ å‡¯æ´›æ ¼é€šè¿‡å®ƒä¸ºå¹¿å‘Šä»˜è´¹çš„æ„æ„¿ä¼ é€’äº†å…¶äº§å“è´¨é‡çš„ä¿¡å·ã€‚ å¹¿å‘Šæœ¬èº«è¯´äº†ä»€ä¹ˆå¹¶ä¸å¦‚æ¶ˆè´¹è€…çŸ¥é“å¹¿å‘Šå¾ˆæ˜‚è´µè¿™ä¸€äº‹å®é‡è¦ã€‚ ä¼ä¸šä¹‹æ‰€ä»¥ä¼šä»˜ç»™è‘—åæ¼”å‘˜å¤§ç¬”çš„é’±æ¥åšå¹¿å‘Šï¼Œ è€Œä»è¡¨é¢ä¸Šçœ‹ï¼Œ è¿™äº›å¹¿å‘Šä¼¼ä¹åˆæ ¹æœ¬æ²¡æœ‰æä¾›ä»€ä¹ˆä¿¡æ¯ã€‚ ä¿¡æ¯å¹¶ä¸åœ¨äºå¹¿å‘Šçš„å†…å®¹ï¼Œ è€Œä»…ä»…åœ¨äºåšå¹¿å‘Šæœ¬èº«åŠå…¶æ˜‚è´µçš„ä»·æ ¼ã€‚</p>
<h4>å¯¡å¤´</h4>
<p>ç”±äºå¯¡å¤´å¸‚åœºä¸Šåªæœ‰å°‘æ•°å‡ å®¶ä¼ä¸šï¼Œ å› æ­¤æ¯ä¸€å®¶éƒ½å¿…é¡»æœ‰ç­–ç•¥åœ°è¡Œäº‹ã€‚
æ¯ä¸€å®¶ä¼ä¸šéƒ½çŸ¥é“ï¼Œ å®ƒçš„åˆ©æ¶¦ä¸ä»…å–å†³äºå®ƒç”Ÿäº§å¤šå°‘ï¼Œ è€Œä¸”è¿˜å–å†³äºå…¶ä»–ä¼ä¸šç”Ÿäº§å¤šå°‘ã€‚</p>
<h4>æ”¶å…¥ä¸æ­§è§†</h4>
<p>ç«äº‰å¸‚åœºåŒ…å«äº†ä¸€ç§è‡ªå‘çŸ«æ­£é›‡ä¸»æ­§è§†çš„æ–¹æ³•ã€‚
åªå…³å¿ƒåˆ©æ¶¦çš„ä¼ä¸šè¿›å…¥å¸‚åœºå€¾å‘äºæ¶ˆé™¤æ­§è§†æ€§å·¥èµ„å·®åˆ«ã€‚
åªæœ‰é¡¾å®¢æ„¿æ„ä¸ºæ­§è§†æ€§åšæ³•è¿›è¡Œæ”¯ä»˜æˆ–æ”¿åºœå¼ºåˆ¶æ­§è§†æ—¶ï¼Œ ç«äº‰å¸‚åœºä¸Šçš„è¿™ç§å·¥èµ„å·®åˆ«æ‰èƒ½æŒç»­ä¸‹å»ã€‚</p>
<h4>æ”¶å…¥ä¸å¹³ç­‰ä¸è´«å›°</h4>
<p>è‡ªç”±è‡³ä¸Šä¸»ä¹‰è€…çš„ç»“è®ºæ˜¯ï¼Œ æœºä¼šå¹³ç­‰æ¯”æ”¶å…¥å¹³ç­‰æ›´é‡è¦ã€‚ ä»–ä»¬è®¤ä¸ºï¼Œ æ”¿åºœåº”è¯¥è½å®ä¸ªäººçš„æƒåˆ©ï¼Œ ä»¥ç¡®ä¿æ¯ä¸ªäººéƒ½æœ‰åŒæ ·çš„å‘æŒ¥è‡ªå·±æ‰èƒ½å¹¶è·å¾—æˆåŠŸçš„æœºä¼šã€‚</p>
<p>å†³ç­–è€…é¢ä¸´å¹³ç­‰å’Œæ•ˆç‡ä¹‹é—´çš„æƒè¡¡å–èˆã€‚
å‡ ä¹æ¯ä¸€ä¸ªäººéƒ½åŒæ„çš„æœ‰å…³æ”¶å…¥åˆ†é…çš„ä¸€ä¸ªç»“è®ºï¼š è¶Šå¹³ç­‰åœ°åˆ†å‰²è›‹ç³•ï¼Œ è›‹ç³•å°±ä¼šå˜å¾—è¶Šå°ã€‚</p>
<h4>å¾®è§‚ç»æµå­¦å‰æ²¿</h4>
<p>æ”¿æ²»å®¶ä¹Ÿæ˜¯æœ‰ç›®æ ‡çš„ã€‚</p>
<p>æœ€å¥½çš„æ”¿æ²»é¢†å¯¼äººæ€»æ˜¯è¿½æ±‚æ•´ä¸ªç¤¾ä¼šçš„ç¦åˆ©ï¼Œ å³ä»–ä»¬çš„ç›®æ ‡æ˜¯æ•ˆç‡ä¸å¹³ç­‰çš„æœ€ä¼˜ç»“åˆã€‚
åˆ©å·±æ˜¯æ”¿æ²»æ´»åŠ¨è€…çš„å¼ºå¤§åŠ¨æœºï¼Œ
ä¸€äº›æ”¿æ²»å®¶çš„åŠ¨æœºæ˜¯æƒ³å†æ¬¡å½“é€‰ï¼Œ å› æ­¤ä»–ä»¬å¯èƒ½æ„¿æ„ç‰ºç‰²å›½å®¶åˆ©ç›Šã€‚
å¦ä¸€äº›æ”¿æ²»å®¶çš„åŠ¨æœºåªæ˜¯è´ªå©ªã€‚</p>
<p>å¯¹äººç±»å†³ç­–è¿‡ç¨‹çš„ç ”ç©¶ï¼Œ åŠ›å›¾æŸ¥æ˜äººçŠ¯ä¸‹çš„ç³»ç»Ÿæ€§é”™è¯¯ï¼Œ ä¸»è¦æœ‰å‡ ä¸ªæ–¹é¢ï¼š
äººä»¬è¿‡åˆ†è‡ªä¿¡ã€ äººä»¬è¿‡åˆ†é‡è§†ä»ç°å®ç”Ÿæ´»ä¸­è§‚å¯Ÿçš„ç»†ææœ«èŠ‚ã€ äººä»¬ä¸æ„¿æ„æ”¹å˜è‡ªå·±çš„è§‚å¿µã€‚</p>
<hr>
<h1>é€šä¿—æ˜“æ‡‚çš„ Promise çŸ¥è¯†ç‚¹æ€»ç»“ï¼Œæ£€éªŒä¸€ä¸‹ä½ æ˜¯å¦çœŸçš„å®Œå…¨æŒæ¡äº† Promiseï¼Ÿ</h1><h1>Promise å¦‚ä½•è¿ä½œ</h1>
<pre><code>let myPromise0 = new Promise();
console.log('myPromise0 :&gt;&gt; ', myPromise0);
</code></pre>
<p>è¾“å‡ºç»“æœï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69545d9620e24d0aa5e0595b92007fcf~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>è¿™ä¸ªé‡ŒåŒ…å«äº†ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š</p>
<ul>
<li>è§„å®šå¿…é¡»ç»™<code>Promise</code>å¯¹è±¡ä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œå¦åˆ™å°†ä¼šæŠ¥é”™ã€‚</li>
</ul>
<p>ä¸åŒäº â€œè€å¼â€ çš„ä¼ å…¥å›è°ƒï¼Œåœ¨ä½¿ç”¨ Promise æ—¶ï¼Œä¼šæœ‰ä»¥ä¸‹çº¦å®šï¼š</p>
<ul>
<li>åœ¨æœ¬è½® <strong>äº‹ä»¶å¾ªç¯</strong> è¿è¡Œå®Œæˆä¹‹å‰ï¼Œå›è°ƒå‡½æ•°æ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„ã€‚</li>
<li>å³ä½¿å¼‚æ­¥æ“ä½œå·²ç»å®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œåœ¨è¿™ä¹‹åé€šè¿‡ then() æ·»åŠ çš„å›è°ƒå‡½æ•°ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚</li>
<li>é€šè¿‡å¤šæ¬¡è°ƒç”¨ then() å¯ä»¥æ·»åŠ å¤šä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§æ’å…¥é¡ºåºè¿›è¡Œæ‰§è¡Œã€‚</li>
</ul>
<p>Promise å¾ˆæ£’çš„ä¸€ç‚¹å°±æ˜¯<strong>é“¾å¼è°ƒç”¨</strong>ã€‚</p>
<h1>åˆ›å»º promise</h1>
<p>Promise API å…¬å¼€äº†ä¸€ä¸ª Promise æ„é€ å‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨ <code>new Promise()</code> å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼š</p>
<pre><code>let done = true

const isItDoneYet = new Promise((resolve, reject) =&gt; {
  if (done) {
    const workDone = 'è¿™æ˜¯åˆ›å»ºçš„ä¸œè¥¿'
    resolve(workDone)
  } else {
    const why = 'ä»ç„¶åœ¨å¤„ç†å…¶ä»–äº‹æƒ…'
    reject(why)
  }
})
</code></pre>
<h1>ä½¿ç”¨ promise</h1>
<p>ç°åœ¨ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ promiseã€‚</p>
<pre><code>const isItDoneYet = new Promise(/* ... å¦‚ä¸Šæ‰€è¿° ... */)
//...

const checkIfItsDone = () =&gt; {
  isItDoneYet
    .then(ok =&gt; {
      console.log(ok)
    })
    .catch(err =&gt; {
      console.error(err)
    })
</code></pre>
<p>è¿è¡Œ <code>checkIfItsDone()</code> ä¼šæŒ‡å®šå½“ <code>isItDoneYet</code> promise è¢«è§£å†³ï¼ˆåœ¨ <strong>then</strong> è°ƒç”¨ä¸­ï¼‰æˆ–è¢«æ‹’ç»ï¼ˆåœ¨ <strong>catch</strong> è°ƒç”¨ä¸­ï¼‰æ—¶æ‰§è¡Œçš„å‡½æ•°ã€‚</p>
<h1>å®ä¾‹ promise å°è£… AJAX</h1>
<pre><code>// Promiseå°è£…Ajaxè¯·æ±‚
function ajax(method, url, data) {
    var xhr = new XMLHttpRequest();
    return new Promise(function (resolve, reject) {
        xhr.onreadystatechange = function () {
            if (xhr.readyState !== 4) return;
            if (xhr.status === 200) {
                resolve(xhr.responseText);
            } else {
                reject(xhr.statusText);
            }

        };
        xhr.open(method, url);
        xhr.send(data);
    });
}
</code></pre>
<p>ä½¿ç”¨ä¸Šé¢å°è£…å¥½çš„ ajax å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼š</p>
<pre><code>ajax('GET', '/api/categories').then(function (data) {
    // AJAXæˆåŠŸï¼Œæ‹¿åˆ°å“åº”æ•°æ®
    console.log(data);
}).catch(function (status) {
    // AJAXå¤±è´¥ï¼Œæ ¹æ®å“åº”ç åˆ¤æ–­å¤±è´¥åŸå› 
    new Error(status)
});
</code></pre>
<h1>Promise.resolve()</h1>
<p>æœ‰æ—¶éœ€è¦å°†ç°æœ‰å¯¹è±¡è½¬ä¸º Promise å¯¹è±¡ï¼Œ<code>Promise.resolve()</code>æ–¹æ³•å°±èµ·åˆ°è¿™ä¸ªä½œç”¨ã€‚</p>
<blockquote>
<p>æ³¨æ„ â— è¿™é‡Œçš„<code>Promise.resolve()</code>æ˜¯ç›´æ¥ä½¿ç”¨çš„ï¼Œä¸æ˜¯åœ¨ promise å¯¹è±¡é‡Œçš„<code>resolve()</code>æ–¹æ³•ï¼Œæ˜¯<code>Promise.resolve()</code> ï¼Œå¼€å¤´å¤§å†™ï¼Œä¸æ˜¯<code>promise</code></p>
</blockquote>
<pre><code>const jsPromise = Promise.resolve($.ajax('/whatever.json'));
</code></pre>
<p>ä¸Šé¢ä»£ç å°† jQuery ç”Ÿæˆçš„å¯¹è±¡ï¼Œè½¬ä¸ºä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ã€‚</p>
<p><code>Promise.resolve()</code>ç­‰ä»·äºä¸‹é¢çš„å†™æ³•ã€‚</p>
<pre><code>Promise.resolve('foo')
// ç­‰ä»·äº
new Promise(resolve =&gt; resolve('foo'))
</code></pre>
<p><code>Promise.resolve</code>æ–¹æ³•çš„å‚æ•°åˆ†æˆå››ç§æƒ…å†µã€‚</p>
<p>â—¾ <strong>ï¼ˆ1ï¼‰å‚æ•°æ˜¯ä¸€ä¸ª Promise å®ä¾‹</strong></p>
<p>å¦‚æœå‚æ•°æ˜¯ Promise å®ä¾‹ï¼Œé‚£ä¹ˆ Promise.resolve å°†ä¸åšä»»ä½•ä¿®æ”¹ã€åŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå®ä¾‹ã€‚</p>
<p>â—¾ <strong>ï¼ˆ2ï¼‰å‚æ•°æ˜¯ä¸€ä¸ª thenable å¯¹è±¡</strong></p>
<p><code>thenable</code>å¯¹è±¡æŒ‡çš„æ˜¯å…·æœ‰<code>then</code>æ–¹æ³•çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªå¯¹è±¡ã€‚</p>
<pre><code>let thenable = {
  then: function(resolve, reject) {
    resolve(42);
  }
};
</code></pre>
<p><code>Promise.resolve</code>æ–¹æ³•ä¼šå°†è¿™ä¸ªå¯¹è±¡è½¬ä¸º Promise å¯¹è±¡ï¼Œç„¶åå°±ç«‹å³æ‰§è¡Œ<code>thenable</code>å¯¹è±¡çš„<code>then</code>æ–¹æ³•ã€‚</p>
<pre><code>let thenable = {
  then: function(resolve, reject) {
    resolve(42);
  }
};
let p1 = Promise.resolve(thenable);
p1.then(function(value) {
  console.log(value);  // 42
});
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>thenable</code>å¯¹è±¡çš„<code>then</code>æ–¹æ³•æ‰§è¡Œåï¼Œå¯¹è±¡<code>p1</code>çš„çŠ¶æ€å°±å˜ä¸º<code>resolved</code>ï¼Œä»è€Œç«‹å³æ‰§è¡Œæœ€åé‚£ä¸ª<code>then</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè¾“å‡º 42ã€‚</p>
<p>â—¾ <strong>ï¼ˆ3ï¼‰å‚æ•°ä¸æ˜¯å…·æœ‰ then æ–¹æ³•çš„å¯¹è±¡ï¼Œæˆ–æ ¹æœ¬å°±ä¸æ˜¯å¯¹è±¡</strong></p>
<p>å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªä¸å…·æœ‰<code>then</code>æ–¹æ³•çš„å¯¹è±¡ï¼Œåˆ™<code>Promise.resolve</code>æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ <code>Promise</code> å¯¹è±¡ï¼ŒçŠ¶æ€ä¸º<code>resolved</code>ã€‚</p>
<pre><code>const p = Promise.resolve('Hello');
p.then(function (s){
  console.log(s)
});
// Hello
</code></pre>
<p>ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>Promise</code> å¯¹è±¡çš„å®ä¾‹<code>p</code>ã€‚ç”±äºå­—ç¬¦ä¸²<code>Hello</code>ä¸å±äºå¼‚æ­¥æ“ä½œï¼ˆåˆ¤æ–­æ–¹æ³•æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ä¸å…·æœ‰ <code>then</code> æ–¹æ³•ï¼‰ï¼Œè¿”å› <code>Promise</code> å®ä¾‹çš„çŠ¶æ€ä»ä¸€ç”Ÿæˆå°±æ˜¯<code>resolved</code>ï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚<code>Promise.resolve</code>æ–¹æ³•çš„å‚æ•°ï¼Œä¼šåŒæ—¶ä¼ ç»™å›è°ƒå‡½æ•°ã€‚</p>
<p>â—¾ <strong>ï¼ˆ4ï¼‰ä¸å¸¦æœ‰ä»»ä½•å‚æ•°</strong></p>
<p><code>Promise.resolve()</code>æ–¹æ³•å…è®¸è°ƒç”¨æ—¶ä¸å¸¦å‚æ•°ï¼Œç›´æ¥è¿”å›ä¸€ä¸ª<code>resolved</code>çŠ¶æ€çš„ Promise å¯¹è±¡ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœå¸Œæœ›å¾—åˆ°ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ¯”è¾ƒæ–¹ä¾¿çš„æ–¹æ³•å°±æ˜¯ç›´æ¥è°ƒç”¨<code>Promise.resolve()</code>æ–¹æ³•ã€‚</p>
<pre><code>const p = Promise.resolve();
p.then(function () {
  // ...
});
</code></pre>
<p>ä¸Šé¢ä»£ç çš„å˜é‡ p å°±æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç«‹å³<code>resolve()</code>çš„ Promise å¯¹è±¡ï¼Œæ˜¯åœ¨æœ¬è½® â€œäº‹ä»¶å¾ªç¯â€ï¼ˆevent loopï¼‰çš„ç»“æŸæ—¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€ çš„å¼€å§‹æ—¶ã€‚</p>
<pre><code>setTimeout(function () {
  console.log('three');
}, 0);
Promise.resolve().then(function () {
  console.log('two');
});
console.log('one');
// one
// two
// three
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>setTimeout(fn, 0)</code>åœ¨ä¸‹ä¸€è½® â€œäº‹ä»¶å¾ªç¯â€ å¼€å§‹æ—¶æ‰§è¡Œï¼Œ<code>Promise.resolve()</code>åœ¨æœ¬è½® â€œäº‹ä»¶å¾ªç¯â€ ç»“æŸæ—¶æ‰§è¡Œï¼Œ<code>console.log('one')</code>åˆ™æ˜¯ç«‹å³æ‰§è¡Œï¼Œå› æ­¤æœ€å…ˆè¾“å‡ºã€‚</p>
<h1>Promise.reject()</h1>
<p><code>Promise.reject(reason)</code>æ–¹æ³•ä¹Ÿä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼Œè¯¥å®ä¾‹çš„çŠ¶æ€ä¸º<code>rejected</code>ã€‚</p>
<pre><code>const p = Promise.reject('å‡ºé”™äº†');
// ç­‰åŒäº
const p = new Promise((resolve, reject) =&gt; reject('å‡ºé”™äº†'))
p.then(null, function (s) {
  console.log(s)
});
// å‡ºé”™äº†
</code></pre>
<p>ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ª Promise å¯¹è±¡çš„å®ä¾‹<code>p</code>ï¼ŒçŠ¶æ€ä¸º<code>rejected</code>ï¼Œå›è°ƒå‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚</p>
<p>æ³¨æ„ï¼Œ<code>Promise.reject()</code>æ–¹æ³•çš„å‚æ•°ï¼Œä¼šåŸå°ä¸åŠ¨åœ°ä½œä¸º<code>reject</code>çš„ç†ç”±ï¼Œå˜æˆåç»­æ–¹æ³•çš„å‚æ•°ã€‚è¿™ä¸€ç‚¹ä¸<code>Promise.resolve</code>æ–¹æ³•ä¸ä¸€è‡´ã€‚</p>
<pre><code>const thenable = {
  then(resolve, reject) {
    reject('å‡ºé”™äº†');
  }
};
Promise.reject(thenable)
.catch(e =&gt; {
  console.log(e === thenable)
})
// true
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>Promise.reject</code>æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ª<code>thenable</code>å¯¹è±¡ï¼Œæ‰§è¡Œä»¥åï¼Œåé¢<code>catch</code>æ–¹æ³•çš„å‚æ•°ä¸æ˜¯<code>reject</code>æŠ›å‡ºçš„ â€œå‡ºé”™äº†â€ è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯<code>thenable</code>å¯¹è±¡ã€‚</p>
<h1>Promise.prototype.then()</h1>
<p>Promise å®ä¾‹å…·æœ‰<code>then</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>then</code>æ–¹æ³•æ˜¯å®šä¹‰åœ¨åŸå‹å¯¹è±¡<code>Promise.prototype</code>ä¸Šçš„ã€‚å®ƒçš„ä½œç”¨æ˜¯ä¸º Promise å®ä¾‹æ·»åŠ çŠ¶æ€æ”¹å˜æ—¶çš„å›è°ƒå‡½æ•°ã€‚</p>
<p><code>then</code>æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>resolved</code>çŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚å¦‚æœè¯¥å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ä¼šåœ¨å†…éƒ¨è¢«æ›¿æ¢ä¸º <code>(x) =&gt; x</code>ï¼Œå³åŸæ ·è¿”å› promise æœ€ç»ˆç»“æœçš„å‡½æ•°ï¼›</p>
<p>ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰æ˜¯<code>rejected</code>çŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚å¦‚æœè¯¥å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ä¼šåœ¨å†…éƒ¨è¢«æ›¿æ¢ä¸ºä¸€ä¸ª &quot;Thrower&quot; å‡½æ•° (it throws an error it received as argument)ã€‚</p>
<p><code>then</code>æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„<code>Promise</code>å®ä¾‹ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯åŸæ¥é‚£ä¸ª<code>Promise</code>å®ä¾‹ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³<code>then</code>æ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ª<code>then</code>æ–¹æ³•ã€‚</p>
<pre><code>getJSON(&quot;/posts.json&quot;).then(function(json) {
  return json.post;
}).then(function(post) {
  // ...
});
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨<code>then</code>æ–¹æ³•ï¼Œä¾æ¬¡æŒ‡å®šäº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å®Œæˆä»¥åï¼Œä¼šå°†è¿”å›ç»“æœä½œä¸ºå‚æ•°ï¼Œä¼ å…¥ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ã€‚</p>
<p>é‡‡ç”¨é“¾å¼çš„<code>then</code>ï¼Œå¯ä»¥æŒ‡å®šä¸€ç»„æŒ‰ç…§æ¬¡åºè°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚è¿™æ—¶ï¼Œå‰ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæœ‰å¯èƒ½è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª<code>Promise</code>å¯¹è±¡ï¼ˆå³æœ‰å¼‚æ­¥æ“ä½œï¼‰ï¼Œè¿™æ—¶åä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå°±ä¼šç­‰å¾…è¯¥<code>Promise</code>å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œæ‰ä¼šè¢«è°ƒç”¨ã€‚</p>
<pre><code>getJSON(&quot;/post/1.json&quot;).then(function(post) {
  return getJSON(post.commentURL);
}).then(function (comments) {
  console.log(&quot;resolved: &quot;, comments);
}, function (err){
  console.log(&quot;rejected: &quot;, err);
});
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬ä¸€ä¸ª<code>then</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè¿”å›çš„æ˜¯å¦ä¸€ä¸ª<code>Promise</code>å¯¹è±¡ã€‚è¿™æ—¶ï¼Œç¬¬äºŒä¸ª<code>then</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå°±ä¼šç­‰å¾…è¿™ä¸ªæ–°çš„<code>Promise</code>å¯¹è±¡çŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœå˜ä¸º<code>resolved</code>ï¼Œå°±è°ƒç”¨ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¦‚æœçŠ¶æ€å˜ä¸º<code>rejected</code>ï¼Œå°±è°ƒç”¨ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ã€‚</p>
<p>å¦‚æœé‡‡ç”¨ç®­å¤´å‡½æ•°ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥å†™å¾—æ›´ç®€æ´ã€‚</p>
<pre><code>getJSON(&quot;/post/1.json&quot;).then(
  post =&gt; getJSON(post.commentURL)
).then(
  comments =&gt; console.log(&quot;resolved: &quot;, comments),
  err =&gt; console.log(&quot;rejected: &quot;, err)
);
</code></pre>
<p>å‰é¢ä»‹ç»äº† <code>then</code> æ–¹æ³•çš„å‚æ•°å’Œé“¾å¼è°ƒç”¨ï¼Œä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ <code>then</code> æ–¹æ³•çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯ <code>then</code> æ–¹æ³•ä¸­çš„ <code>return</code>ã€‚</p>
<p>å½“ä¸€ä¸ª <code>Promise</code> å®Œæˆï¼ˆfulfilledï¼‰æˆ–è€…å¤±è´¥ï¼ˆrejectedï¼‰æ—¶ï¼Œè¿”å›å‡½æ•°å°†è¢«å¼‚æ­¥è°ƒç”¨ï¼ˆç”±å½“å‰çš„çº¿ç¨‹å¾ªç¯æ¥è°ƒåº¦å®Œæˆï¼‰ã€‚</p>
<p>å…·ä½“çš„è¿”å›å€¼ <code>return</code> ä¾æ®ä»¥ä¸‹è§„åˆ™è¿”å›ã€‚
å¦‚æœ <code>then</code> ä¸­çš„å›è°ƒå‡½æ•°ï¼š</p>
<ul>
<li>è¿”å› <code>(return)</code> äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆ <code>then</code> è¿”å›çš„ Promise å°†ä¼šæˆä¸ºæ¥å—çŠ¶æ€ï¼Œå¹¶ä¸”å°†è¿”å›çš„å€¼ä½œä¸ºæ¥å—çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚</li>
<li>æ²¡æœ‰è¿”å› <code>(return)</code> ä»»ä½•å€¼ï¼Œé‚£ä¹ˆ <code>then</code> è¿”å›çš„ Promise å°†ä¼šæˆä¸ºæ¥å—çŠ¶æ€ï¼Œå¹¶ä¸”è¯¥æ¥å—çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ä¸º <code>undefined</code>ã€‚</li>
<li>æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆ <code>then</code> è¿”å›çš„ Promise å°†ä¼šæˆä¸ºæ‹’ç»çŠ¶æ€ï¼Œå¹¶ä¸”å°†æŠ›å‡ºçš„é”™è¯¯ä½œä¸ºæ‹’ç»çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚</li>
<li>è¿”å› <code>(return)</code> ä¸€ä¸ªå·²ç»æ˜¯æ¥å—çŠ¶æ€çš„ Promiseï¼Œé‚£ä¹ˆ <code>then</code> è¿”å›çš„ Promise ä¹Ÿä¼šæˆä¸ºæ¥å—çŠ¶æ€ï¼Œå¹¶ä¸”å°†é‚£ä¸ª Promise çš„æ¥å—çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ä½œä¸ºè¯¥è¢«è¿”å›çš„ Promise çš„æ¥å—çŠ¶æ€å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚</li>
<li>è¿”å› <code>(return)</code> ä¸€ä¸ªå·²ç»æ˜¯æ‹’ç»çŠ¶æ€çš„ Promiseï¼Œé‚£ä¹ˆ <code>then</code> è¿”å›çš„ Promise ä¹Ÿä¼šæˆä¸ºæ‹’ç»çŠ¶æ€ï¼Œå¹¶ä¸”å°†é‚£ä¸ª Promise çš„æ‹’ç»çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ä½œä¸ºè¯¥è¢«è¿”å›çš„ Promise çš„æ‹’ç»çŠ¶æ€å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚</li>
<li>è¿”å› <code>(return)</code> ä¸€ä¸ªæœªå®šçŠ¶æ€ï¼ˆ<code>pending</code>ï¼‰çš„ Promiseï¼Œé‚£ä¹ˆ <code>then</code> è¿”å› Promise çš„çŠ¶æ€ä¹Ÿæ˜¯æœªå®šçš„ï¼Œå¹¶ä¸”å®ƒçš„ç»ˆæ€ä¸é‚£ä¸ª Promise çš„ç»ˆæ€ç›¸åŒï¼›åŒæ—¶ï¼Œå®ƒå˜ä¸ºç»ˆæ€æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°å‚æ•°ä¸é‚£ä¸ª Promise å˜ä¸ºç»ˆæ€æ—¶çš„å›è°ƒå‡½æ•°çš„å‚æ•°æ˜¯ç›¸åŒçš„ã€‚</li>
</ul>
<h1>é“¾å¼è°ƒç”¨ promise.then()</h1>
<p><strong><code>then</code> æ–¹æ³•è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå…¶å…è®¸æ–¹æ³•é“¾ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ª promise é“¾ã€‚</strong></p>
<p>é“¾å¼ promise çš„ä¸€ä¸ªå¾ˆå¥½çš„ç¤ºä¾‹æ˜¯ Fetch APIï¼Œå¯ä»¥ç”¨äºè·å–èµ„æºï¼Œä¸”å½“èµ„æºè¢«è·å–æ—¶å°† promise é“¾å¼æ’é˜Ÿè¿›è¡Œæ‰§è¡Œã€‚</p>
<p>Fetch API æ˜¯åŸºäº promise çš„æœºåˆ¶ï¼Œè°ƒç”¨ <code>fetch()</code> ç›¸å½“äºä½¿ç”¨ new Promise() æ¥å®šä¹‰ promsieã€‚</p>
<pre><code>const status = response =&gt; {
  if (response.status &gt;= 200 &amp;&amp; response.status &lt; 300) {
    return Promise.resolve(response)
  }
  return Promise.reject(new Error(response.statusText))
}

const json = response =&gt; response.json()

fetch('/todos.json')
  .then(status)    // æ³¨æ„ï¼Œ`status` å‡½æ•°å®é™…ä¸Šåœ¨è¿™é‡Œè¢«è°ƒç”¨ï¼Œå¹¶ä¸”åŒæ ·è¿”å› promiseï¼Œ
  .then(json)      // è¿™é‡Œå”¯ä¸€çš„åŒºåˆ«æ˜¯çš„ `json` å‡½æ•°ä¼šè¿”å›è§£å†³æ—¶ä¼ å…¥ `data` çš„ promiseï¼Œ
  .then(data =&gt; {  // è¿™æ˜¯ `data` ä¼šåœ¨æ­¤å¤„ä½œä¸ºåŒ¿åå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„åŸå› ã€‚
    console.log('è¯·æ±‚æˆåŠŸè·å¾— JSON å“åº”', data)
  })
  .catch(error =&gt; {
    console.log('è¯·æ±‚å¤±è´¥', error)
  })
</code></pre>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œè°ƒç”¨ <code>fetch()</code> ä»åŸŸæ ¹ç›®å½•ä¸­çš„ <code>todos.json</code> æ–‡ä»¶ä¸­è·å– TODO é¡¹ç›®çš„åˆ—è¡¨ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª promise é“¾ã€‚</p>
<p>è¿è¡Œ <code>fetch()</code> ä¼šè¿”å›ä¸€ä¸ªå“åº” <code>response</code>ï¼Œè¯¥å“åº”å…·æœ‰è®¸å¤šå±æ€§ï¼Œåœ¨å±æ€§ä¸­å¼•ç”¨äº†ï¼š</p>
<ul>
<li><code>status</code>ï¼Œè¡¨ç¤º HTTP çŠ¶æ€ç çš„æ•°å€¼ã€‚</li>
<li><code>statusText</code>ï¼ŒçŠ¶æ€æ¶ˆæ¯ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸï¼Œåˆ™ä¸º OKã€‚</li>
</ul>
<p><code>response</code> è¿˜æœ‰ä¸€ä¸ª <code>json()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise è§£å†³æ—¶ä¼šä¼ å…¥å·²å¤„ç†å¹¶è½¬æ¢ä¸º JSON çš„å“åº”ä½“çš„å†…å®¹ã€‚</p>
<p>å› æ­¤ï¼Œè€ƒè™‘åˆ°è¿™äº›å‰æï¼Œå‘ç”Ÿçš„è¿‡ç¨‹æ˜¯ï¼šé“¾ä¸­çš„ç¬¬ä¸€ä¸ª promise æ˜¯æˆ‘ä»¬å®šä¹‰çš„å‡½æ•°ï¼Œå³ <code>status()</code>ï¼Œå®ƒä¼šæ£€æŸ¥å“åº”çš„çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯æˆåŠŸå“åº”ï¼ˆä»‹äº 200 å’Œ 299 ä¹‹é—´ï¼‰ï¼Œåˆ™å®ƒä¼šæ‹’ç» promiseã€‚</p>
<p>æ­¤æ“ä½œä¼šå¯¼è‡´ promise é“¾è·³è¿‡åˆ—å‡ºçš„æ‰€æœ‰è¢«é“¾çš„ promiseï¼Œä¸”ä¼šç›´æ¥è·³åˆ°åº•éƒ¨çš„ <code>catch()</code> è¯­å¥ï¼ˆè®°å½•<code>è¯·æ±‚å¤±è´¥</code>çš„æ–‡æœ¬å’Œé”™è¯¯æ¶ˆæ¯ï¼‰ã€‚</p>
<p>å¦‚æœæˆåŠŸï¼Œåˆ™ä¼šè°ƒç”¨å®šä¹‰çš„ <code>json()</code> å‡½æ•°ã€‚ ç”±äºä¸Šä¸€ä¸ª promise æˆåŠŸåè¿”å›äº† response å¯¹è±¡ï¼Œå› æ­¤å°†å…¶ä½œä¸ºç¬¬äºŒä¸ª promise çš„è¾“å…¥ã€‚</p>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œè¿”å›å¤„ç†åçš„ JSON æ•°æ®ï¼Œå› æ­¤ç¬¬ä¸‰ä¸ª promise ç›´æ¥æ¥æ”¶ JSONï¼š</p>
<pre><code>.then((data) =&gt; {
  console.log('è¯·æ±‚æˆåŠŸè·å¾— JSON å“åº”', data)
})
</code></pre>
<h1>Promise.prototype.catch()</h1>
<p><code>catch()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª<code>Promise</code>ï¼Œå¹¶ä¸”å¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨<code>Promise.prototype.then(undefined, onRejected)</code> ç›¸åŒã€‚</p>
<p>äº‹å®ä¸Š, calling <code>obj.catch(onRejected)</code> å†…éƒ¨ calls <code>obj.then(undefined, onRejected)</code>ã€‚(è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬æ˜¾å¼ä½¿ç”¨<code>obj.catch(onRejected)</code>ï¼Œå†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯<code>obj.then(undefined, onRejected)</code>)</p>
<p><code>Promise.prototype.catch()</code>æ–¹æ³•æ˜¯<code>.then(null, rejection)</code>æˆ–<code>.then(undefined, rejection)</code>çš„åˆ«åï¼Œç”¨äºæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒå‡½æ•°ã€‚</p>
<pre><code>getJSON('/posts.json').then(function(posts) {
  // ...
}).catch(function(error) {
  // å¤„ç† getJSON å’Œ å‰ä¸€ä¸ªå›è°ƒå‡½æ•°è¿è¡Œæ—¶å‘ç”Ÿçš„é”™è¯¯
  console.log('å‘ç”Ÿé”™è¯¯ï¼', error);
});
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>getJSON()</code>æ–¹æ³•è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœè¯¥å¯¹è±¡çŠ¶æ€å˜ä¸º<code>resolved</code>ï¼Œåˆ™ä¼šè°ƒç”¨<code>then()</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼›å¦‚æœå¼‚æ­¥æ“ä½œæŠ›å‡ºé”™è¯¯ï¼ŒçŠ¶æ€å°±ä¼šå˜ä¸º<code>rejected</code>ï¼Œå°±ä¼šè°ƒç”¨<code>catch()</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¤„ç†è¿™ä¸ªé”™è¯¯ã€‚å¦å¤–ï¼Œ<code>then()</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¦‚æœè¿è¡Œä¸­æŠ›å‡ºé”™è¯¯ï¼Œä¹Ÿä¼šè¢«<code>catch()</code>æ–¹æ³•æ•è·ã€‚</p>
<pre><code>p.then((val) =&gt; console.log('fulfilled:', val))
  .catch((err) =&gt; console.log('rejected', err));
  
// ç­‰åŒäº
p.then((val) =&gt; console.log('fulfilled:', val))
  .then(null, (err) =&gt; console.log(&quot;rejected:&quot;, err));
</code></pre>
<p>â—¾ ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p>
<pre><code>const promise = new Promise(function(resolve, reject) {
  throw new Error('test');
});
promise.catch(function(error) {
  console.log(error);
});
// Error: test
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œpromise æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°±è¢«<code>catch()</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œä¸Šé¢çš„å†™æ³•ä¸ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ã€‚</p>
<pre><code>// å†™æ³•ä¸€
const promise = new Promise(function(resolve, reject) {
  try {
    throw new Error('test');
  } catch(e) {
    reject(e);
  }
});
promise.catch(function(error) {
  console.log(error);
});
// å†™æ³•äºŒ
const promise = new Promise(function(resolve, reject) {
  reject(new Error('test'));
});
promise.catch(function(error) {
  console.log(error);
});
</code></pre>
<p>æ¯”è¾ƒä¸Šé¢ä¸¤ç§å†™æ³•ï¼Œå¯ä»¥å‘ç° reject() æ–¹æ³•çš„ä½œç”¨ï¼Œç­‰åŒäºæŠ›å‡ºé”™è¯¯ã€‚</p>
<p>â—¾ å¦‚æœ Promise çŠ¶æ€å·²ç»å˜æˆ resolvedï¼Œå†æŠ›å‡ºé”™è¯¯æ˜¯æ— æ•ˆçš„ã€‚</p>
<pre><code>const promise = new Promise(function(resolve, reject) {
  resolve('ok');
  throw new Error('test');
});
promise
  .then(function(value) { console.log(value) })
  .catch(function(error) { console.log(error) });
// ok
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼ŒPromise åœ¨ resolve è¯­å¥åé¢ï¼Œå†æŠ›å‡ºé”™è¯¯ï¼Œä¸ä¼šè¢«æ•è·ï¼Œç­‰äºæ²¡æœ‰æŠ›å‡ºã€‚å› ä¸º Promise çš„çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±æ°¸ä¹…ä¿æŒè¯¥çŠ¶æ€ï¼Œä¸ä¼šå†å˜äº†ã€‚</p>
<p>â—¾ Promise å¯¹è±¡çš„é”™è¯¯å…·æœ‰ â€œå†’æ³¡â€ æ€§è´¨ï¼Œä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ª catch è¯­å¥æ•è·ã€‚</p>
<pre><code>getJSON('/post/1.json').then(function(post) {
  return getJSON(post.commentURL);
}).then(function(comments) {
  // some code
}).catch(function(error) {
  // å¤„ç†å‰é¢ä¸‰ä¸ªPromiseäº§ç”Ÿçš„é”™è¯¯
});
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œä¸€å…±æœ‰ä¸‰ä¸ª Promise å¯¹è±¡ï¼šä¸€ä¸ªç”±<code>getJSON()</code>äº§ç”Ÿï¼Œä¸¤ä¸ªç”±<code>then()</code>äº§ç”Ÿã€‚å®ƒä»¬ä¹‹ä¸­ä»»ä½•ä¸€ä¸ªæŠ›å‡ºçš„é”™è¯¯ï¼Œéƒ½ä¼šè¢«æœ€åä¸€ä¸ª<code>catch()</code>æ•è·ã€‚</p>
<p>â—¾ ä¸€èˆ¬æ¥è¯´ï¼Œä¸è¦åœ¨<code>then()</code>æ–¹æ³•é‡Œé¢å®šä¹‰ Reject çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆå³<code>then</code>çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨<code>catch</code>æ–¹æ³•ã€‚</p>
<pre><code>// bad
promise
  .then(function(data) {
    // success
  }, function(err) {
    // error
  });
  
// good
promise
  .then(function(data) { //cb
    // success
  })
  .catch(function(err) {
    // error
  });
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒç§å†™æ³•è¦å¥½äºç¬¬ä¸€ç§å†™æ³•ï¼Œç†ç”±æ˜¯ç¬¬äºŒç§å†™æ³•å¯ä»¥æ•è·å‰é¢<code>then</code>æ–¹æ³•æ‰§è¡Œä¸­çš„é”™è¯¯ï¼Œä¹Ÿæ›´æ¥è¿‘åŒæ­¥çš„å†™æ³•ï¼ˆ<code>try/catch</code>ï¼‰ã€‚å› æ­¤ï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨<code>catch()</code>æ–¹æ³•ï¼Œè€Œä¸ä½¿ç”¨<code>then()</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<p>â—¾ è·Ÿä¼ ç»Ÿçš„<code>try/catch</code>ä»£ç å—ä¸åŒçš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨<code>catch()</code>æ–¹æ³•æŒ‡å®šé”™è¯¯å¤„ç†çš„å›è°ƒå‡½æ•°ï¼ŒPromise å¯¹è±¡æŠ›å‡ºçš„é”™è¯¯ä¸ä¼šä¼ é€’åˆ°å¤–å±‚ä»£ç ï¼Œå³ä¸ä¼šæœ‰ä»»ä½•ååº”ã€‚</p>
<pre><code>const someAsyncThing = function() {
  return new Promise(function(resolve, reject) {
    // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºxæ²¡æœ‰å£°æ˜
    resolve(x + 2);
  });
};
someAsyncThing().then(function() {
  console.log('everything is great');
});
setTimeout(() =&gt; { console.log(123) }, 2000);
// Uncaught (in promise) ReferenceError: x is not defined
// 123
</code></pre>
<p>åœ¨æµè§ˆå™¨ä¸­è¿è¡Œä¸Šé¢è¿™æ®µä»£ç ï¼Œç­‰å¾…ä¸¤ç§’åï¼Œä½ ä¼šçœ‹åˆ°æ§åˆ¶å°æ­£å¸¸æ‰“å° &quot;123&quot;ï¼Œå¹¶æ²¡æœ‰å› ä¸º<code>someAsyncThing()</code>æ–¹æ³•é‡Œçš„é”™è¯¯é˜»å¡ä»£ç è¿è¡Œã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/819b3df49f7b472d8f1f0ad850632955~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>someAsyncThing()</code>å‡½æ•°äº§ç”Ÿçš„ Promise å¯¹è±¡ï¼Œå†…éƒ¨æœ‰è¯­æ³•é”™è¯¯ã€‚æµè§ˆå™¨è¿è¡Œåˆ°è¿™ä¸€è¡Œï¼Œä¼šæ‰“å°å‡ºé”™è¯¯æç¤º<code>ReferenceError: x is not defined</code>ï¼Œä½†æ˜¯ä¸ä¼šé€€å‡ºè¿›ç¨‹ã€ç»ˆæ­¢è„šæœ¬æ‰§è¡Œï¼Œ2 ç§’ä¹‹åè¿˜æ˜¯ä¼šè¾“å‡º 123ã€‚è¿™å°±æ˜¯è¯´ï¼ŒPromise å†…éƒ¨çš„é”™è¯¯ä¸ä¼šå½±å“åˆ° Promise å¤–éƒ¨çš„ä»£ç ï¼Œé€šä¿—çš„è¯´æ³•å°±æ˜¯ â€œPromise ä¼šåƒæ‰é”™è¯¯â€ã€‚</p>
<h1>å¤„ç†é”™è¯¯</h1>
<p>åœ¨ä¸Šä¸€ç« èŠ‚çš„ç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸ª <code>catch</code> è¢«é™„åŠ åˆ°äº† promise é“¾ä¸Šã€‚</p>
<p>å½“ promise é“¾ä¸­çš„ä»»ä½•å†…å®¹å¤±è´¥å¹¶å¼•å‘é”™è¯¯æˆ–æ‹’ç» promise æ—¶ï¼Œåˆ™æ§åˆ¶æƒä¼šè½¬åˆ°é“¾ä¸­æœ€è¿‘çš„ <code>catch()</code> è¯­å¥ã€‚</p>
<pre><code>new Promise((resolve, reject) =&gt; {
  throw new Error('é”™è¯¯')
}).catch(err =&gt; {
  console.error(err)
})

// æˆ–

new Promise((resolve, reject) =&gt; {
  reject('é”™è¯¯')
}).catch(err =&gt; {
  console.error(err)
})
</code></pre>
<h1>çº§è”é”™è¯¯</h1>
<p>å¦‚æœåœ¨ <code>catch()</code> å†…éƒ¨å¼•å‘é”™è¯¯ï¼Œåˆ™å¯ä»¥é™„åŠ ç¬¬äºŒä¸ª <code>catch()</code>æ¥å¤„ç†ï¼Œä¾æ­¤ç±»æ¨ã€‚</p>
<pre><code>new Promise((resolve, reject) =&gt; {
  throw new Error('é”™è¯¯')
})
  .catch(err =&gt; {
    throw new Error('é”™è¯¯')
  })
  .catch(err =&gt; {
    console.error(err)
  })
</code></pre>
<h1>Promise.prototype.finally()</h1>
<p><code>finally()</code>æ–¹æ³•ç”¨äºæŒ‡å®šä¸ç®¡ Promise å¯¹è±¡æœ€åçŠ¶æ€å¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œã€‚è¯¥æ–¹æ³•æ˜¯ ES2018 å¼•å…¥æ ‡å‡†çš„ã€‚</p>
<p><code>finally()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseã€‚åœ¨ promise ç»“æŸæ—¶ï¼Œæ— è®ºç»“æœæ˜¯<code>fulfilled</code>æˆ–è€…æ˜¯<code>rejected</code>ï¼Œéƒ½ä¼šæ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚è¿™ä¸ºåœ¨<code>Promise</code>æ˜¯å¦æˆåŠŸå®Œæˆåéƒ½éœ€è¦æ‰§è¡Œçš„ä»£ç æä¾›äº†ä¸€ç§æ–¹å¼ã€‚</p>
<p>è¿™é¿å…äº†åŒæ ·çš„è¯­å¥éœ€è¦åœ¨<code>then()</code>å’Œ<code>catch()</code>ä¸­å„å†™ä¸€æ¬¡çš„æƒ…å†µã€‚</p>
<pre><code>promise
.then(result =&gt; {Â·Â·Â·})
.catch(error =&gt; {Â·Â·Â·})
.finally(() =&gt; {Â·Â·Â·});
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œä¸ç®¡<code>promise</code>æœ€åçš„çŠ¶æ€ï¼Œåœ¨æ‰§è¡Œå®Œ<code>then</code>æˆ–<code>catch</code>æŒ‡å®šçš„å›è°ƒå‡½æ•°ä»¥åï¼Œéƒ½ä¼šæ‰§è¡Œ<code>finally</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚</p>
<p>å¦‚æœä½ æƒ³åœ¨ <code>promise</code> æ‰§è¡Œå®Œæ¯•åæ— è®ºå…¶ç»“æœæ€æ ·éƒ½åšä¸€äº›å¤„ç†æˆ–æ¸…ç†æ—¶ï¼Œ<code>finally()</code> æ–¹æ³•å¯èƒ½æ˜¯æœ‰ç”¨çš„ã€‚</p>
<p>â—¾ ç”±äºæ— æ³•çŸ¥é“<code>promise</code>çš„æœ€ç»ˆçŠ¶æ€ï¼Œæ‰€ä»¥<code>finally</code>çš„å›è°ƒå‡½æ•°ä¸­ä¸æ¥æ”¶ä»»ä½•å‚æ•°ï¼Œå®ƒä»…ç”¨äºæ— è®ºæœ€ç»ˆç»“æœå¦‚ä½•éƒ½è¦æ‰§è¡Œçš„æƒ…å†µã€‚</p>
<p>â—¾ ä¸<code>Promise.resolve(2).then(() =&gt; {}, () =&gt; {})</code> ï¼ˆresolved çš„ç»“æœä¸º<code>undefined</code>ï¼‰ä¸åŒï¼Œ<code>Promise.resolve(2).finally(() =&gt; {})</code> resolved çš„ç»“æœä¸º <code>2</code>ã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4c3b75fb94146ae8a35a3f424bc28ed~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>â—¾ åŒæ ·ï¼Œ<code>Promise.reject(3).then(() =&gt; {}, () =&gt; {})</code> (fulfilled çš„ç»“æœä¸º<code>undefined</code>), <code>Promise.reject(3).finally(() =&gt; {})</code> rejected çš„ç»“æœä¸º <code>3</code>ã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6733f2cd59ac47e5bc43cbe8a3aeaee5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<h1>å¹¶å‘ promise.all()</h1>
<p>å¯ä»¥ä½¿ç”¨<code>Promise.all()</code>ï¼Œ<strong>å‘èµ·å¤šä¸ªå¹¶å‘è¯·æ±‚</strong>ï¼Œç„¶ååœ¨æ‰€æœ‰ promise éƒ½è¢«è§£å†³åæ‰§è¡Œä¸€äº›æ“ä½œã€‚</p>
<pre><code>function getUserAccount() {
  return axios.get('/user/12345');
}

function getUserPermissions() {
  return axios.get('/user/12345/permissions');
}

Promise.all([getUserAccount(), getUserPermissions()])
  .then(function (results) {
    const acct = results[0];
    const perm = results[1];
  });
</code></pre>
<p>ES2015 è§£æ„èµ‹å€¼è¯­æ³•ä¹Ÿå¯ä»¥æ‰§è¡Œï¼š</p>
<pre><code>Promise.all([getUserAccount, getUserPermissions]).then(([res1, res2]) =&gt; {
  console.log('ç»“æœ', res1, res2)
})
</code></pre>
<p>å½“ç„¶ï¼Œä¸é™äºä½¿ç”¨ <code>axios</code>ï¼Œä»»ä½• promise éƒ½å¯ä»¥ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code>const promise1 = Promise.resolve(3);
const promise2 = 42;
const promise3 = new Promise((resolve, reject) =&gt; {
  setTimeout(resolve, 100, 'foo');
});

Promise.all([promise1, promise2, promise3]).then((values) =&gt; {
  console.log(values);
});
// expected output: Array [3, 42, &quot;foo&quot;]
</code></pre>
<h1>ç«é€Ÿ promise.race()</h1>
<p>race çš„ç”¨æ³•æ˜¯ï¼š<strong>ä¼ å…¥å¤šä¸ª promise å®ä¾‹ï¼Œè°è·‘çš„å¿«ï¼Œå°±ä»¥è°çš„ç»“æœæ‰§è¡Œå›è°ƒ</strong></p>
<p><code>Promise.raceèµ›è·‘æœºåˆ¶ï¼Œåªè®¤ç¬¬ä¸€å</code></p>
<p>ä¼ ç»™ <code>race()</code> çš„ <code>promiseåˆ—è¡¨</code>ï¼Œ<strong>åªè¦æœ‰ä¸€ä¸ª promise è¢«è§£å†³ï¼Œåˆ™ <code>Promise.race()</code> å¼€å§‹è¿è¡Œï¼Œå¹¶ä¸”åªè¿è¡Œä¸€æ¬¡é™„åŠ çš„å›è°ƒï¼ˆä¼ å…¥ç¬¬ä¸€ä¸ªè¢«è§£å†³çš„ <code>promise</code> çš„ç»“æœï¼‰</strong>ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code>const first = new Promise((resolve, reject) =&gt; {
  setTimeout(resolve, 500, 'ç¬¬ä¸€ä¸ª')
})
const second = new Promise((resolve, reject) =&gt; {
  setTimeout(resolve, 100, 'ç¬¬äºŒä¸ª')
})

Promise.race([first, second]).then(result =&gt; {
  console.log(result) // ç¬¬äºŒä¸ª
})
</code></pre>
<p><strong>â—¾ ä½¿ç”¨åœºæ™¯</strong></p>
<ul>
<li>1ã€æŠŠå¼‚æ­¥æ“ä½œå’Œå®šæ—¶å™¨æ”¾åˆ°ä¸€èµ·ï¼Œå¦‚æœå®šæ—¶å™¨å…ˆè§¦å‘ï¼Œè®¤ä¸ºè¶…æ—¶ï¼Œå‘ŠçŸ¥ç”¨æˆ·ï¼›</li>
<li>2ã€å¦‚æœå›¾ç‰‡ç­‰èµ„æºæœ‰å¤šä¸ªå­˜æ”¾è·¯å¾„ï¼Œä½†æ˜¯ä¸ç¡®å®šå“ªä¸ªè·¯å¾„çš„èµ„æºæ›´å¿«ï¼Œå¯ä»¥ç”¨è¯¥æ–¹æ³•åŒæ—¶è¯·æ±‚å¤šä¸ªè·¯å¾„ï¼Œå“ªä¸ªè·¯å¾„çš„èµ„æºæœ€å…ˆæ‹¿åˆ°ï¼Œä½¿ç”¨å“ªä¸ªèµ„æº</li>
<li>3ã€å¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è·å¾—ç»“æœï¼Œå°±å°† Promise çš„çŠ¶æ€å˜ä¸º<code>reject</code>ï¼Œå¦åˆ™å˜ä¸º<code>resolve</code></li>
</ul>
<p>å®ä¾‹ï¼š</p>
<p>â—¾ æŠŠå¼‚æ­¥æ“ä½œå’Œå®šæ—¶å™¨æ”¾åˆ°ä¸€èµ·ï¼Œå¦‚æœå®šæ—¶å™¨å…ˆè§¦å‘ï¼Œè®¤ä¸ºè¶…æ—¶ï¼Œå‘ŠçŸ¥ç”¨æˆ·:</p>
<pre><code>function timeOut(time) {
    let result = new Promise((resolve,reject) =&gt; {
        setTimeout(() =&gt; {
            resolve(&quot;è¯·æ±‚è¶…æ—¶&quot;)
        }, time) // ä¸ºäº†éªŒè¯æ–¹æ³•ï¼Œå¯ä»¥æŠŠæ—¶é—´è®¾å°ç‚¹
    });
    return result;
}

Promise.race([timeOut(200), fetch('https://api.github.com/users/ruanyf')]).then(res =&gt; {
    console.log(res);
})
</code></pre>
<p>ç°ä»£æµè§ˆå™¨åŸç”Ÿæ”¯æŒ fetchï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œä¸Šé¢çš„ä»£ç ï¼š</p>
<p>ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œè¿™é‡Œ<code>setTimeout</code>æ—¶é—´è®¾å°ä¸€ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°å®šæ—¶å™¨å…ˆå®Œæˆï¼Œç„¶å <code>race()</code> æ–¹æ³•ä»¥å®šæ—¶å™¨çš„ç»“æœæ‰§è¡Œäº†å›è°ƒ</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e388a53e1874d5792ad3fca3792766f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>æŠŠ<code>setTimeout</code>è®¾å¤§ä¸€ç‚¹ï¼Œè¿™æ¬¡æ¥å£å…ˆè¯·æ±‚å®Œæˆï¼Œæ‰€ä»¥ <code>race()</code> ä»¥æ¥å£çš„ç»“æœæ‰§è¡Œäº†å›è°ƒ</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8c8e7f92b3a644fd8308e31d9fa3b773~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>â—¾ ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è·å¾—ç»“æœï¼Œå°±å°† Promise çš„çŠ¶æ€å˜ä¸º<code>reject</code>ï¼Œå¦åˆ™å˜ä¸º<code>resolve</code>ã€‚</p>
<pre><code>const p = Promise.race([
  fetch('/resource-that-may-take-a-while'),
  new Promise(function (resolve, reject) {
    setTimeout(() =&gt; reject(new Error('request timeout')), 5000)
  })
]);

p
.then(console.log)
.catch(console.error);
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœ 5 ç§’ä¹‹å†…<code>fetch</code>æ–¹æ³•æ— æ³•è¿”å›ç»“æœï¼Œå˜é‡<code>p</code>çš„çŠ¶æ€å°±ä¼šå˜ä¸º<code>rejected</code>ï¼Œä»è€Œè§¦å‘<code>catch</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚</p>
<h1>Promise.allSettled()</h1>
<p>è¯¥<code>Promise.allSettled()</code>æ–¹æ³•è¿”å›ä¸€ä¸ªåœ¨æ‰€æœ‰ç»™å®šçš„ promise éƒ½å·²ç»<code>fulfilled</code>æˆ–<code>rejected</code>åçš„ promiseï¼Œå¹¶å¸¦æœ‰ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡è¡¨ç¤ºå¯¹åº”çš„ promise ç»“æœã€‚</p>
<p>å½“æ‚¨æœ‰å¤šä¸ªå½¼æ­¤ä¸ä¾èµ–çš„å¼‚æ­¥ä»»åŠ¡æˆåŠŸå®Œæˆæ—¶ï¼Œæˆ–è€…æ‚¨æ€»æ˜¯æƒ³çŸ¥é“æ¯ä¸ª promise çš„ç»“æœæ—¶ï¼Œé€šå¸¸ä½¿ç”¨å®ƒã€‚</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>Promise.all()</code> æ›´é€‚åˆå½¼æ­¤ç›¸äº’ä¾èµ–æˆ–è€…åœ¨å…¶ä¸­ä»»ä½•ä¸€ä¸ª<code>reject</code>æ—¶ç«‹å³ç»“æŸã€‚</p>
<p><code>Promise.allSettled()</code>æ–¹æ³•æ¥å—ä¸€ç»„ Promise å®ä¾‹ä½œä¸ºå‚æ•°ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚åªæœ‰ç­‰åˆ°æ‰€æœ‰è¿™äº›å‚æ•°å®ä¾‹éƒ½è¿”å›ç»“æœï¼Œä¸ç®¡æ˜¯<code>fulfilled</code>è¿˜æ˜¯<code>rejected</code>ï¼ŒåŒ…è£…å®ä¾‹æ‰ä¼šç»“æŸã€‚è¯¥æ–¹æ³•ç”± ES2020 å¼•å…¥ã€‚</p>
<pre><code>const promises = [
  fetch('/api-1'),
  fetch('/api-2'),
  fetch('/api-3'),
];
await Promise.allSettled(promises);
removeLoadingIndicator();// ç§»é™¤åŠ è½½çš„æ»šåŠ¨å›¾æ ‡
</code></pre>
<p>ä¸Šé¢ä»£ç å¯¹æœåŠ¡å™¨å‘å‡ºä¸‰ä¸ªè¯·æ±‚ï¼Œç­‰åˆ°ä¸‰ä¸ªè¯·æ±‚éƒ½ç»“æŸï¼Œä¸ç®¡è¯·æ±‚æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒåŠ è½½çš„æ»šåŠ¨å›¾æ ‡å°±ä¼šæ¶ˆå¤±ã€‚</p>
<p>è¯¥æ–¹æ³•è¿”å›çš„æ–°çš„ Promise å®ä¾‹ï¼Œä¸€æ—¦ç»“æŸï¼ŒçŠ¶æ€æ€»æ˜¯<code>fulfilled</code>ï¼Œä¸ä¼šå˜æˆ<code>rejected</code>ã€‚çŠ¶æ€å˜æˆ<code>fulfilled</code>åï¼ŒPromise çš„ç›‘å¬å‡½æ•°æ¥æ”¶åˆ°çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæˆå‘˜å¯¹åº”ä¸€ä¸ªä¼ å…¥<code>Promise.allSettled()</code>çš„ Promise å®ä¾‹ã€‚</p>
<pre><code>const resolved = Promise.resolve(42);
const rejected = Promise.reject(-1);

const allSettledPromise = Promise.allSettled([resolved, rejected]);

allSettledPromise.then(function (results) {
  console.log(results);
});
// [
//    { status: 'fulfilled', value: 42 },
//    { status: 'rejected', reason: -1 }
// ]
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>Promise.allSettled()</code>çš„è¿”å›å€¼<code>allSettledPromise</code>ï¼ŒçŠ¶æ€åªå¯èƒ½å˜æˆ<code>fulfilled</code>ã€‚å®ƒçš„ç›‘å¬å‡½æ•°æ¥æ”¶åˆ°çš„å‚æ•°æ˜¯æ•°ç»„<code>results</code>ã€‚è¯¥æ•°ç»„çš„æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹åº”ä¼ å…¥<code>Promise.allSettled()</code>çš„ä¸¤ä¸ª Promise å®ä¾‹ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æœ‰<code>status</code>å±æ€§ï¼Œè¯¥å±æ€§çš„å€¼åªå¯èƒ½æ˜¯å­—ç¬¦ä¸²<code>fulfilled</code>æˆ–å­—ç¬¦ä¸²<code>rejected</code>ã€‚<code>fulfilled</code>æ—¶ï¼Œå¯¹è±¡æœ‰<code>value</code>å±æ€§ï¼Œ<code>rejected</code>æ—¶æœ‰<code>reason</code>å±æ€§ï¼Œå¯¹åº”ä¸¤ç§çŠ¶æ€çš„è¿”å›å€¼ã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a22e24ecb384387ab4b3d2426e1b15a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>â—¾ ä¸‹é¢æ˜¯è¿”å›å€¼ç”¨æ³•çš„ä¾‹å­ã€‚</p>
<pre><code>const promises = [ fetch('index.html'), fetch('https://does-not-exist/') ];
const results = await Promise.allSettled(promises);

// è¿‡æ»¤å‡ºæˆåŠŸçš„è¯·æ±‚
const successfulPromises = results.filter(p =&gt; p.status === 'fulfilled');

// è¿‡æ»¤å‡ºå¤±è´¥çš„è¯·æ±‚ï¼Œå¹¶è¾“å‡ºåŸå› 
const errors = results
  .filter(p =&gt; p.status === 'rejected')
  .map(p =&gt; p.reason);
</code></pre>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒå¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œåªå…³å¿ƒè¿™äº›æ“ä½œæœ‰æ²¡æœ‰ç»“æŸã€‚è¿™æ—¶ï¼Œ<code>Promise.allSettled()</code>æ–¹æ³•å°±å¾ˆæœ‰ç”¨ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæƒ³è¦ç¡®ä¿æ‰€æœ‰æ“ä½œéƒ½ç»“æŸï¼Œå°±å¾ˆéº»çƒ¦ã€‚<code>Promise.all()</code>æ–¹æ³•æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<pre><code>const urls = [ /* ... */ ];
const requests = urls.map(x =&gt; fetch(x));

try {
  await Promise.all(requests);
  console.log('æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸã€‚');
} catch {
  console.log('è‡³å°‘ä¸€ä¸ªè¯·æ±‚å¤±è´¥ï¼Œå…¶ä»–è¯·æ±‚å¯èƒ½è¿˜æ²¡ç»“æŸã€‚');
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>Promise.all()</code>æ— æ³•ç¡®å®šæ‰€æœ‰è¯·æ±‚éƒ½ç»“æŸã€‚æƒ³è¦è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå†™èµ·æ¥å¾ˆéº»çƒ¦ï¼Œæœ‰äº†<code>Promise.allSettled()</code>ï¼Œè¿™å°±å¾ˆå®¹æ˜“äº†ã€‚</p>
<h1>å¸¸è§çš„é”™è¯¯</h1>
<p><strong>â—¾ <code>Uncaught TypeError: undefined is not a promise</code></strong></p>
<p>å¦‚æœåœ¨æ§åˆ¶å°ä¸­æ”¶åˆ° <code>Uncaught TypeError: undefined is not a promise</code> é”™è¯¯ï¼Œåˆ™è¯·ç¡®ä¿ä½¿ç”¨ <code>new Promise()</code> è€Œä¸æ˜¯ <code>Promise()</code>ã€‚</p>
<p><strong>â—¾ <code>UnhandledPromiseRejectionWarning</code></strong></p>
<p>è¿™æ„å‘³ç€è°ƒç”¨çš„ promise è¢«æ‹’ç»ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨äºå¤„ç†é”™è¯¯çš„ catchã€‚ åœ¨ then ä¹‹åæ·»åŠ  catch åˆ™å¯ä»¥æ­£ç¡®åœ°å¤„ç†ã€‚</p>
<hr>