<h1>300 è¡Œä»£ç å®ç° React çš„è°ƒåº¦å™¨ Scheduler</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/7171728961473347614?searchId=20230722164549C90E0B97E39FDD8357CF">juejin.cn</a></p>
</blockquote>
<h2>æºç  Schedule.js</h2>
<hr>
<p>// æµè§ˆå™¨æä¾›çš„ APIï¼Œè·å–ä» time originï¼ˆå½“å‰æ–‡æ¡£ç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹èŠ‚ç‚¹æ—¶é—´ï¼‰ ä¹‹ååˆ°å½“å‰è°ƒç”¨æ—¶ç»è¿‡çš„æ—¶é—´ï¼Œå®ƒä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿç‡æ…¢æ…¢å¢åŠ çš„ï¼Œä¸ä¼šå—åˆ°ç³»ç»Ÿæ—¶é—´çš„å½±å“ï¼Œå…·ä½“å‚è€ƒï¼šhttps://juejin.cn/post/7171633315336683528
let getCurrentTime = () =&gt; performance.now();</p>
<hr>
<p>// å¼•å…¥æœ€å°å †å°è£…ä»£ç 
import {push, pop, peek} from './ScheduleMinHeap.js';</p>
<p>// Scheduler ä¼˜å…ˆçº§åˆ’åˆ†ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œ0 è¡¨ç¤ºæ²¡æœ‰ä¼˜å…ˆçº§
const NoPriority = 0;
const ImmediatePriority = 1;
const UserBlockingPriority = 2;
const NormalPriority = 3;
const LowPriority = 4;
const IdlePriority = 5;</p>
<p>// Scheduler æ ¹æ®ä¼˜å…ˆçº§è®¾ç½®çš„å¯¹åº” timeout æ—¶é—´ï¼Œè¶Šå°è¶Šç´§æ€¥</p>
<hr>
<p>åœ¨ React ä¸­ï¼Œä»»åŠ¡æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œä½†æ˜¯ä»»åŠ¡ä¸èƒ½ä¸€ç›´è¢«æ‰“æ–­ï¼Œæ‰€ä»¥è¦è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¿‡äº†è¿™ä¸ªæ—¶é—´å°±å¿…é¡»ç«‹åˆ»æ‰§è¡Œ
// timeout å°±è¡¨ç¤ºè¶…æ—¶æ—¶é—´
var IMMEDIATE_PRIORITY_TIMEOUT = -1;
var USER_BLOCKING_PRIORITY_TIMEOUT = 250;
var NORMAL_PRIORITY_TIMEOUT = 5000;
var LOW_PRIORITY_TIMEOUT = 10000;
// ä¸ºä»€ä¹ˆæ˜¯ 1073741823ï¼Œç”¨äº† 31ï¼ˆ30+1ï¼‰ ä½æ¥ä¿å­˜
var IDLE_PRIORITY_TIMEOUT = 1073741823;</p>
<hr>
<p>// æ™®é€šä»»åŠ¡é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ€å°å †ç»“æ„
var taskQueue = [];
// å»¶æ—¶ä»»åŠ¡é˜Ÿåˆ—ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ªæœ€å°å †ç»“æ„
var timerQueue = [];
// taskId
var taskIdCounter = 1;</p>
<hr>
<p>// ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨è¢«éå†æ‰§è¡Œï¼ŒworkLoop æ‰§è¡Œå‰ä¸º trueï¼Œæ‰§è¡Œå®Œæˆåæ”¹ä¸º false
var isPerformingWork = false;
// æ˜¯å¦æœ‰æ­£åœ¨æ‰§è¡Œçš„ requestHostCallbackï¼Œå®ƒä¼šåœ¨ requestHostCallback è°ƒç”¨å‰è®¾ä¸º trueï¼ŒworkLoop æ‰§è¡Œå‰æ”¹ä¸º false
var isHostCallbackScheduled = false;
// æ˜¯å¦æœ‰æ­£åœ¨æ‰§è¡Œçš„ requestHostTimeoutï¼Œå®ƒä¼šåœ¨ requestHostTimeout æ‰§è¡Œå‰è®¾ä¸º trueï¼ŒcancenlHostTimeout å’Œ handleTimeout ä¸­è®¾ä¸º false
var isHostTimeoutScheduled = false;
// message loop æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œå®ƒä¼šåœ¨ schedulePerformWorkUntilDeadline å‰è®¾ä¸º trueï¼Œåœ¨ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•åè®¾ä¸º false
let isMessageLoopRunning = false;</p>
<p>// è®°å½• requestHostCallback æ‰§è¡Œæ—¶ä¼ å…¥çš„ callback å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ flushWork
let scheduledHostCallback = null;
// ç”¨äº cancelHostTimeout å–æ¶ˆ requestHostTimeout
let taskTimeoutID = -1;</p>
<p>// è®°å½•å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
var currentTask = null;
var currentPriorityLevel = NormalPriority;</p>
<hr>
<p>// è¿™é‡Œæ˜¯è°ƒåº¦çš„å¼€å§‹
function unstable_scheduleCallback(priorityLevel, callback, options) {
var currentTime = getCurrentTime();</p>
<p>// ä»»åŠ¡è¢«å®‰æ’è°ƒåº¦çš„æ—¶é—´ï¼Œç›¸å½“äºå»é“¶è¡Œæ—¶çš„ç‚¹å‡»æ’å·æœºå™¨çš„é‚£ä¸ªæ—¶é—´
var startTime;
if (typeof options === 'object' &amp;&amp; options !== null) {
var delay = options.delay;
if (typeof delay === 'number' &amp;&amp; delay &gt; 0) {
startTime = currentTime + delay;
} else {
startTime = currentTime;
}
} else {
startTime = currentTime;
}</p>
<p>// ä»»åŠ¡ä¸èƒ½ä¸€ç›´è¢«æ‰“æ–­ï¼Œtimeout è¡¨ç¤ºè¿™ä¸ªä»»åŠ¡çš„è¶…æ—¶æ—¶é—´
var timeout;
switch (priorityLevel) {
case ImmediatePriority:
timeout = IMMEDIATE_PRIORITY_TIMEOUT;
break;
case UserBlockingPriority:
timeout = USER_BLOCKING_PRIORITY_TIMEOUT;
break;
case IdlePriority:
timeout = IDLE_PRIORITY_TIMEOUT;
break;
case LowPriority:
timeout = LOW_PRIORITY_TIMEOUT;
break;
case NormalPriority:
default:
timeout = NORMAL_PRIORITY_TIMEOUT;
break;
}</p>
<hr>
<p>// ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ = å¼€å§‹è°ƒåº¦çš„æ—¶é—´ + è¶…æ—¶æ—¶é—´
var expirationTime = startTime + timeout;</p>
<p>// è¿™å°±æ˜¯å‚¨å­˜åœ¨ä»»åŠ¡é˜Ÿåˆ—ï¼ˆtaskQueue å’Œ timerQueueï¼‰ä¸­çš„ä»»åŠ¡å¯¹è±¡
var newTask = {
id: taskIdCounter++,
callback,
priorityLevel,
startTime,
expirationTime,
sortIndex: -1,
};</p>
<p>// å¦‚æœ startTime &gt; currentTimeï¼Œè¯´æ˜æ˜¯å»¶æ—¶ä»»åŠ¡ï¼Œå°†å…¶æ”¾åˆ° timerQueue
if (startTime &gt; currentTime) {
newTask.sortIndex = startTime;
// è¿™ä¸ª push æ˜¯å°è£…çš„æœ€å°å † push æ–¹æ³•ï¼Œå°†å…ƒç´ è¿½åŠ åˆ°æ•°ç»„åï¼Œå®ƒä¼šå†è¿›è¡Œä¸€ä¸ªæ’åºï¼Œä¿è¯æœ€å°å€¼åœ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ª
push(timerQueue, newTask);
// peek(taskQueue) è·å– taskQueue çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå› ä¸ºæ˜¯æœ€å°å †ç»“æ„ï¼Œè·å–çš„æ˜¯æœ€ç´§æ€¥çš„ä»»åŠ¡
// è¿™ä¸ªé€»è¾‘æ˜¯åœ¨ taskQueue ä¸ºç©ºçš„æƒ…å†µä¸‹æ‰ä¼šè°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸º taskQueue ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šåœ¨æ¯ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šéå†ä¸€ä¸‹ timerQueueï¼Œå°†åˆ°æœŸçš„ä»»åŠ¡ç§»åˆ° taskQueue
// newTask === peek(timerQueue) è¡¨ç¤ºæ–°åˆ›å»ºçš„ä»»åŠ¡å°±æ˜¯æœ€æ—©çš„è¦å®‰æ’è°ƒåº¦çš„å»¶æ—¶ä»»åŠ¡
if (peek(taskQueue) === null &amp;&amp; newTask === peek(timerQueue)) {
// ä¿è¯æœ€å¤šåªæœ‰ä¸€ä¸ª requestHostTimeout åœ¨æ‰§è¡Œ
if (isHostTimeoutScheduled) {
cancelHostTimeout();
} else {
isHostTimeoutScheduled = true;
}
// requestHostTimeout æœ¬è´¨æ˜¯ä¸€ä¸ª setTimeoutï¼Œæ—¶é—´åˆ°åï¼Œæ‰§è¡Œ handleTimeout
requestHostTimeout(handleTimeout, startTime - currentTime);
}
}
// å¦‚æœæ˜¯æ­£å¸¸ä»»åŠ¡ï¼Œå°†å…¶æ”¾åˆ° taskQueue
else {
newTask.sortIndex = expirationTime;
push(taskQueue, newTask);
// å¦‚æœæ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ requestHostCallback å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ²¡æœ‰è¢«æ‰§è¡Œ
if (!isHostCallbackScheduled &amp;&amp; !isPerformingWork) {
isHostCallbackScheduled = true;
requestHostCallback(flushWork);
}
}</p>
<p>return newTask;
}</p>
<hr>
<p>// ä½ å¯ä»¥æŠŠè¿™ä¸ªå‡½æ•°ç†è§£ä¸º requestIdleCallbackï¼Œéƒ½å®ç°äº†ç©ºé—²æ—¶æœŸæ‰§è¡Œä»£ç 
function requestHostCallback(callback) {
// å°† callback å‡½æ•°å­˜ä¸ºå…¨å±€å˜é‡ï¼Œä¼ å…¥çš„æ˜¯ flushWork è¿™ä¸ªå‡½æ•°
scheduledHostCallback = callback;
if (!isMessageLoopRunning) {
isMessageLoopRunning = true;
schedulePerformWorkUntilDeadline();
}
}</p>
<p>const channel = new MessageChannel();
const port = channel.port2;
channel.port1.onmessage = performWorkUntilDeadline;
// å€ŸåŠ© Message Channelï¼Œè®©å‡ºçº¿ç¨‹ï¼Œå‘Šè¯‰æµè§ˆå™¨ç™»ç©ºé—²äº†å†æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—
function schedulePerformWorkUntilDeadline() {
port.postMessage(null);
};</p>
<hr>
<p>// æ‰¹é‡ä»»åŠ¡çš„å¼€å§‹æ—¶é—´
// React å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œéƒ½æ‰§è¡Œ schedulePerformWorkUntilDeadline è®©å‡ºçº¿ç¨‹çš„ï¼Œè€Œæ˜¯æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œçœ‹çœ‹è¿‡äº†å¤šä¹…ï¼Œå¦‚æœæ—¶é—´ä¸è¶…è¿‡ 5msï¼Œé‚£å°±å†æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œç­‰åšå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå‘ç°è¿‡äº† 5msï¼Œè¿™æ‰è®©å‡ºçº¿ç¨‹ï¼Œæ‰€ä»¥ React æ˜¯ä¸€æ‰¹ä¸€æ‰¹ä»»åŠ¡æ‰§è¡Œçš„ï¼ŒstartTime è®°å½•çš„æ˜¯è¿™ä¸€æ‰¹ä»»åŠ¡çš„å¼€å§‹æ—¶é—´ï¼Œè€Œä¸æ˜¯å•ä¸ªä»»åŠ¡çš„å¼€å§‹æ—¶é—´ã€‚
var startTime = -1;
function performWorkUntilDeadline() {
// scheduledHostCallback å°±æ˜¯ flushWork è¿™ä¸ªå‡½æ•°
if (scheduledHostCallback !== null) {
const currentTime = getCurrentTime();
startTime = currentTime;
const hasTimeRemaining = true;
let hasMoreWork = true;
try {
hasMoreWork = scheduledHostCallback(hasTimeRemaining, currentTime);
} finally {
if (hasMoreWork) {
// å¦‚æœåœ¨ä¸€ä¸ªæ—¶é—´åˆ‡ç‰‡é‡Œæ²¡æœ‰å®Œæˆæ‰€æœ‰ä»»åŠ¡ï¼Œé‚£å°±æ‰§è¡Œ schedulePerformWorkUntilDeadlineï¼Œè®©å‡ºçº¿ç¨‹ï¼Œç­‰æµè§ˆå™¨ç©ºé—²äº†å†ç»§ç»­æ‰§è¡Œ
schedulePerformWorkUntilDeadline();
} else {
isMessageLoopRunning = false;
scheduledHostCallback = null;
}
}
} else {
isMessageLoopRunning = false;
}
};</p>
<hr>
<p>function flushWork(hasTimeRemaining, initialTime) {
isHostCallbackScheduled = false;
// å®šæ—¶å™¨çš„ç›®çš„è¡¨é¢ä¸Šæ˜¯ä¸ºäº†ä¿è¯æœ€æ—©çš„å»¶æ—¶ä»»åŠ¡å‡†æ—¶å®‰æ’è°ƒåº¦ï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†ä¿è¯ timerQueue ä¸­çš„ä»»åŠ¡éƒ½èƒ½è¢«æ‰§è¡Œã€‚å®šæ—¶å™¨åˆ°æœŸåï¼Œæˆ‘ä»¬ä¼šæ‰§è¡Œ advanceTimers å’Œ flushWorkï¼ŒflushWork ä¸­ä¼šæ‰§è¡Œ workLoopï¼ŒworkLoop ä¸­ä¼šå°† taskQueue ä¸­çš„ä»»åŠ¡ä¸æ–­æ‰§è¡Œï¼Œå½“ taskQueue æ‰§è¡Œå®Œæ¯•åï¼ŒworkLoop ä¼šé€‰æ‹© timerQueue ä¸­çš„æœ€æ—©çš„ä»»åŠ¡é‡æ–°è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ã€‚æ‰€ä»¥å¦‚æœ flushWork æ‰§è¡Œäº†ï¼Œå®šæ—¶å™¨ä¹Ÿå°±æ²¡æœ‰å¿…è¦äº†ï¼Œæ‰€ä»¥å¯ä»¥å–æ¶ˆäº†ã€‚
if (isHostTimeoutScheduled) {
isHostTimeoutScheduled = false;
cancelHostTimeout();
}</p>
<p>isPerformingWork = true;
const previousPriorityLevel = currentPriorityLevel;
try {
return workLoop(hasTimeRemaining, initialTime);
} finally {
currentTask = null;
currentPriorityLevel = previousPriorityLevel;
isPerformingWork = false;
}
}</p>
<hr>
<p>// éå† taskQueueï¼Œæ‰§è¡Œä»»åŠ¡
function workLoop(hasTimeRemaining, initialTime) {
console.log('workLoop start')
let currentTime = initialTime;
// æ£€æŸ¥ timerQueue ä¸­çš„ä»»åŠ¡ï¼Œå°†åˆ°æœŸçš„ä»»åŠ¡è½¬åˆ° taskQueue ä¸­
advanceTimers(currentTime);
currentTask = peek(taskQueue);
while (currentTask !== null) {
// å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰åˆ°è¿‡æœŸæ—¶é—´å¹¶ä¸” shouldYieldToHost è¿”å› true
if (currentTask.expirationTime &gt; currentTime &amp;&amp; shouldYieldToHost()) {
break;
}
// è·å–ä»»åŠ¡æ‰§è¡Œå‡½æ•°
const callback = currentTask.callback;
if (typeof callback === 'function') {
currentTask.callback = null;
currentPriorityLevel = currentTask.priorityLevel;
// è¯¥ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™æ˜¯å¦å·²ç»è¿‡æœŸ
const didUserCallbackTimeout = currentTask.expirationTime &lt;= currentTime;
// ä»»åŠ¡å‡½æ•°æ‰§è¡Œ
const continuationCallback = callback(didUserCallbackTimeout);
currentTime = getCurrentTime();
// React ä¸­å•ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œå¦‚æœå•ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™è¢«æ‰“æ–­ï¼Œä¼šè¿”å›ä¸€ä¸ªå‡½æ•°
// è¿™ä¸ªä»»åŠ¡è¢«æ‰“æ–­äº†
if (typeof continuationCallback === 'function') {
currentTask.callback = continuationCallback;
}
// è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•
else {
if (currentTask === peek(taskQueue)) {
pop(taskQueue);
}
}
// æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—
advanceTimers(currentTime);
}
// è¯´æ˜ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
else {
pop(taskQueue);
}
// æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
currentTask = peek(taskQueue);
}</p>
<p>if (currentTask !== null) {
return true;
} else {
// å¦‚æœ taskQueue ç©ºäº†ï¼ŒtimerQueue ä¸­çš„æœ€å…ˆæ‰§è¡Œçš„ä»»åŠ¡è¿˜æ²¡æœ‰åˆ°æ—¶é—´ï¼Œé‚£å°±æ‰§è¡Œä¸€ä¸ª requestHostTimeout å®šæ—¶å™¨ï¼Œä¿è¯å‡†æ—¶æ‰§è¡Œ
const firstTimer = peek(timerQueue);
if (firstTimer !== null) {
requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime);
}
return false;
}
}</p>
<hr>
<p>// æ£€æŸ¥ timerQueue ä¸­çš„ä»»åŠ¡ï¼Œå°†åˆ°æœŸçš„ä»»åŠ¡è½¬åˆ° taskQueue ä¸­
function advanceTimers(currentTime) {
let timer = peek(timerQueue);
while (timer !== null) {
// ä»»åŠ¡è¢«å–æ¶ˆäº†
if (timer.callback === null) {
pop(timerQueue);
}
// //ä»»åŠ¡åˆ°æœŸå°±è½¬åˆ° taskQueue ä¸­
else if (timer.startTime &lt;= currentTime) {
pop(timerQueue);
timer.sortIndex = timer.expirationTime;
push(taskQueue, timer);
} else {
return;
}
timer = peek(timerQueue);
}
}</p>
<hr>
<p>// é»˜è®¤æ—¶é—´åˆ‡ç‰‡ä¸º 5ms
let frameInterval = 5;</p>
<p>// åˆ¤æ–­æ˜¯å¦è®©å‡ºçº¿ç¨‹ï¼Œä¸»è¦çœ‹è¿™æ‰¹ä»»åŠ¡è‡ªå¼€å§‹è¿‡äº†å¤šä¹…ï¼Œè¶…è¿‡äº†åˆ‡ç‰‡æ—¶é—´ï¼Œå°±è®©å‡ºçº¿ç¨‹
function shouldYieldToHost() {
const timeElapsed = getCurrentTime() - startTime;
if (timeElapsed &lt; frameInterval) {
return false;
}</p>
<p>return true;
}</p>
<hr>
<p>function requestHostTimeout(callback, ms) {
taskTimeoutID = setTimeout(() =&gt; {
callback(getCurrentTime());
}, ms);
}</p>
<p>function cancelHostTimeout() {
clearTimeout(taskTimeoutID);
taskTimeoutID = -1;
}</p>
<p>function handleTimeout(currentTime) {
isHostTimeoutScheduled = false;
advanceTimers(currentTime);</p>
<p>if (!isHostCallbackScheduled) {
if (peek(taskQueue) !== null) {
isHostCallbackScheduled = true;
requestHostCallback(flushWork);
}
// å»¶æ—¶ä»»åŠ¡å¯èƒ½è¢«å–æ¶ˆäº†
else {
const firstTimer = peek(timerQueue);
if (firstTimer !== null) {
requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime);
}
}
}
}</p>
<h2>æºç  ScheduleMinHeap.js</h2>
<pre><code class="language-js">// æºç åœ°å€ï¼šhttps://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerMinHeap.js

export function push(heap, node) {
  const index = heap.length;
  heap.push(node);

  siftUp(heap, node, index);
}

export function peek(heap) {
  return heap.length === 0 ? null : heap[0];
}

export function pop(heap) {
  if (heap.length === 0) {
    return null;
  }
  const first = heap[0];
  // JavaScript çš„ pop æ–¹æ³•åˆ é™¤å¹¶è¿”å›æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ 
  const last = heap.pop();
  if (last !== first) {
    heap[0] = last;
    siftDown(heap, last, 0);
  }
  return first;
}

function siftUp(heap, node, i) {
  let index = i;
  while (index &gt; 0) {
    // è·å–çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•ä½ç½®
    const parentIndex = (index - 1) &gt;&gt;&gt; 1;
    const parent = heap[parentIndex];
    if (compare(parent, node) &gt; 0) {
      // å¦‚æœçˆ¶èŠ‚ç‚¹æ›´å¤§ï¼Œå°±äº¤æ¢ä½ç½®
      heap[parentIndex] = node;
      heap[index] = parent;
      index = parentIndex;
    } else {
      // ç›´åˆ°çˆ¶èŠ‚ç‚¹æ›´å°ï¼Œå°±é€€å‡º
      return;
    }
  }
}

function siftDown(heap, node, i) {
  let index = i;
  const length = heap.length;
  const halfLength = length &gt;&gt;&gt; 1;
  while (index &lt; halfLength) {
    const leftIndex = (index + 1) * 2 - 1;
    const left = heap[leftIndex];
    const rightIndex = leftIndex + 1;
    const right = heap[rightIndex];
    
    // å¦‚æœ left æ¯” node å°
    if (compare(left, node) &lt; 0) {
      // å¦‚æœ right æ¯” left è¿˜å°ï¼Œè¯´æ˜ right æœ€å°ï¼Œright ä¸ node äº¤æ¢
      if (rightIndex &lt; length &amp;&amp; compare(right, left) &lt; 0) {
        heap[index] = right;
        heap[rightIndex] = node;
        index = rightIndex;
      }
      // è¯´æ˜ left æœ€å°ï¼Œleft ä¸ node äº¤æ¢
      else {
        heap[index] = left;
        heap[leftIndex] = node;
        index = leftIndex;
      }
    }
    // å¦‚æœ left node å¤§ï¼Œä½† right æ¯” node å°ï¼Œright ä¸ node äº¤æ¢
    else if (rightIndex &lt; length &amp;&amp; compare(right, node) &lt; 0) {
      heap[index] = right;
      heap[rightIndex] = node;
      index = rightIndex;
    } else {
      // å­å…ƒç´ éƒ½æ¯” node å¤§
      return;
    }
  }
}

function compare(a, b) {
  // é¦–å…ˆæ¯”è¾ƒ sortIndexï¼Œå…¶æ¬¡æ˜¯ id
  const diff = a.sortIndex - b.sortIndex;
  return diff !== 0 ? diff : a.id - b.id;
}
</code></pre>
<h2>æµ‹è¯•ä»£ç </h2>
<pre><code>// æ¨¡æ‹Ÿå‡½æ•°çš„æ‰§è¡Œ
const sleep = delay =&gt; {
  for (let start = Date.now(); Date.now() - start &lt;= delay;) {}
}

unstable_scheduleCallback(3, () =&gt; {console.log(1)})

unstable_scheduleCallback(3, () =&gt; {
  console.log(2)
  sleep(10)
}, {
  delay: 10
})

unstable_scheduleCallback(3, () =&gt; {console.log(3)}, {
  delay: 10
})

unstable_scheduleCallback(3, () =&gt; {
  console.log(4)
  sleep(10)
})

unstable_scheduleCallback(3, () =&gt; {console.log(5)})
</code></pre>
<p>å®ƒçš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a04414af9954279bbd1e2e6a41b72c4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<h1> </h1>
<h1>React Scheduler åŸç†åŠæ‰‹å†™æºç </h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/7140642609806082061">juejin.cn</a></p>
</blockquote>
<h2>å­¦ä¹ ç›®æ ‡</h2>
<ul>
<li>åŒæ­¥æ›´æ–° &amp; å¼‚æ­¥æ›´æ–°</li>
<li>ä¸ºå•¥é‡‡ç”¨ MessageChannel è€Œä¸æ˜¯ setTimeout ç­‰ api å®ç°å¼‚æ­¥ä»»åŠ¡è°ƒåº¦</li>
<li>ä»»åŠ¡åˆ‡ç‰‡</li>
<li>æ—¶é—´åˆ‡ç‰‡</li>
</ul>
<h2>åŒæ­¥æ›´æ–°é¡µé¢</h2>
<p>è€æ¿è¯´äº†ï¼Œä»–æœ‰ä¸€ç»„ä»»åŠ¡ï¼Œç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œéœ€è¦éå†æ‰§è¡Œå®Œè¿™ç»„ä»»åŠ¡ï¼Œç»Ÿè®¡å…¨éƒ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆçš„è€—æ—¶ï¼Œç„¶åæ›´æ–°åˆ°é¡µé¢ã€‚æ¯ä¸ªä»»åŠ¡æ‰§è¡Œè€—æ—¶å·®ä¸å¤š 2msï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>let works = [];
for (let i = 0; i &lt; 3000; i++) {
  works.push(() =&gt; {
    const start = new Date().getTime();
    while (new Date().getTime() - start &lt; 2) {}
  });
}
</code></pre>
<p>å°æçœ‹äº†çœ‹ï¼Œè€æ¿çš„éœ€æ±‚æ€»æ˜¯è¿™ä¹ˆç®€å•ï¼Œä¸åˆ° 2 ç§’ï¼Œå°æå·²ç»å®ç°äº†å¦‚ä¸‹ï¼š</p>
<pre><code>btn.onclick = () =&gt; {
  const startTime = new Date().getTime();
  flushWork();
  const endTime = new Date().getTime();
  animate.innerHTML = endTime - startTime;
};

function flushWork() {
  works.forEach((w) =&gt; w());
}
</code></pre>
<hr>
<p>ç‚¹äº†ä¸‹æŒ‰é’®ã€‚ç»“æœï¼Œè¿‡äº†å·®ä¸å¤š 6 ç§’é¡µé¢æ‰æ›´æ–°ï¼ŒåŒæ—¶é¡µé¢å¡æ­»ï¼Œå†æ¬¡ç‚¹å‡»æŒ‰é’®éƒ½ç‚¹ä¸äº†ã€‚
å› ä¸ºè¿™ç»„ä»»åŠ¡æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ€»å…±è€—æ—¶å·®ä¸å¤š 6 ç§’ï¼Œè€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œjs å¼•æ“ä¸€ç›´å ç”¨ç€æ§åˆ¶æƒï¼Œæµè§ˆå™¨æ— æ³•ç»˜åˆ¶é¡µé¢ï¼Œä¹Ÿæ— æ³•å“åº”ç”¨æˆ·ï¼Œç”¨æˆ·ä½“éªŒç›¸å½“ä¸å¥½
æ‰€ä»¥ï¼Œè¿™ç»„è€—æ—¶é•¿çš„ä»»åŠ¡ä¸åº”è¯¥åŒæ­¥æ‰§è¡Œ</p>
<h2>ä½¿ç”¨ setTimeout å¼‚æ­¥æ›´æ–°é¡µé¢</h2>
<p>ä¸ºäº†ä¸é•¿æ—¶é—´å ç”¨ä¸»çº¿ç¨‹ï¼Œé˜»å¡æµè§ˆå™¨æ¸²æŸ“ï¼Œå°æå°†ä»»åŠ¡æ‹†åˆ†åˆ°å®šæ—¶å™¨æ‰§è¡Œï¼Œæ¯ä¸ªå®šæ—¶å™¨æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚
æ¯æ‰§è¡Œä¸€æ¬¡éƒ½åˆ¤æ–­ works æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œå¦‚æœå…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œåˆ™æ›´æ–°é¡µé¢ã€‚
æ¯æ‰§è¡Œå®Œä¸€æ¬¡ä»»åŠ¡ï¼Œéƒ½ä¸»åŠ¨å°†æ§åˆ¶æƒè®©å‡ºç»™æµè§ˆå™¨ã€‚</p>
<pre><code>btn.onclick = () =&gt; {
  startTime = new Date().getTime();
  flushWork();
};

function flushWork() {
  setTimeout(workLoop, 0);
}

function workLoop() {
  const work = works.shift();
  if (work) {
    work();
    setTimeout(workLoop, 0);
  } else {
    const endTime = new Date().getTime();
    animate.innerHTML = endTime - startTime;
  }
}
</code></pre>
<p>ç‚¹å‡»æŒ‰é’®ï¼Œè¿™æ¬¡é¡µé¢åŠ¨ç”»ç»ˆäºä¸å¡é¡¿äº†ï¼Œç„¶è€Œç­‰äº†å·®ä¸å¤š 19 ç§’çš„æ—¶é—´ï¼Œé¡µé¢æ‰æ›´æ–°ã€‚</p>
<hr>
<p>ä¸ºå•¥è¿™æ¬¡æ‰§è¡Œè€—æ—¶ 19266 æ¯«ç§’ï¼Œè¿œæ¯”ä¹‹å‰å¤šå‡ºäº† 13266 æ¯«ç§’ï¼Ÿ
å°æçœ‹äº†ä¸‹ Performanceã€‚
è™½ç„¶ä½¿ç”¨äº†<code>setTimeout(workLoop, 0)</code>0 æ¯«ç§’çš„æ—¶é—´é—´éš”ï¼Œä½†æ˜¯æµè§ˆå™¨ä¾ç„¶ä¼šæœ‰ 4 åˆ° 5 æ¯«ç§’çš„é—´éš”æ—¶é—´ã€‚å¦‚æœä¸¤æ¬¡ setTimeout ä¹‹é—´æœ€å°‘é—´éš” 4 æ¯«ç§’ï¼Œéƒ½æœ‰è‡³å°‘ 3000 * 4 = 12000 æ¯«ç§’çš„è€—æ—¶äº†ã€‚
æ˜¾ç„¶ï¼ŒsetTimeout ç”±äº 4 æ¯«ç§’é—´éš”çš„åŸå› ï¼Œä¸é€‚ç”¨äºæˆ‘ä»¬çš„åœºæ™¯ã€‚</p>
<hr>
<p>ä¸ä½¿ç”¨ Promise æˆ–è€… MutationObserver ç­‰å¾®ä»»åŠ¡ API çš„åŸå› æ˜¯ï¼Œå¾®ä»»åŠ¡æ˜¯åœ¨é¡µé¢æ›´æ–°å‰å…¨éƒ¨æ‰§è¡Œå®Œæˆçš„ï¼Œæ•ˆæœå’ŒåŒæ­¥æ‰§è¡Œä»»åŠ¡å·®ä¸å¤šã€‚</p>
<h2>ä½¿ç”¨ MessageChannel å¼‚æ­¥æ›´æ–°é¡µé¢</h2>
<p>ä½¿ç”¨ <code>MessageChannel</code> è§¦å‘ä¸€ä¸ªå®ä»»åŠ¡ï¼Œåœ¨å®ä»»åŠ¡äº‹ä»¶ä¸­æ‰§è¡Œå·¥ä½œã€‚
æ¯æ‰§è¡Œå®Œä¸€ä¸ªå·¥ä½œï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»æ‰§è¡Œå®Œå…¨éƒ¨çš„å·¥ä½œï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ›´æ–°é¡µé¢ï¼Œå¦åˆ™è°ƒç”¨<code>port.postMessage(null)</code>è§¦å‘ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œç»§ç»­æ‰§è¡Œå‰©ä½™çš„å·¥ä½œã€‚</p>
<pre><code>var channel = new MessageChannel();
var port = channel.port2;
channel.port1.onmessage = workLoop;

let startTime;
btn.onclick = () =&gt; {
  startTime = new Date().getTime();
  port.postMessage(null);
};

function workLoop() {
  const work = works.shift();
  if (work) {
    work();
    port.postMessage(null);
  } else {
    const endTime = new Date().getTime();
    animate.innerHTML = endTime - startTime;
  }
}
</code></pre>
<p>è‡ªæµ‹äº†ä¸‹ï¼Œå‘ç°è€—æ—¶åªç”¨äº† 6090 æ¯«ç§’ï¼
ä¸ºä»€ä¹ˆä¼šå¤šå‡ºäº† 90 æ¯«ç§’ï¼Ÿè§‚å¯Ÿ performance å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶ä¸¤æ¬¡å®ä»»åŠ¡ä¹‹é—´é—´éš”éå¸¸çŸ­ï¼Œä½†ä¹Ÿä¼šå¯¼è‡´é¢å¤–çš„å¼€é”€ï¼Œç´¯ç§¯èµ·æ¥å°±æœ‰äº†å‡ æ¯«ç§’çš„å·®å¼‚ã€‚ä¸è¿‡ï¼Œè¿™å·²ç»å¾ˆè´´è¿‘ 6000 æ¯«ç§’çš„æ‰§è¡Œè€—æ—¶äº†ï¼Œä¼˜åŠ¿è¿œèƒœäº setTimeout</p>
<h3>MessageChannelé—®é¢˜åˆ†æ</h3>
<p>è¿™æ¬¡ï¼Œå°æèƒ½å¤ŸåŒæ—¶å…¼é¡¾é¡µé¢åŠ¨ç”»æµç•…ã€ä¸å¡é¡¿ä»¥åŠå¿«é€Ÿå“åº”ç”¨æˆ·è¾“å…¥ï¼Œå°½æ—©æ›´æ–°é¡µé¢ã€‚
ä½†æ˜¯è¿˜æœ‰ä¸€ç‚¹å°ç‘•ç–µï¼Œç”±äºä¸¤æ¬¡ä»»åŠ¡ä¹‹é—´è¿˜æ˜¯ä¼šæœ‰ä¸€ç‚¹ç‚¹çš„æ—¶é—´é—´éš”ï¼Œæ‰§è¡Œæ•°é‡ä¼—å¤šçš„ä»»åŠ¡æ—¶ï¼Œè¿™äº›é—´éš”çš„æ—¶é—´å°±ä¼šç´¯åŠ èµ·æ¥ï¼Œå°±ä¼šæœ‰å‡ æ¯«ç§’çš„é¢å¤–å¼€é”€ã€‚</p>
<h2>ä»»åŠ¡åˆ‡ç‰‡ï¼šä¸€æ¬¡å®ä»»åŠ¡äº‹ä»¶å°½å¯èƒ½æ‰§è¡Œæ›´å¤šçš„ä»»åŠ¡</h2>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œé¢å¤–æ¶ˆè€—çš„æ—¶é—´ç­‰äºä¸¤æ¬¡å®ä»»åŠ¡ä¹‹é—´çš„æ—¶é—´é—´éš” * å·¥ä½œçš„æ•°é‡ï¼š
æ˜¾ç„¶ï¼Œæˆ‘ä»¬æ— æ³•æ§åˆ¶ä¸¤æ¬¡å®ä»»åŠ¡ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‡å°‘è§¦å‘å®ä»»åŠ¡äº‹ä»¶çš„æ¬¡æ•°ã€‚
å¯ä»¥é€šè¿‡åœ¨ä¸€æ¬¡å®ä»»åŠ¡äº‹ä»¶ä¸­æ‰§è¡Œæ›´å¤šçš„ä»»åŠ¡æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚
åŒæ—¶ï¼Œä¸€æ¬¡å®ä»»åŠ¡äº‹ä»¶çš„æ‰§è¡Œè€—æ—¶åˆä¸èƒ½è¶…è¿‡ 1 å¸§çš„æ—¶é—´ (16.6ms)ï¼Œæ¯•ç«Ÿæˆ‘ä»¬éœ€è¦ç•™ç‚¹æ—¶é—´ç»™æµè§ˆå™¨ç»˜åˆ¶é¡µé¢
ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå°æå°†ä»»åŠ¡æ‹†åˆ†æˆå‡ å°æ®µæ‰§è¡Œï¼Œå³<strong>ä»»åŠ¡åˆ‡ç‰‡</strong>ã€‚</p>
<hr>
<p>æ—¢ç„¶ä¸€å¸§ 16.6 æ¯«ç§’ï¼Œæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡éœ€è¦ 2 æ¯«ç§’ï¼Œé‚£åªéœ€è¦åœ¨ä¸€æ¬¡å®ä»»åŠ¡äº‹ä»¶ä¸­æ‰§è¡Œ 7 ä¸ªä»»åŠ¡å°±å¥½ï¼Œè¿™æ ·æµè§ˆå™¨è¿˜æœ‰ 2.6 æ¯«ç§’ç»˜åˆ¶é¡µé¢ã€‚</p>
<pre><code>var channel = new MessageChannel();
var port = channel.port2;
channel.port1.onmessage = workLoop;

let startTime;
btn.onclick = () =&gt; {
  startTime = new Date().getTime();
  port.postMessage(null);
};
function workLoop() {
  let i = 0;
  while (i &lt; 7) {
    let work = works.shift();
    if (work) {
      work();
      i++;
    } else {
      const endTime = new Date().getTime();
      animate.innerHTML = endTime - startTime;
      i = 7; // æ²¡æœ‰å‰©ä½™å·¥ä½œå°±ç›´æ¥é€€å‡ºå¾ªç¯
    }
  }
  if (works.length) {
    port.postMessage(null);
  }
}
</code></pre>
<h3>ä»»åŠ¡åˆ‡ç‰‡é—®é¢˜åˆ†æ</h3>
<h2>é‡‡ç”¨ä»»åŠ¡åˆ‡ç‰‡çš„æ–¹æ³•æå¤§å‡å°‘äº†è§¦å‘ message channel çš„æ¬¡æ•°ï¼Œå‡å°‘äº†å®ä»»åŠ¡ä¹‹é—´è°ƒåº¦çš„é¢å¤–æ¶ˆè€—ã€‚
ä½†ä»»åŠ¡åˆ‡ç‰‡çš„ä¸€ä¸ªå‰ææ˜¯ï¼Œæ¯ä¸ªä»»åŠ¡æ‰§è¡Œè€—æ—¶æ˜¯ç¡®å®šçš„ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ 2 æ¯«ç§’ï¼Œä½†çœŸå®çš„ä¸šåŠ¡åœºæ™¯æ˜¯æ— æ³•çŸ¥é“ä»»åŠ¡çš„æ‰§è¡Œè€—æ—¶çš„
æˆ‘ä»¬æ¥æ¢è®¨ä¸€ç§æ—¶é—´åˆ‡ç‰‡çš„æ–¹å¼
æ—¶é—´åˆ‡ç‰‡</h2>
<p>æˆ‘ä»¬çŸ¥é“æµè§ˆå™¨ä¸€å¸§åªæœ‰ 16.6msï¼ŒåŒæ—¶æˆ‘ä»¬çš„å·¥ä½œæ‰§è¡Œè€—æ—¶åˆä¸æ˜¯ç¡®å®šçš„ã€‚
é‚£æˆ‘ä»¬å¯ä»¥ï¼Œå°†ä¸€æ¬¡å®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°½å¯èƒ½çš„æ§åˆ¶åœ¨ä¸€å®šçš„æ—¶é—´å†…ï¼Œæ¯”å¦‚ 5msã€‚
æ¯å®Œæˆä¸€ä¸ªå·¥ä½œä»»åŠ¡ï¼Œéƒ½åˆ¤æ–­æ‰§è¡Œæ—¶é—´æ˜¯å¦è¶…å‡ºäº† 5 æ¯«ç§’ï¼Œå¦‚æœè¶…å‡ºäº† 5 æ¯«ç§’ï¼Œåˆ™ä¸ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå·¥ä½œä»»åŠ¡ï¼Œç»“æŸæœ¬è½®å®ä»»åŠ¡äº‹ä»¶ï¼Œ<strong>ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ</strong>ç»™æµè§ˆå™¨ç»˜åˆ¶é¡µé¢ã€‚
å¦‚æœæ²¡æœ‰è¶…è¿‡ 5 æ¯«ç§’ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå·¥ä½œä»»åŠ¡ã€‚</p>
<hr>
<p>æ—¶é—´åˆ‡ç‰‡å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code>let works = [];
for (let i = 0; i &lt; 3000; i++) {
  works.push(() =&gt; {
    const start = new Date().getTime();
    while (new Date().getTime() - start &lt; 2) {}
  });
}
const btn = document.getElementById(&quot;btn&quot;);
const animate = document.getElementById(&quot;animation&quot;);

var channel = new MessageChannel();
var port = channel.port2;
channel.port1.onmessage = workLoop;

let endTime;
let startTime;
btn.onclick = () =&gt; {
  startTime = new Date().getTime();
  port.postMessage(null);
};
const yieldInterval = 5; // å•ä½æ¯«ç§’
function workLoop() {
  const currentEventStartTime = new Date().getTime();
  let work = works.shift();
  while (work) {
    work();
    // æ‰§è¡Œå®Œå½“å‰å·¥ä½œï¼Œåˆ™åˆ¤æ–­æ—¶é—´æ˜¯å¦è¶…è¿‡5msï¼Œå¦‚æœè¶…è¿‡ï¼Œåˆ™é€€å‡ºwhileå¾ªç¯
    if (new Date().getTime() - currentEventStartTime &gt; yieldInterval) {
      // æ‰§è¡Œè€—æ—¶è¶…è¿‡äº†5msï¼Œç»“æŸæœ¬è½®äº‹ä»¶ï¼Œä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒç»™æµè§ˆå™¨ç»˜åˆ¶é¡µé¢æˆ–è€…æ‰§è¡Œå…¶ä»–æ“ä½œ
      break;
    }
    work = works.shift();
  }
  // å¦‚æœè¿˜æœ‰å‰©ä½™çš„å·¥ä½œï¼Œåˆ™æ”¾åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶ä¸­å¤„ç†
  if (works.length) {
    port.postMessage(null);
  } else {
    const endTime = new Date().getTime();
    animate.innerHTML = endTime - startTime;
  }
}
</code></pre>
<h2>å°ç»“</h2>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ•ˆæœè¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚å°ææ”¶è·äº†ä»¥ä¸‹çŸ¥è¯†ï¼š</p>
<ul>
<li>è€—æ—¶é•¿çš„åŒæ­¥ä»»åŠ¡ä¼šé•¿æ—¶é—´å ç”¨æµè§ˆå™¨å¯¼è‡´æ— æ³•å“åº”ç”¨æˆ·è¾“å…¥ï¼Œé¡µé¢å¡é¡¿ç­‰é—®é¢˜</li>
<li>setTimeout ç”±äºæœ‰è‡³å°‘ 4 æ¯«ç§’çš„å»¶è¿Ÿï¼Œå› æ­¤ä¸é€‚åˆç”¨äºå¼‚æ­¥ä»»åŠ¡çš„è°ƒåº¦</li>
<li>MessageChannel åœ¨ä¸€å¸§çš„æ—¶é—´å†…è°ƒç”¨é¢‘ç‡è¶…é«˜ï¼Œä¸¤æ¬¡ message channel å®ä»»åŠ¡äº‹ä»¶ä¹‹é—´çš„é—´éš”å¼€é”€æå°‘ï¼Œé€‚åˆç”¨äºå¼‚æ­¥ä»»åŠ¡çš„è°ƒåº¦ã€‚</li>
<li>ç”±äºæ— æ³•æå‰å¾—çŸ¥ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œä»è€Œæ— æ³•è®¡ç®—ä¸€å¸§ä¹‹å†…åº”è¯¥æ‰§è¡Œå‡ ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥ä»»åŠ¡åˆ‡ç‰‡ä¸å¤ªé€‚ç”¨äºä¸€å¸§å†…è°ƒåº¦å¼‚æ­¥ä»»åŠ¡ã€‚</li>
<li>æ—¶é—´åˆ‡ç‰‡æ˜¯æ¯”è¾ƒç†æƒ³çš„é€‰æ‹©</li>
</ul>
<h2>å¼€æºç¬¬ä¸€æ­¥</h2>
<p>å°æå†³å®šå°†è¿™ä¸ªå°å·¥å…·å¼€æº</p>
<hr>
<ol>
<li>å°† Message Channel æŠ½æˆä¸€ä¸ªå…¬ç”¨çš„è°ƒåº¦æ–¹æ³•</li>
</ol>
<p>é€šè¿‡ requestHostCallback è§¦å‘ä¸€ä¸ª message channel äº‹ä»¶ï¼Œ
åŒæ—¶åœ¨ performWorkUntilDeadline æ¥æ”¶äº‹ä»¶</p>
<p>å¦‚æœ scheduledHostCallback è¿”å› trueï¼Œè¯´æ˜è¿˜æœ‰å‰©ä½™çš„å·¥ä½œæ²¡å®Œæˆï¼Œåˆ™è°ƒåº¦ä¸‹ä¸€ä¸ªå®ä»»åŠ¡äº‹ä»¶æ‰§è¡Œå‰©ä½™çš„å·¥ä½œã€‚</p>
<pre><code>const yieldInterval = 5;
let deadline = 0;
const channel = new MessageChannel();
let port = channel.port2;
channel.port1.onmessage = performWorkUntilDeadline;
function performWorkUntilDeadline() {
  if (scheduledHostCallback) {
    // å½“å‰å®ä»»åŠ¡äº‹ä»¶å¼€å§‹æ‰§è¡Œ
    let currentTime = new Date().getTime();
    // è®¡ç®—å½“å‰å®ä»»åŠ¡äº‹ä»¶ç»“æŸæ—¶é—´
    deadline = currentTime + yieldInterval;
    const hasMoreWork = scheduledHostCallback(currentTime);
    if (!hasMoreWork) {
      scheduledHostCallback = null;
    } else {
      // å¦‚æœè¿˜æœ‰å·¥ä½œï¼Œåˆ™è§¦å‘ä¸‹ä¸€ä¸ªå®ä»»åŠ¡äº‹ä»¶
      port.postMessage(null);
    }
  }
}
function requestHostCallback(callback) {
  scheduledHostCallback = callback;
  port.postMessage(null);
}
</code></pre>
<hr>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ performWorkUntilDeadline (ç”¨æ¥æ¥å—äº‹ä»¶)å¼€å§‹æ—¶è·å–åˆ°å½“å‰çš„æ—¶é—´ currentTimeï¼Œç„¶åè®¡ç®—å‡ºæœ¬æ¬¡äº‹ä»¶æ‰§è¡Œçš„æˆªæ­¢æ—¶é—´ï¼ŒperformWorkUntilDeadline çš„æ‰§è¡Œæ—¶é—´æ§åˆ¶åœ¨ 5 æ¯«ç§’å†…ï¼Œå› æ­¤æˆªæ­¢æ—¶é—´å°±æ˜¯ deadline = currentTime + yieldInterval;</p>
<hr>
<ol start="2">
<li>æˆ‘ä»¬éœ€è¦ä¸€ä¸ª scheduleCallback æ–¹æ³•ç»™ç”¨æˆ·æ·»åŠ ä»»åŠ¡ï¼Œ
æˆ‘ä»¬å°†ç”¨æˆ·æ·»åŠ çš„ä»»åŠ¡ä¿å­˜åœ¨ taskQueue ä¸­ã€‚ç„¶åè§¦å‘ä¸€ä¸ª message channel äº‹ä»¶ï¼Œå¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚</li>
</ol>
<pre><code>let taskQueue = [];
let isHostCallbackSchedule = false;
function scheduleCallback(callback) {
  var newTask = {
    callback: callback,
  };
  taskQueue.push(newTask);
  if (!isHostCallbackScheduled) {
    isHostCallbackScheduled = true;
    requestHostCallback(flushWork);
  }
  return newTask;
}
</code></pre>
<hr>
<ol start="3">
<li>æœ€åéœ€è¦å®ç° flushwork æ–¹æ³•ï¼Œåœ¨ workLoop æ–¹æ³•ä¸­ï¼Œæ¯æ‰§è¡Œä¸€ä¸ªå·¥ä½œï¼Œéƒ½éœ€è¦åˆ¤æ–­å½“å‰ performWorkUntilDeadline äº‹ä»¶æ‰§è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡ 5ms</li>
</ol>
<pre><code>let currentTask = null;
function flushWork(initialTime) {
  return workLoop(initialTime);
}

function workLoop(initialTime) {
  currentTask = taskQueue[0];

  while (currentTask) {
    if (new Date().getTime() &gt;= deadline) {
      // æ¯æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œéƒ½éœ€è¦åˆ¤æ–­å½“å‰çš„performWorkUntilDeadlineæ‰§è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡äº†æˆªæ­¢æ—¶é—´
      break;
    }
    var callback = currentTask.callback;
    callback();

    taskQueue.shift();
    currentTask = taskQueue[0];
  }
  if (currentTask) {
    // å¦‚æœtaskQueueä¸­è¿˜æœ‰å‰©ä½™å·¥ä½œï¼Œåˆ™è¿”å›true
    return true;
  } else {
    return false;
  }
}
</code></pre>
<hr>
<p>schedule å®ç°çš„ä½¿ç”¨</p>
<pre><code>const btn = document.getElementById(&quot;btn&quot;);
const animate = document.getElementById(&quot;animation&quot;);
let startTime;
btn.onclick = () =&gt; {
  startTime = new Date().getTime();
  for (let i = 0; i &lt; 3000; i++) {
    if (i === 2999) {
      scheduleCallback(() =&gt; {
        const start = new Date().getTime();
        while (new Date().getTime() - start &lt; 2) {}
        const endTime = new Date().getTime();
        animate.innerHTML = endTime - startTime;
      });
    } else {
      scheduleCallback(() =&gt; {
        const start = new Date().getTime();
        while (new Date().getTime() - start &lt; 2) {}
      });
    }
  }
};
</code></pre>
<p>ä»¥ä¸Šå°±æ˜¯ schedule çš„ç®€å•å®ç°ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šç»§ç»­å®ç°ä¼˜å…ˆçº§ã€å»¶è¿Ÿä»»åŠ¡ã€‚</p>
<h1> </h1>
<h1>React ä¹‹ Scheduler æºç ä¸­çš„ä¸‰ä¸ªå°çŸ¥è¯†ç‚¹ï¼Œçœ‹çœ‹ä½ çŸ¥ä¸çŸ¥é“ï¼Ÿ</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/7171633315336683528">juejin.cn</a></p>
</blockquote>
<h2>getCurrentTime</h2>
<p>Scheduler ä¸­æœ‰ä¸€ä¸ª getCurrentTime å‡½æ•°ï¼Œå®ƒçš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ¤æ–­performanceå¯ä»¥ä½¿ç”¨</li>
<li>ä¸èƒ½ç”¨ä½¿ç”¨ dateæ¥è·å¾—æ—¶é—´</li>
</ul>
<h2>åˆ¤æ–­performanceå¯ä»¥ä½¿ç”¨</h2>
<h2>const hasPerformanceNow =
typeof performance === 'object' &amp;&amp; typeof performance.now === 'function';
è·å¾—æ—¶é—´</h2>
<p>let getCurrentTime;
if (hasPerformanceNow) {
const localPerformance = performance;
getCurrentTime = () =&gt; localPerformance.now();
} else {
const localDate = Date;
const initialTime = localDate.now();
getCurrentTime = () =&gt; localDate.now() - initialTime;
}</p>
<p>è™½ç„¶å‡½æ•°åä¸ºè·å–å½“å‰æ—¶é—´ï¼Œä½†æ ¹æ®å®ç°ï¼Œå¯ä»¥çœ‹å‡ºï¼Œè·å–çš„å…¶å®æ˜¯ä»æ€§èƒ½æµ‹é‡æ—¶åˆ»å¼€å§‹çš„æ¯«ç§’æ•°
å¦‚æœç¯å¢ƒæ”¯æŒ performance.nowï¼Œé‚£å°±ç›´æ¥ä½¿ç”¨ performance.nowï¼Œæˆ‘ä»¬çœ‹ä¸‹ performance.now</p>
<h3>performance.now</h3>
<p>performance.nowè¿”å›å€¼è¡¨ç¤ºä¸ºä» time origin ä¹‹ååˆ°å½“å‰è°ƒç”¨æ—¶ç»è¿‡çš„æ—¶é—´,ç®€å•çš„æ¥è¯´ï¼Œperformance.now ä¼šè¿”å›è‡ªé¡µé¢åˆ›å»ºè¿‡äº†å¤šä¹…ã€‚
time origin è¯‘ä¸º â€œæ—¶é—´æºâ€, æ—¶é—´æºæ˜¯ä¸€ä¸ªå¯ä»¥è¢«è®¤å®šä¸ºå½“å‰æ–‡æ¡£ç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹èŠ‚ç‚¹çš„æ ‡å‡†æ—¶é—´ï¼Œ</p>
<hr>
<p>originçš„è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœè„šæœ¬çš„ global object æ˜¯ Window, åˆ™æ—¶é—´æºçš„ç¡®å®šæ–¹å¼å¦‚ä¸‹ï¼š
<ul>
<li>å¦‚æœå½“å‰ Document æ˜¯ä¸­åŠ è½½çš„ç¬¬ä¸€ä¸ª Window, åˆ™æ—¶é—´æºæ˜¯åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡çš„æ—¶é—´ã€‚</li>
<li>å¦‚æœå¤„äºå¸è½½çª—å£ä¸­å·²åŠ è½½çš„å…ˆå‰æ–‡æ¡£çš„è¿‡ç¨‹ä¸­ï¼Œ ä¸€ä¸ªç¡®è®¤å¯¹è¯æ¡†ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œè®©ç”¨æˆ·ç¡®è®¤æ˜¯å¦ç¦»å¼€å‰ä¸€é¡µï¼Œåˆ™æ—¶é—´æºæ˜¯ç”¨æˆ·ç¡®è®¤å¯¼èˆªåˆ°æ–°é¡µé¢çš„è¿™ä¸ªæ—¶é—´ï¼Œè¿™ä¸€ç‚¹æ˜¯è¢«è®¤åŒçš„ã€‚</li>
<li>å¦‚æœä»¥ä¸Šæ–¹å¼éƒ½ä¸èƒ½ç¡®å®šæ—¶é—´æº, é‚£ä¹ˆæ—¶é—´æºæ˜¯åˆ›å»ºçª—å£ä¸­å½“å‰ Document çš„å¯¼èˆªå‘ç”Ÿçš„æ—¶æœºã€‚</li>
</ul>
</li>
<li>å¦‚æœè„šæœ¬ä¸­çš„å…¨å±€å¯¹è±¡æ˜¯ WorkerGlobalScope (æ„å‘³ç€ï¼Œè¯¥è„šæœ¬ä»¥ web worker çš„å½¢å¼è¿è¡Œ), åˆ™æ—¶é—´æºæ˜¯è¿™ä¸ª worker è¢«åˆ›å»ºçš„æ—¶åˆ»ã€‚</li>
<li>åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œæ—¶é—´æºçš„å€¼æ˜¯ undefinedã€‚</li>
</ul>
<h3>Date.now</h3>
<p>è€Œ Date.now è¿”å›çš„æ˜¯è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ 00:00:00 (UTC) åˆ°å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°ã€‚</p>
<h3>performance.now VS Date.now</h3>
<ol>
<li>performance.now ç²¾åº¦æ›´é«˜ï¼Œä»¥æµ®ç‚¹æ•°è¡¨ç¤ºæ—¶é—´ï¼Œç²¾åº¦æœ€é«˜å¯è¾¾å¾®ç§’çº§ï¼ˆ1 æ¯«ç§’ = 1000 å¾®ç§’ï¼‰ï¼ŒDate.now åˆ™ä¸ºæ¯«ç§’çº§</li>
<li>performance.now() ä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿç‡æ…¢æ…¢å¢åŠ çš„ï¼Œå®ƒä¸ä¼šå—åˆ°ç³»ç»Ÿæ—¶é—´çš„å½±å“ï¼ˆç³»ç»Ÿæ—¶é’Ÿå¯èƒ½ä¼šè¢«æ‰‹åŠ¨è°ƒæ•´æˆ–è¢« NTP ç­‰è½¯ä»¶ç¯¡æ”¹ï¼‰</li>
<li>performance.now æ˜¯æµè§ˆå™¨æä¾›çš„æ–¹æ³•ï¼ŒDate.now æ˜¯ JavaScript å†…ç½®çš„æ–¹æ³•</li>
<li>performance.timing.navigationStart + performance.now() çº¦ç­‰äº Date.now()</li>
</ol>
<h2>maxSigned31BitInt</h2>
<p>åœ¨ <code>unstable_scheduleCallback</code> å‡½æ•°ä¸­ï¼Œå½“æ ¹æ®ä¼˜å…ˆçº§è®¡ç®— timeout æ—¶é—´æ—¶ï¼Œå¦‚æœæ˜¯ <code>IdlePriority</code>ï¼Œå¯¹åº”çš„ timeout æ—¶é—´ä¸º <code>IDLE_PRIORITY_TIMEOUT</code>ï¼Œå€¼ä¸º 1073741823ï¼Œè¿™ä¸ªæ•°å€¼æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„å‘¢ï¼Ÿ</p>
<pre><code>// Max 31 bit integer. The max integer size in V8 for 32-bit systems.
// Math.pow(2, 30) - 1
// 0b111111111111111111111111111111
var maxSigned31BitInt = 1073741823;
// Never times out
var IDLE_PRIORITY_TIMEOUT = maxSigned31BitInt;

</code></pre>
<p>æ ¹æ®æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼ŒmaxSigned31BitInt è¡¨ç¤º 32 ä½ç³»ç»Ÿä¸‹ V8 æœ€å¤§çš„æ•´æ•°ï¼Œå®ƒæ˜¯æœ€å¤§çš„ 31 ä½æ•´æ•°ï¼Œå®ƒçš„äºŒè¿›åˆ¶ä¸º <code>0b111111111111111111111111111111</code>ï¼Œè¿™å…¶ä¸­ <code>0b</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ•°å­—ï¼Œåé¢è·Ÿäº†ä¸€å…± 30 ä¸ª <code>1</code>ï¼Œæ‰€ä»¥è¿™ä¸ªå€¼æ˜¯ 2 çš„ 30 æ¬¡æ–¹ - 1ï¼Œä¹Ÿå°±æ˜¯ 1073741823ï¼Œè¿™ä¸ªæ—¶é—´å¤§æ¦‚æ˜¯ 12.4 å¤©</p>
<h2>Smis</h2>
<p>æ—¢ç„¶æ˜¯ 32 ä½ï¼Œä¸€ä½ç”¨äºç¬¦å·ä½ï¼Œé‚£è¿˜æœ‰ 31 ä½å‘€ï¼Œä¸ºä»€ä¹ˆæ˜¯ 2 çš„ 30 æ¬¡æ–¹è€Œä¸æ˜¯ 2 çš„ 31 æ¬¡æ–¹å‘¢ï¼Ÿ</p>
<p>è¿™å°±è¦è¯´åˆ°<code>Smis</code>ï¼Œåœ¨ ECMAScript æ ‡å‡†ä¸­ï¼Œæ•°å­—ä¼šè¢«å½“æˆ 64 ä½åŒç²¾åº¦æµ®ç‚¹æ•°å¤„ç†ï¼Œä½†æ˜¯ä¸€ç›´ä½¿ç”¨ 64 ä½å­˜å‚¨æ•°å­—æ˜¯ååˆ†ä½æ•ˆçš„ï¼Œå°±æ¯”å¦‚æ•°ç»„ç´¢å¼•ï¼Œåœ¨<a href="https://link.juejin.cn?target=https%3A%2F%2Ftc39.es%2Fecma262%2F%23array-index" title="https://tc39.es/ecma262/#array-index">è§„èŒƒ</a>ä¸­ï¼Œå®ƒçš„æœ€å¤§å€¼æ˜¯ 2Â³Â²-2ï¼Œæ²¡æœ‰å¿…è¦éè¦ä½¿ç”¨ 64 ä½å‚¨å­˜ï¼Œæ‰€ä»¥åƒ V8 å°±å»ºç«‹äº†ä¸€ä¸ªåä¸º <code>Smis</code> çš„ç‰¹æ®Šæ•´æ•°è¡¨ç¤ºæ–¹å¼ã€‚</p>
<p>å®ƒå…¶å®æ˜¯ <code>Small Integer</code>çš„ç¼©å†™ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯å°æ•´æ•°ï¼Œå®ƒçš„ç‰¹æ®Šåœ°æ–¹åœ¨äºå®ƒä¼šä½¿ç”¨æœ€ä½æœ‰æ•ˆä½ï¼ˆleast significant bitsï¼‰æ ‡è®°è¿™ä¸ªå€¼æ˜¯å¦æ˜¯ <code>Smis</code>ï¼š <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/317e39c4ace34267af97ae52a32a89e2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""> æ‰€ä»¥åœ¨ 32 ä½å¹³å°ä¸Šï¼Œå°±åªæœ‰ 31 ä½ç”¨æ¥å‚¨å­˜ <code>Smi</code>å€¼ã€‚</p>
<h2>isInputPending</h2>
<p>åœ¨ shouldYieldToHost çš„æºç ä¸­ï¼Œå…¶å®è¿˜æ¶‰åŠäº†ä¸€ä¸ª Scheduling API â€”â€” isInputPendingï¼Œå®ƒæ˜¯ facebook çš„å¼€å‘è€…æå‡ºçš„</p>
<p>å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½œç”¨æ˜¯æ£€æµ‹æ˜¯å¦æœ‰ç­‰å¾…ä¸­çš„ç”¨æˆ·è¾“å…¥äº‹ä»¶ï¼Œä½¿ç”¨è¯­æ³•ä¸ºï¼š</p>
<pre><code>if (navigator.scheduling.isInputPending()){
  // ...
}
</code></pre>
<h2>å½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœæµè§ˆå™¨æœ‰éœ€è¦å¤„ç†çš„è¾“å…¥äº‹ä»¶ï¼ŒisInputPending() å°±ä¼šè¿”å› trueã€‚
isInputPending()ä¼˜åŒ–</h2>
<p>React è¾›è¾›è‹¦è‹¦å®ç° Fiber ç»“æ„ï¼Œå…¶ç›®çš„å°±åœ¨äºèƒ½å¤ŸåŠæ—¶è®©å‡ºçº¿ç¨‹ï¼Œè®©æµè§ˆå™¨å¯ä»¥å¤„ç†ç”¨æˆ·è¾“å…¥æˆ–è€…åŠ¨ç”»ç­‰ï¼Œå€ŸåŠ© isInputPending() è¿™ä¸ª APIï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿåˆ¤æ–­å‡ºæ‰§è¡ŒæœŸé—´æ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥ï¼Œä»è€Œåšå‡ºå¤„ç†ï¼Œä¿è¯åŠæ—¶å“åº”ç”¨æˆ·è¾“å…¥ã€‚</p>
<p>é€šè¿‡åˆç†ä½¿ç”¨ isInputPending æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é¡µé¢æ¸²æŸ“æ—¶åŠæ—¶å“åº”ç”¨æˆ·è¾“å…¥ï¼Œå¹¶ä¸”ï¼Œå½“æœ‰é•¿è€—æ—¶çš„ JS ä»»åŠ¡è¦æ‰§è¡Œæ—¶ï¼Œå¯ä»¥é€šè¿‡ isInputPending æ¥ä¸­æ–­ JS çš„æ‰§è¡Œï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™æµè§ˆå™¨æ¥æ‰§è¡Œç”¨æˆ·å“åº”ã€‚</p>
<h2>isInputPending()ä½¿ç”¨å®ä¾‹</h2>
<pre><code>let taskQueue = [task1, task2, ...];
const options = {includeContinuous: true};

function doWork() {
  while (let task = taskQueue.pop()) {
    task.execute();
    if (navigator.scheduling.isInputPending(options)) {
      setTimeout(doWork, 0);
      break;
    }
  }
}

doWork();
</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥äº†ä¸€ä¸ª <code>{includeContinuous: true}</code>å¯¹è±¡ï¼Œè¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒisInputPending å¹¶ä¸ä¼šæ£€æµ‹è¿ç»­äº‹ä»¶ï¼Œå°±æ¯”å¦‚ <code>mousemove</code>ã€<code>pointermove</code>ç­‰ï¼Œè®¾ç½®ä¸º true åï¼Œä¹Ÿä¼šå¼€å¯æ£€æµ‹è¿™äº›äº‹ä»¶ã€‚</p>
<p>ä½†ç›®å‰å®ƒçš„å…¼å®¹æ€§è¿˜ä¸å¥½ï¼ŒChrome ä¹Ÿåªæœ‰ 87 ç‰ˆæœ¬ä»¥ä¸Šæ‰æ”¯æŒï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e4175b78faa4e5cb88cf16a7b807018~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>æ‰€ä»¥ React æºç ä¸­ä¹Ÿæ²¡æœ‰æ­£å¼å¼€å¯ä½¿ç”¨è¿™ä¸ª APIï¼š</p>
<pre><code>const continuousYieldMs = 50;
const continuousInputInterval = continuousYieldMs;

const maxYieldMs = 300;
const maxInterval = maxYieldMs;

const isInputPending =
  typeof navigator !== 'undefined' &amp;&amp;
  navigator.scheduling !== undefined &amp;&amp;
  navigator.scheduling.isInputPending !== undefined
    ? navigator.scheduling.isInputPending.bind(navigator.scheduling)
    : null;

function shouldYieldToHost() {
  const timeElapsed = getCurrentTime() - startTime;
  if (timeElapsed &lt; frameInterval) {
    return false;
  }

  // enableIsInputPending é»˜è®¤ false
  if (enableIsInputPending) {
    // ...
    if (timeElapsed &lt; continuousInputInterval) {
      if (isInputPending !== null) {
        return isInputPending();
      }
    } else if (timeElapsed &lt; maxInterval) {
      if (isInputPending !== null) {
        return isInputPending(continuousOptions);
      }
    } else {
      return true;
    }
  }
  return true;
}
</code></pre>
<h1> </h1>
<h1>React ä¹‹æœ€å°å †ï¼ˆmin heapï¼‰</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/7168283003037155359">juejin.cn</a></p>
</blockquote>
<h2>React é‡‡ç”¨åŸå› </h2>
<p>React çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆtaskQueueï¼‰ç”¨çš„å°±æ˜¯æœ€å°å †ã€‚
React ä¸ºä»€ä¹ˆé‡‡ç”¨æœ€å°å †ç»“æ„å‘¢ï¼Ÿ
React å°†æ›´æ–°ä»»åŠ¡æ‹†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œæ¯ä¸ªå°ä»»åŠ¡çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªå¸¦ç€ expirationTime çš„å¯¹è±¡ï¼ŒexpirationTime è¡¨ç¤ºè¿™ä¸ªä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ï¼ŒexpirationTime è¶Šå°å°±è¡¨ç¤ºè¿‡æœŸæ—¶é—´è¶Šè¿‘ï¼Œè¯¥ä»»åŠ¡çš„ä¼˜å…ˆçº§å°±è¶Šé«˜ï¼Œå–å‡ºæœ€å°å€¼å°±ç›¸å½“äºå–å‡ºä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ã€‚</p>
<h2>æ’å…¥è¿‡ç¨‹ï¼ˆpushï¼‰</h2>
<h2>äºŒå‰å †çš„æ’å…¥è¿‡ç¨‹ï¼š
å½“æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåœ¨äºŒå‰å †çš„æœ€åæ·»åŠ ï¼Œç„¶åå°†å…¶ â€œä¸Šæµ®â€ åˆ°æ­£ç¡®ä½ç½®ã€‚ä¸¾ä¸ªä¾‹å­ï¼š
&gt;&gt;&gt; 1</h2>
<pre><code>const parentIndex = (index - 1) &gt;&gt;&gt; 1;
</code></pre>
<p>è¿™æ˜¯ç”¨æ¥è·å–çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•å€¼çš„ã€‚
&gt;&gt;1 æ˜¯æœ‰ç¬¦å·å³ç§»ä½æ“ä½œç¬¦
&gt;&gt;&gt; 11 æ˜¯æ— ç¬¦å·å³ç§»ä½æ“ä½œç¬¦</p>
<h2>åˆ é™¤è¿‡ç¨‹ï¼ˆpopï¼‰</h2>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹åˆ é™¤è¿‡ç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬åˆ é™¤çš„æ˜¯æ ¹èŠ‚ç‚¹ï¼Œå®ƒçš„å…·ä½“æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>å–å‡ºæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ›¿æ¢æ‰æ ¹èŠ‚ç‚¹</li>
<li>å°†èŠ‚ç‚¹ â€œä¸‹æ²‰â€ åˆ°æ­£ç¡®ä½ç½®</li>
</ol>
<h2>halfLength</h2>
<p>siftDown çš„å®ç°ä¸­ï¼Œæˆ‘è®¤ä¸ºæœ€æœ‰æ„æ€æ˜¯åœ¨ <code>halfLength</code> è¿™é‡Œï¼š</p>
<pre><code>const length = heap.length;
  const halfLength = length &gt;&gt;&gt; 1;
  while (index &lt; halfLength) {//...}

</code></pre>
<p>é‚£ä¸ºä»€ä¹ˆåªç”¨æ¯”è¾ƒä¸€åŠå°±å¯ä»¥äº†å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬å°è¯•è‡ªå·±å»ç”»å‡ ä¸ªæœ€å°å †ï¼Œå‘ç°ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå®Œå…¨ä¸ç”¨å…¨éƒ¨æ¯”è¾ƒä¸€éã€‚
æˆ‘ä»¬å¯ä»¥è¿™æ ·æƒ³ï¼š å‡è®¾çˆ¶èŠ‚ç‚¹çš„ index ä¸º xï¼Œé‚£ä¹ˆå·¦å­èŠ‚ç‚¹çš„ index ä¸º 2x + 1ï¼Œå³å­èŠ‚ç‚¹çš„ index ä¸º 2x + 2ï¼Œæ¯ä¸€æ¬¡ shiftDownï¼Œindex çš„æœ€å¤§å˜åŒ–å°±æ˜¯ 2x + 2ï¼Œè€Œ 2x + 2 æœ€å¤§åªèƒ½ç­‰äº length - 1ï¼Œé‚£ä¹ˆï¼š</p>
<pre><code>å› ä¸º 2x + 2 &lt;= length - 1 
æ‰€ä»¥ x &lt;= length/2 - 1.5

æˆ‘ä»¬çŸ¥é“ y &gt;&gt;&gt; 1 ï¼Œåœ¨ y ä¸ºæ­£æ•°çš„æƒ…å†µä¸‹ï¼Œè®¡ç®—çš„ç»“æœä¸º y/2 - 0.5 æˆ–è€… y/2

å¦‚æœ x &lt;= length/2 - 1.5
é‚£ä¹ˆè‚¯å®š x &lt; length/2 - 0.5 ä»¥åŠ x &lt; length/2
æ‰€ä»¥è‚¯å®š x &lt; length &gt;&gt;&gt; 1

</code></pre>
<h1> </h1>
<h1>ã€Œreact è¿›é˜¶ã€ä¸€æ–‡åƒé€ react-hooks åŸç†</h1><h1>ä¸€ å‰è¨€</h1>
<p><code>react-hooks</code>å°±æ˜¯å‡½æ•°ç»„ä»¶<strong>è§£å†³æ²¡æœ‰<code>state</code>ï¼Œç”Ÿå‘½å‘¨æœŸï¼Œé€»è¾‘ä¸èƒ½å¤ç”¨</strong>çš„ä¸€ç§æŠ€æœ¯æ–¹æ¡ˆã€‚
Hook æ˜¯ React 16.8 çš„æ·»åŠ ç‰¹æ€§ã€‚å®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™ class çš„æƒ…å†µä¸‹ä½¿ç”¨ state ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§ã€‚</p>
<h2>å¸¦ç€ç–‘é—®</h2>
<ul>
<li>1 åœ¨æ— çŠ¶æ€ç»„ä»¶æ¯ä¸€æ¬¡å‡½æ•°ä¸Šä¸‹æ–‡æ‰§è¡Œçš„æ—¶å€™ï¼Œ<code>react</code>ç”¨ä»€ä¹ˆæ–¹å¼è®°å½•äº†<code>hooks</code>çš„çŠ¶æ€ï¼Ÿ</li>
<li>2 å¤šä¸ª<code>react-hooks</code>ç”¨ä»€ä¹ˆæ¥è®°å½•æ¯ä¸€ä¸ª<code>hooks</code>çš„é¡ºåºçš„ ï¼Ÿ ä¸ºä»€ä¹ˆä¸èƒ½æ¡ä»¶è¯­å¥ä¸­ï¼Œå£°æ˜<code>hooks</code>? <code>hooks</code>å£°æ˜ä¸ºä»€ä¹ˆåœ¨ç»„ä»¶çš„æœ€é¡¶éƒ¨ï¼Ÿ</li>
<li>3 <code>function</code>å‡½æ•°ç»„ä»¶ä¸­çš„<code>useState</code>ï¼Œå’Œ <code>class</code>ç±»ç»„ä»¶ <code>setState</code>æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li>
<li>4 <code>react</code> æ˜¯æ€ä¹ˆæ•è·åˆ°<code>hooks</code>çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ˜¯åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨çš„ï¼Ÿ</li>
<li>5 <code>useEffect</code>,<code>useMemo</code> ä¸­ï¼Œä¸ºä»€ä¹ˆ<code>useRef</code>ä¸éœ€è¦ä¾èµ–æ³¨å…¥ï¼Œå°±èƒ½è®¿é—®åˆ°æœ€æ–°çš„æ”¹å˜å€¼ï¼Ÿ</li>
<li>6 <code>useMemo</code>æ˜¯æ€ä¹ˆå¯¹å€¼åšç¼“å­˜çš„ï¼Ÿå¦‚ä½•åº”ç”¨å®ƒä¼˜åŒ–æ€§èƒ½ï¼Ÿ</li>
<li>7 ä¸ºä»€ä¹ˆä¸¤æ¬¡ä¼ å…¥<code>useState</code>çš„å€¼ç›¸åŒï¼Œå‡½æ•°ç»„ä»¶ä¸æ›´æ–°?</li>
</ul>
<h2>function ç»„ä»¶å’Œ class ç»„ä»¶æœ¬è´¨çš„åŒºåˆ«</h2>
<p><strong>å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶åˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«</strong>ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬å…ˆçœ‹ ä¸¤ä¸ªä»£ç ç‰‡æ®µã€‚</p>
<pre><code>class Index extends React.Component&lt;any,any&gt;{
    constructor(props){
        super(props)
        this.state={
            number:0
        }
    }
    handerClick=()=&gt;{
       for(let i = 0 ;i&lt;5;i++){
           setTimeout(()=&gt;{
               this.setState({ number:this.state.number+1 })
               console.log(this.state.number)
           },1000)
       }
    }

    render(){
        return &lt;div&gt;
            &lt;button onClick={ this.handerClick } &gt;num++&lt;/button&gt;
        &lt;/div&gt;
    }
}
</code></pre>
<p>æ‰“å°ç»“æœï¼š 1 2 3 4 5
ç±»ç»„ä»¶ä¸­ï¼Œç”±äºæ‰§è¡Œä¸Š<code>setState</code>æ²¡æœ‰åœ¨<code>react</code>æ­£å¸¸çš„å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯<code>setTimeout</code>ä¸­æ‰§è¡Œçš„ï¼Œ<strong>æ‰¹é‡æ›´æ–°</strong>æ¡ä»¶è¢«ç ´åã€‚ æ‰€ä»¥å¯ä»¥ç›´æ¥è·å–åˆ°å˜åŒ–åçš„<code>state</code>ã€‚</p>
<hr>
<p>å‡½æ•°ç»„ä»¶ä¸­ï¼š</p>
<pre><code>function Index(){
    const [ num ,setNumber ] = React.useState(0)
    const handerClick=()=&gt;{
        for(let i=0; i&lt;5;i++ ){
           setTimeout(() =&gt; {
                setNumber(num+1)
                console.log(num)
           }, 1000)
        }
    }
    return &lt;button onClick={ handerClick } &gt;{ num }&lt;/button&gt;
}
</code></pre>
<p>åœ¨ç¬¬äºŒä¸ªä¾‹å­ğŸŒ°æ‰“å°ç»“æœï¼š 0 0 0 0 0
åœ¨<code>class</code>çŠ¶æ€ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªå®ä¾‹åŒ–çš„<code>class</code>ï¼Œå»ç»´æŠ¤ç»„ä»¶ä¸­çš„å„ç§çŠ¶æ€ï¼›
ä½†æ˜¯åœ¨<code>function</code>ç»„ä»¶ä¸­ï¼Œæ²¡æœ‰ä¸€ä¸ªçŠ¶æ€å»ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œæ¯ä¸€æ¬¡å‡½æ•°ä¸Šä¸‹æ–‡æ‰§è¡Œï¼Œæ‰€æœ‰å˜é‡ï¼Œå¸¸é‡éƒ½é‡æ–°å£°æ˜ï¼Œæ‰§è¡Œå®Œæ¯•ï¼Œå†è¢«åƒåœ¾æœºåˆ¶å›æ”¶ã€‚
æ‰€ä»¥å¦‚ä¸Šï¼Œæ— è®º<code>setTimeout</code>æ‰§è¡Œå¤šå°‘æ¬¡ï¼Œéƒ½æ˜¯åœ¨å½“å‰å‡½æ•°ä¸Šä¸‹æ–‡æ‰§è¡Œ, æ­¤æ—¶<code>num = 0</code>ä¸ä¼šå˜ï¼Œä¹‹å<code>setNumber</code>æ‰§è¡Œï¼Œå‡½æ•°ç»„ä»¶é‡æ–°æ‰§è¡Œä¹‹åï¼Œ<code>num</code>æ‰å˜åŒ–ã€‚</p>
<hr>
<p>æ‰€ä»¥ï¼Œ å¯¹äº<code>class</code>ç»„ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œå®ä¾‹ä¸­ä¿å­˜äº†ç»„ä»¶çš„<code>state</code>ç­‰çŠ¶æ€ã€‚å¯¹äºæ¯ä¸€æ¬¡æ›´æ–°åªéœ€è¦è°ƒç”¨<code>render</code>æ–¹æ³•å°±å¯ä»¥ã€‚
ä½†æ˜¯åœ¨<code>function</code>ç»„ä»¶ä¸­ï¼Œæ¯ä¸€æ¬¡æ›´æ–°éƒ½æ˜¯ä¸€æ¬¡æ–°çš„å‡½æ•°æ‰§è¡Œ,
ä¸ºäº†ä¿å­˜ä¸€äº›çŠ¶æ€, æ‰§è¡Œä¸€äº›å‰¯ä½œç”¨é’©å­,<code>react-hooks</code>åº”è¿è€Œç”Ÿï¼Œå»å¸®åŠ©è®°å½•ç»„ä»¶çš„çŠ¶æ€ï¼Œå¤„ç†ä¸€äº›é¢å¤–çš„å‰¯ä½œç”¨ã€‚</p>
<h2>1 å½“æˆ‘ä»¬å¼•å…¥ hooks æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h2>
<p><code>useState</code>åœ¨æ–‡ä»¶ <code>react/src/ReactHooks.js</code>ä¸­</p>
<pre><code>export function useState(initialState){
  const dispatcher = resolveDispatcher();
  return dispatcher.useState(initialState);
}
</code></pre>
<p><code>useState()</code> çš„æ‰§è¡Œç­‰äº <code>dispatcher.useState(initialState)</code> è¿™é‡Œé¢å¼•å…¥äº†ä¸€ä¸ª<code>dispatcher</code>ï¼Œ
dispatcherç”±resolveDispatherè·å¾—, æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>resolveDispatcher</code>åšäº†äº›ä»€ä¹ˆï¼Ÿ</p>
<hr>
<p><strong>resolveDispatcher</strong></p>
<pre><code>function resolveDispatcher() {
  const dispatcher = ReactCurrentDispatcher.current
  return dispatcher
}
</code></pre>
<pre><code>const ReactCurrentDispatcher = {
  current: null,
};
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°<code>ReactCurrentDispatcher.current</code>åˆå§‹åŒ–çš„æ—¶å€™ä¸º<code>null</code>ï¼Œç„¶åå°±æ²¡ä»»ä½•ä¸‹æ–‡äº†ã€‚æˆ‘ä»¬æš‚ä¸”åªèƒ½æŠŠ <strong><code>ReactCurrentDispatcher</code></strong> è®°ä¸‹æ¥ã€‚çœ‹çœ‹<code>ReactCurrentDispatcher</code>ä»€ä¹ˆæ—¶å€™ç”¨åˆ°çš„ ï¼Ÿ</p>
<p>æœ€åä»¥ä¸€ä¸ª<code>ReactCurrentDispatcher</code>è‰è‰æ”¶å°¾ï¼Œçº¿ç´¢å…¨éƒ¨æ–­äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬åªèƒ½ä»å‡½æ•°ç»„ä»¶æ‰§è¡Œå¼€å§‹ã€‚</p>
<h3>renderWithHooks æ‰§è¡Œå‡½æ•°</h3>
<p>å¯¹äº<code>function</code>ç»„ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„å‘¢ï¼Ÿ<code>react-reconciler/src/ReactFiberBeginWork.js</code></p>
<p><code>function</code>ç»„ä»¶åˆå§‹åŒ–ï¼š</p>
<pre><code>renderWithHooks(
    null,                // current Fiber
    workInProgress,      // workInProgress Fiber
    Component,           // å‡½æ•°ç»„ä»¶æœ¬èº«
    props,               // props
    context,             // ä¸Šä¸‹æ–‡
    renderExpirationTime,// æ¸²æŸ“ ExpirationTime
);
</code></pre>
<hr>
<p><code>function</code>ç»„ä»¶æ›´æ–°ï¼š
å¯¹äºåˆå§‹åŒ–æ˜¯æ²¡æœ‰<code>current</code>æ ‘çš„ï¼Œä¹‹åå®Œæˆä¸€æ¬¡ç»„ä»¶æ›´æ–°åï¼Œä¼šæŠŠå½“å‰<code>workInProgress</code>æ ‘èµ‹å€¼ç»™<code>current</code>æ ‘ã€‚</p>
<pre><code>renderWithHooks(
    current,
    workInProgress,
    render,
    nextProps,
    context,
    renderExpirationTime,
);
</code></pre>
<hr>
<p><code>renderWithHooks</code>å‡½æ•°ä½œç”¨æ˜¯<strong>è°ƒç”¨<code>function</code>ç»„ä»¶å‡½æ•°</strong>çš„ä¸»è¦å‡½æ•°ã€‚ä»–è´Ÿè´£<code>function</code>ç»„ä»¶åˆå§‹åŒ–å’Œæ›´æ–°
æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹<code>renderWithHooks</code>åšäº†äº›ä»€ä¹ˆï¼Ÿ</p>
<hr>
<p><strong>renderWithHooks</strong> <code>react-reconciler/src/ReactFiberHooks.js</code></p>
<pre><code>export function renderWithHooks(
  current,
  workInProgress,
  Component,
  props,
  secondArg,
  nextRenderExpirationTime,
) {
  renderExpirationTime = nextRenderExpirationTime;
  currentlyRenderingFiber = workInProgress;

  workInProgress.memoizedState = null;
  workInProgress.updateQueue = null;
  workInProgress.expirationTime = NoWork;

  ReactCurrentDispatcher.current =
      current === null || current.memoizedState === null
        ? HooksDispatcherOnMount
        : HooksDispatcherOnUpdate;

  let children = Component(props, secondArg);

  if (workInProgress.expirationTime === renderExpirationTime) { 
       // ....è¿™é‡Œçš„é€»è¾‘æˆ‘ä»¬å…ˆæ”¾ä¸€æ”¾
  }

  ReactCurrentDispatcher.current = ContextOnlyDispatcher;

  renderExpirationTime = NoWork;
  currentlyRenderingFiber = null;

  currentHook = null
  workInProgressHook = null;

  didScheduleRenderPhaseUpdate = false;

  return children;
}
</code></pre>
<p><strong>æ‰€æœ‰çš„å‡½æ•°ç»„ä»¶æ‰§è¡Œï¼Œéƒ½æ˜¯åœ¨è¿™é‡Œæ–¹æ³•ä¸­</strong>,
<strong><code>renderWithHooks</code>å‡½æ•°ä¸»è¦ä½œç”¨:</strong></p>
<ol>
<li>é¦–å…ˆå…ˆç½®ç©ºå³å°†è°ƒå’Œæ¸²æŸ“çš„<code>workInProgress</code>æ ‘çš„<code>memoizedState</code>å’Œ<code>updateQueue</code>ï¼Œ</li>
<li>æ ¹æ®å½“å‰å‡½æ•°ç»„ä»¶æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œèµ‹äºˆ<code>ReactCurrentDispatcher.current</code>ä¸åŒçš„<code>hooks</code></li>
<li>è°ƒç”¨<code>Component(props, secondArg);</code>æ‰§è¡Œæˆ‘ä»¬çš„å‡½æ•°ç»„ä»¶</li>
<li>å°†<code>ContextOnlyDispatcher</code>èµ‹å€¼ç»™ <code>ReactCurrentDispatcher.current</code></li>
<li>æœ€åé‡æ–°ç½®ç©ºä¸€äº›å˜é‡æ¯”å¦‚<code>currentHook</code>ï¼Œ<code>currentlyRenderingFiber</code>,<code>workInProgressHook</code>ç­‰</li>
</ol>
<hr>
<h2><img src="./Pasted image 20230815133430.png" /></h2>
<ol>
<li>é¦–å…ˆå…ˆç½®ç©ºå³å°†è°ƒå’Œæ¸²æŸ“çš„<code>workInProgress</code>æ ‘çš„<code>memoizedState</code>å’Œ<code>updateQueue</code>ï¼Œ
ä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œ
<ul>
<li>å› ä¸ºåœ¨æ¥ä¸‹æ¥çš„å‡½æ•°ç»„ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¦æŠŠæ–°çš„<code>hooks</code>ä¿¡æ¯æŒ‚è½½åˆ°è¿™ä¸¤ä¸ªå±æ€§ä¸Šï¼Œç„¶ååœ¨ç»„ä»¶<code>commit</code>é˜¶æ®µï¼Œå°†<code>workInProgress</code>æ ‘æ›¿æ¢æˆ<code>current</code>æ ‘ï¼Œæ›¿æ¢çœŸå®çš„<code>DOM</code>å…ƒç´ èŠ‚ç‚¹ã€‚å¹¶åœ¨<code>current</code>æ ‘ä¿å­˜<code>hooks</code>ä¿¡æ¯ã€‚</li>
</ul>
</li>
</ol>
<hr>
<ol>
<li>ç„¶åæ ¹æ®å½“å‰å‡½æ•°ç»„ä»¶æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œèµ‹äºˆ<code>ReactCurrentDispatcher.current</code>ä¸åŒçš„<code>hooks</code>
<ul>
<li>å¦‚æœ<code>current</code>ä¸å­˜åœ¨ï¼Œè¯æ˜æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“å‡½æ•°ç»„ä»¶ã€‚é€šè¿‡<code>current</code>æ ‘ä¸Šæ˜¯å¦<code>memoizedState</code>ï¼ˆhook ä¿¡æ¯ï¼‰æ¥åˆ¤æ–­ä¸åŒçš„ hooks</li>
<li>å¯¹äºç¬¬ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶ï¼Œé‚£ä¹ˆç”¨çš„æ˜¯<code>HooksDispatcherOnMount</code> hooks å¯¹è±¡ã€‚</li>
<li>å¯¹äºæ¸²æŸ“åï¼Œéœ€è¦æ›´æ–°çš„å‡½æ•°ç»„ä»¶ï¼Œåˆ™æ˜¯<code>HooksDispatcherOnUpdate</code>å¯¹è±¡</li>
</ul>
</li>
</ol>
<hr>
<ol>
<li>è°ƒç”¨<code>Component(props, secondArg);</code>æ‰§è¡Œæˆ‘ä»¬çš„å‡½æ•°ç»„ä»¶
æˆ‘ä»¬çš„å‡½æ•°ç»„ä»¶åœ¨è¿™é‡ŒçœŸæ­£çš„è¢«æ‰§è¡Œäº†ï¼Œç„¶åï¼Œæˆ‘ä»¬å†™çš„<code>hooks</code>è¢«ä¾æ¬¡æ‰§è¡Œï¼ŒæŠŠ<code>hooks</code>ä¿¡æ¯ä¾æ¬¡ä¿å­˜åˆ°<code>workInProgress</code>æ ‘ä¸Šã€‚
è‡³äºå®ƒæ˜¯æ€ä¹ˆä¿å­˜çš„ï¼Œæˆ‘ä»¬é©¬ä¸Šä¼šè®²åˆ°ã€‚</li>
</ol>
<hr>
<ol>
<li>å°†<code>ContextOnlyDispatcher</code>èµ‹å€¼ç»™ <code>ReactCurrentDispatcher.current</code>ï¼Œ
ç”±äº<code>js</code>æ˜¯å•çº¿ç¨‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ²¡æœ‰åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œè°ƒç”¨çš„<code>hooks</code>ï¼Œéƒ½æ˜¯<code>ContextOnlyDispatcher</code>å¯¹è±¡ä¸Š<code>hooks</code>,</li>
</ol>
<hr>
<p>é¦–å…ˆæˆ‘ä»¬åº”è¯¥æ˜ç™½å‡ ä¸ªæ„Ÿå¿µï¼Œè¿™å¯¹äºåç»­æˆ‘ä»¬ç†è§£<code>useState</code>æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚
<code>current fiberæ ‘</code>: å½“å®Œæˆä¸€æ¬¡æ¸²æŸ“ä¹‹åï¼Œä¼šäº§ç”Ÿä¸€ä¸ª<code>current</code>æ ‘,<code>current</code>ä¼šåœ¨<code>commit</code>é˜¶æ®µæ›¿æ¢æˆçœŸå®çš„<code>Dom</code>æ ‘ã€‚
<code>workInProgress fiberæ ‘</code>: å³å°†è°ƒå’Œæ¸²æŸ“çš„ <code>fiber</code> æ ‘ã€‚å†ä¸€æ¬¡æ–°çš„ç»„ä»¶æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œä¼šä»<code>current</code>å¤åˆ¶ä¸€ä»½ä½œä¸º<code>workInProgress</code>, æ›´æ–°å®Œæ¯•åï¼Œå°†å½“å‰çš„<code>workInProgress</code>æ ‘èµ‹å€¼ç»™<code>current</code>æ ‘ã€‚</p>
<p><code>workInProgress.memoizedState</code>: åœ¨<code>class</code>ç»„ä»¶ä¸­ï¼Œ<code>memoizedState</code>å­˜æ”¾<code>state</code>ä¿¡æ¯ï¼Œåœ¨<code>function</code>ç»„ä»¶ä¸­ï¼Œ<strong>è¿™é‡Œå¯ä»¥æå‰é€æ¼ä¸€ä¸‹ï¼Œ<code>memoizedState</code>åœ¨ä¸€æ¬¡è°ƒå’Œæ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾<code>hooks</code>ä¿¡æ¯ã€‚</strong>
<code>workInProgress.expirationTime</code>: <code>react</code>ç”¨ä¸åŒçš„<code>expirationTime</code>, æ¥ç¡®å®šæ›´æ–°çš„ä¼˜å…ˆçº§ã€‚
<code>currentHook</code> : å¯ä»¥ç†è§£ <code>current</code>æ ‘ä¸Šçš„æŒ‡å‘çš„å½“å‰è°ƒåº¦çš„ <code>hooks</code>èŠ‚ç‚¹ã€‚
<code>workInProgressHook</code> : å¯ä»¥ç†è§£ <code>workInProgress</code>æ ‘ä¸ŠæŒ‡å‘çš„å½“å‰è°ƒåº¦çš„ <code>hooks</code>èŠ‚ç‚¹ã€‚</p>
<hr>
<p>æˆ‘ä»¬çœ‹çœ‹<code>ContextOnlyDispatcher</code>hooksï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆã€‚</p>
<pre><code>const ContextOnlyDispatcher = {
    useState:throwInvalidHookError
}
function throwInvalidHookError() {
  invariant(
    false,
    'Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for' +
      ' one of the following reasons:\n' +
      '1. You might have mismatching versions of React and the renderer (such as React DOM)\n' +
      '2. You might be breaking the Rules of Hooks\n' +
      '3. You might have more than one copy of React in the same app\n' +
      'See https://fb.me/react-invalid-hook-call for tips about how to debug and fix this problem.',
  );
}
</code></pre>
<p>åŸæ¥å¦‚æ­¤ï¼Œ<code>react-hooks</code>å°±æ˜¯é€šè¿‡è¿™ç§å‡½æ•°ç»„ä»¶æ‰§è¡Œèµ‹å€¼ä¸åŒçš„<code>hooks</code>å¯¹è±¡æ–¹å¼ï¼Œ
åˆ¤æ–­åœ¨<code>hooks</code>æ‰§è¡Œæ˜¯å¦åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨ï¼Œæ•è·å¹¶æŠ›å‡ºå¼‚å¸¸çš„ã€‚</p>
<h2>3 ä¸åŒçš„<code>hooks</code>å¯¹è±¡</h2>
<p>å‡½æ•°ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶å’Œæ›´æ–°ç»„ä»¶åˆ†åˆ«è°ƒç”¨ä¸åŒçš„<code>hooks</code>å¯¹è±¡ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ¥çœ‹çœ‹<code>HooksDispatcherOnMount</code> å’Œ <code>HooksDispatcherOnUpdate</code>ã€‚</p>
<hr>
<p>HooksDispatcherOnMount <strong>ç¬¬ä¸€æ¬¡æ¸²æŸ“ (æˆ‘è¿™é‡Œåªå±•ç¤ºäº†å¸¸ç”¨çš„<code>hooks</code>)ï¼š</strong></p>
<pre><code>const HooksDispatcherOnMount = {
  useCallback: mountCallback,
  useEffect: mountEffect,
  useLayoutEffect: mountLayoutEffect,
  useMemo: mountMemo,
  useReducer: mountReducer,
  useRef: mountRef,
  useState: mountState,
};
</code></pre>
<hr>
<p>HooksDispatcherOnUpdate <strong>æ›´æ–°ç»„ä»¶ï¼š</strong></p>
<pre><code>const HooksDispatcherOnUpdate = {
  useCallback: updateCallback,
  useEffect: updateEffect,
  useLayoutEffect: updateLayoutEffect,
  useMemo: updateMemo,
  useReducer: updateReducer,
  useRef: updateRef,
  useState: updateState
};
</code></pre>
<h1>ä¸‰ hooks åˆå§‹åŒ–ï¼Œæˆ‘ä»¬å†™çš„ hooks ä¼šå˜æˆä»€ä¹ˆæ ·å­</h1>
<p>æœ¬æ–‡å°†é‡ç‚¹å›´ç»•å››ä¸ªé‡ç‚¹<code>hooks</code>å±•å¼€ï¼Œåˆ†åˆ«æ˜¯
è´Ÿè´£ç»„ä»¶æ›´æ–°çš„<code>useState</code>ï¼Œè´Ÿè´£æ‰§è¡Œå‰¯ä½œç”¨<code>useEffect</code> ,
è´Ÿè´£ä¿å­˜æ•°æ®çš„<code>useRef</code>, è´Ÿè´£ç¼“å­˜ä¼˜åŒ–çš„<code>useMemo</code>ï¼Œ
è‡³äº<code>useCallback</code>,<code>useReducer</code>,<code>useLayoutEffect</code>åŸç†å’Œé‚£å››ä¸ªé‡ç‚¹<code>hooks</code>æ¯”è¾ƒç›¸è¿‘ï¼Œå°±ä¸ä¸€ä¸€è§£é‡Šäº†ã€‚</p>
<hr>
<p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç»„ä»¶ï¼Œå¹¶ä¸”ç”¨åˆ°ä¸Šè¿°å››ä¸ªä¸»è¦<code>hooks</code>ï¼š
<strong>è¯·è®°ä½å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œåé¢è®²è§£å°†ä»¥å¦‚ä¸‹ä»£ç æ®µå±•å¼€</strong></p>
<pre><code class="language-js">import React , { useEffect , useState , useRef , useMemo  } from 'react'
function Index(){
    const [ number , setNumber ] = useState(0)
    const DivDemo = useMemo(() =&gt; &lt;div&gt; hello , i am useMemo &lt;/div&gt;,[])
    const curRef  = useRef(null)
    useEffect(()=&gt;{
       console.log(curRef.current)
    },[])
    return &lt;div ref={ curRef } &gt;
        hello,world { number } 
        { DivDemo }
        &lt;button onClick={() =&gt; setNumber(number+1) } &gt;number++&lt;/button&gt;
     &lt;/div&gt;
}
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·ç ”ç©¶ä¸€ä¸‹æˆ‘ä»¬ä¸Šè¿°å†™çš„å››ä¸ª<code>hooks</code>æœ€ç»ˆä¼šå˜æˆä»€ä¹ˆï¼Ÿ</p>
<h2>1 mountWorkInProgressHook</h2>
<p>åœ¨ç»„ä»¶åˆå§‹åŒ–çš„æ—¶å€™, æ¯ä¸€æ¬¡<code>hooks</code>æ‰§è¡Œï¼Œå¦‚<code>useState()</code>,<code>useRef()</code>, éƒ½ä¼šè°ƒç”¨<code>mountWorkInProgressHook</code>,</p>
<hr>
<p><code>mountWorkInProgressHook</code>åˆ°åº•åšäº†å†™ä»€ä¹ˆï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥åˆ†æä¸€ä¸‹ï¼š
<code>react-reconciler/src/ReactFiberHooks.js -&gt; mountWorkInProgressHook</code></p>
<pre><code>function mountWorkInProgressHook() {
  const hook: Hook = {
    memoizedState: null,  // useStateä¸­ ä¿å­˜ stateä¿¡æ¯ ï½œ useEffect ä¸­ ä¿å­˜ç€ effect å¯¹è±¡ ï½œ useMemo ä¸­ ä¿å­˜çš„æ˜¯ç¼“å­˜çš„å€¼å’Œdeps ï½œ useRefä¸­ä¿å­˜çš„æ˜¯ref å¯¹è±¡
    baseState: null,
    baseQueue: null,
    queue: null,
    next: null,
  };
  if (workInProgressHook === null) { // ä¾‹å­ä¸­çš„ç¬¬ä¸€ä¸ª`hooks`-&gt; useState(0) èµ°çš„å°±æ˜¯è¿™æ ·ã€‚
    currentlyRenderingFiber.memoizedState = workInProgressHook = hook;
  } else {
    workInProgressHook = workInProgressHook.next = hook;
  }
  return workInProgressHook;
}
</code></pre>
<p><code>mountWorkInProgressHook</code>è¿™ä¸ªå‡½æ•°åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œ</p>
<ul>
<li>é¦–å…ˆæ¯æ¬¡æ‰§è¡Œä¸€ä¸ª<code>hooks</code>å‡½æ•°ï¼Œéƒ½äº§ç”Ÿä¸€ä¸ª<code>hook</code>å¯¹è±¡ï¼Œé‡Œé¢ä¿å­˜äº†å½“å‰<code>hook</code>ä¿¡æ¯,</li>
<li>ç„¶åå°†æ¯ä¸ª<code>hooks</code>ä»¥é“¾è¡¨å½¢å¼ä¸²è”èµ·æ¥ï¼Œå¹¶èµ‹å€¼ç»™<code>workInProgress</code>çš„<code>memoizedState</code>ã€‚</li>
<li>ä¹Ÿå°±è¯å®äº†ä¸Šè¿°æ‰€è¯´çš„ï¼Œå‡½æ•°ç»„ä»¶ç”¨<code>memoizedState</code>å­˜æ”¾<code>hooks</code>é“¾è¡¨ã€‚</li>
</ul>
<hr>
<p><code>hook</code>å¯¹è±¡ä¸­éƒ½ä¿ç•™äº†é‚£äº›ä¿¡æ¯ï¼Ÿæˆ‘è¿™é‡Œå…ˆåˆ†åˆ«ä»‹ç»ä¸€ä¸‹ :<br>
<strong>memoizedState</strong>ï¼š <code>useStateä¸­</code> ä¿å­˜ <code>state</code> ä¿¡æ¯ ï½œ <code>useEffect</code> ä¸­ ä¿å­˜ç€ <code>effect</code> å¯¹è±¡ ï½œ <code>useMemo</code> ä¸­ ä¿å­˜çš„æ˜¯ç¼“å­˜çš„å€¼å’Œ <code>deps</code> ï½œ <code>useRef</code> ä¸­ä¿å­˜çš„æ˜¯ <code>ref</code> å¯¹è±¡ã€‚
<strong>baseQueue</strong> : <code>usestate</code>å’Œ<code>useReducer</code>ä¸­ ä¿å­˜æœ€æ–°çš„æ›´æ–°é˜Ÿåˆ—ã€‚
<strong>baseState</strong> ï¼š <code>usestate</code>å’Œ<code>useReducer</code>ä¸­, ä¸€æ¬¡æ›´æ–°ä¸­ ï¼Œäº§ç”Ÿçš„æœ€æ–°<code>state</code>å€¼ã€‚
<strong>queue</strong> ï¼š ä¿å­˜å¾…æ›´æ–°é˜Ÿåˆ— <code>pendingQueue</code> ï¼Œæ›´æ–°å‡½æ•° <code>dispatch</code> ç­‰ä¿¡æ¯ã€‚
<strong>next</strong>: æŒ‡å‘ä¸‹ä¸€ä¸ª <code>hooks</code>å¯¹è±¡ã€‚</p>
<hr>
<p>é‚£ä¹ˆå½“æˆ‘ä»¬å‡½æ•°ç»„ä»¶æ‰§è¡Œä¹‹åï¼Œå››ä¸ª<code>hooks</code>å’Œ<code>workInProgress</code>å°†æ˜¯å¦‚å›¾çš„å…³ç³»ã€‚
workInprogress.memoizedState = state hook
state hook   =next&gt;  memo hook   =next&gt; ref hook =next&gt; effect hook =next&gt; null
<img src="./Pasted image 20230815134417.png" /></p>
<hr>
<p>çŸ¥é“æ¯ä¸ª<code>hooks</code>å…³ç³»ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥ç†è§£äº†ï¼Œä¸ºä»€ä¹ˆä¸èƒ½æ¡ä»¶è¯­å¥ä¸­ï¼Œå£°æ˜<code>hooks</code>ã€‚
æˆ‘ä»¬ç”¨ä¸€å¹…å›¾è¡¨ç¤ºå¦‚æœåœ¨æ¡ä»¶è¯­å¥ä¸­å£°æ˜ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘ç”Ÿã€‚
å¦‚æœæˆ‘ä»¬å°†ä¸Šè¿°<code>demo</code>å…¶ä¸­çš„ä¸€ä¸ª <code>useRef</code> æ”¾å…¥æ¡ä»¶è¯­å¥ä¸­ï¼Œ</p>
<pre><code>let curRef  = null
 if(isFisrt){
  curRef = useRef(null)
}
</code></pre>
<p><strong>å› ä¸ºä¸€æ—¦åœ¨æ¡ä»¶è¯­å¥ä¸­å£°æ˜<code>hooks</code>ï¼Œåœ¨ä¸‹ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ›´æ–°ï¼Œ<code>hooks</code>é“¾è¡¨ç»“æ„ï¼Œå°†ä¼šè¢«ç ´åï¼Œ<code>current</code>æ ‘çš„<code>memoizedState</code>ç¼“å­˜<code>hooks</code>ä¿¡æ¯ï¼Œå’Œå½“å‰<code>workInProgress</code>ä¸ä¸€è‡´ï¼Œå¦‚æœæ¶‰åŠåˆ°è¯»å–<code>state</code>ç­‰æ“ä½œï¼Œå°±ä¼šå‘ç”Ÿå¼‚å¸¸ã€‚</strong></p>
<hr>
<p>ä¸Šè¿°ä»‹ç»äº† <code>hooks</code>é€šè¿‡ä»€ä¹ˆæ¥è¯æ˜å”¯ä¸€æ€§çš„ï¼Œç­”æ¡ˆ é€šè¿‡<code>hooks</code>é“¾è¡¨é¡ºåºã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ç…§å››ä¸ªæ–¹å‘ï¼Œåˆ†åˆ«ä»‹ç»åˆå§‹åŒ–çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<h2>2 åˆå§‹åŒ– useState -&gt; mountState</h2>
<p><strong>mountState</strong></p>
<pre><code>function mountState(
  initialState
){
  const hook = mountWorkInProgressHook();
  if (typeof initialState === 'function') {
    // å¦‚æœ useState ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‡½æ•°ï¼Œæ‰§è¡Œå‡½æ•°å¾—åˆ°state
    initialState = initialState();
  }
  hook.memoizedState = hook.baseState = initialState;
  const queue = (hook.queue = {
    pending: null,  // å¸¦æ›´æ–°çš„
    dispatch: null, // è´Ÿè´£æ›´æ–°å‡½æ•°
    lastRenderedReducer: basicStateReducer, //ç”¨äºå¾—åˆ°æœ€æ–°çš„ state ,
    lastRenderedState: initialState, // æœ€åä¸€æ¬¡å¾—åˆ°çš„ state
  });

  const dispatch = (queue.dispatch = (dispatchAction.bind( // è´Ÿè´£æ›´æ–°çš„å‡½æ•°
    null,
    currentlyRenderingFiber,
    queue,
  )))
  return [hook.memoizedState, dispatch];
}
</code></pre>
<p><code>mountState</code>åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Œ</p>
<ul>
<li>é¦–å…ˆå°†åˆå§‹åŒ–çš„<code>state</code>èµ‹å€¼ç»™<code>mountWorkInProgressHook</code>äº§ç”Ÿçš„<code>hook</code>å¯¹è±¡çš„ <code>memoizedState</code>å’Œ<code>baseState</code>å±æ€§ï¼Œ</li>
<li>ç„¶ååˆ›å»ºä¸€ä¸ª<code>queue</code>å¯¹è±¡ï¼Œé‡Œé¢ä¿å­˜äº†è´Ÿè´£æ›´æ–°çš„ä¿¡æ¯ã€‚</li>
<li>é€šè¿‡ dispatchAction è·å¾— dispatch æ–¹æ³•</li>
<li>è¿”å›å½“å‰è®°å¿†çš„ state å’Œ dispatch æ–¹æ³•</li>
</ul>
<hr>
<p>åœ¨æ— çŠ¶æ€ç»„ä»¶ä¸­ï¼Œ<code>useState</code>å’Œ<code>useReducer</code>è§¦å‘å‡½æ•°æ›´æ–°çš„æ–¹æ³•éƒ½æ˜¯<code>dispatchAction</code>,
<code>useState</code>ï¼Œå¯ä»¥çœ‹æˆä¸€ä¸ªç®€åŒ–ç‰ˆçš„<code>useReducer</code>,</p>
<hr>
<p>åœ¨ç ”ç©¶ä¹‹å‰ æˆ‘ä»¬<strong>å…ˆè¦å¼„æ˜ç™½<code>dispatchAction</code>æ˜¯ä»€ä¹ˆ?</strong></p>
<pre><code>function dispatchAction&lt;S, A&gt;(
  fiber: Fiber,
  queue: UpdateQueue&lt;S, A&gt;,
  action: A,
)
</code></pre>
<pre><code>const [ number , setNumber ] = useState(0)
</code></pre>
<p><strong><code>dispatchAction</code> å°±æ˜¯ <code>setNumber</code></strong> ,
<code>dispatchAction</code> ç¬¬ä¸€ä¸ªå‚æ•°å’Œç¬¬äºŒä¸ªå‚æ•°ï¼Œå·²ç»è¢«<code>bind</code>ç»™æ”¹æˆ<code>currentlyRenderingFiber</code>å’Œ <code>queue</code>, æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°<code>action</code></p>
<h3>dispatchAction æ— çŠ¶æ€ç»„ä»¶æ›´æ–°æœºåˆ¶</h3>
<p>ä½œä¸ºæ›´æ–°çš„ä¸»è¦å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€ä¸‹æ¥ç ”ç©¶ä¸€ä¸‹ï¼Œæˆ‘æŠŠ <code>dispatchAction</code> ç²¾ç®€ï¼Œç²¾ç®€ï¼Œå†ç²¾ç®€ï¼Œ</p>
<pre><code>function dispatchAction(fiber, queue, action) {

  // è®¡ç®— expirationTime è¿‡ç¨‹ç•¥è¿‡ã€‚
  /* åˆ›å»ºä¸€ä¸ªupdate */
  const update= {
    expirationTime,
    suspenseConfig,
    action,
    eagerReducer: null,
    eagerState: null,
    next: null,
  }
  /* æŠŠåˆ›å»ºçš„update */
  const pending = queue.pending;
  if (pending === null) {  // è¯æ˜ç¬¬ä¸€æ¬¡æ›´æ–°
    update.next = update;
  } else { // ä¸æ˜¯ç¬¬ä¸€æ¬¡æ›´æ–°
    update.next = pending.next;
    pending.next = update;
  }
  
  queue.pending = update;
  const alternate = fiber.alternate;
  /* åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨æ¸²æŸ“é˜¶æ®µ */
  if ( fiber === currentlyRenderingFiber || (alternate !== null &amp;&amp; alternate === currentlyRenderingFiber)) {
    didScheduleRenderPhaseUpdate = true;
    update.expirationTime = renderExpirationTime;
    currentlyRenderingFiber.expirationTime = renderExpirationTime;
  } else { /* å½“å‰å‡½æ•°ç»„ä»¶å¯¹åº”fiberæ²¡æœ‰å¤„äºè°ƒå’Œæ¸²æŸ“é˜¶æ®µ ï¼Œé‚£ä¹ˆè·å–æœ€æ–°state , æ‰§è¡Œæ›´æ–° */
    if (fiber.expirationTime === NoWork &amp;&amp; (alternate === null || alternate.expirationTime === NoWork)) {
      const lastRenderedReducer = queue.lastRenderedReducer;
      if (lastRenderedReducer !== null) {
        let prevDispatcher;
        try {
          const currentState = queue.lastRenderedState; /* ä¸Šä¸€æ¬¡çš„state */
          const eagerState = lastRenderedReducer(currentState, action); /**/
          update.eagerReducer = lastRenderedReducer;
          update.eagerState = eagerState;
          if (is(eagerState, currentState)) { 
            return
          }
        } 
      }
    }
    scheduleUpdateOnFiber(fiber, expirationTime);
  }
}
</code></pre>
<ol>
<li>äº§ç”Ÿä¸€ä¸ª <code>update</code>å¯¹è±¡ï¼Œé‡Œé¢è®°å½•äº†æ­¤æ¬¡æ›´æ–°çš„ä¿¡æ¯ï¼Œ</li>
<li>ç„¶åå°†æ­¤<code>update</code>æ”¾å…¥å¾…æ›´æ–°çš„<code>pending</code>é˜Ÿåˆ—ä¸­ï¼Œ</li>
<li>åˆ¤æ–­å½“å‰å‡½æ•°ç»„ä»¶çš„<code>fiber</code>å¯¹è±¡æ˜¯å¦å¤„äºæ¸²æŸ“é˜¶æ®µï¼Œé€‰æ‹©æ›´æ–°expirationTimeè¿˜æ˜¯å¼€å§‹æ¸²æŸ“</li>
</ol>
<hr>
<p>åˆ¤æ–­å½“å‰å‡½æ•°ç»„ä»¶çš„<code>fiber</code>å¯¹è±¡æ˜¯å¦å¤„äºæ¸²æŸ“é˜¶æ®µï¼Œé€‰æ‹©æ›´æ–°expirationTimeè¿˜æ˜¯å¼€å§‹æ¸²æŸ“</p>
<pre><code class="language-js">if ( fiber === currentlyRenderingFiber || (alternate !== null &amp;&amp; alternate === currentlyRenderingFiber)) {
    didScheduleRenderPhaseUpdate = true;
    update.expirationTime = renderExpirationTime;
    currentlyRenderingFiber.expirationTime = renderExpirationTime;
  } 
</code></pre>
<p>å¦‚æœå¤„äºæ¸²æŸ“é˜¶æ®µï¼Œé‚£ä¹ˆä¸éœ€è¦æˆ‘ä»¬åœ¨æ›´æ–°å½“å‰å‡½æ•°ç»„ä»¶ï¼Œåªéœ€è¦æ›´æ–°ä¸€ä¸‹å½“å‰<code>update</code>çš„<code>expirationTime</code>å³å¯ã€‚</p>
<hr>
<pre><code class="language-js">else { /* å½“å‰å‡½æ•°ç»„ä»¶å¯¹åº”fiberæ²¡æœ‰å¤„äºè°ƒå’Œæ¸²æŸ“é˜¶æ®µ ï¼Œé‚£ä¹ˆè·å–æœ€æ–°state , æ‰§è¡Œæ›´æ–° */
    if (fiber.expirationTime === NoWork &amp;&amp; (alternate === null || alternate.expirationTime === NoWork)) {
      const lastRenderedReducer = queue.lastRenderedReducer;
      if (lastRenderedReducer !== null) {
        let prevDispatcher;
        try {
          const currentState = queue.lastRenderedState; /* ä¸Šä¸€æ¬¡çš„state */
          const eagerState = lastRenderedReducer(currentState, action); /**/
          update.eagerReducer = lastRenderedReducer;
          update.eagerState = eagerState;
          if (is(eagerState, currentState)) { 
            return
          }
        } 
      }
    }
    scheduleUpdateOnFiber(fiber, expirationTime);
  }
</code></pre>
<ul>
<li>å¦‚æœå½“å‰<code>fiber</code>æ²¡æœ‰å¤„äºæ›´æ–°é˜¶æ®µã€‚é‚£ä¹ˆé€šè¿‡è°ƒç”¨<code>lastRenderedReducer</code>è·å–æœ€æ–°çš„<code>state</code>, å’Œä¸Šä¸€æ¬¡çš„<code>currentState</code>ï¼Œè¿›è¡Œæµ…æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆå°±é€€å‡ºï¼Œå¦‚æœä¸¤æ¬¡<code>state</code>ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆè°ƒç”¨<code>scheduleUpdateOnFiber</code>è°ƒåº¦æ¸²æŸ“å½“å‰<code>fiber</code>ï¼Œ<code>scheduleUpdateOnFiber</code>æ˜¯<code>react</code>æ¸²æŸ“æ›´æ–°çš„ä¸»è¦å‡½æ•°ã€‚</li>
<li>è¿™å°±è¯å®äº†ä¸ºä»€ä¹ˆ<code>useState</code>ï¼Œä¸¤æ¬¡å€¼ç›¸ç­‰çš„æ—¶å€™ï¼Œç»„ä»¶ä¸æ¸²æŸ“çš„åŸå› äº†ï¼Œè¿™ä¸ªæœºåˆ¶å’Œ<code>Component</code>æ¨¡å¼ä¸‹çš„<code>setState</code>æœ‰ä¸€å®šçš„åŒºåˆ«ã€‚</li>
</ul>
<h2>3 åˆå§‹åŒ– useEffect -&gt; mountEffect</h2>
<p>ä¸Šè¿°è®²åˆ°äº†æ— çŠ¶æ€ç»„ä»¶ä¸­<code>fiber</code>å¯¹è±¡<code>memoizedState</code>ä¿å­˜å½“å‰çš„<code>hooks</code>å½¢æˆçš„é“¾è¡¨ã€‚
é‚£ä¹ˆ<code>updateQueue</code>ä¿å­˜äº†ä»€ä¹ˆä¿¡æ¯å‘¢ï¼Œæˆ‘ä»¬ä¼šåœ¨æ¥ä¸‹æ¥æ¢ç´¢<code>useEffect</code>è¿‡ç¨‹ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚
å½“æˆ‘ä»¬è°ƒç”¨<code>useEffect</code>çš„æ—¶å€™ï¼Œåœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™ä¼šè°ƒç”¨<code>mountEffect</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Ÿ</p>
<h3>mountEffect</h3>
<pre><code>function mountEffect(
  create,
  deps,
) {
  const hook = mountWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  hook.memoizedState = pushEffect(
    HookHasEffect | hookEffectTag, 
    create, // useEffect ç¬¬ä¸€æ¬¡å‚æ•°ï¼Œå°±æ˜¯å‰¯ä½œç”¨å‡½æ•°
    undefined,
    nextDeps, // useEffect ç¬¬äºŒæ¬¡å‚æ•°ï¼Œdeps
  );
}

</code></pre>
<p>æ¯ä¸ª<code>hooks</code>åˆå§‹åŒ–éƒ½ä¼šåˆ›å»ºä¸€ä¸ª<code>hook</code>å¯¹è±¡ï¼Œç„¶åå°† hook çš„<code>memoizedState</code>ä¿å­˜å½“å‰<code>effect hook</code>ä¿¡æ¯ã€‚</p>
<p><strong>æœ‰ä¸¤ä¸ª<code>memoizedState</code>å¤§å®¶åƒä¸‡åˆ«æ··æ·†äº†ï¼Œæˆ‘è¿™é‡Œå†å‹æƒ…æç¤ºä¸€é</strong></p>
<ul>
<li><code>workInProgress / current</code> æ ‘ä¸Šçš„ <code>memoizedState</code> ä¿å­˜çš„æ˜¯å½“å‰å‡½æ•°ç»„ä»¶æ¯ä¸ª<code>hooks</code>å½¢æˆçš„é“¾è¡¨ã€‚</li>
<li>æ¯ä¸ª<code>hooks</code>ä¸Šçš„<code>memoizedState</code> ä¿å­˜äº†å½“å‰<code>hooks</code>ä¿¡æ¯ï¼Œä¸åŒç§ç±»çš„<code>hooks</code>çš„<code>memoizedState</code>å†…å®¹ä¸åŒã€‚</li>
</ul>
<p>ä¸Šè¿°çš„æ–¹æ³•æœ€åæ‰§è¡Œäº†ä¸€ä¸ª<code>pushEffect</code>ï¼ŒpushEffect åˆ›å»ºäº† effect å¯¹è±¡ï¼ŒæŒ‚è½½ updateQueue</p>
<h3>pushEffect</h3>
<pre><code>function pushEffect(tag, create, destroy, deps) {
  const effect = {
    tag,
    create,
    destroy,
    deps,
    next: null,
  };
  let componentUpdateQueue = currentlyRenderingFiber.updateQueue
  if (componentUpdateQueue === null) { // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ª useEffect
    componentUpdateQueue = {  lastEffect: null  }
    currentlyRenderingFiber.updateQueue = componentUpdateQueue
    componentUpdateQueue.lastEffect = effect.next = effect;
  } else {  // å­˜åœ¨å¤šä¸ªeffect
    const lastEffect = componentUpdateQueue.lastEffect;
    if (lastEffect === null) {
      componentUpdateQueue.lastEffect = effect.next = effect;
    } else {
      const firstEffect = lastEffect.next;
      lastEffect.next = effect;
      effect.next = firstEffect;
      componentUpdateQueue.lastEffect = effect;
    }
  }
  return effect;
}
</code></pre>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>effect</code> ï¼Œ
åˆ¤æ–­ç»„ä»¶å¦‚æœç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œé‚£ä¹ˆåˆ›å»º <code>componentUpdateQueue</code> ï¼Œå°±æ˜¯<code>workInProgress</code>çš„<code>updateQueue</code>ã€‚
å°†<code>effect</code>æ”¾å…¥<code>updateQueue</code>ä¸­ã€‚</p>
<hr>
<p>å‡è®¾æˆ‘ä»¬åœ¨ä¸€ä¸ªå‡½æ•°ç»„ä»¶ä¸­è¿™ä¹ˆå†™ï¼š</p>
<pre><code>useEffect(()=&gt;{
    console.log(1)
},[ props.a ])
useEffect(()=&gt;{
    console.log(2)
},[])
useEffect(()=&gt;{
    console.log(3)
},[])
</code></pre>
<p>æœ€å<code>workInProgress.updateQueue</code>ä¼šä»¥è¿™æ ·çš„å½¢å¼ä¿å­˜ï¼š</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/14ac9e04c10e45e5b93fc76d47a5fdd5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<h3>æ‹“å±•: effectList</h3>
<p><code>effect list</code> å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªå­˜å‚¨ <code>effectTag</code> å‰¯ä½œç”¨åˆ—è¡¨å®¹å™¨ã€‚å®ƒæ˜¯ç”± <code>fiber</code> èŠ‚ç‚¹å’ŒæŒ‡é’ˆ <code>nextEffect</code> æ„æˆçš„å•é“¾è¡¨ç»“æ„ï¼Œè¿™å…¶ä¸­è¿˜åŒ…æ‹¬ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ <code>firstEffect</code> ï¼Œå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹ <code>lastEffect</code>ã€‚
<code>React</code> é‡‡ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ï¼Œåœ¨ <code>render</code> é˜¶æ®µéå† <code>fiber</code> æ ‘æ—¶ï¼ŒæŠŠæ¯ä¸€ä¸ªæœ‰å‰¯ä½œç”¨çš„ <code>fiber</code> ç­›é€‰å‡ºæ¥ï¼Œæœ€åæ„å»ºç”Ÿæˆä¸€ä¸ªåªå¸¦å‰¯ä½œç”¨çš„ <code>effect list</code> é“¾è¡¨ã€‚ åœ¨ <code>commit</code> é˜¶æ®µï¼Œ<code>React</code> æ‹¿åˆ° <code>effect list</code> æ•°æ®åï¼Œé€šè¿‡éå† <code>effect list</code>ï¼Œå¹¶æ ¹æ®æ¯ä¸€ä¸ª <code>effect</code> èŠ‚ç‚¹çš„ <code>effectTag</code> ç±»å‹ï¼Œæ‰§è¡Œæ¯ä¸ª<code>effect</code>ï¼Œä»è€Œå¯¹ç›¸åº”çš„ <code>DOM</code> æ ‘æ‰§è¡Œæ›´æ”¹ã€‚</p>
<h2>4 åˆå§‹åŒ– useMemo -&gt; mountMemo</h2>
<p>ä¸çŸ¥é“å¤§å®¶æ˜¯å¦æŠŠ <code>useMemo</code> æƒ³è±¡çš„è¿‡äºå¤æ‚äº†ï¼Œå®é™…ç›¸æ¯”å…¶ä»– <code>useState</code> , <code>useEffect</code>ç­‰ï¼Œå®ƒçš„é€»è¾‘å®é™…ç®€å•çš„å¾ˆã€‚</p>
<pre><code>function mountMemo(nextCreate,deps){
  const hook = mountWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  const nextValue = nextCreate();
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}
</code></pre>
<p>åˆå§‹åŒ–<code>useMemo</code>ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª<code>hook</code>ï¼Œç„¶åæ‰§è¡Œ<code>useMemo</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°, å¾—åˆ°éœ€è¦ç¼“å­˜çš„å€¼ï¼Œç„¶åå°†å€¼å’Œ<code>deps</code>è®°å½•ä¸‹æ¥ï¼Œèµ‹å€¼ç»™å½“å‰<code>hook</code>çš„<code>memoizedState</code>ã€‚æ•´ä½“ä¸Šå¹¶æ²¡æœ‰å¤æ‚çš„é€»è¾‘ã€‚</p>
<h2>5 åˆå§‹åŒ– useRef -&gt; mountRef</h2>
<p>å¯¹äº<code>useRef</code>åˆå§‹åŒ–å¤„ç†ï¼Œä¼¼ä¹æ›´æ˜¯ç®€å•ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ï¼š</p>
<pre><code>function mountRef(initialValue) {
  const hook = mountWorkInProgressHook();
  const ref = {current: initialValue};
  hook.memoizedState = ref;
  return ref;
}
</code></pre>
<p><code>mountRef</code>åˆå§‹åŒ–å¾ˆç®€å•, åˆ›å»ºä¸€ä¸ª ref å¯¹è±¡ï¼Œ å¯¹è±¡çš„<code>current</code> å±æ€§æ¥ä¿å­˜åˆå§‹åŒ–çš„å€¼ï¼Œæœ€åç”¨<code>memoizedState</code>ä¿å­˜<code>ref</code>ï¼Œå®Œæˆæ•´ä¸ªæ“ä½œã€‚</p>
<h2>6 mounted é˜¶æ®µ hooks æ€»ç»“</h2>
<p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹åˆå§‹åŒ–é˜¶æ®µ,<code>react-hooks</code>åšçš„äº‹æƒ…ï¼Œåœ¨ä¸€ä¸ªå‡½æ•°ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“æ‰§è¡Œä¸Šä¸‹æ–‡è¿‡ç¨‹ä¸­ï¼Œ
æ¯ä¸ª<code>react-hooks</code>æ‰§è¡Œï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ª<code>hook</code>å¯¹è±¡ï¼Œå¹¶å½¢æˆé“¾è¡¨ç»“æ„ï¼Œç»‘å®šåœ¨<code>workInProgress</code>çš„<code>memoizedState</code>å±æ€§ä¸Šï¼Œ
ç„¶å<code>react-hooks</code>ä¸Šçš„çŠ¶æ€ï¼Œç»‘å®šåœ¨å½“å‰<code>hooks</code>å¯¹è±¡çš„<code>memoizedState</code>å±æ€§ä¸Šã€‚
å¯¹äº<code>effect</code>å‰¯ä½œç”¨é’©å­ï¼Œä¼šç»‘å®šåœ¨<code>workInProgress.updateQueue</code>ä¸Šï¼Œç­‰åˆ°<code>commit</code>é˜¶æ®µï¼Œ<code>dom</code>æ ‘æ„å»ºå®Œæˆï¼Œåœ¨æ‰§è¡Œæ¯ä¸ª <code>effect</code> å‰¯ä½œç”¨é’©å­ã€‚</p>
<h1>å›› hooks æ›´æ–°é˜¶æ®µ</h1>
<p>å¯¹äºæ›´æ–°é˜¶æ®µï¼Œè¯´æ˜ä¸Šä¸€æ¬¡ <code>workInProgress</code> æ ‘å·²ç»èµ‹å€¼ç»™äº† <code>current</code> æ ‘ã€‚
å­˜æ”¾<code>hooks</code>ä¿¡æ¯çš„<code>memoizedState</code>ï¼Œæ­¤æ—¶å·²ç»å­˜åœ¨<code>current</code>æ ‘ä¸Šï¼Œ<code>react</code>å¯¹äº<code>hooks</code>çš„å¤„ç†é€»è¾‘å’Œ<code>fiber</code>æ ‘é€»è¾‘ç±»ä¼¼ã€‚</p>
<p>å¯¹äºä¸€æ¬¡å‡½æ•°ç»„ä»¶æ›´æ–°ï¼Œå½“å†æ¬¡æ‰§è¡Œ<code>hooks</code>å‡½æ•°çš„æ—¶å€™ï¼Œæ¯”å¦‚ <code>useState(0)</code> ï¼Œé¦–å…ˆè¦ä»<code>current</code>çš„<code>hooks</code>ä¸­æ‰¾åˆ°ä¸å½“å‰<code>workInProgressHook</code>ï¼Œå¯¹åº”çš„<code>currentHooks</code>ï¼Œç„¶åå¤åˆ¶ä¸€ä»½<code>currentHooks</code>ç»™<code>workInProgressHook</code>, æ¥ä¸‹æ¥<code>hooks</code>å‡½æ•°æ‰§è¡Œçš„æ—¶å€™, æŠŠæœ€æ–°çš„çŠ¶æ€æ›´æ–°åˆ°<code>workInProgressHook</code>ï¼Œä¿è¯<code>hooks</code>çŠ¶æ€ä¸ä¸¢å¤±ã€‚</p>
<p>æ‰€ä»¥å‡½æ•°ç»„ä»¶æ¯æ¬¡æ›´æ–°ï¼Œæ¯ä¸€æ¬¡<code>react-hooks</code>å‡½æ•°æ‰§è¡Œï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ªå‡½æ•°å»åšä¸Šé¢çš„æ“ä½œï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯<code>updateWorkInProgressHook</code>, æˆ‘ä»¬æ¥ä¸‹æ¥ä¸€èµ·çœ‹è¿™ä¸ª<code>updateWorkInProgressHook</code>ã€‚</p>
<h2>1 updateWorkInProgressHook</h2>
<pre><code>function updateWorkInProgressHook() {
  let nextCurrentHook;
  if (currentHook === null) {  /* å¦‚æœ currentHook = null è¯æ˜å®ƒæ˜¯ç¬¬ä¸€ä¸ªhooks */
    const current = currentlyRenderingFiber.alternate;
    if (current !== null) {
      nextCurrentHook = current.memoizedState;
    } else {
      nextCurrentHook = null;
    }
  } else { /* ä¸æ˜¯ç¬¬ä¸€ä¸ªhooksï¼Œé‚£ä¹ˆæŒ‡å‘ä¸‹ä¸€ä¸ª hooks */
    nextCurrentHook = currentHook.next;
  }
  let nextWorkInProgressHook
  if (workInProgressHook === null) {  //ç¬¬ä¸€æ¬¡æ‰§è¡Œhooks
    // è¿™é‡Œåº”è¯¥æ³¨æ„ä¸€ä¸‹ï¼Œå½“å‡½æ•°ç»„ä»¶æ›´æ–°ä¹Ÿæ˜¯è°ƒç”¨ renderWithHooks ,memoizedStateå±æ€§æ˜¯ç½®ç©ºçš„
    nextWorkInProgressHook = currentlyRenderingFiber.memoizedState;
  } else { 
    nextWorkInProgressHook = workInProgressHook.next;
  }

  if (nextWorkInProgressHook !== null) { 
      /* è¿™ä¸ªæƒ…å†µè¯´æ˜ renderWithHooks æ‰§è¡Œ è¿‡ç¨‹å‘ç”Ÿå¤šæ¬¡å‡½æ•°ç»„ä»¶çš„æ‰§è¡Œ ï¼Œæˆ‘ä»¬æš‚æ—¶å…ˆä¸è€ƒè™‘ */
    workInProgressHook = nextWorkInProgressHook;
    nextWorkInProgressHook = workInProgressHook.next;
    currentHook = nextCurrentHook;
  } else {
    invariant(
      nextCurrentHook !== null,
      'Rendered more hooks than during the previous render.',
    );
    currentHook = nextCurrentHook;
    const newHook = { //åˆ›å»ºä¸€ä¸ªæ–°çš„hook
      memoizedState: currentHook.memoizedState,
      baseState: currentHook.baseState,
      baseQueue: currentHook.baseQueue,
      queue: currentHook.queue,
      next: null,
    };
    if (workInProgressHook === null) { // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªhooks
      currentlyRenderingFiber.memoizedState = workInProgressHook = newHook;
    } else { // é‡æ–°æ›´æ–° hook
      workInProgressHook = workInProgressHook.next = newHook;
    }
  }
  return workInProgressHook;
}
</code></pre>
<ul>
<li>é¦–å…ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ<code>hooks</code>å‡½æ•°ï¼Œé‚£ä¹ˆä»<code>current</code>æ ‘ä¸Šå–å‡º<code>memoizedState</code> ï¼Œä¹Ÿå°±æ˜¯æ—§çš„<code>hooks</code></li>
<li>ç„¶åå£°æ˜å˜é‡<code>nextWorkInProgressHook</code>ï¼Œ</li>
<li>æœ€åå¤åˆ¶<code>current</code>çš„<code>hooks</code>ï¼ŒæŠŠå®ƒèµ‹å€¼ç»™<code>workInProgressHook</code>, ç”¨äºæ›´æ–°æ–°çš„ä¸€è½®<code>hooks</code>çŠ¶æ€ã€‚</li>
</ul>
<hr>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¬¡<code>renderWithHooks</code>æ‰§è¡Œï¼Œ<code>workInProgress</code>ä¸Šçš„<code>memoizedState</code>ä¼šè¢«ç½®ç©ºï¼Œ<code>hooks</code>å‡½æ•°é¡ºåºæ‰§è¡Œï¼Œ<code>nextWorkInProgressHook</code>åº”è¯¥ä¸€ç›´ä¸º<code>null</code>ï¼Œ
é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹<code>nextWorkInProgressHook</code>ä¸ä¸º<code>null</code>,
ä¹Ÿå°±æ˜¯å½“ä¸€æ¬¡<code>renderWithHooks</code>æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œäº†å¤šæ¬¡å‡½æ•°ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯åœ¨<code>renderWithHooks</code>ä¸­è¿™æ®µé€»è¾‘ã€‚</p>
<pre><code>if (workInProgress.expirationTime === renderExpirationTime) { 
       // ....è¿™é‡Œçš„é€»è¾‘æˆ‘ä»¬å…ˆæ”¾ä¸€æ”¾
  }
</code></pre>
<p>è¿™é‡Œé¢çš„é€»è¾‘ï¼Œå®é™…å°±æ˜¯åˆ¤å®šï¼Œå¦‚æœå½“å‰å‡½æ•°ç»„ä»¶æ‰§è¡Œåï¼Œå½“å‰å‡½æ•°ç»„ä»¶çš„è¿˜æ˜¯å¤„äºæ¸²æŸ“ä¼˜å…ˆçº§ï¼Œè¯´æ˜å‡½æ•°ç»„ä»¶åˆæœ‰äº†æ–°çš„æ›´æ–°ä»»åŠ¡ï¼Œé‚£ä¹ˆå¾ªåæ‰§è¡Œå‡½æ•°ç»„ä»¶ã€‚è¿™å°±é€ æˆäº†ä¸Šè¿°çš„ï¼Œ<code>nextWorkInProgressHook</code>ä¸ä¸º <code>null</code> çš„æƒ…å†µã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å››ä¸ªç§ç±»çš„<code>hooks</code>ï¼Œåœ¨ä¸€æ¬¡ç»„ä»¶æ›´æ–°ä¸­ï¼Œåˆ†åˆ«åšäº†é‚£äº›æ“ä½œã€‚</p>
<h2>2 updateState</h2>
<pre><code class="language-js">function updateReducer(
  reducer,
  initialArg,
  init,
){
  const hook = updateWorkInProgressHook();
  const queue = hook.queue;
  queue.lastRenderedReducer = reducer;
  const current = currentHook;
  let baseQueue = current.baseQueue;
  const pendingQueue = queue.pending;
  if (pendingQueue !== null) {
     // è¿™é‡Œçœç•¥... ç¬¬ä¸€æ­¥ï¼šå°† pending  queue åˆå¹¶åˆ° basequeue
  }
  if (baseQueue !== null) {
    const first = baseQueue.next;
    let newState = current.baseState;
    let newBaseState = null;
    let newBaseQueueFirst = null;
    let newBaseQueueLast = null;
    let update = first;
    do {
      const updateExpirationTime = update.expirationTime;
      if (updateExpirationTime &lt; renderExpirationTime) { //ä¼˜å…ˆçº§ä¸è¶³
        const clone  = {
          expirationTime: update.expirationTime,
          ...
        };
        if (newBaseQueueLast === null) {
          newBaseQueueFirst = newBaseQueueLast = clone;
          newBaseState = newState;
        } else {
          newBaseQueueLast = newBaseQueueLast.next = clone;
        }
      } else {  //æ­¤æ›´æ–°ç¡®å®å…·æœ‰è¶³å¤Ÿçš„ä¼˜å…ˆçº§ã€‚
        if (newBaseQueueLast !== null) {
          const clone= {
            expirationTime: Sync, 
             ...
          };
          newBaseQueueLast = newBaseQueueLast.next = clone;
        }
        /* å¾—åˆ°æ–°çš„ state */
        newState = reducer(newState, action);
      }
      update = update.next;
    } while (update !== null &amp;&amp; update !== first);
    if (newBaseQueueLast === null) {
      newBaseState = newState;
    } else {
      newBaseQueueLast.next = newBaseQueueFirst;
    }
    hook.memoizedState = newState;
    hook.baseState = newBaseState;
    hook.baseQueue = newBaseQueueLast;
    queue.lastRenderedState = newState;
  }
  const dispatch = queue.dispatch
  return [hook.memoizedState, dispatch];
}
</code></pre>
<p>é¦–å…ˆå°†ä¸Šä¸€æ¬¡æ›´æ–°çš„<code>pending queue</code> åˆå¹¶åˆ° <code>basequeue</code>ï¼Œ
æ¥ä¸‹æ¥æŠŠå½“å‰<code>useState</code>æˆ–æ˜¯<code>useReduer</code>å¯¹åº”çš„<code>hooks</code>ä¸Šçš„<code>baseState</code>å’Œ<code>baseQueue</code>æ›´æ–°åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚
ä¼šå¾ªç¯<code>baseQueue</code>çš„<code>update</code>ï¼Œå¤åˆ¶ä¸€ä»½<code>update</code>, æ›´æ–° <code>expirationTime</code>ï¼Œ
å¯¹äºæœ‰è¶³å¤Ÿä¼˜å…ˆçº§çš„<code>update</code>ï¼ˆä¸Šè¿°ä¸‰ä¸ª<code>setNumber</code>äº§ç”Ÿçš„<code>update</code>éƒ½å…·æœ‰è¶³å¤Ÿçš„ä¼˜å…ˆçº§ï¼‰ï¼Œæˆ‘ä»¬è¦è·å–æœ€æ–°çš„<code>state</code>çŠ¶æ€ã€‚
ä¼šä¸€æ¬¡æ‰§è¡Œ<code>useState</code>ä¸Šçš„æ¯ä¸€ä¸ª<code>action</code>ã€‚å¾—åˆ°æœ€æ–°çš„<code>state</code>ã€‚</p>
<h2>è¿™é‡Œæœ‰ä¼šæœ‰ä¸¤ä¸ªç–‘é—®ğŸ¤”ï¸:</h2>
<p>é—®é¢˜ä¸€ï¼šè¿™é‡Œä¸æ˜¯æ‰§è¡Œæœ€åä¸€ä¸ª<code>action</code>ä¸å°±å¯ä»¥äº†å˜›?</p>
<ul>
<li>ç­”æ¡ˆï¼šä¸Šé¢è¯´äº† <code>useState</code>é€»è¾‘å’Œ<code>useReducer</code>å·®ä¸å¤šã€‚å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šå¼•ç”¨ä¸Šä¸€æ¬¡ <code>update</code>äº§ç”Ÿçš„ <code>state</code>, æ‰€ä»¥éœ€è¦<strong>å¾ªç¯è°ƒç”¨ï¼Œæ¯ä¸€ä¸ª<code>update</code>çš„<code>reducer</code></strong>ï¼Œ</li>
<li>å¦‚æœ<code>setNumber(2)</code>æ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆåªç”¨æ›´æ–°å€¼ï¼Œå¦‚æœæ˜¯<code>setNumber(state=&gt;state+1)</code>, é‚£ä¹ˆä¼ å…¥ä¸Šä¸€æ¬¡çš„ <code>state</code> å¾—åˆ°æœ€æ–°<code>state</code>ã€‚</li>
</ul>
<hr>
<p>é—®é¢˜äºŒï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰ä¼˜å…ˆçº§ä¸è¶³çš„æƒ…å†µ (<code>updateExpirationTime &lt; renderExpirationTime</code>)ï¼Ÿ</p>
<ul>
<li>ç­”æ¡ˆï¼š è¿™ç§æƒ…å†µï¼Œä¸€èˆ¬ä¼šå‘ç”Ÿåœ¨ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>setNumber</code>æ—¶å€™ï¼Œè°ƒç”¨<code>scheduleUpdateOnFiber</code>æ¸²æŸ“å½“å‰ç»„ä»¶æ—¶ï¼Œåˆäº§ç”Ÿäº†ä¸€æ¬¡æ–°çš„æ›´æ–°ï¼Œæ‰€ä»¥æŠŠæœ€ç»ˆæ‰§è¡Œ<code>reducer</code>æ›´æ–°<code>state</code>ä»»åŠ¡äº¤ç»™ä¸‹ä¸€æ¬¡æ›´æ–°ã€‚</li>
</ul>
<hr>
<p>ä¸ºä»€ä¹ˆè¦å°†ä¸Šä¸€æ¬¡æ›´æ–°çš„<code>pending queue</code> åˆå¹¶åˆ° <code>basequeue</code>ï¼Œæ¯”å¦‚æˆ‘ä»¬å†ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ä¸­è¿™ä¹ˆå†™ï¼Œ</p>
<pre><code>function Index(){
   const [ number ,setNumber ] = useState(0)
   const handerClick = ()=&gt;{
    //    setNumber(1)
    //    setNumber(2)
    //    setNumber(3)
       setNumber(state=&gt;state+1)
       // è·å–ä¸Šæ¬¡ state = 1 
       setNumber(state=&gt;state+1)
       // è·å–ä¸Šæ¬¡ state = 2
       setNumber(state=&gt;state+1)
   }
   console.log(number) // 3 
   return &lt;div&gt;
       &lt;div&gt;{ number }&lt;/div&gt;
       &lt;button onClick={ ()=&gt; handerClick() } &gt;ç‚¹å‡»&lt;/button&gt;
   &lt;/div&gt;
}
</code></pre>
<p><strong>ç‚¹å‡»æŒ‰é’®ï¼Œ æ‰“å° 3</strong></p>
<p>ä¸‰æ¬¡<code>setNumber</code>äº§ç”Ÿçš„<code>update</code>ä¼šæš‚ä¸”æ”¾å…¥<code>pending queue</code>ï¼Œåœ¨ä¸‹ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œæ—¶å€™ï¼Œä¸‰æ¬¡ <code>update</code>è¢«åˆå¹¶åˆ° <code>baseQueue</code>ã€‚ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52ed6118238d412aa20044ad33f25827~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<h2>3 updateEffect</h2>
<pre><code>function updateEffect(create, deps): void {
  const hook = updateWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  let destroy = undefined;
  if (currentHook !== null) {
    const prevEffect = currentHook.memoizedState;
    destroy = prevEffect.destroy;
    if (nextDeps !== null) {
      const prevDeps = prevEffect.deps;
      if (areHookInputsEqual(nextDeps, prevDeps)) {
        pushEffect(hookEffectTag, create, destroy, nextDeps);
        return;
      }
    }
  }
  currentlyRenderingFiber.effectTag |= fiberEffectTag
  hook.memoizedState = pushEffect(
    HookHasEffect | hookEffectTag,
    create,
    destroy,
    nextDeps,
  );
}
</code></pre>
<p><code>useEffect</code> åšçš„äº‹å¾ˆç®€å•ï¼Œåˆ¤æ–­ä¸¤æ¬¡<code>deps</code> ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰è¯´æ˜æ­¤æ¬¡æ›´æ–°ä¸éœ€è¦æ‰§è¡Œï¼Œåˆ™ç›´æ¥è°ƒç”¨ <code>pushEffect</code>, è¿™é‡Œæ³¨æ„ <code>effect</code>çš„æ ‡ç­¾ï¼Œ<code>hookEffectTag</code>, å¦‚æœä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆæ›´æ–° <code>effect</code> , å¹¶ä¸”èµ‹å€¼ç»™<code>hook.memoizedState</code>ï¼Œè¿™é‡Œæ ‡ç­¾æ˜¯ <code>HookHasEffect | hookEffectTag</code>, ç„¶ååœ¨<code>commit</code>é˜¶æ®µï¼Œ<code>react</code>ä¼šé€šè¿‡æ ‡ç­¾æ¥åˆ¤æ–­ï¼Œæ˜¯å¦æ‰§è¡Œå½“å‰çš„ <code>effect</code> å‡½æ•°ã€‚</p>
<h2>4 updateMemo</h2>
<pre><code>function updateMemo(
  nextCreate,
  deps,
) {
  const hook = updateWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps; // æ–°çš„ deps å€¼
  const prevState = hook.memoizedState; 
  if (prevState !== null) {
    if (nextDeps !== null) {
      const prevDeps = prevState[1]; // ä¹‹å‰ä¿å­˜çš„ deps å€¼
      if (areHookInputsEqual(nextDeps, prevDeps)) { //åˆ¤æ–­ä¸¤æ¬¡ deps å€¼
        return prevState[0];
      }
    }
  }
  const nextValue = nextCreate();
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}
</code></pre>
<p>åœ¨ç»„ä»¶æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œ<code>useMemo</code>å‡½æ•°ï¼Œåšçš„äº‹æƒ…å®é™…å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­ä¸¤æ¬¡ <code>deps</code>æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸æƒ³ç­‰ï¼Œè¯æ˜ä¾èµ–é¡¹å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæ‰§è¡Œ <code>useMemo</code>çš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œå¾—åˆ°æ–°çš„å€¼ï¼Œç„¶åé‡æ–°èµ‹å€¼ç»™<code>hook.memoizedState</code>, å¦‚æœç›¸ç­‰ è¯æ˜æ²¡æœ‰ä¾èµ–é¡¹æ”¹å˜ï¼Œé‚£ä¹ˆç›´æ¥è·å–ç¼“å­˜çš„å€¼ã€‚</p>
<p>ä¸è¿‡è¿™é‡Œæœ‰ä¸€ç‚¹ï¼Œå€¼å¾—æ³¨æ„ï¼Œ<code>nextCreate()</code>æ‰§è¡Œï¼Œå¦‚æœé‡Œé¢å¼•ç”¨äº†<code>usestate</code>ç­‰ä¿¡æ¯ï¼Œå˜é‡ä¼šè¢«å¼•ç”¨ï¼Œæ— æ³•è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ï¼Œå°±æ˜¯é—­åŒ…åŸç†ï¼Œé‚£ä¹ˆè®¿é—®çš„å±æ€§æœ‰å¯èƒ½ä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œæ‰€ä»¥éœ€è¦æŠŠå¼•ç”¨çš„å€¼ï¼Œæ·»åŠ åˆ°ä¾èµ–é¡¹ <code>dep</code> æ•°ç»„ä¸­ã€‚æ¯ä¸€æ¬¡<code>dep</code>æ”¹å˜ï¼Œé‡æ–°æ‰§è¡Œï¼Œå°±ä¸ä¼šå‡ºç°é—®é¢˜äº†ã€‚</p>
<p><strong>æ¸©é¦¨å°æç¤ºï¼š æœ‰å¾ˆå¤šåŒå­¦è¯´ <code>useMemo</code>æ€ä¹ˆç”¨ï¼Œåˆ°åº•ä»€ä¹ˆåœºæ™¯ç”¨ï¼Œç”¨äº†ä¼šä¸ä¼šèµ·åˆ°åä½œç”¨ï¼Œé€šè¿‡å¯¹æºç åŸç†è§£æï¼Œæˆ‘å¯ä»¥æ˜ç¡®çš„è¯´ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼Œè¯´ç™½äº†å°±æ˜¯å¯ä»¥å®šåˆ¶åŒ–ç¼“å­˜ï¼Œå­˜å€¼å–å€¼è€Œå·²ã€‚</strong></p>
<h2>5 updateRef</h2>
<pre><code>function updateRef(initialValue){
  const hook = updateWorkInProgressHook()
  return hook.memoizedState
}
</code></pre>
<p>å‡½æ•°ç»„ä»¶æ›´æ–° useRef åšçš„äº‹æƒ…æ›´ç®€å•ï¼Œå°±æ˜¯è¿”å›äº†ç¼“å­˜ä¸‹æ¥çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ— è®ºå‡½æ•°ç»„ä»¶æ€ä¹ˆæ‰§è¡Œï¼Œæ‰§è¡Œå¤šå°‘æ¬¡ï¼Œ<code>hook.memoizedState</code>å†…å­˜ä¸­éƒ½æŒ‡å‘äº†ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥è§£é‡Šäº†<code>useEffect</code>,<code>useMemo</code> ä¸­ï¼Œä¸ºä»€ä¹ˆ<code>useRef</code>ä¸éœ€è¦ä¾èµ–æ³¨å…¥ï¼Œå°±èƒ½è®¿é—®åˆ°æœ€æ–°çš„æ”¹å˜å€¼ã€‚</p>
<h2>ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶æ›´æ–°</h2>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a02c58be8c6f455f96c2e691b2ac6f7b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<h1> </h1>
<h1>ã€Œå‰ç«¯å·¥ç¨‹åŒ–ã€ä» 0-1 æ­å»º reactï¼Œts è„šæ‰‹æ¶ï¼ˆ1.2w å­—è¶…è¯¦ç»†æ•™ç¨‹ï¼‰</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/6919308174151385096">juejin.cn</a></p>
</blockquote>
<h3>è®¾ç½®ç›®æ ‡ï¼Œåˆ†è§£ç›®æ ‡</h3>
<p>æ•´ä¸ªæµç¨‹ï¼Œä¸»è¦åˆ†ä¸º</p>
<ul>
<li>åˆ›å»ºæ–‡ä»¶é˜¶æ®µ ï¼Œ</li>
<li>æ„å»ºï¼Œ</li>
<li>é›†æˆ webpack é˜¶æ®µï¼Œ</li>
<li>è¿è¡Œé¡¹ç›®é˜¶æ®µ</li>
</ul>
<h1>äºŒ åˆ›å»ºæ–‡ä»¶é˜¶æ®µ</h1>
<p>1 ç»ˆç«¯å‘½ä»¤è¡Œäº¤äº’</p>
<h2>1 ç»ˆç«¯å‘½ä»¤è¡Œäº¤äº’</h2>
<h3>â‘  node ä¿®æ”¹ bin</h3>
<p>æˆ‘ä»¬å¸Œæœ›çš„ç»ˆç«¯èƒ½å¤Ÿè¯†åˆ«<code>mycli</code> , ç„¶åé€šè¿‡ <code>mycli create</code>åˆ›å»ºä¸€ä¸ªé¡¹ç›®ã€‚
å®é™…ä¸Šæµç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„é€šè¿‡<code>mycli</code>å¯ä»¥æŒ‡å‘æ€§æ‰§è¡ŒæŒ‡å®šçš„<code>node</code>æ–‡ä»¶ã€‚</p>
<ol>
<li>æ–°å»º<strong>mycli.js æ–‡ä»¶</strong>
åœ¨<code>bin</code>æ–‡ä»¶å¤¹åˆ›å»ºçš„ <code>mycli.js</code>æ–‡ä»¶</li>
</ol>
<pre><code>#!/usr/bin/env node
'use strict';
console.log('hello,world')
</code></pre>
<ol start="2">
<li>åœ¨<code>package.json</code>ä¸­å£°æ˜ä¸€ä¸‹<code>bin</code>ã€‚</li>
</ol>
<pre><code>{
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;bin&quot;: {
    &quot;mycli&quot;: &quot;./bin/mycli.js&quot;
  },
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;ğŸ‘½&quot;,
}
</code></pre>
<p>ä¸ºäº†åœ¨æœ¬åœ°è°ƒè¯•ï¼Œ<code>my-cli</code>æ–‡ä»¶å¤¹ä¸‹ç”¨<code>npm link</code>, å¦‚æœåœ¨<code>mac</code>ä¸Šéœ€è¦æ‰§è¡Œ <code>sudo npm link</code>
ç„¶åæˆ‘ä»¬éšä¾¿æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œä¸€ä¸‹ <code>mycli</code>ã€‚çœ‹åˆ°æˆåŠŸæ‰“å°<code>hello,world</code>, ç¬¬ä¸€æ­¥ç®—æ˜¯æˆåŠŸäº†ã€‚</p>
<hr>
<p>åœ¨package.jsonæ–‡ä»¶ä¸­ï¼Œbinå­—æ®µç”¨äºæŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚å®ƒå…è®¸æ‚¨å°†é¡¹ç›®ä¸­çš„æŸä¸ªè„šæœ¬æˆ–å‘½ä»¤è¡Œå·¥å…·ä½œä¸ºå…¨å±€å‘½ä»¤ä½¿ç”¨ã€‚</p>
<p>å½“æ‚¨åœ¨å…¨å±€å®‰è£…é¡¹ç›®æ—¶ï¼Œbinå­—æ®µä¸­æŒ‡å®šçš„è„šæœ¬å°†è¢«é“¾æ¥åˆ°å…¨å±€çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä¸­ï¼Œä»è€Œä½¿æ‚¨å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥è¿è¡Œè¯¥è„šæœ¬ã€‚è¿™æ ·ï¼Œæ‚¨å°±å¯ä»¥åƒè¿è¡Œå…¶ä»–å…¨å±€å‘½ä»¤ä¸€æ ·è¿è¡Œé¡¹ç›®ä¸­çš„è„šæœ¬ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨çš„é¡¹ç›®æœ‰ä¸€ä¸ªåä¸º&quot;my-script.js&quot;çš„è„šæœ¬ï¼Œå¹¶ä¸”æ‚¨åœ¨package.jsonçš„binå­—æ®µä¸­æŒ‡å®šäº†è¯¥è„šæœ¬çš„è·¯å¾„ä¸º&quot;./bin/my-script.js&quot;ã€‚å½“æ‚¨åœ¨å…¨å±€å®‰è£…é¡¹ç›®åï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥è¿è¡Œ&quot;my-script&quot;å‘½ä»¤ï¼Œè€Œä¸éœ€è¦æŒ‡å®šå®Œæ•´çš„è„šæœ¬è·¯å¾„ã€‚</p>
<p>è¿™å¯¹äºå°†é¡¹ç›®ä½œä¸ºå‘½ä»¤è¡Œå·¥å…·åˆ†å‘ç»™å…¶ä»–å¼€å‘äººå‘˜æˆ–ç”¨æˆ·éå¸¸æœ‰ç”¨ã€‚ä»–ä»¬å¯ä»¥é€šè¿‡å…¨å±€å®‰è£…æ‚¨çš„é¡¹ç›®ï¼Œç„¶åç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨æ‚¨çš„å·¥å…·ã€‚</p>
<h3>â‘¡ commander -nodejs ç»ˆç«¯å‘½ä»¤è¡Œ</h3>
<hr>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åšçš„æ˜¯è®©<code>node</code>æ–‡ä»¶ (<code>demo</code>é¡¹ç›®ä¸­çš„<code>mycli.js</code>) èƒ½å¤Ÿè¯»æ‡‚æˆ‘ä»¬çš„ç»ˆç«¯å‘½ä»¤ã€‚
æ¯”å¦‚è¯´ <code>mycli create</code> åˆ›å»ºé¡¹ç›®ï¼› <code>mycli start</code>è¿è¡Œé¡¹ç›®; <code>mycli build</code> æ‰“åŒ…é¡¹ç›®ï¼›
ä¸ºäº†èƒ½å¤Ÿåœ¨ç»ˆç«¯æµåˆ©çš„æ“çºµå‘½ä»¤è¡Œ ï¼Œæˆ‘ä»¬å¼•å…¥ <code>commander</code> æ¨¡å—ã€‚</p>
<hr>
<p>ä¸ºäº†èƒ½åœ¨ç»ˆç«¯æ‰“å°å‡ºèŠ±é‡Œèƒ¡å“¨çš„é¢œè‰²ï¼Œæˆ‘ä»¬å¼•å…¥<code>chalk</code>åº“ã€‚</p>
<pre><code>const chalk = require('chalk')
const colors = [ 'green' , 'blue' , 'yellow' ,'red'  ]
const consoleColors = {}
/* console color */
colors.forEach(color=&gt;{
    consoleColors[color] = function(text,isConsole=true){
         return isConsole ? console.log( chalk[color](text) ) : chalk[color](text)
    }
})
module.exports = consoleColors
</code></pre>
<h4>ç®€ä»‹ commander å¸¸ç”¨ api</h4>
<p><code>Commander.js node.js</code>å‘½ä»¤è¡Œç•Œé¢çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ, å— <code>Ruby Commander</code>å¯å‘ã€‚
å‰ç«¯å¼€å‘<code>node cli</code> å¿…å¤‡æŠ€èƒ½ã€‚</p>
<h5>1 <code>version</code>ç‰ˆæœ¬</h5>
<pre><code>var program = require('commander');
program
    .version('0.0.1')
    .parse(process.argv);  
</code></pre>
<p>æ‰§è¡Œç»“æœ
node index.js -V
0.0.1</p>
<h5>2 <code>option</code>é€‰é¡¹</h5>
<p>ä½¿ç”¨<code>.option()</code>æ–¹æ³•å®šä¹‰<code>commander</code>çš„é€‰é¡¹<code>options</code>
ç¤ºä¾‹ï¼š.option('-n, --name [items2]', 'name description', 'default value')ã€‚</p>
<pre><code>program
  .option('-d, --debug', 'output extra debugging')
  .option('-s, --small', 'small pizza size')
program.parse(process.argv)
if( program.debug ){
    blue('option is debug')
}else if(program.small){
    blue('option is small')
}
</code></pre>
<p><strong>ç»ˆç«¯è¾“å…¥</strong> mycli -d
<strong>ç»ˆç«¯è¾“å‡º</strong> option is debug</p>
<h5>3 <code>commander</code>è‡ªå®šä¹‰æŒ‡ä»¤ (é‡ç‚¹)</h5>
<p>ä½œç”¨ï¼šæ·»åŠ å‘½ä»¤åç§°ï¼Œ ç¤ºä¾‹ï¼š<code>.command('add &lt;num&gt;</code></p>
<p>1 å‘½ä»¤åç§° &lt;å¿…é¡»&gt;ï¼šå‘½ä»¤åé¢å¯è·Ÿç”¨ &lt;&gt; æˆ– [] åŒ…å«çš„å‚æ•°ï¼›å‘½ä»¤çš„æœ€åä¸€ä¸ªå‚æ•°å¯ä»¥æ˜¯å¯å˜çš„ï¼Œåƒå®ä¾‹ä¸­é‚£æ ·åœ¨æ•°ç»„åé¢åŠ å…¥ ... æ ‡å¿—ï¼›åœ¨å‘½ä»¤åé¢ä¼ å…¥çš„å‚æ•°ä¼šè¢«ä¼ å…¥åˆ° <code>action</code> çš„å›è°ƒå‡½æ•°ä»¥åŠ <code>program.args</code> æ•°ç»„ä¸­ã€‚</p>
<p>2 å‘½ä»¤æè¿° &lt;å¯çœç•¥&gt;ï¼šå¦‚æœå­˜åœ¨ï¼Œä¸”æ²¡æœ‰æ˜¾ç¤ºè°ƒç”¨ <code>action(fn)</code> ï¼Œå°±ä¼šå¯åŠ¨å­å‘½ä»¤ç¨‹åºï¼Œå¦åˆ™ä¼šæŠ¥é”™ é…ç½®é€‰é¡¹ &lt;å¯çœç•¥&gt;ï¼šå¯é…ç½®<code>noHelpã€isDefault</code>ç­‰ã€‚</p>
<h4>ä½¿ç”¨ commanderï¼Œæ·»åŠ è‡ªå®šä¹‰å‘½ä»¤</h4>
<p>å› ä¸ºæˆ‘ä»¬åšçš„æ˜¯è„šæ‰‹æ¶ï¼Œæœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œåˆ›å»ºé¡¹ç›®ï¼Œè¿è¡Œé¡¹ç›® (å¼€å‘ç¯å¢ƒ), æ‰“åŒ…é¡¹ç›® (ç”Ÿäº§ç¯å¢ƒ)ï¼Œæ‰€ä»¥æˆ‘ä»¬æ·»åŠ ä¸‰ä¸ªå‘½ä»¤</p>
<pre><code>/* mycli create åˆ›å»ºé¡¹ç›® */
program
    .command('create')
    .description('create a project ')
    .action(function(){
        green('ğŸ‘½ ğŸ‘½ ğŸ‘½ '+'æ¬¢è¿ä½¿ç”¨mycli,è½»æ¾æ„å»ºreact tsé¡¹ç›®ï½ğŸ‰ğŸ‰ğŸ‰')
    })

/* mycli start è¿è¡Œé¡¹ç›® */
program
.command('start')
 .description('start a project')
 .action(function(){
    green('--------è¿è¡Œé¡¹ç›®-------')
 })

/* mycli build æ‰“åŒ…é¡¹ç›® */
program
.command('build')
.description('build a project')
.action(function(){
    green('--------æ„å»ºé¡¹ç›®-------')
})

program.parse(process.argv)
</code></pre>
<h3>â‘¢ inquirer æ¨¡å—å‘½ä»¤è¡Œäº¤äº’</h3>
<p>æˆ‘ä»¬æœŸæœ›åƒ<code>vue-cli</code>æˆ–è€…<code>dva-cli</code>å†æˆ–è€…æ˜¯<code>taro-cli</code>ä¸€æ ·ï¼Œå®ç°å’Œç»ˆç«¯çš„äº¤äº’åŠŸèƒ½ã€‚
è¿™å°±éœ€è¦å¦å¤–ä¸€ä¸ª <code>nodejs</code>æ¨¡å— <code>inquirer</code>ã€‚<code>Inquirer.js</code>æä¾›ç”¨æˆ·ç•Œé¢å’ŒæŸ¥è¯¢ä¼šè¯ã€‚
ä¸Šæ‰‹ï¼š</p>
<pre><code>var inquirer = require('inquirer');
inquirer
  .prompt([
    /* æŠŠä½ çš„é—®é¢˜ä¼ è¿‡æ¥ */
  ])
  .then(answers =&gt; {
    /* åé¦ˆç”¨æˆ·å†…å®¹ */
  })
  .catch(error =&gt; {
    /* å‡ºç°é”™è¯¯ */
  });
</code></pre>
<hr>
<p>ç”±äºæˆ‘ä»¬åšçš„æ˜¯<code>react</code>è„šæ‰‹æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å’Œç”¨æˆ·äº¤äº’é—®é¢˜è®¾å®šä¸ºï¼Œ
æ˜¯å¦åˆ›å»ºæ–°çš„é¡¹ç›®ï¼Ÿ(æ˜¯ / å¦) -&gt; è¯·è¾“å…¥é¡¹ç›®åç§°ï¼Ÿ(æ–‡æœ¬è¾“å…¥) -&gt; è¯·è¾“å…¥ä½œè€…ï¼Ÿ(æ–‡æœ¬è¾“å…¥) -&gt; è¯·é€‰æ‹©å…¬å…±ç®¡ç†çŠ¶æ€ï¼Ÿ(å•é€‰) <code>mobx</code> æˆ– <code>redux</code>ã€‚
ä¸Šè¿°<code>prompt</code>ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦å¯¹è¿™äº›é—®é¢˜åšåŸºç¡€é…ç½®ã€‚æˆ‘ä»¬çš„ <code>question</code> é…ç½®å¤§è‡´æ˜¯è¿™æ ·</p>
<pre><code>const question = [
   {
        name:'conf',              /* key */
        type:'confirm',           /* ç¡®è®¤ */
        message:'æ˜¯å¦åˆ›å»ºæ–°çš„é¡¹ç›®ï¼Ÿ' /* æç¤º */
    },{
        name:'name',
        message:'è¯·è¾“å…¥é¡¹ç›®åç§°ï¼Ÿ',
        when: res =&gt; Boolean(res.conf) /* æ˜¯å¦è¿›è¡Œ */
    },{
        name:'author',
        message:'è¯·è¾“å…¥ä½œè€…ï¼Ÿ',
        when: res =&gt; Boolean(res.conf)
    },{
        type: 'list',            /* é€‰æ‹©æ¡† */
        message: 'è¯·é€‰æ‹©å…¬å…±ç®¡ç†çŠ¶æ€ï¼Ÿ',
        name: 'state',
        choices: ['mobx','redux'], /* é€‰é¡¹*/
        filter: function(val) {    /* è¿‡æ»¤ */
          return val.toLowerCase()
        },
        when: res =&gt; Boolean(res.conf)
    }
]

</code></pre>
<hr>
<p>ç„¶åæˆ‘ä»¬åœ¨ <code>command('create')</code> å›è°ƒ <code>action()</code>é‡Œé¢ç»§ç»­åŠ ä¸Šå¦‚ä¸‹ä»£ç ã€‚</p>
<pre><code>program
    .command('create')
    .description('create a project ')
    .action(function(){
        green('ğŸ‘½ ğŸ‘½ ğŸ‘½ '+'æ¬¢è¿ä½¿ç”¨mycli,è½»æ¾æ„å»ºreact tsé¡¹ç›®ï½ğŸ‰ğŸ‰ğŸ‰')
        inquirer.prompt(question).then(answer=&gt;{
            console.log('answer=', answer )
        })
    })
</code></pre>
<hr>
<h2>æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„æ˜¯ï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯<code>copy</code>é¡¹ç›®æ–‡ä»¶ï¼Œ
<code>copy</code>æ–‡ä»¶æœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œ
ç¬¬ä¸€ç§é¡¹ç›®æ¨¡ç‰ˆå­˜åœ¨è„šæ‰‹æ¶ä¸­ï¼Œç¬¬äºŒç§å°±æ˜¯å‘<code>github</code>è¿™ç§è¿œç¨‹æ‹‰å–é¡¹ç›®æ¨¡ç‰ˆï¼Œ
æˆ‘ä»¬åœ¨è¿™é‡Œç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹æ¡ˆã€‚
æˆ‘ä»¬åœ¨è„šæ‰‹æ¶é¡¹ç›®ä¸­æ–°å»º<code>template</code>æ–‡ä»¶å¤¹ã€‚æ”¾å…¥<code>react-typescript</code>æ¨¡ç‰ˆã€‚æ¥ä¸‹æ¥è¦åšçš„æ˜¯å°±æ˜¯å¤åˆ¶æ•´ä¸ª<code>template</code>é¡¹ç›®æ¨¡ç‰ˆäº†ã€‚
2 æ·±æ‹·è´æ–‡ä»¶</h2>
<h3>2 é€’å½’å¤åˆ¶é¡¹ç›®æ–‡ä»¶</h3>
<h4>å®ç°æ€è·¯</h4>
<p>æ€è·¯ï¼š</p>
<p>â‘  é€‰æ‹©é¡¹ç›®æ¨¡ç‰ˆ ï¼šé¦–å…ˆè§£æåœ¨ç¬¬ä¸€æ­¥<code>inquirer</code>äº¤äº’æ¨¡å—ä¸‹ç”¨æˆ·é€‰æ‹©çš„é¡¹ç›®é…ç½®ï¼Œæˆ‘ä»¬é¡¹ç›®æœ‰å¯èƒ½æœ‰å¤šå¥—æ¨¡ç‰ˆã€‚
â‘¡ ä¿®æ”¹é…ç½®ï¼šå¯¹äºæˆ‘ä»¬åœ¨<code>inquirer</code>é˜¶æ®µï¼Œæä¾›çš„é…ç½®é¡¹ï¼Œæ¯”å¦‚é¡¹ç›®åç§°ï¼Œä½œè€…ç­‰ç­‰ï¼Œéœ€è¦æˆ‘ä»¬å¯¹é¡¹ç›®æ¨¡ç‰ˆå•ç‹¬å¤„ç†, ä¿®æ”¹é…ç½®é¡¹ã€‚è¿™äº›ä¿¡æ¯ä¸€èˆ¬éƒ½å­˜åœ¨<code>package.json</code>ä¸­ã€‚
â‘¢ å¤åˆ¶æ¨¡ç‰ˆç”Ÿæˆé¡¹ç›®
â‘£ é€šçŸ¥ä¸»ç¨‹åºæ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</p>
<hr>
<p>éå†æ•´ä¸ª<code>template</code>æ–‡ä»¶å¤¹ä¸‹é¢æ‰€æœ‰æ–‡ä»¶ï¼Œåˆ¤æ–­å­æ–‡ä»¶<strong>æ–‡ä»¶ç±»å‹</strong>ï¼Œå¦‚æœæ˜¯æ–‡ä»¶å°±ç›´æ¥å¤åˆ¶æ–‡ä»¶ï¼Œå¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œåˆ›å»ºæ–‡ä»¶å¤¹ï¼Œç„¶å<strong>é€’å½’</strong>éå†æ–‡ä»¶å¤¹ä¸‹å­æ–‡ä»¶ï¼Œé‡å¤ä»¥ä¸Šçš„æ“ä½œã€‚ç›´åˆ°æ‰€æœ‰çš„æ–‡ä»¶å…¨éƒ¨å¤åˆ¶å®Œæˆã€‚</p>
<hr>
<h4>å¤åˆ¶é¡¹ç›®æ–‡ä»¶æ ¸å¿ƒä»£ç </h4>
<h5>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æ¨¡ç‰ˆ</h5>
<p><strong><code>create</code>æ–¹æ³•</strong></p>
<pre><code>module.exports = function(res){
    /* åˆ›å»ºæ–‡ä»¶ */
    utils.green('------å¼€å§‹æ„å»º-------')
    /* æ‰¾åˆ°templateæ–‡ä»¶å¤¹ä¸‹çš„æ¨¡ç‰ˆé¡¹ç›® */
    const sourcePath = __dirname.slice(0,-3)+'template'
    utils.blue('å½“å‰è·¯å¾„:'+ process.cwd())
    /* ä¿®æ”¹package.json*/
    revisePackageJson( res ,sourcePath ).then(()=&gt;{
        copy( sourcePath , process.cwd() ,npm() )
    })
}
</code></pre>
<hr>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬è¦å¼„æ˜ç™½ä¸¤ä¸ªè·¯å¾„çš„æ„ä¹‰ï¼š</p>
<p><strong><code>__dirname</code></strong>:<code>Node.js</code>ä¸­,<code>__dirname</code>æ€»æ˜¯æŒ‡å‘è¢«æ‰§è¡Œ <code>js</code> æ–‡ä»¶çš„ç»å¯¹è·¯å¾„, æ‰€ä»¥å½“ä½ åœ¨ <code>/d1/d2/mycli.js</code>æ–‡ä»¶ä¸­å†™äº†<code>__dirname</code>, å®ƒçš„å€¼å°±æ˜¯<code>/d1/d2</code>ã€‚
<strong><code>process.cwd()</code></strong> : <code>process.cwd()</code> æ–¹æ³•ä¼šè¿”å› <code>Node.js</code> è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ã€‚</p>
<h5>ç¬¬äºŒæ­¥ï¼šä¿®æ”¹é…ç½®</h5>
<p>æ¨¡ç‰ˆé¡¹ç›®ä¸­çš„<code>package.json</code>ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•çš„åšä¸€ä¸ªæ›¿æ¢ï¼Œ
å°±æ˜¯è¯»å–<code>template</code>ä¸­çš„<code>package.json</code>æ–‡ä»¶ï¼Œç„¶åæ ¹æ®æ¨¡ç‰ˆæ›¿æ¢ï¼Œ
æ¥ä¸‹æ¥é‡æ–°åœ¨ç›®æ ‡ç›®å½•ä¸­ç”Ÿæˆ<code>package.json</code>ã€‚
æ¥ä¸‹æ¥<code>revisePackageJson</code>è¿”å›çš„<code>promise</code>ä¸­è¿›è¡ŒçœŸæ­£çš„å¤åˆ¶æ–‡ä»¶æµç¨‹ã€‚</p>
<pre><code>function revisePackageJson(res,sourcePath){
    return new Promise((resolve)=&gt;{
      /* è¯»å–æ–‡ä»¶ */
        fs.readFile(sourcePath+'/package.json',(err,data)=&gt;{
            if(err) throw err
            const { author , name  } = res
            let json = data.toString()
            /* æ›¿æ¢æ¨¡ç‰ˆ */
            json = json.replace(/demoName/g,name.trim())
            json = json.replace(/demoAuthor/g,author.trim())
            const path = process.cwd()+ '/package.json'
            /* å†™å…¥æ–‡ä»¶ */
            fs.writeFile(path, new Buffer(json) ,()=&gt;{
                utils.green( 'åˆ›å»ºæ–‡ä»¶ï¼š'+ path )
                resolve()
            })
        })
    })
}
</code></pre>
<h5>ç¬¬ä¸‰æ­¥ï¼šå¤åˆ¶æ–‡ä»¶</h5>
<pre><code>let fileCount = 0  /* æ–‡ä»¶æ•°é‡ */
let dirCount = 0   /* æ–‡ä»¶å¤¹æ•°é‡ */
let flat = 0       /* readiræ•°é‡ */
/**
 * 
 * @param {*} sourcePath   //templateèµ„æºè·¯å¾„
 * @param {*} currentPath  //å½“å‰é¡¹ç›®è·¯å¾„
 * @param {*} cb           //é¡¹ç›®å¤åˆ¶å®Œæˆå›è°ƒå‡½æ•° 
 */
function copy (sourcePath,currentPath,cb){
    flat++
    /* è¯»å–æ–‡ä»¶å¤¹ä¸‹é¢çš„æ–‡ä»¶ */
    fs.readdir(sourcePath,(err,paths)=&gt;{
        flat--
        if(err){
            throw err
        }
        paths.forEach(path=&gt;{
            if(path !== '.git' &amp;&amp; path !=='package.json' ) fileCount++
            const  newSoucePath = sourcePath + '/' + path
            const  newCurrentPath = currentPath + '/' + path
            /* åˆ¤æ–­æ–‡ä»¶ä¿¡æ¯ */
            fs.stat(newSoucePath,(err,stat)=&gt;{
                if(err){
                    throw err
                }
                /* åˆ¤æ–­æ˜¯æ–‡ä»¶ï¼Œä¸”ä¸æ˜¯ package.json  */
                if(stat.isFile() &amp;&amp; path !=='package.json' ){
                    /* åˆ›å»ºè¯»å†™æµ */
                    const readSteam = fs.createReadStream(newSoucePath)
                    const writeSteam = fs.createWriteStream(newCurrentPath)
                    readSteam.pipe(writeSteam)
                    color.green( 'åˆ›å»ºæ–‡ä»¶ï¼š'+ newCurrentPath  )
                    fileCount--
                    completeControl(cb)
                /* åˆ¤æ–­æ˜¯æ–‡ä»¶å¤¹ï¼Œå¯¹æ–‡ä»¶å¤¹å•ç‹¬è¿›è¡Œ dirExist æ“ä½œ */    
                }else if(stat.isDirectory()){
                    if(path!=='.git' &amp;&amp; path !=='package.json' ){
                        dirCount++
                        dirExist( newSoucePath , newCurrentPath ,copy,cb)
                    }
                }
            })
        })
    })
}

/**
 * 
 * @param {*} sourcePath  //templateèµ„æºè·¯å¾„
 * @param {*} currentPath  //å½“å‰é¡¹ç›®è·¯å¾„
 * @param {*} copyCallback  // ä¸Šé¢çš„ copy å‡½æ•°
 * @param {*} cb    //é¡¹ç›®å¤åˆ¶å®Œæˆå›è°ƒå‡½æ•° 
 */
function dirExist(sourcePath,currentPath,copyCallback,cb){
    fs.exists(currentPath,(ext=&gt;{
        if(ext){
            /* é€’å½’è°ƒç”¨copyå‡½æ•° */
            copyCallback( sourcePath , currentPath,cb)
        }else {
            fs.mkdir(currentPath,()=&gt;{
                fileCount--
                dirCount--
                copyCallback( sourcePath , currentPath,cb)
                color.yellow('åˆ›å»ºæ–‡ä»¶å¤¹ï¼š'+ currentPath )
                completeControl(cb)
            })
        }
    }))
}

</code></pre>
<p>è¿™ä¸€æ­¥çš„æµç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆç”¨ <code>fs.readdir</code>è¯»å–<code>template</code>æ–‡ä»¶å¤¹ä¸‹é¢çš„æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ <code>fs.stat</code>è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼Œåˆ¤æ–­æ–‡ä»¶çš„ç±»å‹ï¼Œå¦‚æœå½“å‰æ–‡ä»¶ç±»å‹æ˜¯<strong>æ–‡ä»¶ç±»å‹</strong>ï¼Œé‚£ä¹ˆé€šè¿‡è¯»å†™æµ<code>fs.createReadStream</code>å’Œ<code>fs.createWriteStream</code>åˆ›å»ºæ–‡ä»¶ï¼›å¦‚æœå½“å‰æ–‡ä»¶ç±»å‹æ˜¯<strong>æ–‡ä»¶å¤¹ç±»å‹</strong>ï¼Œåˆ¤æ–­æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå½“å‰æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œé€’å½’è°ƒç”¨<code>copy</code>å¤åˆ¶æ–‡ä»¶å¤¹ä¸‹é¢çš„æ–‡ä»¶, å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆé‡æ–°æ–°å»ºæ–‡ä»¶å¤¹ï¼Œç„¶åæ‰§è¡Œé€’å½’è°ƒç”¨ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬å¯¹<code>package.json</code>å•ç‹¬å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œçš„ä¸€åˆ‡æ–‡ä»¶æ“ä½œåº”è¯¥æ’é™¤<code>package.json</code>ã€‚å› ä¸ºæˆ‘ä»¬è¦åœ¨æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å…¨éƒ¨å¤åˆ¶åï¼Œè¿›è¡Œè‡ªåŠ¨ä¸‹è½½ä¾èµ–ç­‰åç»­æ“ä½œã€‚</p>
<h3><strong>å°æŠ€å·§ï¼šä¸‰å˜é‡è®¡æ•°æ³•æ§åˆ¶å¼‚æ­¥ I/O æ“ä½œ</strong></h3>
<p><strong>å¦‚ä½•æ‰èƒ½å¤Ÿåˆ¤æ–­æ‰€æœ‰çš„æ–‡ä»¶éƒ½å·²ç»å¤åˆ¶å®Œæˆå‘¢</strong> ï¼Œè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰å¼•å…¥ç¬¬ä¸‰æ–¹å¼‚æ­¥æµç¨‹åº“ï¼Œè€Œæ˜¯å·§å¦™çš„è¿ç”¨<strong>å˜é‡è®¡æ•°æ³•</strong>æ¥åˆ¤æ–­æ˜¯å¦æ‰€æœ‰æ–‡ä»¶å‡ä»¥å¤åˆ¶å®Œæ¯•ã€‚</p>
<p>å˜é‡ä¸€<code>flat</code>: æ¯ä¸€æ¬¡ <strong>copy</strong> å‡½æ•°è°ƒç”¨, ä¼šæ‰§è¡Œå¼‚æ­¥<code>fs.readdir</code>è¯»å–æ–‡ä»¶å¤¹ä¸‹é¢çš„æ‰€æœ‰æ–‡ä»¶, æˆ‘ä»¬ç”¨ <code>flat++</code>è®°å½• <code>readdir</code>æ•°é‡ï¼Œ æ¯æ¬¡<code>readdir</code>å®Œæˆæ‰§è¡Œ<code>flat--</code>ã€‚
å˜é‡äºŒ<code>fileCount</code>: æ¯ä¸€æ¬¡æ–‡ä»¶ (å¯èƒ½æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹) çš„éå†ï¼Œæˆ‘ä»¬ç”¨<code>fileCount++</code>æ¥è®°å½•ï¼Œå½“æ–‡ä»¶åˆ›å»ºå®Œæˆæˆ–è€…æ–‡ä»¶å¤¹åˆ›å»ºå®Œæˆï¼Œæ‰§è¡Œ <code>fileCount--</code> ã€‚
å˜é‡ä¸‰<code>dirCount</code>: æ¯ä¸€æ¬¡åˆ¤æ–­æ–‡ä»¶å¤¹çš„æ“ä½œï¼Œæˆ‘ä»¬ç”¨ <code>dirCount++</code>æ¥è®°å½•ï¼Œå½“æ–°çš„æ–‡ä»¶å¤¹è¢«åˆ›å»ºå®Œæˆï¼Œæ‰§è¡Œ <code>dirCount--</code>ã€‚</p>
<pre><code>function completeControl(cb){
    /* ä¸‰å˜é‡å‡ä¸º0ï¼Œå¼‚æ­¥I/Oæ‰§è¡Œå®Œæ¯•ã€‚ */
    if(fileCount === 0 &amp;&amp; dirCount ===0 &amp;&amp; flat===0){
        color.green('------æ„å»ºå®Œæˆ-------')
        if(cb &amp;&amp; !isInstall ){
            isInstall = true
            color.blue('-----å¼€å§‹install-----')
            cb(()=&gt;{
                color.blue('-----å®Œæˆinstall-----')
                /* åˆ¤æ–­æ˜¯å¦å­˜åœ¨webpack  */
                runProject()
            })
        }
    }
}

</code></pre>
<p>æˆ‘ä»¬åœ¨æ¯æ¬¡åˆ›å»ºæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹äº‹ä»¶æ‰§è¡Œä¹‹åï¼Œéƒ½ä¼šè°ƒç”¨<code>completeControl</code>æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­<code>flat</code>,<code>fileCount</code>,<code>dirCount</code>ä¸‰ä¸ªå˜é‡å‡ä¸º <strong>0</strong>ï¼Œå°±èƒ½åˆ¤æ–­å‡ºæ•´ä¸ªå¤åˆ¶æµç¨‹, æ‰§è¡Œå®Œæ¯•, å¹¶ä½œå‡ºä¸‹ä¸€æ­¥æ“ä½œã€‚</p>
<h1>ä¸‰ æ„å»ºï¼Œé›†æˆé¡¹ç›®é˜¶æ®µ</h1>
<h2>1 è§£æå‘½ä»¤ï¼Œè‡ªåŠ¨è¿è¡Œå‘½ä»¤è¡Œã€‚</h2>
<p>ä¹‹å‰æˆ‘ä»¬é€šè¿‡ä¿®æ”¹<code>bin</code>ï¼Œå€ŸåŠ©<code>commander</code>æ¨¡å—æ¥é€šè¿‡è¾“å…¥ç»ˆç«¯<strong>å‘½ä»¤è¡Œ</strong>ï¼Œæ¥æ‰§è¡Œ<code>node</code>æ–‡ä»¶ï¼Œæ¥å¯¹åº”å¯åŠ¨æˆ‘ä»¬çš„ç¨‹åºã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„æ˜¯é€šè¿‡<code>nodejs</code>ä»£ç ï¼Œæ¥æ‰§è¡Œå¯¹åº”çš„<strong>ç»ˆç«¯å‘½ä»¤</strong>ã€‚
æˆ‘ä»¬éœ€è¦åœ¨å¤åˆ¶æ•´ä¸ªé¡¹ç›®ç›®å½•ä¹‹åï¼Œæ¥<strong>è‡ªåŠ¨ä¸‹è½½ä¾èµ–<code>npm, install</code>ï¼Œå¯åŠ¨é¡¹ç›®<code>npm start</code></strong>ã€‚
é¦–å…ˆæˆ‘ä»¬åœ¨<code>mycli</code>è„šæ‰‹æ¶é¡¹ç›®çš„<code>src</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»º<code>npm.js</code>ï¼Œç”¨æ¥å¤„ç†ä¸‹è½½ä¾èµ–ï¼Œå¯åŠ¨é¡¹ç›®æ“ä½œã€‚</p>
<h3>â‘ <code>which</code>æ¨¡å—åŠ©åŠ›æ‰¾åˆ°<code>npm</code></h3>
<pre><code>var which = require('which')
//å¼‚æ­¥ç”¨æ³•
which('node', function (er, resolvedPath) {
  // å¦‚æœåœ¨PATHä¸Šæ‰¾ä¸åˆ°â€œèŠ‚ç‚¹â€ï¼Œåˆ™è¿”å›er
  // å¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿”å›execçš„ç»å¯¹è·¯å¾„
})
//åŒæ­¥ç”¨æ³•
const resolved = which.sync('node')
</code></pre>
<p><strong>åœ¨ npm.js ä¸‹</strong></p>
<pre><code>const which = require('which')
/* æ‰¾åˆ°npm */
function findNpm() {
  var npms = process.platform === 'win32' ? ['npm.cmd'] : ['npm']
  for (var i = 0; i &lt; npms.length; i++) {
    try {
      which.sync(npms[i])
      console.log('use npm: ' + npms[i])
      return npms[i]
    } catch (e) {
    }
  }
  throw new Error('please install npm')
}
</code></pre>
<h3>â‘¡ child_process.spawn è¿è¡Œç»ˆç«¯å‘½ä»¤</h3>
<p>åœ¨ä¸Šé¢æˆ‘ä»¬æˆåŠŸæ‰¾åˆ°<code>npm</code>ä¹‹åï¼Œéœ€è¦ç”¨ <code>child_process.spawn</code>è¿è¡Œå½“å‰å‘½ä»¤ã€‚
<code>child_process.spawn(command[, args][, options])</code>
<code>command &lt;string&gt;</code> è¦è¿è¡Œçš„å‘½ä»¤ã€‚ <code>args &lt;string[]&gt;</code> å­—ç¬¦ä¸²å‚æ•°åˆ—è¡¨ã€‚</p>
<p><code>options &lt;Object&gt;</code> é…ç½®å‚æ•°ã€‚</p>
<pre><code>/**
 * 
 * @param {*} cmd   
 * @param {*} args 
 * @param {*} fn 
 */
/* è¿è¡Œç»ˆç«¯å‘½ä»¤ */ 
function runCmd(cmd, args, fn) {
  args = args || []
  var runner = require('child_process').spawn(cmd, args, {
    stdio: 'inherit'
  })
  runner.on('close', function (code) {
    if (fn) {
      fn(code)
    }
  })
}
</code></pre>
<h3>â‘¢ç¼–å†™ npm æ–¹æ³•</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬â‘ â‘¡æ­¥éª¤çš„å†…å®¹æ•´åˆåœ¨ä¸€èµ·ï¼ŒæŠŠæ•´ä¸ª<code>npm.js</code> <code>npm</code>æ–¹æ³•æš´éœ²å‡ºå».</p>
<pre><code>/**
 * 
 * @param {*} installArg  æ‰§è¡Œå‘½ä»¤ å‘½ä»¤è¡Œç»„æˆçš„æ•°ç»„ï¼Œé»˜è®¤ä¸º install 
 */
module.exports = function (installArg = [ 'install' ]) {
  /* é€šè¿‡ç¬¬ä¸€æ­¥,é—­åŒ…ä¿å­˜npm */  
  const npm = findNpm()
  return function (done){
    /* æ‰§è¡Œå‘½ä»¤ */  
    runCmd(which.sync(npm),installArg, function () {
        /* æ‰§è¡ŒæˆåŠŸå›è°ƒ */
        done &amp;&amp; done()
     })
  }
}
</code></pre>
<p><strong>ä½¿ç”¨ä¾‹å­ğŸŒ°ğŸŒ°</strong></p>
<pre><code>const npm = require('./npm')

/* æ‰§è¡Œ npm install  */
const install = npm()
install()

/* æ‰§è¡Œ npm start */
const start = npm(['start])
start()

</code></pre>
<h3>â‘£ å®Œæˆè‡ªåŠ¨é¡¹ç›®å®‰è£…ï¼Œé¡¹ç›®å¯åŠ¨</h3>
<p>æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥å¤åˆ¶é¡¹ç›®ä¸­ï¼Œå›è°ƒå‡½æ•°<code>cb</code>åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ ç›¸ä¿¡ç»†å¿ƒçš„åŒå­¦å·²ç»å‘ç°äº†ã€‚</p>
<pre><code>const npm = require('./npm')
 copy( sourcePath , process.cwd() ,npm() )
</code></pre>
<p><code>cb</code> å‡½æ•°å°±æ˜¯æ‰§è¡Œ<code>npm install</code> çš„æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€ä¸Šè¿°çš„å¤åˆ¶æˆåŠŸåï¼Œå¯åŠ¨é¡¹ç›®æ¥è®²ã€‚
åœ¨ä¸‰å˜é‡åˆ¤æ–­é¡¹ç›®åˆ›å»ºæˆåŠŸä¹‹å, æˆ‘ä»¬å¼€å§‹æ‰§è¡Œå®‰è£…é¡¹ç›®.</p>
<pre><code>function completeControl(cb){
    if(fileCount === 0 &amp;&amp; dirCount ===0 &amp;&amp; flat===0){
        color.green('------æ„å»ºå®Œæˆ-------')
        if(cb &amp;&amp; !isInstall ){
            isInstall = true
            color.blue('-----å¼€å§‹install-----')
            /* ä¸‹è½½é¡¹ç›® */
            cb(()=&gt;{
                color.blue('-----å®Œæˆinstall-----')
                runProject()
            })
        }
    }
}
</code></pre>
<p>æˆ‘ä»¬åœ¨å®‰è£…ä¾èµ–æˆåŠŸçš„å›è°ƒå‡½æ•°ä¸­ï¼Œç»§ç»­è°ƒç”¨<code>runProject</code>å¯åŠ¨é¡¹ç›®ã€‚</p>
<pre><code>function runProject(){
    try{
        /* ç»§ç»­è°ƒç”¨ npm æ‰§è¡Œï¼Œnpm start å‘½ä»¤ */
        const start = npm([ 'start' ])
        start()
    }catch(e){
       color.red('è‡ªåŠ¨å¯åŠ¨å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨npm start å¯åŠ¨é¡¹ç›®')
    }
} 
</code></pre>
<p><strong>æ•ˆæœï¼šç”±äºå®‰è£…ä¾èµ–æ—¶é—´è¿‡é•¿ï¼Œè¿è¡Œé¡¹ç›®é˜¶æ®µæ²¡æœ‰åœ¨è§†é¢‘é‡Œå±•ç¤º</strong>
<code>runProject</code>ä»£ç å¾ˆç®€å•ï¼Œç»§ç»­è°ƒç”¨ <code>npm</code>ï¼Œ æ‰§è¡Œ <code>npm start</code> å‘½ä»¤ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®ç°äº†é€šè¿‡ <code>mycli create</code> <strong>åˆ›å»ºé¡¹ç›®</strong>ï¼Œ<strong>å®‰è£…ä¾èµ–</strong>ï¼Œ<strong>è¿è¡Œé¡¹ç›®</strong>å…¨æµç¨‹ï¼Œé‡Œé¢è¿˜æœ‰é›†æˆ<code>webpack</code>, è¿›ç¨‹é€šä¿¡ç­‰ç»†èŠ‚ï¼Œæˆ‘ä»¬é©¬ä¸Šæ…¢æ…¢é“æ¥ã€‚</p>
<h2>2 åˆ›å»ºå­è¿›ç¨‹ï¼Œè¿›ç¨‹é€šä¿¡</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°<code>mycli start</code> å’Œ <code>mycli build</code> ä¸¤ä¸ªåŠŸèƒ½ã€‚</p>
<h3>â‘  åŒè¿›ç¨‹è§£å†³æ–¹æ¡ˆ</h3>
<p>æˆ‘ä»¬æ‰“ç®—ç”¨<code>webpack</code>ä½œä¸ºè„šæ‰‹æ¶çš„æ„å»ºå·¥å…·ã€‚
é‚£ä¹ˆæˆ‘ä»¬éœ€è¦<code>mycli</code>ä¸»è¿›ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥ç®¡ç†<code>webpack</code>, åˆå¹¶<code>webpack</code>é…ç½®é¡¹ï¼Œè¿è¡Œ<code>webpack-dev-serve</code>ç­‰ï¼Œ</p>
<p>è¿™é‡Œæ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„ä¸»è¿›ç¨‹æ˜¯åœ¨<code>mycli</code>å…¨å±€è„šæ‰‹æ¶é¡¹ç›®ä¸­ï¼Œè€Œæˆ‘ä»¬çš„å­è¿›ç¨‹è¦å»ºç«‹åœ¨æˆ‘ä»¬æœ¬åœ°é€šè¿‡<code>mycli create</code>åˆ›å»ºçš„<code>react</code>æ–°é¡¹ç›®<code>node_modules</code>ä¸­ï¼Œ
æ‰€ä»¥æˆ‘ä»¬å†™äº†ä¸€ä¸ªè„šæ‰‹æ¶çš„<code>plugin</code>ç”¨æ¥</p>
<ul>
<li>ä¸€æ–¹é¢å»ºç«‹å’Œ<code>mycli</code>è¿›ç¨‹é€šä¿¡,</li>
<li>å¦ä¸€æ–¹é¢ç®¡ç†æˆ‘ä»¬çš„<code>react</code>ç›®çš„é…ç½®ï¼Œæ“æ§<code>webpack</code>ã€‚</li>
</ul>
<p><code>mycli-react-webpack-plugin</code>åœ¨åˆ›å»ºé¡¹ç›®ä¸­<code>package.json</code>ä¸­ï¼Œæˆ‘ä»¬åœ¨å®‰è£…ä¾èµ–çš„è¿‡ç¨‹ä¸­ï¼Œå·²ç»å®‰è£…åœ¨äº†æ–°å»ºé¡¹ç›®çš„<code>node_modules</code>ä¸­ã€‚</p>
<h3>â‘¡ mycli start å’Œ mycli build</h3>
<h4>ç¬¬ä¸€æ­¥ï¼šå®Œå–„ <code>mycli start</code> å’Œ <code>mycli build</code></h4>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨<code>mycli</code>è„šæ‰‹æ¶é¡¹ç›®<code>src</code>æ–‡ä»¶å¤¹ä¸‹é¢åˆ›å»º<code>start.js</code>ä¸ºäº†å’Œä¸Šè¿°çš„<code>plugin</code>å»ºç«‹èµ·è¿›ç¨‹é€šä¿¡ã€‚å› ä¸ºæ— è®ºæ˜¯æ‰§è¡Œ<code>mycli start</code>æˆ–è€…æ˜¯ <code>mycli build</code>éƒ½æ˜¯éœ€è¦æ“çºµ<code>webpack</code>æ‰€ä»¥æˆ‘ä»¬å†™åœ¨äº†ä¸€èµ·äº†ã€‚
æˆ‘ä»¬ç»§ç»­åœ¨<code>mycli.js</code>ä¸­å®Œå–„ <code>mycli start</code> å’Œ <code>mycli build</code>ä¸¤ä¸ªæŒ‡ä»¤ã€‚</p>
<pre><code>const start = require('../src/start')
/* mycli start è¿è¡Œé¡¹ç›® */
program
.command('start')
 .description('start a project')
 .action(function(){
    green('--------è¿è¡Œé¡¹ç›®-------')
    /* è¿è¡Œé¡¹ç›® */
     start('start').then(()=&gt;{
		green('-------âœ…  âœ…è¿è¡Œå®Œæˆ-------')
	})
 })

/* mycli build æ‰“åŒ…é¡¹ç›® */
program
.command('build')
.description('build a project')
.action(function(){
    green('--------æ„å»ºé¡¹ç›®-------')
    /* æ‰“åŒ…é¡¹ç›® */
    start('build').then(()=&gt;{
		green('-------âœ…  âœ…æ„å»ºå®Œæˆ-------')
	})
})

</code></pre>
<h4>ç¬¬äºŒæ­¥ï¼šstart.js è¿›ç¨‹é€šä¿¡</h4>
<h5>child_process.fork ä»‹ç»</h5>
<p><code>modulePath</code>ï¼šå­è¿›ç¨‹è¿è¡Œçš„æ¨¡å—ã€‚</p>
<p>å‚æ•°è¯´æ˜ï¼šï¼ˆé‡å¤çš„å‚æ•°è¯´æ˜å°±ä¸åœ¨è¿™é‡Œåˆ—ä¸¾ï¼‰</p>
<p><code>execPath</code>ï¼š ç”¨æ¥åˆ›å»ºå­è¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé»˜è®¤æ˜¯<code>/usr/local/bin/node</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯é€šè¿‡<code>execPath</code>æ¥æŒ‡å®šå…·ä½“çš„<code>node</code>å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ã€‚ï¼ˆæ¯”å¦‚å¤šä¸ª<code>node</code>ç‰ˆæœ¬ï¼‰ <code>execArgvï¼š:</code> ä¼ ç»™å¯æ‰§è¡Œæ–‡ä»¶çš„å­—ç¬¦ä¸²å‚æ•°åˆ—è¡¨ã€‚é»˜è®¤æ˜¯ <code>process.execArgv</code>ï¼Œè·Ÿçˆ¶è¿›ç¨‹ä¿æŒä¸€è‡´ã€‚ <code>silentï¼š</code> é»˜è®¤æ˜¯<code>false</code>ï¼Œå³å­è¿›ç¨‹çš„ stdio ä»çˆ¶è¿›ç¨‹ç»§æ‰¿ã€‚å¦‚æœæ˜¯<code>true</code>ï¼Œåˆ™ç›´æ¥<code>pipe</code>å‘å­è¿›ç¨‹çš„<code>child.stdinã€child.stdout</code>ç­‰ã€‚ <code>stdioï¼š</code> å¦‚æœå£°æ˜äº†<code>stdio</code>ï¼Œåˆ™ä¼šè¦†ç›–<code>silent</code>é€‰é¡¹çš„è®¾ç½®ã€‚</p>
<h5>è¿è¡Œå­ç¨‹åº</h5>
<p>æˆ‘ä»¬åœ¨<code>start.js</code>ä¸­å¯åŠ¨<strong>å­è¿›ç¨‹</strong>å’Œä¸Šè¿°çš„<code>mycli-react-webpack-plugin</code>å»ºç«‹èµ·é€šä¿¡ã€‚æ¥ä¸‹æ¥å°±æ˜¯ä»‹ç»<code>start.js</code>ã€‚</p>
<p><strong>start.js</strong></p>
<pre><code>'use strict';
/* å¯åŠ¨é¡¹ç›® */
const child_process = require('child_process')
const chalk = require('chalk')
const fs = require('fs')
/* æ‰¾åˆ°mycli-react-webpack-pluginçš„è·¯å¾„*/
const currentPath = process.cwd()+'/node_modules/mycli-react-webpack-plugin'

/**
 * 
 * @param {*} type  type = start æœ¬åœ°å¯åŠ¨é¡¹ç›®  type = build çº¿ä¸Šæ‰“åŒ…é¡¹ç›®
 */
module.exports = (type) =&gt; {
    return new Promise((resolve,reject)=&gt;{
        /* åˆ¤æ–­ mycli-react-webpack-plugin æ˜¯å¦å­˜åœ¨ */
        fs.exists(currentPath,(ext)=&gt;{
            if(ext){ /* å­˜åœ¨ å¯åŠ¨å­è¿›ç¨‹  */
              const children = child_process.fork(currentPath + '/index.js' )
              /* ç›‘å¬å­è¿›ç¨‹ä¿¡æ¯ */
              children.on('message',(message)=&gt;{
                  const msg = JSON.parse( message )
                  if(msg.type ==='end'){
                      /* å…³é—­å­è¿›ç¨‹ */
                      children.kill()
                      resolve()
                  }else if(msg.type === 'error'){
                       /* å…³é—­å­è¿›ç¨‹ */
                      children.kill()
                      reject()
                  }
              })
              /* å‘é€cwdè·¯å¾„ å’Œ æ“ä½œç±»å‹ start è¿˜æ˜¯ build  */
              children.send(JSON.stringify({
                  cwdPath:process.cwd(),
                  type: type || 'build'
              }))
            }else{ /* ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºè­¦å‘Šï¼Œä¸‹è½½ */
               console.log( chalk.red('mycli-react-webpack-plugin does not exist , please install mycli-react-webpack-plugin')   )
            }
        })
    })
}
</code></pre>
<p>è¿™ä¸€æ­¥å®é™…å¾ˆç®€å•ï¼Œå¤§è‡´åˆ†ä¸ºäºŒæ­¥:</p>
<p>1 åˆ¤æ–­ <code>mycli-react-webpack-plugin</code> æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å¯åŠ¨ <code>mycli-react-webpack-plugin</code>ä¸‹çš„<code>index.js</code>ä¸ºå­è¿›ç¨‹ã€‚å¦‚æœä¸å­˜åœ¨ï¼ŒæŠ›å‡ºè­¦å‘Šä¸‹è½½<code>plugin</code>ã€‚</p>
<p>2 ç»‘å®šå­è¿›ç¨‹äº‹ä»¶<code>message</code>, å‘å­è¿›ç¨‹å‘é€æŒ‡ä»¤ï¼Œæ˜¯<strong>å¯åŠ¨é¡¹ç›®</strong>è¿˜æ˜¯<strong>æ„å»ºé¡¹ç›®</strong>ã€‚</p>
<h3>â‘¢ mycli-react-webpack-plugin</h3>
<p>æ¥ä¸‹æ¥åšçš„äº‹å°±æ˜¯è®©<code>mycli-react-webpack-plugin</code> å®Œæˆ<strong>é¡¹ç›®é…ç½®</strong>ï¼Œ<strong>é¡¹ç›®æ„å»º</strong>æµç¨‹ã€‚</p>
<h4>1 é¡¹ç›®ç»“æ„</h4>
<p><strong><code>mycli-react-webpack-plugin</code>æ’ä»¶é¡¹ç›®æ–‡ä»¶ç»“æ„</strong></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8593363eb6c94455a4c25b717f1f95a7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>é¡¹ç›®ç›®å½•å¤§è‡´æ˜¯å¦‚ä¸Šçš„æ ·å­ï¼Œ<code>config</code>æ–‡ä»¶ä¸‹ï¼Œæ˜¯ä¸åŒæ„å»ºç¯å¢ƒçš„åŸºç¡€é…ç½®æ–‡ä»¶, åœ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šè¯»å–åˆ›å»ºæ–°é¡¹ç›®çš„<code>mycli.config.js</code>åœ¨ç”Ÿäº§ç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒçš„é…ç½®é¡¹ï¼Œç„¶ååˆå¹¶é…ç½®é¡¹ã€‚</p>
<p><strong>æˆ‘ä»¬çš„æ–°åˆ›å»ºé¡¹ç›®çš„<code>mycli.config.js</code></strong></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9191ac6486c4df6b516e50289481df5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<h4>2 å…¥å£æ–‡ä»¶</h4>
<pre><code>const RunningWebpack = require('./lib/run')

/**
 * åˆ›å»ºä¸€ä¸ªè¿è¡Œç¨‹åºï¼Œåœ¨webpackçš„ä¸åŒç¯å¢ƒä¸‹è¿è¡Œé…ç½®æ–‡ä»¶
 */

/* å¯åŠ¨ RunningWebpack å®ä¾‹ */
const runner = new RunningWebpack()

process.on('message',message=&gt;{
   const msg = JSON.parse( message )
   if(msg.type &amp;&amp; msg.cwdPath ){
     runner.listen(msg).then(
          ()=&gt;{
             /* æ„å»ºå®Œæˆ ï¼Œé€šçŸ¥ä¸»è¿›ç¨‹ ï¼Œç»“æŸå­è¿›ç¨‹ */ 
             process.send(JSON.stringify({ type:'end' }))
          },(error)=&gt;{
             /* å‡ºç°é”™è¯¯ ï¼Œé€šçŸ¥ä¸»è¿›ç¨‹ ï¼Œç»“æŸå­è¿›ç¨‹ */     
             process.send(JSON.stringify({ type:'error' , error }))
          }
      )
   }
})
</code></pre>
<p>æˆ‘ä»¬è¿™é‡Œç”¨<code>RunningWebpack</code>æ¥æ‰§è¡Œä¸€ç³»åˆ—çš„<code>webpack</code>å¯åŠ¨, æ‰“åŒ…æ“ä½œã€‚</p>
<h2>3 åˆå¹¶é…ç½®é¡¹ï¼Œè‡ªåŠ¨å¯åŠ¨ webpackã€‚</h2>
<h3>â‘  åŸºäº <code>EventEmitter</code>çš„ <code>RunningWebpack</code></h3>
<p>æˆ‘ä»¬çš„ <code>RunningWebpack</code> åŸºäº <code>nodejs</code> çš„ <code>EventEmitter</code> æ¨¡å—ï¼Œ<code>EventEmitter</code> å¯ä»¥è§£å†³å¼‚æ­¥ I/Oï¼Œå¯ä»¥åœ¨åˆé€‚çš„åœºæ™¯è§¦å‘ä¸åŒçš„<code>webpack</code>å‘½ä»¤ï¼Œæ¯”å¦‚ <code>start</code> æˆ–è€…æ˜¯ <code>build</code>ç­‰ã€‚</p>
<h4>EventEmitter ç®€ä»‹</h4>
<p><code>nodejs</code>æ‰€æœ‰çš„å¼‚æ­¥ I/O æ“ä½œåœ¨å®Œæˆæ—¶éƒ½ä¼šå‘é€ä¸€ä¸ªäº‹ä»¶åˆ°äº‹ä»¶é˜Ÿåˆ—ã€‚</p>
<p>Node.js é‡Œé¢çš„è®¸å¤šå¯¹è±¡éƒ½ä¼šåˆ†å‘äº‹ä»¶ï¼šä¸€ä¸ª <code>net.Server</code> å¯¹è±¡ä¼šåœ¨æ¯æ¬¡æœ‰æ–°è¿æ¥æ—¶è§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œ ä¸€ä¸ª <code>fs.readStream</code> å¯¹è±¡ä¼šåœ¨æ–‡ä»¶è¢«æ‰“å¼€çš„æ—¶å€™è§¦å‘ä¸€ä¸ªäº‹ä»¶ã€‚ æ‰€æœ‰è¿™äº›äº§ç”Ÿäº‹ä»¶çš„å¯¹è±¡éƒ½æ˜¯ <code>events.EventEmitter</code> çš„å®ä¾‹ã€‚</p>
<h4>ç®€å•ç”¨æ³•</h4>
<pre><code>//event.js æ–‡ä»¶
var EventEmitter = require('events').EventEmitter; 
var event = new EventEmitter(); 
event.on('some_event', function() { 
    console.log('some_event äº‹ä»¶è§¦å‘'); 
}); 
setTimeout(function() { 
    event.emit('some_event'); 
}, 1000); 
</code></pre>
<h3>â‘¡ åˆå¹¶<code>webpack</code>é…ç½®é¡¹</h3>
<p>ä¸Šè¿°ä»‹ç»å®Œç”¨ <code>EventEmitter</code>ä½œä¸ºè¿è¡Œ<code>webpack</code>çš„äº‹ä»¶æ¨¡å‹ï¼Œæ¥ä¸‹æˆ‘ä»¬æ¥åˆ†æä»¥ä¸‹ï¼Œå½“è¿è¡Œå…¥å£æ–‡ä»¶çš„æ—¶å€™ã€‚</p>
<pre><code>runner.listen(msg).then
</code></pre>
<pre><code>const merge = require('./merge')
const webpack = require('webpack')
const runMergeGetConfig = require('../config/webpack.base')
   /**
     * æ¥å—ä¸åŒçš„webpackçŠ¶æ€ï¼Œåˆå¹¶
     */
    listen({ type,cwdPath }){
       this.path = cwdPath
       this.type = type
       /* åˆå¹¶é…ç½®é¡¹ï¼Œå¾—åˆ°æ–°çš„webpacké…ç½®é¡¹ */
       this.config = merge.call(this,runMergeGetConfig( cwdPath )(type))
       return new Promise((resolve,reject)=&gt;{
           this.emit('running',type)
           this.once('error',reject)
           this.once('end',resolve)
       })
    }
</code></pre>
<p><code>listen</code>å…¥å‚å‚æ•°æœ‰ä¸¤ä¸ª,<code>type</code>æ˜¯ä¸»çº¿ç¨‹çš„ä¼ é€’è¿‡æ¥çš„<code>webpack</code>å‘½ä»¤ï¼Œåˆ†ä¸º<code>start</code>å’Œ<code>build</code>,<code>cwdPath</code>æ˜¯æˆ‘ä»¬è¾“å…¥ç»ˆç«¯å‘½ä»¤è¡Œçš„ç»å¯¹è·¯å¾„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„æ˜¯è¯»å–æ–°åˆ›å»ºé¡¹ç›®çš„<code>mycli.config.js</code>ã€‚ç„¶åå’Œæˆ‘ä»¬çš„<strong>é»˜è®¤é…ç½®</strong>è¿›è¡Œ<strong>åˆå¹¶</strong>æ“ä½œã€‚</p>
<h4>runMergeGetConfig</h4>
<p><strong>runMergeGetConfig</strong> å¯ä»¥æ ¹æ®æˆ‘ä»¬ä¼ é€’çš„ç¯å¢ƒ (<code>start</code> or <code>build</code>) å¾—åˆ°å¯¹åº”çš„<code>webpack</code>åŸºç¡€é…ç½®ã€‚æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹<code>runMergeGetConfig</code> åšäº†ä»€ä¹ˆã€‚</p>
<pre><code>const merge = require('webpack-merge')
module.exports = function(path){
  return type =&gt; {
    if (type==='start') {
      return merge(Appconfig(path), devConfig(path))
    } else {
      return merge(Appconfig(path), proConfig)
    }
  }
}
</code></pre>
<p><code>runMergeGetConfig</code> å¾ˆç®€å•å°±æ˜¯å°† <code>base</code>åŸºç¡€é…ç½®ï¼Œå’Œ <code>dev</code>æˆ–è€…<code>pro</code>ç¯å¢ƒè¿›è¡Œåˆå¹¶å¾—åˆ°è„šæ‰‹æ¶çš„åŸºæœ¬é…ç½®ï¼Œç„¶åå†å’Œ<code>mycli.config.js</code>æ–‡ä»¶ä¸‹çš„è‡ªå®šä¹‰é…ç½®é¡¹åˆå¹¶ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ã€‚</p>
<h4>merge</h4>
<p>æˆ‘ä»¬æ¥ç€çœ‹ <code>mycli-react-webpack-plugin</code>æ’ä»¶ä¸‹ï¼Œ<code>lib</code>æ–‡ä»¶å¤¹ä¸‹çš„<code>merge.js</code>ã€‚</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44530b901f1249beb5f37b694f4945ad~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<pre><code>const fs = require('fs')
const merge = require('webpack-merge')


/* åˆå¹¶é…ç½® */
function configMegre(Pconf,config){
   const {
      dev = Object.create(null),
      pro = Object.create(null),
      base= Object.create(null)
   } = Pconf
   if(this.type === 'start'){
     return merge(config,base,dev)
   }else{
      return merge(config,base,pro)
   }
}

/**
 * @param {*} config ç»è¿‡ runMergeGetConfig å¾—åˆ°çš„è„šæ‰‹æ¶åŸºç¡€é…ç½®
 */
function megreConfig(config){
   const targetPath = this.path + '/mycli.config.js'
   const isExi = fs.existsSync(targetPath)
   if(isExi){
     /* è·å–å¼€å‘è€…è‡ªå®šä¹‰é…ç½® */ 
      const perconfig = require(targetPath)
      /**/
      const mergeConfigResult = configMegre.call(this,perconfig,config)
      return mergeConfigResult
   }
   /* è¿”å›æœ€ç»ˆæ‰“åŒ…çš„webpacké…ç½®é¡¹ */
   return config
}

module.exports = megreConfig
</code></pre>
<p>è¿™ä¸€æ­¥å®é™…å¾ˆç®€å•ï¼Œè·å–å¼€å‘è€…çš„è‡ªå®šä¹‰é…ç½®ï¼Œç„¶åå’Œè„šæ‰‹æ¶çš„é»˜è®¤é…ç½®åˆå¹¶ï¼Œå¾—åˆ°æœ€ç»ˆçš„é…ç½®ã€‚å¹¶ä¼šè¿”å›ç»™æˆ‘ä»¬çš„<code>running</code>å®ä¾‹ã€‚</p>
<h3>â‘¢ è‡ªåŠ¨å¯åŠ¨<code>webpack</code></h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åšçš„æ˜¯å¯åŠ¨<code>webpack</code>ã€‚ç”Ÿäº§ç¯å¢ƒæ¯”è¾ƒç®€å•ï¼Œç›´æ¥ <code>webpack(config)</code>å°±å¯ä»¥äº†ã€‚åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œç”±äºéœ€è¦<code>webpack-dev-server</code>æ­å»ºèµ·æœåŠ¡å™¨ï¼Œç„¶åæŒ‚èµ·é¡¹ç›®ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬å•ç‹¬å¤„ç†ã€‚é¦–å…ˆå°†å¼€å‘ç¯å¢ƒä¸‹çš„<code>config</code>ä¼ å…¥<code>webpack</code>ä¸­å¾—åˆ°<code>compiler</code>ï¼Œç„¶åå¯åŠ¨<code>dev-server</code>æœåŠ¡ï¼Œ<code>compiler</code> ä½œä¸ºå‚æ•°ä¼ å…¥<code>webpack</code> å¹¶ç›‘å¬æˆ‘ä»¬è®¾ç½®çš„ç«¯å£ï¼Œå®Œæˆæ•´ä¸ªæµç¨‹ã€‚</p>
<pre><code>const Server = require('webpack-dev-server/lib/Server')
    const webpack = require('webpack')
    const processOptions = require('webpack-dev-server/lib/utils/processOptions')
    const yargs = require('yargs')
    /* è¿è¡Œç”Ÿäº§ç¯å¢ƒwebpack */
    build(){
        try{
            webpack(this.config,(err)=&gt;{
               if(err){
                   /* å¦‚æœå‘ç”Ÿé”™è¯¯ */
                  this.emit('error')
               }else{
                   /* ç»“æŸ */
                  this.emit('end')
               }
            })
        }catch(e){
            this.emit('error')
        }

    }
    /* è¿è¡Œå¼€å‘ç¯å¢ƒwebpack */
    start(){
        const _this = this
        processOptions(this.config,yargs.argv,(config,options)=&gt;{
            /* å¾—åˆ°webpack  compiler*/
            const compiler = webpack(config)
            /* åˆ›å»ºdev-serveræœåŠ¡ */
            const server = new Server(compiler , options )
            /* port æ˜¯åœ¨webpack.dev.jsä¸‹çš„å¼€å‘ç¯å¢ƒé…ç½®é¡¹ä¸­ è®¾ç½®çš„ç›‘å¬ç«¯å£ */
            server.listen(options.port, options.host, (err) =&gt; {
              if (err) {
                _this.emit('error')
                throw err;
              }
            })
        })
    }
</code></pre>
<h1>å›› è¿è¡Œé¡¹ç›®ï¼Œå®ç° plugin, è‡ªåŠ¨åŒ–æ”¶é›† model é˜¶æ®µ</h1>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®²çš„é¡¹ç›®è¿è¡Œé˜¶æ®µï¼Œä¸€äº›é™„åŠ çš„é…ç½®é¡¹ï¼Œå’Œä¸€èµ·å…¶ä»–çš„æ“ä½œã€‚</p>
<h2>1 å®ç°ä¸€ä¸ªç®€å•çš„ç»ˆç«¯åŠ è½½æ¡çš„ <code>plugin</code></h2>
<p>æˆ‘ä»¬å†™ä¸€ä¸ª<code>webpack</code> çš„<code>plugin</code>åšä¸º<code>mycli</code>è„šæ‰‹æ¶çš„å·¥å…·ï¼Œä¸ºäº†æ–¹ä¾¿å‘å¼€å‘è€…å±•ç¤ºä¿®æ”¹çš„æ–‡ä»¶ï¼Œå’Œä¸€æ¬¡<code>webpack</code>æ„å»ºæ—¶é—´ï¼Œæ•´ä¸ªæ’ä»¶æ˜¯åœ¨<code>webpack</code>ç¼–è¯‘é˜¶æ®µå®Œæˆçš„ã€‚æˆ‘ä»¬éœ€è¦ç®€å•äº†è§£<code>webpack</code>ä¸€äº›çŸ¥è¯†ã€‚</p>
<h3>â‘  Compiler å’Œ Compilation</h3>
<p>åœ¨å¼€å‘ <code>Plugin</code> æ—¶æœ€å¸¸ç”¨çš„ä¸¤ä¸ªå¯¹è±¡å°±æ˜¯ <code>Compiler</code> å’Œ <code>Compilation</code> ï¼Œå®ƒä»¬æ˜¯ <code>Plugin</code> å’Œ <code>Webpack</code> ä¹‹é—´çš„æ¡¥æ¢ã€‚
<code>Compiler</code> å’Œ <code>Compilation</code> çš„åŒºåˆ«åœ¨äºï¼š <code>Compiler</code> ä»£è¡¨äº†æ•´ä¸ª <code>Webpack</code> ä»å¯åŠ¨åˆ°å…³é—­çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ <code>Compilation</code> åªæ˜¯ä»£è¡¨äº†ä¸€æ¬¡æ–°çš„ç¼–è¯‘ã€‚</p>
<p><code>Compiler</code> å¯¹è±¡åŒ…å«äº† <code>Webpack</code> ç¯å¢ƒæ‰€æœ‰çš„çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å« <code>optionsï¼Œloadersï¼Œplugins</code> è¿™äº›ä¿¡æ¯ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨ <code>Webpack</code> å¯åŠ¨æ—¶å€™è¢«å®ä¾‹åŒ–ï¼Œå®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¯ä»¥ç®€å•åœ°æŠŠå®ƒç†è§£ä¸º <code>Webpack</code> å®ä¾‹ï¼›
<code>Compilation</code> å¯¹è±¡åŒ…å«äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ç­‰ã€‚
å½“ <code>Webpack</code> ä»¥å¼€å‘æ¨¡å¼è¿è¡Œæ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œä¸€æ¬¡æ–°çš„ <code>Compilation</code> å°†è¢«åˆ›å»ºã€‚ <code>Compilation</code> å¯¹è±¡ä¹Ÿæä¾›äº†å¾ˆå¤šäº‹ä»¶å›è°ƒä¾›æ’ä»¶åšæ‰©å±•ã€‚é€šè¿‡ <code>Compilation</code> ä¹Ÿèƒ½è¯»å–åˆ° <code>Compiler</code> å¯¹è±¡ã€‚</p>
<h3>â‘¡ <code>Compiler</code> ç¼–è¯‘é˜¶æ®µ</h3>
<p>æˆ‘ä»¬è¦ç†è§£ä¸€æ¬¡<code>Compiler</code>å„ä¸ªé˜¶æ®µè¦åšçš„äº‹ï¼Œæ‰èƒ½åœ¨ç‰¹å®šçš„é˜¶æ®µç”¨æŒ‡å®šçš„é’©å­æ¥å®Œæˆæˆ‘ä»¬çš„è‡ªå®šä¹‰<code>plugin</code>ã€‚</p>
<ol>
<li>
<p>run å¯åŠ¨ä¸€æ¬¡æ–°çš„ç¼–è¯‘</p>
</li>
<li>
<p>watch-run å’Œ <code>run</code> ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå®ƒæ˜¯åœ¨ç›‘å¬æ¨¡å¼ä¸‹å¯åŠ¨çš„ç¼–è¯‘ï¼Œåœ¨è¿™ä¸ªäº‹ä»¶ä¸­å¯ä»¥è·å–åˆ°æ˜¯<strong>å“ªäº›æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–</strong>å¯¼è‡´é‡æ–°å¯åŠ¨ä¸€æ¬¡æ–°çš„ç¼–è¯‘ã€‚</p>
</li>
<li>
<p>compile  è¯¥äº‹ä»¶æ˜¯ä¸ºäº†å‘Šè¯‰æ’ä»¶ä¸€æ¬¡æ–°çš„ç¼–è¯‘å°†è¦å¯åŠ¨ï¼ŒåŒæ—¶ä¼šç»™æ’ä»¶å¸¦ä¸Š <code>compiler</code> å¯¹è±¡ã€‚</p>
</li>
<li>
<p>compilation
å½“ <code>Webpack</code> ä»¥å¼€å‘æ¨¡å¼è¿è¡Œæ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œä¸€æ¬¡æ–°çš„ <code>Compilation</code> å°†è¢«åˆ›å»ºã€‚ä¸€ä¸ª <code>Compilation</code> å¯¹è±¡åŒ…å«äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ç­‰ã€‚<code>Compilation</code> å¯¹è±¡ä¹Ÿæä¾›äº†å¾ˆå¤šäº‹ä»¶å›è°ƒä¾›æ’ä»¶åšæ‰©å±•ã€‚</p>
</li>
<li>
<p>make
ä¸€ä¸ªæ–°çš„ <code>Compilation</code> åˆ›å»ºå®Œæ¯•ï¼Œå³å°†ä» <code>Entry</code> å¼€å§‹è¯»å–æ–‡ä»¶ï¼Œæ ¹æ®æ–‡ä»¶ç±»å‹å’Œé…ç½®çš„ <code>Loader</code> å¯¹æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘å®Œåå†æ‰¾å‡ºè¯¥æ–‡ä»¶ä¾èµ–çš„æ–‡ä»¶ï¼Œé€’å½’çš„ç¼–è¯‘å’Œè§£æã€‚</p>
</li>
<li>
<p>after-compile sä¸€æ¬¡ <code>Compilation</code> æ‰§è¡Œå®Œæˆã€‚</p>
</li>
<li>
<p>invalid
å½“é‡åˆ°æ–‡ä»¶ä¸å­˜åœ¨ã€æ–‡ä»¶ç¼–è¯‘é”™è¯¯ç­‰å¼‚å¸¸æ—¶ä¼šè§¦å‘è¯¥äº‹ä»¶ï¼Œè¯¥äº‹ä»¶ä¸ä¼šå¯¼è‡´ <code>Webpack</code> é€€å‡ºã€‚</p>
</li>
</ol>
<h3>â‘¢ ç¼–å†™æ’ä»¶</h3>
<p>æˆ‘ä»¬ç¼–å†™çš„<code>webpack</code>æ’ä»¶ï¼Œéœ€è¦åœ¨æ”¹åŠ¨æ—¶å€™ï¼Œæ‰“å°å‡ºå½“å‰æ”¹åŠ¨çš„æ–‡ä»¶ , å¹¶ç”¨è¿›åº¦æ¡å±•ç¤ºä¸€æ¬¡ç¼–è¯‘çš„æ—¶é—´ã€‚</p>
<pre><code>const chalk = require('chalk')
var slog = require('single-line-log');

class MycliConsolePlugin {
    
    constructor(options){
       this.options = options
    }
    apply(compiler){
        /* ç›‘å¬æ–‡ä»¶æ”¹åŠ¨ */
        compiler.hooks.watchRun.tap('MycliConsolePlugin', (watching) =&gt; {
            const changeFiles = watching.watchFileSystem.watcher.mtimes
            for(let file in changeFiles){
                console.log(chalk.green('å½“å‰æ”¹åŠ¨æ–‡ä»¶ï¼š'+ file))
            }
        })
        /* åœ¨ä¸€æ¬¡ç¼–è¯‘åˆ›å»ºä¹‹å‰ */
        compiler.hooks.compile.tap('MycliConsolePlugin',()=&gt;{
            this.beginCompile()
        })
        /* ä¸€æ¬¡ compile å®Œæˆ */
        compiler.hooks.done.tap('MycliConsolePlugin',()=&gt;{
            this.timer &amp;&amp; clearInterval( this.timer )
            console.log( chalk.yellow(' ç¼–è¯‘å®Œæˆ') )
        })
    }
    /* å¼€å§‹è®°å½•ç¼–è¯‘ */
    beginCompile(){
       const lineSlog = slog.stdout
       let text  = 'å¼€å§‹ç¼–è¯‘ï¼š'

       this.timer = setInterval(()=&gt;{
          text +=  'â–ˆ'
          lineSlog( chalk.green(text))
       },50)
    }
}
module.exports = RuxConsolePlugin
</code></pre>
<h4>ä½¿ç”¨</h4>
<p>æ’ä»¶çš„ä½¿ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿™ä¸ªæ’ä»¶æ˜¯åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨<code>webpack.dev.js</code>åŠ å…¥ä¸Šè¿°çš„<code>MycliConsolePlugin</code>æ’ä»¶ã€‚</p>
<pre><code>const webpack = require('webpack')
const MycliConsolePlugin = require('../plugins/mycli-console-pulgin')
const devConfig =(path)=&gt;{
  return  {
    devtool: 'cheap-module-eval-source-map',
    mode: 'development',
    devServer: {
      contentBase: path + '/dist',
      open: true, /* è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ */
      hot: true,
      historyApiFallback: true,
      publicPath: '/',
      port: 8888, /* æœåŠ¡å™¨ç«¯å£ */
      inline: true,
      proxy: {  /* ä»£ç†æœåŠ¡å™¨ */
      }    },
    plugins: [
      new webpack.HotModuleReplacementPlugin(),
      new MycliConsolePlugin({
        dec:1
      })
    ]
  }
}
module.exports = devConfig
</code></pre>
<h2>2 require.context å®ç°å‰ç«¯è‡ªåŠ¨åŒ–</h2>
<p>å‰ç«¯è‡ªåŠ¨åŒ–å·²ç»è„±ç¦» <code>mycli</code>èŒƒç•´äº†ï¼Œä½†æ˜¯ä¸ºäº†è®©å¤§å®¶æ˜ç™½å‰ç«¯è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿™é‡Œç”¨<code>webpack</code>æä¾›çš„<code>API</code> ä¸­çš„<code>require.context</code>ä¸ºæ¡ˆä¾‹ã€‚</p>
<h3>require.context è®²è§£</h3>
<pre><code>require.context(directory, useSubdirectories = true, regExp = /^\.\/.*$/, mode = 'sync');
</code></pre>
<p>å¯ä»¥ç»™è¿™ä¸ªå‡½æ•°ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š â‘  <code>directory</code> è¦æœç´¢çš„ç›®å½•ï¼Œ â‘¡ <code>useSubdirectories</code> æ ‡è®°è¡¨ç¤ºæ˜¯å¦è¿˜æœç´¢å…¶å­ç›®å½•ï¼Œ â‘¢ <code>regExp</code> åŒ¹é…æ–‡ä»¶çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚</p>
<p><code>webpack</code> ä¼šåœ¨æ„å»ºä¸­è§£æä»£ç ä¸­çš„ <code>require.context()</code> ã€‚</p>
<p>å®˜ç½‘ç¤ºä¾‹ï¼š</p>
<pre><code>/* ï¼ˆåˆ›å»ºå‡ºï¼‰ä¸€ä¸ª contextï¼Œå…¶ä¸­æ–‡ä»¶æ¥è‡ª test ç›®å½•ï¼Œrequest ä»¥ `.test.js` ç»“å°¾ã€‚ */
require.context('./test', false, /\.test\.js$/);

/* ï¼ˆåˆ›å»ºå‡ºï¼‰ä¸€ä¸ª contextï¼Œå…¶ä¸­æ‰€æœ‰æ–‡ä»¶éƒ½æ¥è‡ªçˆ¶æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰å­çº§æ–‡ä»¶å¤¹ï¼Œrequest ä»¥ `.stories.js` ç»“å°¾ã€‚ */
require.context('../', true, /\.stories\.js$/);

</code></pre>
<h3>å®ç°è‡ªåŠ¨åŒ–</h3>
<p>æˆ‘ä»¬æ¥ç€ç”¨<code>mycli</code>åˆ›å»ºçš„é¡¹ç›®ä½œä¸º<code>demo</code>, æˆ‘ä»¬åœ¨é¡¹ç›®<code>src</code>æ–‡ä»¶å¤¹ä¸‹é¢æ–°å»º<code>model</code>æ–‡ä»¶å¤¹ï¼Œç”¨æ¥è‡ªåŠ¨æ”¶é›†é‡Œé¢çš„æ–‡ä»¶ã€‚<code>model</code>æ–‡ä»¶ä¸‹ï¼Œæœ‰ä¸‰ä¸ªæ–‡ä»¶ <code>demo.ts</code> , <code>demo1.ts</code> ,<code>demo2.ts</code> , æˆ‘ä»¬æ¥ä¸‹æ¥åšçš„æ˜¯è‡ªåŠ¨æ”¶é›†æ–‡ä»¶ä¸‹çš„æ•°æ®ã€‚</p>
<p><strong>demo.ts</strong></p>
<pre><code>const a = 'demo'
export default a
</code></pre>
<p>Â· <strong>demo1.ts</strong></p>
<pre><code>const b = 'demo1'
export default b
</code></pre>
<p><strong>demo2.ts</strong></p>
<pre><code>const b = 'demo2'
export default b
</code></pre>
<p><strong>æ¢ç´¢ <code>require.context</code></strong></p>
<pre><code>const file  = require.context('./model',false,/\.tsx?|jsx?$/)
console.log(file)
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2806e1a51cc54088a5b5a2c32fd505f2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>æ‰“å°<code>file</code> ï¼Œæˆ‘ä»¬å‘ç°<code>webpack</code>çš„æ–¹æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è·å–æ–‡ä»¶åç»„æˆçš„æ•°ç»„ã€‚</p>
<pre><code>const file  = require.context('./model',false,/\.tsx?|jsx?$/)
console.log(file.keys())
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9aaacad35554330b51cdc9177ad7e76~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>è§£ææ¥æˆ‘ä»¬è‡ªåŠ¨æ”¶é›†æ–‡ä»¶ä¸‹çš„ a , b ,c å˜é‡ã€‚</p>
<pre><code>/* ç”¨æ¥æ”¶é›†æ–‡ä»¶ */
const model ={} 
const file  = require.context('./model',false,/\.tsx?|jsx?$/)

/* éå†æ–‡ä»¶ */
file.keys().map(item=&gt;{
    /* æ”¶é›†æ•°æ® */
    model[item] = file(item).default
})

console.log(model)
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adae9722fc234aee93e9e3f920146d07~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å®ç°äº†è‡ªåŠ¨æ”¶é›†æµç¨‹ã€‚å¦‚æœæ·±å±‚æ¬¡é€’å½’æ”¶é›†ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>require.context</code> ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º<code>true</code></p>
<pre><code>require.context('./model',true,/\.tsx?|jsx?$/)
</code></pre>
<p><strong>é¡¹ç›®ç›®å½•</strong>
model/text/demo3.ts
<strong>demo3.ts</strong></p>
<pre><code>const d = 'demo3'

export default d
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc4722b618fd402a8f01c6ba2fe773d2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p><strong>æ‰“å°å®Œç¾é€’å½’æ”¶é›†äº†å­æ–‡ä»¶ä¸‹çš„<code>model</code></strong></p>
<h1> </h1>
<h1>ä¸€å¥—è§„èŒƒçš„ Vue3.x é¡¹ç›®å·¥ç¨‹ç¯å¢ƒ</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/6951649464637636622?searchId=202307221641218C3D1D22C162116DC090">juejin.cn</a></p>
</blockquote>
<p>æœ¬æ–‡ç¯‡å¹…ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å±•å¼€ï¼š</p>
<ul>
<li>æ¶æ„æ­å»º</li>
<li>ä»£ç è§„èŒƒ</li>
<li>æäº¤è§„èŒƒ</li>
<li>å•å…ƒæµ‹è¯•</li>
<li>è‡ªåŠ¨éƒ¨ç½²</li>
</ul>
<h2>æŠ€æœ¯æ ˆ</h2>
<ul>
<li>Git Hook å·¥å…·ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Ftypicode.github.io%2Fhusky%2F%23%2F" title="https://typicode.github.io/husky/#/">husky</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fokonet%2Flint-staged" title="https://github.com/okonet/lint-staged">lint-staged</a></li>
<li>ä»£ç è§„èŒƒï¼š<a href="https://link.juejin.cn?target=http%3A%2F%2Feditorconfig.org" title="http://editorconfig.org">EditorConfig</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fprettier.io%2F" title="https://prettier.io/">Prettier</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2F" title="https://eslint.org/">ESLint</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fairbnb%2Fjavascript%23translation" title="https://github.com/airbnb/javascript#translation">Airbnb JavaScript Style Guide</a></li>
<li>æäº¤è§„èŒƒï¼š<a href="https://link.juejin.cn?target=http%3A%2F%2Fcommitizen.github.io%2Fcz-cli%2F" title="http://commitizen.github.io/cz-cli/">Commitizen</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fcommitlint.js.org%2F%23%2F" title="https://commitlint.js.org/#/">Commitlint</a></li>
<li>å•å…ƒæµ‹è¯•ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fnext.vue-test-utils.vuejs.org%2F" title="https://next.vue-test-utils.vuejs.org/">vue-test-utils</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fjestjs.io%2F" title="https://jestjs.io/">jest</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue-jest" title="https://github.com/vuejs/vue-jest">vue-jest</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fkulshekhar.github.io%2Fts-jest%2F" title="https://kulshekhar.github.io/ts-jest/">ts-jest</a></li>
<li>è‡ªåŠ¨éƒ¨ç½²ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Fcn%2Factions%2Flearn-github-actions" title="https://docs.github.com/cn/actions/learn-github-actions">GitHub Actions</a></li>
</ul>
<h2>æ¶æ„æ­å»º</h2>
<p>è¯·ç¡®ä¿ä½ çš„ç”µè„‘ä¸ŠæˆåŠŸå®‰è£… Node.jsï¼Œæœ¬é¡¹ç›®ä½¿ç”¨ Vite æ„å»ºå·¥å…·ï¼Œ<strong>éœ€è¦ Node.js ç‰ˆæœ¬ &gt;= 12.0.0</strong>ã€‚</p>
<h3>ä½¿ç”¨ Vite å¿«é€Ÿåˆå§‹åŒ–é¡¹ç›®é›å½¢</h3>
<ul>
<li>ä½¿ç”¨ NPMï¼šnpm init @vitejs/app</li>
<li>ä½¿ç”¨ Yarnï¼šyarn create @vitejs/app</li>
</ul>
<h3>ä½¿ç”¨ Vite å¿«é€Ÿåˆå§‹åŒ–é¡¹ç›®é›å½¢</h3>
<p>ç„¶åæŒ‰ç…§ç»ˆç«¯æç¤ºå®Œæˆä»¥ä¸‹æ“ä½œï¼š
2.  é€‰æ‹©æ¨¡æ¿
æœ¬é¡¹ç›®éœ€è¦ä½¿ç”¨ Vue3 + TypeScriptï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹© <code>vue-ts</code>ï¼Œä¼šè‡ªåŠ¨å®‰è£… Vue3 å’Œ TypeScriptã€‚
3.  å®‰è£…ä¾èµ– npm install
4.  å¯åŠ¨é¡¹ç›® npm run dev</p>
<hr>
<p>ä½ è¿˜å¯ä»¥é€šè¿‡é™„åŠ çš„å‘½ä»¤è¡Œé€‰é¡¹ç›´æ¥æŒ‡å®šé¡¹ç›®åå’Œæ¨¡æ¿ï¼Œæœ¬é¡¹ç›®è¦æ„å»º Vite + Vue3 + TypeScript é¡¹ç›®ï¼Œåˆ™è¿è¡Œï¼š
npm 6.x
npm init @vitejs/app vite-vue3-starter --template vue-ts</p>
<p>npm 7+ï¼ˆéœ€è¦é¢å¤–çš„åŒæ¨ªçº¿ï¼‰
npm init @vitejs/app vite-vue3-starter -- --template vue-ts
yarn
yarn create @vitejs/app vite-vue3-starter --template vue-ts</p>
<hr>
<p>Vite é…ç½®æ–‡ä»¶ <code>vite.config.ts</code> ä½äºæ ¹ç›®å½•ä¸‹ï¼Œé¡¹ç›®å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è¯»å–ã€‚</p>
<h3>ä¿®æ”¹ Vite é…ç½®æ–‡ä»¶</h3>
<p>æœ¬é¡¹ç›®å…ˆåšä¸€äº›ç®€å•é…ç½®ï¼Œä¾‹å¦‚ï¼šè®¾ç½® <code>@</code> æŒ‡å‘ <code>src</code> ç›®å½•ã€ æœåŠ¡å¯åŠ¨ç«¯å£ã€æ‰“åŒ…è·¯å¾„ã€ä»£ç†ç­‰ã€‚</p>
<pre><code>import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
// å¦‚æœç¼–è¾‘å™¨æç¤º path æ¨¡å—æ‰¾ä¸åˆ°ï¼Œåˆ™å¯ä»¥å®‰è£…ä¸€ä¸‹ @types/node -&gt; npm i @types/node -D
import { resolve } from 'path'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src') // è®¾ç½® `@` æŒ‡å‘ `src` ç›®å½•
    }
  },
  base: './', // è®¾ç½®æ‰“åŒ…è·¯å¾„
  server: {
    port: 4000, // è®¾ç½®æœåŠ¡å¯åŠ¨ç«¯å£å·
    open: true, // è®¾ç½®æœåŠ¡å¯åŠ¨æ—¶æ˜¯å¦è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    cors: true // å…è®¸è·¨åŸŸ

    // è®¾ç½®ä»£ç†ï¼Œæ ¹æ®æˆ‘ä»¬é¡¹ç›®å®é™…æƒ…å†µé…ç½®
    // proxy: {
    //   '/api': {
    //     target: 'http://xxx.xxx.xxx.xxx:8000',
    //     changeOrigin: true,
    //     secure: false,
    //     rewrite: (path) =&gt; path.replace('/api/', '/')
    //   }
    // }
  }
})

</code></pre>
<h3>è§„èŒƒç›®å½•ç»“æ„</h3>
<pre><code>â”œâ”€â”€ publish/
â””â”€â”€ src/
    â”œâ”€â”€ assets/                    // é™æ€èµ„æºç›®å½•
    â”œâ”€â”€ common/                    // é€šç”¨ç±»åº“ç›®å½•
    â”œâ”€â”€ components/                // å…¬å…±ç»„ä»¶ç›®å½•
    â”œâ”€â”€ router/                    // è·¯ç”±é…ç½®ç›®å½•
    â”œâ”€â”€ store/                     // çŠ¶æ€ç®¡ç†ç›®å½•
    â”œâ”€â”€ style/                     // é€šç”¨ CSS ç›®å½•
    â”œâ”€â”€ utils/                     // å·¥å…·å‡½æ•°ç›®å½•
    â”œâ”€â”€ views/                     // é¡µé¢ç»„ä»¶ç›®å½•
    â”œâ”€â”€ App.vue
    â”œâ”€â”€ main.ts
    â”œâ”€â”€ shims-vue.d.ts
â”œâ”€â”€ tests/                         // å•å…ƒæµ‹è¯•ç›®å½•
â”œâ”€â”€ index.html
â”œâ”€â”€ tsconfig.json                  // TypeScript é…ç½®æ–‡ä»¶
â”œâ”€â”€ vite.config.ts                 // Vite é…ç½®æ–‡ä»¶
â””â”€â”€ package.json

</code></pre>
<h3>é›†æˆè·¯ç”±å·¥å…· Vue Router</h3>
<ol>
<li>å®‰è£…æ”¯æŒ Vue3 çš„è·¯ç”±å·¥å…· vue-router@4    npm i vue-router@4</li>
<li>åˆ›å»º <code>src/router/index.ts</code> è·¯ç”±é…ç½®æ–‡ä»¶</li>
<li>åœ¨ <code>main.ts</code> æ–‡ä»¶ä¸­æŒ‚è½½è·¯ç”±é…ç½®</li>
</ol>
<hr>
<p>router/index.ts` è·¯ç”±é…ç½®æ–‡ä»¶</p>
<pre><code>import {
  createRouter,
  createWebHashHistory,
  RouteRecordRaw
} from 'vue-router'
import Home from '@/views/home.vue'
import Vuex from '@/views/vuex.vue'

const routes: Array&lt;RouteRecordRaw&gt; = [
  {
	path: '/',
	name: 'Home',
	component: Home
  },
  {
	path: '/vuex',
	name: 'Vuex',
	component: Vuex
  },
  {
	path: '/axios',
	name: 'Axios',
	component: () =&gt; import('@/views/axios.vue') // æ‡’åŠ è½½ç»„ä»¶
  }
]

const router = createRouter({
  history: createWebHashHistory(),
  routes
})

export default router

</code></pre>
<p>æ ¹æ®æœ¬é¡¹ç›®è·¯ç”±é…ç½®çš„å®é™…æƒ…å†µï¼Œä½ éœ€è¦åœ¨ <code>src</code> ä¸‹åˆ›å»º <code>views</code> ç›®å½•ï¼Œç”¨æ¥å­˜å‚¨é¡µé¢ç»„ä»¶ã€‚
æˆ‘ä»¬åœ¨ <code>views</code> ç›®å½•ä¸‹åˆ›å»º <code>home.vue</code> ã€<code>vuex.vue</code> ã€<code>axios.vue</code>ã€‚</p>
<hr>
<ol start="3">
<li>åœ¨ <code>main.ts</code> æ–‡ä»¶ä¸­æŒ‚è½½è·¯ç”±é…ç½®<pre><code>import { createApp } from 'vue'
import App from './App.vue'

import router from './router/index'

createApp(App).use(router).mount('#app')

</code></pre>
</li>
</ol>
<h3>é›†æˆçŠ¶æ€ç®¡ç†å·¥å…· Vuex</h3>
<ol>
<li>å®‰è£…æ”¯æŒ Vue3 çš„çŠ¶æ€ç®¡ç†å·¥å…· vuex@next   npm i vuex@next</li>
<li>åˆ›å»º <code>src/store/index.ts</code> æ–‡ä»¶</li>
<li>
<ol start="3">
<li>åœ¨ <code>main.ts</code> æ–‡ä»¶ä¸­æŒ‚è½½ Vuex é…ç½®</li>
</ol>
</li>
</ol>
<hr>
<p>Vuexé…ç½®æ–‡ä»¶
åœ¨ <code>src</code> ä¸‹åˆ›å»º <code>store</code> ç›®å½•ï¼Œç„¶ååœ¨ <code>store</code> ç›®å½•é‡Œæ–°å»º <code>index.ts</code> æ–‡ä»¶ï¼š</p>
<pre><code>import { createStore } from 'vuex'

const defaultState = {
  count: 0
}

// Create a new store instance.
export default createStore({
  state() {
	return defaultState
  },
  mutations: {
	increment(state: typeof defaultState) {
	  state.count++
	}
  },
  actions: {
	increment(context) {
	  context.commit('increment')
	}
  },
  getters: {
	double(state: typeof defaultState) {
	  return 2 * state.count
	}
  }
})
</code></pre>
<hr>
<ol start="2">
<li>åœ¨ <code>main.ts</code> æ–‡ä»¶ä¸­æŒ‚è½½ Vuex é…ç½®<pre><code>import { createApp } from 'vue'
import App from './App.vue'

import store from './store/index'

createApp(App).use(store).mount('#app')

</code></pre>
</li>
</ol>
<h3>é›†æˆ UI æ¡†æ¶ Element Plus</h3>
<ol>
<li>npmå®‰è£…æ”¯æŒ Vue3 çš„ UI æ¡†æ¶ Element Plus</li>
<li>åœ¨ <code>main.ts</code> æ–‡ä»¶ä¸­æŒ‚è½½ Element Plus<pre><code>import { createApp } from 'vue'
import App from './App.vue'

import ElementPlus from 'element-plus'
import 'element-plus/lib/theme-chalk/index.css'

createApp(App).use(ElementPlus).mount('#app')

</code></pre>
</li>
</ol>
<h3>é›†æˆ HTTP å·¥å…· Axios</h3>
<ol>
<li>npmå®‰è£… Axiosï¼ˆAxios è·Ÿ Vue ç‰ˆæœ¬æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œå®‰è£…æœ€æ–°å³å¯ï¼‰</li>
<li>é…ç½® Axios
ä¸ºäº†ä½¿é¡¹ç›®çš„ç›®å½•ç»“æ„åˆç†ä¸”è§„èŒƒï¼Œæˆ‘ä»¬åœ¨ <code>src</code> ä¸‹åˆ›å»º <code>utils</code> ç›®å½•æ¥å­˜å‚¨æˆ‘ä»¬å¸¸ç”¨çš„å·¥å…·å‡½æ•°ã€‚</li>
<li>ä½¿ç”¨ Axios   åœ¨éœ€è¦ä½¿ç”¨ Axios æ–‡ä»¶é‡Œï¼Œå¼•å…¥ Axios é…ç½®æ–‡ä»¶
Axios ä½œä¸º HTTP å·¥å…·ï¼Œæˆ‘ä»¬åœ¨ <code>utils</code> ç›®å½•ä¸‹åˆ›å»º <code>axios.ts</code> ä½œä¸º Axios é…ç½®æ–‡ä»¶ï¼š</li>
</ol>
<hr>
<p>axiosé…ç½®æ–‡ä»¶</p>
<pre><code>import Axios from 'axios'
import { ElMessage } from 'element-plus'

const baseURL = 'https://api.github.com'

const axios = Axios.create({
  baseURL,
  timeout: 20000 // è¯·æ±‚è¶…æ—¶ 20s
})

// å‰ç½®æ‹¦æˆªå™¨ï¼ˆå‘èµ·è¯·æ±‚ä¹‹å‰çš„æ‹¦æˆªï¼‰
axios.interceptors.request.use(
  (response) =&gt; {
	/**
	 * æ ¹æ®ä½ çš„é¡¹ç›®å®é™…æƒ…å†µæ¥å¯¹ config åšå¤„ç†
	 * è¿™é‡Œå¯¹ config ä¸åšä»»ä½•å¤„ç†ï¼Œç›´æ¥è¿”å›
	 */
	return response
  },
  (error) =&gt; {
	return Promise.reject(error)
  }
)

// åç½®æ‹¦æˆªå™¨ï¼ˆè·å–åˆ°å“åº”æ—¶çš„æ‹¦æˆªï¼‰
axios.interceptors.response.use(
  (response) =&gt; {
	/**
	 * æ ¹æ®ä½ çš„é¡¹ç›®å®é™…æƒ…å†µæ¥å¯¹ response å’Œ error åšå¤„ç†
	 * è¿™é‡Œå¯¹ response å’Œ error ä¸åšä»»ä½•å¤„ç†ï¼Œç›´æ¥è¿”å›
	 */
	return response
  },
  (error) =&gt; {
	if (error.response &amp;&amp; error.response.data) {
	  const code = error.response.status
	  const msg = error.response.data.message
	  ElMessage.error(`Code: ${code}, Message: ${msg}`)
	  console.error(`[Axios Error]`, error.response)
	} else {
	  ElMessage.error(`${error}`)
	}
	return Promise.reject(error)
  }
)

export default axios

</code></pre>
<hr>
<ol start="3">
<li>ä½¿ç”¨ Axios<br>
åœ¨éœ€è¦ä½¿ç”¨ Axios æ–‡ä»¶é‡Œï¼Œå¼•å…¥ Axios é…ç½®æ–‡ä»¶ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š<pre><code>&lt;template&gt;&lt;/template&gt;
&lt;script lang=&quot;ts&quot;&gt;
  import { defineComponent } from 'vue'
  import axios from '../utils/axios'

  export default defineComponent({
    setup() {
      axios
        .get('/users/XPoet')
        .then((res) =&gt; {
          console.log('res: ', res)
        })
        .catch((err) =&gt; {
          console.log('err: ', err)
        })
    }
  })
&lt;/script&gt;

</code></pre>
</li>
</ol>
<h3>é›†æˆ CSS é¢„ç¼–è¯‘å™¨ Stylus/Sass/Less</h3>
<p>æœ¬é¡¹ç›®ä½¿ç”¨ CSS é¢„ç¼–è¯‘å™¨ Stylusï¼Œç›´æ¥å®‰è£…ä¸ºå¼€å‘ä¾èµ–å³å¯ã€‚
Vite å†…éƒ¨å·²å¸®æˆ‘ä»¬é›†æˆäº†ç›¸å…³çš„ loaderï¼Œä¸éœ€è¦é¢å¤–é…ç½®ã€‚åŒç†ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Sass æˆ– Less ç­‰ã€‚</p>
<ol>
<li>å®‰è£…   npm i stylus -D</li>
<li>ä½¿ç”¨<pre><code>&lt;style lang=&quot;stylus&quot;&gt;
  ...
&lt;/style&gt;

</code></pre>
</li>
</ol>
<h2>ä»£ç è§„èŒƒ</h2>
<p>ä½¿ç”¨ <strong>EditorConfig + Prettier + ESLint</strong> ç»„åˆæ¥å®ç°ä»£ç è§„èŒƒåŒ–ã€‚</p>
<h3>é›†æˆ EditorConfig é…ç½®</h3>
<p>EditorConfig æœ‰åŠ©äºä¸ºä¸åŒ IDE ç¼–è¾‘å™¨ä¸Šå¤„ç†åŒä¸€é¡¹ç›®çš„å¤šä¸ªå¼€å‘äººå‘˜ç»´æŠ¤ä¸€è‡´çš„ç¼–ç é£æ ¼ã€‚
åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å¢åŠ  <code>.editorconfig</code> æ–‡ä»¶ï¼š</p>
<pre><code># Editor configuration, see http://editorconfig.org

# è¡¨ç¤ºæ˜¯æœ€é¡¶å±‚çš„ EditorConfig é…ç½®æ–‡ä»¶
root = true

[*] # è¡¨ç¤ºæ‰€æœ‰æ–‡ä»¶é€‚ç”¨
charset = utf-8 # è®¾ç½®æ–‡ä»¶å­—ç¬¦é›†ä¸º utf-8
indent_style = space # ç¼©è¿›é£æ ¼ï¼ˆtab | spaceï¼‰
indent_size = 2 # ç¼©è¿›å¤§å°
end_of_line = lf # æ§åˆ¶æ¢è¡Œç±»å‹(lf | cr | crlf)
trim_trailing_whitespace = true # å»é™¤è¡Œé¦–çš„ä»»æ„ç©ºç™½å­—ç¬¦
insert_final_newline = true # å§‹ç»ˆåœ¨æ–‡ä»¶æœ«å°¾æ’å…¥ä¸€ä¸ªæ–°è¡Œ

[*.md] # è¡¨ç¤ºä»… md æ–‡ä»¶é€‚ç”¨ä»¥ä¸‹è§„åˆ™
max_line_length = off
trim_trailing_whitespace = false

</code></pre>
<hr>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>VSCode ä½¿ç”¨ EditorConfig éœ€è¦å»æ’ä»¶å¸‚åœºä¸‹è½½æ’ä»¶ <strong>EditorConfig for VS Code</strong> ã€‚</li>
<li>JetBrains ç³»åˆ—ï¼ˆWebStormã€IntelliJ IDEA ç­‰ï¼‰åˆ™ä¸ç”¨é¢å¤–å®‰è£…æ’ä»¶ï¼Œå¯ç›´æ¥ä½¿ç”¨ EditorConfig é…ç½®ã€‚</li>
</ul>
<h3>é›†æˆ Prettier é…ç½®</h3>
<ol>
<li>å®‰è£… Prettier   npm i prettier -D</li>
<li>åˆ›å»º Prettier é…ç½®æ–‡ä»¶</li>
<li>é…ç½® <code>.prettierrc</code></li>
</ol>
<hr>
<p>Prettier æ”¯æŒå¤šç§æ ¼å¼çš„<a href="https://link.juejin.cn?target=https%3A%2F%2Fprettier.io%2Fdocs%2Fen%2Fconfiguration.html" title="https://prettier.io/docs/en/configuration.html">é…ç½®æ–‡ä»¶</a>ï¼Œæ¯”å¦‚ <code>.json</code>ã€<code>.yml</code>ã€<code>.yaml</code>ã€<code>.js</code>ç­‰ã€‚
åœ¨æœ¬é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º <code>.prettierrc</code> æ–‡ä»¶ã€‚
åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬è¿›è¡Œå¦‚ä¸‹ç®€å•é…ç½®</p>
<pre><code>{
  &quot;useTabs&quot;: false,
  &quot;tabWidth&quot;: 2,
  &quot;printWidth&quot;: 100,
  &quot;singleQuote&quot;: true,
  &quot;trailingComma&quot;: &quot;none&quot;,
  &quot;bracketSpacing&quot;: true,
  &quot;semi&quot;: false
}

</code></pre>
<hr>
<p>Prettier å®‰è£…ä¸”é…ç½®å¥½ä¹‹åï¼Œå°±èƒ½ä½¿ç”¨å‘½ä»¤æ¥æ ¼å¼åŒ–ä»£ç </p>
<pre><code># æ ¼å¼åŒ–æ‰€æœ‰æ–‡ä»¶ï¼ˆ. è¡¨ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼‰
npx prettier --write .
</code></pre>
<hr>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>VSCode ç¼–è¾‘å™¨ä½¿ç”¨ Prettier é…ç½®éœ€è¦ä¸‹è½½æ’ä»¶ <strong>Prettier - Code formatter</strong> ã€‚</li>
<li>JetBrains ç³»åˆ—ç¼–è¾‘å™¨ï¼ˆWebStormã€IntelliJ IDEA ç­‰ï¼‰åˆ™ä¸ç”¨é¢å¤–å®‰è£…æ’ä»¶ï¼Œå¯ç›´æ¥ä½¿ç”¨ Prettier é…ç½®ã€‚</li>
</ul>
<hr>
<p>Prettier æ˜¯ä¸€æ¬¾å¼ºå¤§çš„ä»£ç æ ¼å¼åŒ–å·¥å…·ï¼ŒåŸºæœ¬ä¸Šå‰ç«¯èƒ½ç”¨åˆ°çš„æ–‡ä»¶æ ¼å¼å®ƒéƒ½å¯ä»¥æå®šï¼Œ
Prettier é…ç½®å¥½ä»¥åï¼Œåœ¨ä½¿ç”¨ VSCode æˆ– WebStorm ç­‰ç¼–è¾‘å™¨çš„æ ¼å¼åŒ–åŠŸèƒ½æ—¶ï¼Œç¼–è¾‘å™¨å°±ä¼šæŒ‰ç…§ Prettier é…ç½®æ–‡ä»¶çš„è§„åˆ™æ¥è¿›è¡Œæ ¼å¼åŒ–ï¼Œé¿å…äº†å› ä¸ºå¤§å®¶ç¼–è¾‘å™¨é…ç½®ä¸ä¸€æ ·è€Œå¯¼è‡´æ ¼å¼åŒ–åçš„ä»£ç é£æ ¼ä¸ç»Ÿä¸€çš„é—®é¢˜ã€‚</p>
<h3>é›†æˆ ESLint é…ç½®</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Feslint%2Feslint" title="https://github.com/eslint/eslint">ESLint</a> æ˜¯ä¸€æ¬¾ç”¨äºæŸ¥æ‰¾å¹¶æŠ¥å‘Šä»£ç ä¸­é—®é¢˜çš„å·¥å…·ï¼Œå¹¶ä¸”æ”¯æŒéƒ¨åˆ†é—®é¢˜è‡ªåŠ¨ä¿®å¤ã€‚
å¦‚æœå‘ç°é”™è¯¯ï¼Œå°±ç»™å‡ºè§„åˆ™æç¤ºï¼Œå¹¶ä¸”è‡ªåŠ¨ä¿®å¤ï¼Œ
å…¶æ ¸å¿ƒæ˜¯é€šè¿‡å¯¹ä»£ç è§£æå¾—åˆ°çš„ ASTï¼ˆAbstract Syntax Tree æŠ½è±¡è¯­æ³•æ ‘ï¼‰è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼Œæ¥åˆ†æä»£ç è¾¾åˆ°æ£€æŸ¥ä»£ç è´¨é‡å’Œé£æ ¼é—®é¢˜çš„èƒ½åŠ›ã€‚</p>
<ol>
<li>å®‰è£… ESLint    npm i eslint -D</li>
<li>é…ç½® ESLint</li>
<li>ESLint é…ç½®æ–‡ä»¶ <code>.eslintrc.js</code></li>
</ol>
<hr>
<p>ESLint å®‰è£…æˆåŠŸåï¼Œæ‰§è¡Œ <code>npx eslint --init</code>ï¼Œç„¶åæŒ‰ç…§ç»ˆç«¯æ“ä½œæç¤ºå®Œæˆä¸€ç³»åˆ—è®¾ç½®æ¥åˆ›å»ºé…ç½®æ–‡ä»¶ã€‚
*   How would you like to use ESLint? ï¼ˆä½ æƒ³å¦‚ä½•ä½¿ç”¨ ESLint?ï¼‰<br>
æˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>To check syntax, find problems, and enforce code styleï¼ˆæ£€æŸ¥è¯­æ³•ã€å‘ç°é—®é¢˜å¹¶å¼ºåˆ¶æ‰§è¡Œä»£ç é£æ ¼ï¼‰</strong>
*   What type of modules does your project use?ï¼ˆä½ çš„é¡¹ç›®ä½¿ç”¨å“ªç§ç±»å‹çš„æ¨¡å—?ï¼‰
æˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>JavaScript modules (import/export)</strong>
*   Which framework does your project use? ï¼ˆä½ çš„é¡¹ç›®ä½¿ç”¨å“ªç§æ¡†æ¶?ï¼‰
æˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>Vue.js</strong>
*   Does your project use TypeScript?ï¼ˆä½ çš„é¡¹ç›®æ˜¯å¦ä½¿ç”¨ TypeScriptï¼Ÿï¼‰
æˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>Yes</strong>
*   Where does your code run?ï¼ˆä½ çš„ä»£ç åœ¨å“ªé‡Œè¿è¡Œ?ï¼‰
æˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>Browser å’Œ Node</strong>ï¼ˆæŒ‰ç©ºæ ¼é”®è¿›è¡Œé€‰æ‹©ï¼Œé€‰å®ŒæŒ‰å›è½¦é”®ç¡®å®šï¼‰
*   How would you like to define a style for your project?ï¼ˆä½ æƒ³æ€æ ·ä¸ºä½ çš„é¡¹ç›®å®šä¹‰é£æ ¼ï¼Ÿï¼‰
æˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>Use a popular style guideï¼ˆä½¿ç”¨ä¸€ç§æµè¡Œçš„é£æ ¼æŒ‡å—ï¼‰</strong>
*   Which style guide do you want to follow?ï¼ˆä½ æƒ³éµå¾ªå“ªä¸€ç§é£æ ¼æŒ‡å—?ï¼‰
ESLint ä¸ºæˆ‘ä»¬åˆ—å‡ºäº†ä¸‰ç§ç¤¾åŒºæµè¡Œçš„ JavaScript é£æ ¼æŒ‡å—ï¼Œåˆ†åˆ«æ˜¯ Airbnbã€Standardã€Googleã€‚**è¿™é‡Œä½œè€…ä¸å»ºè®®å¤§å®¶å»è‡ªç”±é…ç½® ESLint è§„åˆ™ï¼Œ
*   What format do you want your config file to be in?ï¼ˆä½ å¸Œæœ›ä½ çš„é…ç½®æ–‡ä»¶æ˜¯ä»€ä¹ˆæ ¼å¼?ï¼‰
æˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>JavaScript</strong>
*   Would you like to install them now with npm?ï¼ˆä½ æƒ³ç°åœ¨å°±ç”¨ NPM å®‰è£…å®ƒä»¬å—?ï¼‰
æ ¹æ®ä¸Šé¢çš„é€‰æ‹©ï¼ŒESLint ä¼šè‡ªåŠ¨å»æŸ¥æ‰¾ç¼ºå¤±çš„ä¾èµ–ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹© <strong>Yes</strong>ï¼Œä½¿ç”¨ NPM ä¸‹è½½å®‰è£…è¿™äº›ä¾èµ–åŒ…ã€‚
æ³¨æ„ï¼šå¦‚æœè‡ªåŠ¨å®‰è£…ä¾èµ–å¤±è´¥ï¼Œé‚£ä¹ˆéœ€è¦æ‰‹åŠ¨å®‰è£…
npm i @typescript-eslint/eslint-plugin @typescript-eslint/parser eslint-config-airbnb-base eslint-plugin-import eslint-plugin-vue -D</p>
<hr>
<p>åœ¨é…ç½®æ“ä½œå®Œæˆåï¼Œä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è‡ªåŠ¨ç”Ÿæˆ <code>.eslintrc.js</code> é…ç½®æ–‡ä»¶ï¼š</p>
<pre><code>module.exports = {
  env: {
	browser: true,
	es2021: true,
	node: true
  },
  extends: ['plugin:vue/essential', 'airbnb-base'],
  parserOptions: {
	ecmaVersion: 12,
	parser: '@typescript-eslint/parser',
	sourceType: 'module'
  },
  plugins: ['vue', '@typescript-eslint'],
  rules: {}
}

</code></pre>
<p>æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µï¼Œå¦‚æœæˆ‘ä»¬æœ‰é¢å¤–çš„ ESLint è§„åˆ™ï¼Œä¹Ÿåœ¨æ­¤æ–‡ä»¶ä¸­è¿½åŠ ã€‚</p>
<hr>
<ul>
<li>VSCode ä½¿ç”¨ ESLint é…ç½®æ–‡ä»¶éœ€è¦å»æ’ä»¶å¸‚åœºä¸‹è½½æ’ä»¶ <strong>ESLint</strong> ã€‚</li>
<li>JetBrains ç³»åˆ—ï¼ˆWebStormã€IntelliJ IDEA ç­‰ï¼‰åˆ™ä¸ç”¨é¢å¤–å®‰è£…æ’ä»¶ã€‚</li>
</ul>
<hr>
<p>é…ç½®å¥½ä»¥åï¼Œæˆ‘ä»¬åœ¨ VSCode æˆ– WebStorm ç­‰ç¼–è¾‘å™¨ä¸­å¼€å¯ ESLinï¼Œå†™ä»£ç æ—¶ï¼ŒESLint å°±ä¼šæŒ‰ç…§æˆ‘ä»¬é…ç½®çš„è§„åˆ™æ¥è¿›è¡Œå®æ—¶ä»£ç æ£€æŸ¥ï¼Œå‘ç°é—®é¢˜ä¼šç»™å‡ºå¯¹åº”é”™è¯¯æç¤ºå’Œä¿®å¤æ–¹æ¡ˆã€‚
è™½ç„¶ï¼Œç°åœ¨ç¼–è¾‘å™¨å·²ç»ç»™å‡ºé”™è¯¯æç¤ºå’Œä¿®å¤æ–¹æ¡ˆï¼Œä½†éœ€è¦æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªå»ç‚¹å‡»ä¿®å¤ï¼Œ</p>
<p>æˆ‘ä»¬åªéœ€è®¾ç½®ç¼–è¾‘å™¨ä¿å­˜æ–‡ä»¶æ—¶è‡ªåŠ¨æ‰§è¡Œ <code>eslint --fix</code> å‘½ä»¤è¿›è¡Œä»£ç é£æ ¼ä¿®å¤ã€‚</p>
<ul>
<li>VSCode åœ¨ <code>settings.json</code> è®¾ç½®æ–‡ä»¶ä¸­ï¼Œå¢åŠ ä»¥ä¸‹ä»£ç ï¼š<pre><code>&quot;editor.codeActionsOnSave&quot;: {
    &quot;source.fixAll.eslint&quot;: true
 }

</code></pre>
</li>
</ul>
<h3>è§£å†³ Prettier å’Œ ESLint çš„å†²çª</h3>
<p>å†²çª:: ä¼šå‡ºç°ç”¨ Prettier æ ¼å¼åŒ–åçš„ä»£ç ï¼ŒESLint æ£€æµ‹åˆ°æ ¼å¼æœ‰é—®é¢˜çš„ï¼Œä»è€ŒæŠ›å‡ºé”™è¯¯æç¤ºã€‚</p>
<p>è§£å†³ä¸¤è€…å†²çªé—®é¢˜ï¼Œéœ€è¦ç”¨åˆ° <strong>eslint-plugin-prettier</strong> å’Œ <strong>eslint-config-prettier</strong>ã€‚</p>
<ul>
<li><code>eslint-plugin-prettier</code> å°† Prettier çš„è§„åˆ™è®¾ç½®åˆ° ESLint çš„è§„åˆ™ä¸­ã€‚</li>
<li><code>eslint-config-prettier</code> å…³é—­ ESLint ä¸­ä¸ Prettier ä¸­ä¼šå‘ç”Ÿå†²çªçš„è§„åˆ™ã€‚
æœ€åå½¢æˆä¼˜å…ˆçº§ï¼š<code>Prettier é…ç½®è§„åˆ™</code> &gt; <code>ESLint é…ç½®è§„åˆ™</code>ã€‚
è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œ <code>eslint --fix</code> å‘½ä»¤æ—¶ï¼ŒESLint å°±ä¼šæŒ‰ç…§ Prettier çš„é…ç½®è§„åˆ™æ¥æ ¼å¼åŒ–ä»£ç ï¼Œè½»æ¾è§£å†³äºŒè€…å†²çªé—®é¢˜ã€‚</li>
</ul>
<hr>
<ul>
<li>å®‰è£…æ’ä»¶  npm i eslint-plugin-prettier eslint-config-prettier -D</li>
<li>åœ¨ <code>.eslintrc.js</code> æ·»åŠ  prettier æ’ä»¶<pre><code>module.exports = {
  ...
  extends: [
    'plugin:vue/essential',
    'airbnb-base',
    'plugin:prettier/recommended' // æ·»åŠ  prettier æ’ä»¶
  ],
  ...
}

</code></pre>
</li>
</ul>
<h3>é›†æˆ husky å’Œ lint-staged</h3>
<p>æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å·²é›†æˆ ESLint å’Œ Prettierï¼Œä½†å›¢é˜Ÿå¯èƒ½ä¼šæœ‰äº›äººè§‰å¾—è¿™äº›æ¡æ¡æ¡†æ¡†çš„é™åˆ¶å¾ˆéº»çƒ¦ï¼Œé€‰æ‹©è§† â€œæç¤ºâ€ è€Œä¸è§
æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åšä¸€äº›é™åˆ¶ï¼Œè®©æ²¡é€šè¿‡ ESLint æ£€æµ‹å’Œä¿®å¤çš„ä»£ç ç¦æ­¢æäº¤ï¼Œä»è€Œä¿è¯ä»“åº“ä»£ç éƒ½æ˜¯ç¬¦åˆè§„èŒƒçš„ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° Git Hookï¼Œåœ¨æœ¬åœ°æ‰§è¡Œ <code>git commit</code> çš„æ—¶å€™ï¼Œå°±å¯¹æ‰€æäº¤çš„ä»£ç è¿›è¡Œ ESLint æ£€æµ‹å’Œä¿®å¤ï¼ˆå³æ‰§è¡Œ <code>eslint --fix</code>ï¼‰ï¼Œå¦‚æœè¿™äº›ä»£ç æ²¡é€šè¿‡ ESLint è§„åˆ™æ ¡éªŒï¼Œåˆ™ç¦æ­¢æäº¤ã€‚</p>
<p>å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œæˆ‘ä»¬å€ŸåŠ© <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftypicode%2Fhusky" title="https://github.com/typicode/husky">husky</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fokonet%2Flint-staged" title="https://github.com/okonet/lint-staged">lint-staged</a> ã€‚</p>
<hr>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftypicode%2Fhusky" title="https://github.com/typicode/husky">husky</a> â€”â€” Git Hook å·¥å…·ï¼Œå¯ä»¥è®¾ç½®åœ¨ git å„ä¸ªé˜¶æ®µï¼ˆ<code>pre-commit</code>ã€<code>commit-msg</code>ã€<code>pre-push</code> ç­‰ï¼‰è§¦å‘æˆ‘ä»¬çš„å‘½ä»¤ã€‚<br>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fokonet%2Flint-staged" title="https://github.com/okonet/lint-staged">lint-staged</a> â€”â€” åœ¨ git æš‚å­˜çš„æ–‡ä»¶ä¸Šè¿è¡Œ lintersã€‚</p>
<h4>é…ç½® husky</h4>
<ul>
<li>è‡ªåŠ¨é…ç½®ï¼ˆæ¨èï¼‰
ä½¿ç”¨ <code>husky-init</code> å‘½ä»¤å¿«é€Ÿåœ¨é¡¹ç›®åˆå§‹åŒ–ä¸€ä¸ª husky é…ç½®ã€‚</li>
</ul>
<pre><code>npx husky-init &amp;&amp; npm install
</code></pre>
<p>è¿™è¡Œå‘½ä»¤åšäº†å››ä»¶äº‹ï¼š</p>
<ol>
<li>å®‰è£… husky åˆ°å¼€å‘ä¾èµ–</li>
<li>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º <code>.husky</code> ç›®å½•</li>
<li>åœ¨ <code>.husky</code> ç›®å½•åˆ›å»º <code>pre-commit</code> hookï¼Œå¹¶åˆå§‹åŒ– <code>pre-commit</code> å‘½ä»¤ä¸º <code>npm test</code></li>
<li>ä¿®æ”¹ <code>package.json</code> çš„ <code>scripts</code>ï¼Œå¢åŠ  <code>&quot;prepare&quot;: &quot;husky install&quot;</code></li>
</ol>
<hr>
<p>ç°åœ¨æˆ‘ä»¬æ¥ä½¿ç”¨huskyï¼š
husky åŒ…å«å¾ˆå¤š <code>hook</code>ï¼ˆé’©å­ï¼‰ï¼Œå¸¸ç”¨æœ‰ï¼š<code>pre-commit</code>ã€<code>commit-msg</code>ã€<code>pre-push</code>ã€‚
è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>pre-commit</code> æ¥è§¦å‘ ESLint å‘½ä»¤ã€‚ä¿®æ”¹ <code>.husky/pre-commit</code> hook æ–‡ä»¶çš„è§¦å‘å‘½ä»¤</p>
<hr>
<pre><code>eslint --fix ./src --ext .vue,.js,.ts
</code></pre>
<p>ä¸Šé¢è¿™ä¸ª <code>pre-commit</code> hook æ–‡ä»¶çš„ä½œç”¨æ˜¯ï¼šå½“æˆ‘ä»¬æ‰§è¡Œ <code>git commit -m &quot;xxx&quot;</code> æ—¶ï¼Œä¼šå…ˆå¯¹ <code>src</code> ç›®å½•ä¸‹æ‰€æœ‰çš„ <code>.vue</code>ã€<code>.js</code>ã€<code>.ts</code> æ–‡ä»¶æ‰§è¡Œ <code>eslint --fix</code> å‘½ä»¤ï¼Œå¦‚æœ ESLint é€šè¿‡ï¼ŒæˆåŠŸ <code>commit</code>ï¼Œå¦åˆ™ç»ˆæ­¢ <code>commit</code>ã€‚</p>
<hr>
<p>æœ‰æ—¶å€™æˆ‘ä»¬æ˜æ˜åªæ”¹åŠ¨äº†ä¸€ä¸¤ä¸ªæ–‡ä»¶ï¼Œå´è¦å¯¹æ‰€æœ‰çš„æ–‡ä»¶æ‰§è¡Œ <code>eslint --fix</code>ã€‚
å‡å¦‚è¿™æ˜¯ä¸€ä¸ªå†å²é¡¹ç›®ï¼Œæˆ‘ä»¬åœ¨ä¸­é€”é…ç½®äº† ESLint è§„åˆ™ï¼Œé‚£ä¹ˆåœ¨æäº¤ä»£ç æ—¶ï¼Œä¹Ÿä¼šå¯¹å…¶ä»–æœªä¿®æ”¹çš„ â€œå†å²â€ æ–‡ä»¶éƒ½è¿›è¡Œæ£€æŸ¥ï¼Œå¯èƒ½ä¼šé€ æˆå¤§é‡æ–‡ä»¶å‡ºç° ESLint é”™è¯¯</p>
<p>å¯ä»¥ç”¨ lint-staged å¸®åŠ©æˆ‘ä»¬ï¼Œlint-staged è¿™ä¸ªå·¥å…·ä¸€èˆ¬ç»“åˆ husky æ¥ä½¿ç”¨ï¼Œå®ƒå¯ä»¥è®© husky çš„ <code>hook</code> è§¦å‘çš„å‘½ä»¤åªä½œç”¨äº <code>git add</code>é‚£äº›æ–‡ä»¶ï¼ˆå³ git æš‚å­˜åŒºçš„æ–‡ä»¶ï¼‰ï¼Œè€Œä¸ä¼šå½±å“åˆ°å…¶ä»–æ–‡ä»¶ã€‚</p>
<h4>é…ç½® lint-staged</h4>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ lint-staged ç»§ç»­ä¼˜åŒ–é¡¹ç›®ã€‚</p>
<ol>
<li>å®‰è£… lint-staged      npm i lint-staged -D</li>
<li>åœ¨ <code>package.json</code>é‡Œå¢åŠ  lint-staged é…ç½®é¡¹</li>
<li>ä¿®æ”¹ <code>.husky/pre-commit</code> hook çš„è§¦å‘å‘½ä»¤ä¸ºï¼š<code>npx lint-staged</code></li>
</ol>
<hr>
<p>åœ¨ <code>package.json</code>é‡Œå¢åŠ  lint-staged é…ç½®é¡¹</p>
<pre><code>&quot;lint-staged&quot;: {
&quot;*.{vue,js,ts}&quot;: &quot;eslint --fix&quot;
},
</code></pre>
<p>è¿™è¡Œå‘½ä»¤è¡¨ç¤ºï¼šåªå¯¹ git æš‚å­˜åŒºçš„ <code>.vue</code>ã€<code>.js</code>ã€<code>.ts</code> æ–‡ä»¶æ‰§è¡Œ <code>eslint --fix</code>ã€‚</p>
<hr>
<p>è‡³æ­¤ï¼Œhusky å’Œ lint-staged ç»„åˆé…ç½®å®Œæˆã€‚ç°åœ¨æˆ‘ä»¬æäº¤ä»£ç æ—¶å°±ä¼šå˜æˆè¿™æ ·ï¼š</p>
<p>å‡å¦‚æˆ‘ä»¬ä¿®æ”¹äº† <code>scr</code> ç›®å½•ä¸‹çš„ <code>test-1.js</code>ã€<code>test-2.ts</code> å’Œ <code>test-3.md</code> æ–‡ä»¶ï¼Œç„¶å <code>git add ./src/</code>ï¼Œæœ€å <code>git commit -m &quot;test...&quot;</code>ï¼Œè¿™æ—¶å€™å°±ä¼šåªå¯¹ <code>test-1.js</code>ã€<code>test-2.ts</code> è¿™ä¸¤ä¸ªæ–‡ä»¶æ‰§è¡Œ <code>eslint --fix</code>ã€‚å¦‚æœ ESLint é€šè¿‡ï¼ŒæˆåŠŸæäº¤ï¼Œå¦åˆ™ç»ˆæ­¢æäº¤ã€‚ä»è€Œä¿è¯äº†æˆ‘ä»¬æäº¤åˆ° Git ä»“åº“çš„ä»£ç éƒ½æ˜¯è§„èŒƒçš„ã€‚</p>
<h2>æäº¤è§„èŒƒ</h2>
<p>åœ¨æäº¤ä»£ç è¿™ä¸ªç¯èŠ‚ï¼Œä¹Ÿå­˜åœ¨ä¸€ç§æƒ…å†µï¼šä¸èƒ½ä¿è¯æ¯ä¸ªäººå¯¹æäº¤ä¿¡æ¯çš„å‡†ç¡®æè¿°
å¦‚æœ <code>git commit</code> çš„æè¿°ä¿¡æ¯ç²¾å‡†ï¼Œåœ¨åæœŸç»´æŠ¤å’Œ Bug å¤„ç†æ—¶ä¼šå˜å¾—æœ‰æ®å¯æŸ¥ï¼Œé¡¹ç›®å¼€å‘å‘¨æœŸå†…è¿˜å¯ä»¥æ ¹æ®è§„èŒƒçš„æäº¤ä¿¡æ¯å¿«é€Ÿç”Ÿæˆå¼€å‘æ—¥å¿—ï¼Œä»è€Œæ–¹ä¾¿æˆ‘ä»¬è¿½è¸ªé¡¹ç›®å’ŒæŠŠæ§è¿›åº¦ã€‚</p>
<h3>Angular çš„commit message æ ¼å¼è§„èŒƒ</h3>
<p>commit message ç”± Headerã€Bodyã€Footer ç»„æˆã€‚</p>
<pre><code>&lt;Header&gt;
&lt;Body&gt;
&lt;Footer&gt;
</code></pre>
<h4>Header</h4>
<p>Header éƒ¨åˆ†åŒ…æ‹¬ä¸‰ä¸ªå­—æ®µ typeï¼ˆå¿…éœ€ï¼‰ã€scopeï¼ˆå¯é€‰ï¼‰å’Œ subjectï¼ˆå¿…éœ€ï¼‰ã€‚</p>
<pre><code>&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;
</code></pre>
<h5>type</h5>
<p>type ç”¨äºè¯´æ˜ commit çš„æäº¤ç±»å‹ï¼ˆå¿…é¡»æ˜¯ä»¥ä¸‹å‡ ç§ä¹‹ä¸€ï¼‰ã€‚</p>
<table><thead><tr><th align="left">å€¼</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">feat</td><td align="left">æ–°å¢ä¸€ä¸ªåŠŸèƒ½</td></tr><tr><td align="left">fix</td><td align="left">ä¿®å¤ä¸€ä¸ª Bug</td></tr><tr><td align="left">docs</td><td align="left">æ–‡æ¡£å˜æ›´</td></tr><tr><td align="left">style</td><td align="left">ä»£ç æ ¼å¼ï¼ˆä¸å½±å“åŠŸèƒ½ï¼Œä¾‹å¦‚ç©ºæ ¼ã€åˆ†å·ç­‰æ ¼å¼ä¿®æ­£ï¼‰</td></tr><tr><td align="left">refactor</td><td align="left">ä»£ç é‡æ„</td></tr><tr><td align="left">perf</td><td align="left">æ”¹å–„æ€§èƒ½</td></tr><tr><td align="left">test</td><td align="left">æµ‹è¯•</td></tr><tr><td align="left">build</td><td align="left">å˜æ›´é¡¹ç›®æ„å»ºæˆ–å¤–éƒ¨ä¾èµ–ï¼ˆä¾‹å¦‚ scopes: webpackã€gulpã€npm ç­‰ï¼‰</td></tr><tr><td align="left">ci</td><td align="left">æ›´æ”¹æŒç»­é›†æˆè½¯ä»¶çš„é…ç½®æ–‡ä»¶å’Œ package ä¸­çš„ scripts å‘½ä»¤ï¼Œä¾‹å¦‚ scopes: Travis, Circle ç­‰</td></tr><tr><td align="left">chore</td><td align="left">å˜æ›´æ„å»ºæµç¨‹æˆ–è¾…åŠ©å·¥å…·</td></tr><tr><td align="left">revert</td><td align="left">ä»£ç å›é€€</td></tr></tbody></table>
<h5>scope</h5>
<p>scope ç”¨äºæŒ‡å®šæœ¬æ¬¡ commit å½±å“çš„èŒƒå›´ã€‚scope ä¾æ®é¡¹ç›®è€Œå®šï¼Œä¾‹å¦‚åœ¨ä¸šåŠ¡é¡¹ç›®ä¸­å¯ä»¥ä¾æ®èœå•æˆ–è€…åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼Œå¦‚æœæ˜¯ç»„ä»¶åº“å¼€å‘ï¼Œåˆ™å¯ä»¥ä¾æ®ç»„ä»¶åˆ’åˆ†ã€‚ï¼ˆscope å¯çœç•¥ï¼‰</p>
<h5>subject</h5>
<p>subject æ˜¯æœ¬æ¬¡ commit çš„ç®€æ´æè¿°ï¼Œé•¿åº¦çº¦å®šåœ¨ 50 ä¸ªå­—ç¬¦ä»¥å†…ï¼Œé€šå¸¸éµå¾ªä»¥ä¸‹å‡ ä¸ªè§„èŒƒï¼š</p>
<ul>
<li>ç”¨åŠ¨è¯å¼€å¤´ï¼Œç¬¬ä¸€äººç§°ç°åœ¨æ—¶è¡¨è¿°ï¼Œä¾‹å¦‚ï¼šchange ä»£æ›¿ changed æˆ– changes</li>
<li>ç¬¬ä¸€ä¸ªå­—æ¯å°å†™</li>
<li>ç»“å°¾ä¸åŠ å¥å·ï¼ˆ.ï¼‰</li>
</ul>
<h4>Body</h4>
<p>body æ˜¯å¯¹æœ¬æ¬¡ commit çš„è¯¦ç»†æè¿°ï¼Œå¯ä»¥åˆ†æˆå¤šè¡Œã€‚ï¼ˆbody å¯çœç•¥ï¼‰
è·Ÿ subject ç±»ä¼¼ï¼Œç”¨åŠ¨è¯å¼€å¤´ï¼Œbody åº”è¯¥è¯´æ˜ä¿®æ”¹çš„åŸå› å’Œæ›´æ”¹å‰åçš„è¡Œä¸ºå¯¹æ¯”ã€‚</p>
<h4>Footer</h4>
<p>å¦‚æœæœ¬æ¬¡æäº¤çš„ä»£ç æ˜¯çªç ´æ€§çš„å˜æ›´æˆ–å…³é—­ç¼ºé™·ï¼Œåˆ™ Footer å¿…éœ€ï¼Œå¦åˆ™å¯ä»¥çœç•¥ã€‚</p>
<ul>
<li>çªç ´æ€§çš„å˜æ›´
å½“å‰ä»£ç ä¸ä¸Šä¸€ä¸ªç‰ˆæœ¬æœ‰çªç ´æ€§æ”¹å˜ï¼Œåˆ™ Footer ä»¥ BREAKING CHANGE å¼€å¤´ï¼Œåé¢æ˜¯å¯¹å˜åŠ¨çš„æè¿°ã€ä»¥åŠå˜åŠ¨çš„ç†ç”±ã€‚</li>
<li>å…³é—­ç¼ºé™·
å¦‚æœå½“å‰æäº¤æ˜¯é’ˆå¯¹ç‰¹å®šçš„ issueï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ Footer éƒ¨åˆ†å¡«å†™éœ€è¦å…³é—­çš„å•ä¸ª issue æˆ–ä¸€ç³»åˆ— issuesã€‚</li>
</ul>
<h4>å‚è€ƒä¾‹å­</h4>
<ul>
<li>
<p>fix</p>
<pre><code>fix(compile): couple of unit tests for IE9

Older IEs serialize html uppercased, but IE9 does not...
Would be better to expect case insensitive, unfortunately jasmine does
not allow to user regexps for throw expectations.

Closes #392
Breaks foo.bar api, foo.baz should be used instead

</code></pre>
</li>
</ul>
<h3>é›†æˆ Commitizen å®ç°è§„èŒƒæäº¤</h3>
<p>æˆ‘ä»¬ä½¿ç”¨ Commitizen å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆ commit message æ ¼å¼ï¼Œä»è€Œå®ç°è§„èŒƒæäº¤ã€‚
Commitizen æ˜¯ä¸€ä¸ªå¸®åŠ©æ’°å†™è§„èŒƒ commit message çš„å·¥å…·ã€‚å®ƒæœ‰ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…· cz-cliã€‚</p>
<ul>
<li>å®‰è£… Commitizen npm install commitizen -D</li>
</ul>
<h4>åˆå§‹åŒ–é¡¹ç›®</h4>
<p>æˆåŠŸå®‰è£… Commitizen åï¼Œæˆ‘ä»¬ç”¨ <strong>cz-conventional-changelog</strong> é€‚é…å™¨æ¥åˆå§‹åŒ–é¡¹ç›®ï¼š</p>
<pre><code>npx commitizen init cz-conventional-changelog --save-dev --save-exact
</code></pre>
<p>è¿™è¡Œå‘½ä»¤åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>å®‰è£… cz-conventional-changelog åˆ°å¼€å‘ä¾èµ–ï¼ˆdevDependenciesï¼‰</li>
<li>åœ¨ <code>package.json</code> ä¸­å¢åŠ äº† <code>config.commitizen</code><pre><code>&quot;config&quot;: {
  &quot;commitizen&quot;: {
    &quot;path&quot;: &quot;./node_modules/cz-conventional-changelog&quot;
  }
}

</code></pre>
</li>
</ul>
<h4>ä½¿ç”¨ Commitizen</h4>
<p>ä»¥å‰æˆ‘ä»¬æäº¤ä»£ç éƒ½æ˜¯ <code>git commit -m &quot;xxx&quot;</code>ï¼Œç°åœ¨æ”¹ä¸º <code>git cz</code>ï¼Œç„¶åæŒ‰ç…§ç»ˆç«¯æ“ä½œæç¤ºï¼Œé€æ­¥å¡«å…¥ä¿¡æ¯ï¼Œå°±èƒ½è‡ªåŠ¨ç”Ÿæˆè§„èŒƒçš„ commit messageã€‚</p>
<h4>è‡ªå®šä¹‰é…ç½®æäº¤è¯´æ˜</h4>
<p><code>git cz</code> ç»ˆç«¯æ“ä½œæç¤ºéƒ½æ˜¯è‹±æ–‡çš„ï¼Œå¦‚æœæƒ³æ”¹æˆä¸­æ–‡çš„æˆ–è€…è‡ªå®šä¹‰è¿™äº›é…ç½®é€‰é¡¹ï¼Œæˆ‘ä»¬ä½¿ç”¨ <strong>cz-customizable</strong> é€‚é…å™¨ã€‚</p>
<h5>cz-customizable åˆå§‹åŒ–é¡¹ç›®</h5>
<p>è¿è¡Œå¦‚ä¸‹å‘½ä»¤ä½¿ç”¨ cz-customizable åˆå§‹åŒ–é¡¹ç›®ï¼Œæ³¨æ„ä¹‹å‰å·²ç»åˆå§‹åŒ–è¿‡ä¸€æ¬¡ï¼Œè¿™æ¬¡å†åˆå§‹åŒ–ï¼Œéœ€è¦åŠ  <code>--force</code> è¦†ç›–ã€‚</p>
<pre><code>npx commitizen init cz-customizable --save-dev --save-exact --force
</code></pre>
<p>è¿™è¡Œå‘½ä»¤åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>
<p>å®‰è£… cz-customizable åˆ°å¼€å‘ä¾èµ–ï¼ˆdevDependenciesï¼‰</p>
<pre><code>&quot;devDependencies&quot;: {
  ...
  &quot;cz-customizable&quot;: &quot;^6.3.0&quot;,
  ...
},

</code></pre>
</li>
<li>
<p>ä¿®æ”¹ <code>package.json</code> ä¸­çš„ <code>config.commitizen</code> å­—æ®µä¸ºï¼š</p>
<pre><code>&quot;config&quot;: {
  &quot;commitizen&quot;: {
    &quot;path&quot;: &quot;./node_modules/cz-customizable&quot;
  }
}

</code></pre>
</li>
</ul>
<h5>ä½¿ç”¨ cz-customizable</h5>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º <code>.cz-config.js</code> æ–‡ä»¶ï¼Œç„¶åæŒ‰ç…§å®˜æ–¹æä¾›çš„<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fleoforfree%2Fcz-customizable%2Fblob%2Fmaster%2Fcz-config-EXAMPLE.js" title="https://github.com/leoforfree/cz-customizable/blob/master/cz-config-EXAMPLE.js">ç¤ºä¾‹</a>æ¥é…ç½®ã€‚</p>
<p>åœ¨æœ¬é¡¹ç›®ä¸­æˆ‘ä»¬ä¿®æ”¹æˆä¸­æ–‡ï¼š</p>
<pre><code>module.exports = {
  // type ç±»å‹ï¼ˆå®šä¹‰ä¹‹åï¼Œå¯é€šè¿‡ä¸Šä¸‹é”®é€‰æ‹©ï¼‰
  types: [
    { value: 'feat', name: 'feat:     æ–°å¢åŠŸèƒ½' },
    { value: 'fix', name: 'fix:      ä¿®å¤ bug' },
    { value: 'docs', name: 'docs:     æ–‡æ¡£å˜æ›´' },
    { value: 'style', name: 'style:    ä»£ç æ ¼å¼ï¼ˆä¸å½±å“åŠŸèƒ½ï¼Œä¾‹å¦‚ç©ºæ ¼ã€åˆ†å·ç­‰æ ¼å¼ä¿®æ­£ï¼‰' },
    { value: 'refactor', name: 'refactor: ä»£ç é‡æ„ï¼ˆä¸åŒ…æ‹¬ bug ä¿®å¤ã€åŠŸèƒ½æ–°å¢ï¼‰' },
    { value: 'perf', name: 'perf:     æ€§èƒ½ä¼˜åŒ–' },
    { value: 'test', name: 'test:     æ·»åŠ ã€ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹' },
    { value: 'build', name: 'build:    æ„å»ºæµç¨‹ã€å¤–éƒ¨ä¾èµ–å˜æ›´ï¼ˆå¦‚å‡çº§ npm åŒ…ã€ä¿®æ”¹ webpack é…ç½®ç­‰ï¼‰' },
    { value: 'ci', name: 'ci:       ä¿®æ”¹ CI é…ç½®ã€è„šæœ¬' },
    { value: 'chore', name: 'chore:    å¯¹æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·å’Œåº“çš„æ›´æ”¹ï¼ˆä¸å½±å“æºæ–‡ä»¶ã€æµ‹è¯•ç”¨ä¾‹ï¼‰' },
    { value: 'revert', name: 'revert:   å›æ»š commit' }
  ],

  // scope ç±»å‹ï¼ˆå®šä¹‰ä¹‹åï¼Œå¯é€šè¿‡ä¸Šä¸‹é”®é€‰æ‹©ï¼‰
  scopes: [
    ['components', 'ç»„ä»¶ç›¸å…³'],
    ['hooks', 'hook ç›¸å…³'],
    ['utils', 'utils ç›¸å…³'],
    ['element-ui', 'å¯¹ element-ui çš„è°ƒæ•´'],
    ['styles', 'æ ·å¼ç›¸å…³'],
    ['deps', 'é¡¹ç›®ä¾èµ–'],
    ['auth', 'å¯¹ auth ä¿®æ”¹'],
    ['other', 'å…¶ä»–ä¿®æ”¹'],
    // å¦‚æœé€‰æ‹© customï¼Œåé¢ä¼šè®©ä½ å†è¾“å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„ scopeã€‚ä¹Ÿå¯ä»¥ä¸è®¾ç½®æ­¤é¡¹ï¼ŒæŠŠåé¢çš„ allowCustomScopes è®¾ç½®ä¸º true
    ['custom', 'ä»¥ä¸Šéƒ½ä¸æ˜¯ï¼Ÿæˆ‘è¦è‡ªå®šä¹‰']
  ].map(([value, description]) =&gt; {
    return {
      value,
      name: `${value.padEnd(30)} (${description})`
    }
  }),

  // æ˜¯å¦å…è®¸è‡ªå®šä¹‰å¡«å†™ scopeï¼Œåœ¨ scope é€‰æ‹©çš„æ—¶å€™ï¼Œä¼šæœ‰ empty å’Œ custom å¯ä»¥é€‰æ‹©ã€‚
  // allowCustomScopes: true,

  // allowTicketNumber: false,
  // isTicketNumberRequired: false,
  // ticketNumberPrefix: 'TICKET-',
  // ticketNumberRegExp: '\\d{1,5}',


  // é’ˆå¯¹æ¯ä¸€ä¸ª type å»å®šä¹‰å¯¹åº”çš„ scopesï¼Œä¾‹å¦‚ fix
  /*
  scopeOverrides: {
    fix: [
      { name: 'merge' },
      { name: 'style' },
      { name: 'e2eTest' },
      { name: 'unitTest' }
    ]
  },
  */

  // äº¤äº’æç¤ºä¿¡æ¯
  messages: {
    type: 'ç¡®ä¿æœ¬æ¬¡æäº¤éµå¾ª Angular è§„èŒƒï¼\né€‰æ‹©ä½ è¦æäº¤çš„ç±»å‹ï¼š',
    scope: '\né€‰æ‹©ä¸€ä¸ª scopeï¼ˆå¯é€‰ï¼‰ï¼š',
    // é€‰æ‹© scope: custom æ—¶ä¼šå‡ºä¸‹é¢çš„æç¤º
    customScope: 'è¯·è¾“å…¥è‡ªå®šä¹‰çš„ scopeï¼š',
    subject: 'å¡«å†™ç®€çŸ­ç²¾ç‚¼çš„å˜æ›´æè¿°ï¼š\n',
    body:
      'å¡«å†™æ›´åŠ è¯¦ç»†çš„å˜æ›´æè¿°ï¼ˆå¯é€‰ï¼‰ã€‚ä½¿ç”¨ &quot;|&quot; æ¢è¡Œï¼š\n',
    breaking: 'åˆ—ä¸¾éå…¼å®¹æ€§é‡å¤§çš„å˜æ›´ï¼ˆå¯é€‰ï¼‰ï¼š\n',
    footer: 'åˆ—ä¸¾å‡ºæ‰€æœ‰å˜æ›´çš„ ISSUES CLOSEDï¼ˆå¯é€‰ï¼‰ã€‚ ä¾‹å¦‚: #31, #34ï¼š\n',
    confirmCommit: 'ç¡®è®¤æäº¤ï¼Ÿ'
  },

  // è®¾ç½®åªæœ‰ type é€‰æ‹©äº† feat æˆ– fixï¼Œæ‰è¯¢é—® breaking message
  allowBreakingChanges: ['feat', 'fix'],

  // è·³è¿‡è¦è¯¢é—®çš„æ­¥éª¤
  // skipQuestions: ['body', 'footer'],

  // subject é™åˆ¶é•¿åº¦
  subjectLimit: 100
  breaklineChar: '|', // æ”¯æŒ body å’Œ footer
  // footerPrefix : 'ISSUES CLOSED:'
  // askForBreakingChangeFirst : true,
}

</code></pre>
<p>å»ºè®®å¤§å®¶ç»“åˆé¡¹ç›®å®é™…æƒ…å†µæ¥è‡ªå®šä¹‰é…ç½®æäº¤è§„åˆ™ï¼Œä¾‹å¦‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¸éœ€è¦å†™é•¿æè¿°ï¼Œå…¬å¸å†…éƒ¨çš„ä»£ç ä»“åº“ä¹Ÿä¸éœ€è¦ç®¡ç† issueï¼Œé‚£ä¹ˆå¯ä»¥æŠŠè¯¢é—® body å’Œ footer çš„æ­¥éª¤è·³è¿‡ï¼ˆåœ¨ <code>.cz-config.js</code> ä¸­ä¿®æ”¹æˆ <code>skipQuestions: ['body', 'footer']</code>ï¼‰ã€‚</p>
<h3>é›†æˆ commitlint éªŒè¯æäº¤è§„èŒƒ</h3>
<p>æäº¤ä»£ç è¿™ä¸ªç¯èŠ‚ï¼Œæˆ‘ä»¬ä¹Ÿå¢åŠ ä¸€ä¸ªé™åˆ¶ï¼š<strong>åªè®©ç¬¦åˆ Angular è§„èŒƒçš„ commit message é€šè¿‡</strong>
æˆ‘ä»¬å€ŸåŠ© @commitlint/config-conventional å’Œ @commitlint/cli æ¥å®ç°ã€‚</p>
<h4>å®‰è£… commitlint</h4>
<p>å®‰è£… @commitlint/config-conventional å’Œ @commitlint/cli</p>
<pre><code>npm i @commitlint/config-conventional @commitlint/cli -D
</code></pre>
<h4>é…ç½® commitlint</h4>
<ul>
<li>åˆ›å»º commitlint.config.js æ–‡ä»¶ åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º <code>commitlint.config.js</code> æ–‡ä»¶ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š</li>
</ul>
<pre><code>module.exports = { extends: ['@commitlint/config-conventional'] }
</code></pre>
<ul>
<li>ä½¿ç”¨ husky çš„ <code>commit-msg</code> hook è§¦å‘éªŒè¯æäº¤ä¿¡æ¯çš„å‘½ä»¤<br>
æˆ‘ä»¬ä½¿ç”¨ husky å‘½ä»¤åœ¨ <code>.husky</code> ç›®å½•ä¸‹åˆ›å»º <code>commit-msg</code> æ–‡ä»¶ï¼Œå¹¶åœ¨æ­¤æ‰§è¡Œ commit message çš„éªŒè¯å‘½ä»¤ã€‚</li>
</ul>
<pre><code>npx husky add .husky/commit-msg &quot;npx --no-install commitlint --edit $1&quot;
</code></pre>
<p>å› ä¸ºå·²åœ¨é¡¹ç›®ä¸­é›†æˆ commitizenï¼Œå»ºè®®å¤§å®¶ç”¨ <code>git cz</code> æ¥ä»£æ›¿ <code>git commit</code> æäº¤ä»£ç ï¼Œå¯ä»¥ä¿è¯æäº¤ä¿¡æ¯è§„èŒƒã€‚</p>
<h2>å•å…ƒæµ‹è¯•</h2>
<h3>å®‰è£…æ ¸å¿ƒä¾èµ–</h3>
<p>æˆ‘ä»¬ä½¿ç”¨ Vue å®˜æ–¹æä¾›çš„ <strong>vue-test-utils</strong> å’Œç¤¾åŒºæµè¡Œçš„æµ‹è¯•å·¥å…· <strong>jest</strong> æ¥è¿›è¡Œ Vue ç»„ä»¶çš„å•å…ƒæµ‹è¯•ã€‚</p>
<ul>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue-test-utils-next" title="https://github.com/vuejs/vue-test-utils-next">vue-test-utils</a></strong> The next iteration of Vue Test Utils. It targets Vue 3.</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Fjest" title="https://github.com/facebook/jest">jest</a></strong> Delightful JavaScript Testing.</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue-jest" title="https://github.com/vuejs/vue-jest">vue-jest</a></strong> Jest Vue transformer</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkulshekhar%2Fts-jest" title="https://github.com/kulshekhar/ts-jest">ts-jest</a></strong> A Jest transformer with source map support that lets you use Jest to test projects written in TypeScript.</li>
</ul>
<hr>
<p>å®‰è£…è¿™äº›å·¥å…·ä¸ºå¼€å‘ä¾èµ–ï¼ˆdevDependenciesï¼‰ï¼š</p>
<pre><code>npm i @vue/test-utils@next jest vue-jest@next ts-jest -D

</code></pre>
<h3>åˆ›å»º jest é…ç½®æ–‡ä»¶</h3>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»º <code>jest.config.js</code> æ–‡ä»¶ï¼š</p>
<pre><code>module.exports = {
  moduleFileExtensions: ['vue', 'js', 'ts'],
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  transform: {
    '^.+\\.vue$': 'vue-jest', // vue æ–‡ä»¶ç”¨ vue-jest è½¬æ¢
    '^.+\\.ts$': 'ts-jest' // ts æ–‡ä»¶ç”¨ ts-jest è½¬æ¢
  },
  // åŒ¹é… __tests__ ç›®å½•ä¸‹çš„ .js/.ts æ–‡ä»¶ æˆ–å…¶ä»–ç›®å½•ä¸‹çš„ xx.test.js/ts xx.spec.js/ts
  testRegex: '(/__tests__/.*|(\\.|/)(test|spec))\\.(ts)$'
}

</code></pre>
<h3>åˆ›å»ºå•å…ƒæµ‹è¯•æ–‡ä»¶</h3>
<p>åœ¨ä¸Šé¢çš„ <code>jest.config.js</code> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é…ç½®åªåŒ¹é… <code>__tests__</code> ç›®å½•ä¸‹çš„ä»»æ„ <code>.ts</code> æ–‡ä»¶æˆ–å…¶ä»–ç›®å½•ä¸‹çš„ <code>xx.test.ts</code>/<code>xx.spec.ts</code> æ–‡ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º <code>tests</code> ç›®å½•æ¥å­˜å‚¨å•å…ƒæµ‹è¯•æ–‡ä»¶</p>
<pre><code>â”œâ”€â”€ src/
â””â”€â”€ tests/                           // å•å…ƒæµ‹è¯•ç›®å½•
    â”œâ”€â”€ Test.spec.ts                 // Test ç»„ä»¶æµ‹è¯•

</code></pre>
<ul>
<li>Test.vue</li>
</ul>
<pre><code>&lt;template&gt;
  &lt;div class=&quot;test-container page-container&quot;&gt;
    &lt;div class=&quot;page-title&quot;&gt;Unit Test Page&lt;/div&gt;
    &lt;p&gt;count is: {{ count }}&lt;/p&gt;
    &lt;button @click=&quot;increment&quot;&gt;increment&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script lang=&quot;ts&quot;&gt;
  import { defineComponent, ref } from 'vue'
  export default defineComponent({
    name: 'Vuex',
    setup() {
      const count = ref&lt;number&gt;(0)
      const increment = () =&gt; {
        count.value += 1
      }
      return { count, increment }
    }
  })
&lt;/script&gt;

</code></pre>
<ul>
<li><code>Test.spec.ts</code><pre><code>import { mount } from '@vue/test-utils'
import Test from '../src/views/Test.vue'

test('Test.vue', async () =&gt; {
  const wrapper = mount(Test)
  expect(wrapper.html()).toContain('Unit Test Page')
  expect(wrapper.html()).toContain('count is: 0')
  await wrapper.find('button').trigger('click')
  expect(wrapper.html()).toContain('count is: 1')
})
</code></pre>
</li>
</ul>
<h3>é›†æˆ @types/jest</h3>
<p>æˆ‘ä»¬ä½¿ç”¨ VSCode / WebStrom / IDEA ç­‰ç¼–è¾‘å™¨æ—¶ï¼Œåœ¨å•å…ƒæµ‹è¯•æ–‡ä»¶ä¸­ï¼ŒIDE ä¼šæç¤ºæŸäº›æ–¹æ³•ä¸å­˜åœ¨ï¼ˆå¦‚ <code>test</code>ã€<code>describe</code>ã€<code>it</code>ã€<code>expect</code>ç­‰ï¼‰
å®‰è£… @types/jest å³å¯è§£å†³ã€‚ npm i @types/jest -D</p>
<hr>
<p>TypeScript çš„ç¼–è¯‘å™¨ä¹Ÿä¼šæç¤º jest çš„æ–¹æ³•å’Œç±»å‹æ‰¾ä¸åˆ°ï¼Œæˆ‘ä»¬è¿˜éœ€æŠŠ @types/jest æ·»åŠ æ ¹ç›®å½•ä¸‹çš„ <code>ts.config.json</code>ï¼ˆTypeScript é…ç½®æ–‡ä»¶ï¼‰ä¸­ï¼š</p>
<pre><code>{
  &quot;compilerOptions&quot;: {
    ...
    &quot;types&quot;: [&quot;vite/client&quot;, &quot;jest&quot;]
  },
}

</code></pre>
<h3>æ·»åŠ  eslint-plugin-jest</h3>
<p>å› ä¸ºæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­é›†æˆäº† ESLintï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ ESLint ä¸­å¢åŠ  <strong>eslint-plugin-jest</strong> æ’ä»¶æ¥è§£é™¤å¯¹ jest çš„æ ¡éªŒã€‚</p>
<ul>
<li>å®‰è£… eslint-plugin-jestnpm i eslint-plugin-jest -D</li>
<li>æ·»åŠ  eslint-plugin-jest åˆ° ESLint é…ç½®æ–‡ä»¶ <code>.eslintrc.js</code> ä¸­<pre><code>module.exports = {
  ...
  extends: [
    ...
    'plugin:jest/recommended'
  ],
  ...
}

</code></pre>
</li>
</ul>
<h3>æ‰§è¡Œå•å…ƒæµ‹è¯•</h3>
<p>åœ¨æ ¹ç›®å½•ä¸‹ <code>package.json</code> æ–‡ä»¶çš„ <code>scripts</code> ä¸­ï¼Œæ·»åŠ ä¸€æ¡å•å…ƒæµ‹è¯•å‘½ä»¤ï¼š <code>&quot;test&quot;: &quot;jest&quot;</code>ã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66354199386b431088db0593f34b88e6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p>
<p>æ‰§è¡Œå‘½ä»¤ <code>npm run test</code> å³å¯è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œjest ä¼šæ ¹æ® <code>jest.config.js</code> é…ç½®æ–‡ä»¶å»æŸ¥æ‰¾ <code>__tests__</code> ç›®å½•ä¸‹çš„ <code>.ts</code> æ–‡ä»¶æˆ–å…¶ä»–ä»»æ„ç›®å½•ä¸‹çš„ <code>.spec.ts</code> å’Œ <code>.test.ts</code> æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œå•å…ƒæµ‹è¯•æ–¹æ³•ã€‚</p>
<p>ä½ å¯ä»¥åœ¨ <code>jest.config.js</code> é…ç½®æ–‡ä»¶ä¸­ï¼Œè‡ªç”±é…ç½®å•å…ƒæµ‹è¯•æ–‡ä»¶çš„ç›®å½•ã€‚</p>
<h3>å•å…ƒæµ‹è¯•çº¦æŸ</h3>
<p>å‰é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ husky åœ¨ Git çš„ <code>pre-commit</code> å’Œ <code>commit-msg</code> é˜¶æ®µåˆ†åˆ«çº¦æŸä»£ç é£æ ¼è§„èŒƒå’Œæäº¤ä¿¡æ¯è§„èŒƒã€‚
è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨ <code>pre-push</code> é˜¶æ®µè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œåªæœ‰å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡æ‰è®©ä»£ç  <code>push</code> åˆ°è¿œç«¯ä»“åº“ï¼Œå¦åˆ™ç»ˆæ­¢ <code>push</code>ã€‚</p>
<p>ä½¿ç”¨ husky å‘½ä»¤åœ¨ <code>.husky</code> ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»º <code>pre-push</code> hook æ–‡ä»¶ï¼Œå¹¶åœ¨æ­¤æ‰§è¡Œå•å…ƒæµ‹è¯•å‘½ä»¤ <code>npm run test</code>ã€‚</p>
<pre><code>npx husky add .husky/pre-push &quot;npm run test $1&quot;
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨ <code>git push</code> æ—¶å°±èƒ½å…ˆè¿›è¡Œå•å…ƒæµ‹è¯•äº†ï¼Œåªæœ‰å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œæ‰èƒ½æˆåŠŸ <code>push</code>ã€‚</p>
<h2>è‡ªåŠ¨éƒ¨ç½²</h2>
<p>æœ¬é¡¹ç›®æ˜¯è¦æ­å»ºä¸€å¥—è§„èŒƒçš„å‰ç«¯å·¥ç¨‹åŒ–ç¯å¢ƒï¼Œä¸ºæ­¤æˆ‘ä»¬ä½¿ç”¨ CIï¼ˆContinuous Integration æŒç»­é›†æˆï¼‰æ¥å®Œæˆé¡¹ç›®æœ€åçš„éƒ¨ç½²å·¥ä½œã€‚
è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ GitHub Actionsã€‚</p>
<h3>ä»€ä¹ˆæ˜¯ GitHub Actions</h3>
<p>GitHub Actions æ˜¯ GitHub çš„æŒç»­é›†æˆæœåŠ¡ï¼ŒæŒç»­é›†æˆç”±å¾ˆå¤šæ“ä½œç»„æˆï¼Œæ¯”å¦‚æŠ“å–ä»£ç ã€è¿è¡Œæµ‹è¯•ã€ç™»å½•è¿œç¨‹æœåŠ¡å™¨ã€å‘å¸ƒåˆ°ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰ç­‰ï¼ŒGitHub æŠŠè¿™äº›æ“ä½œç§°ä¸º actionsã€‚</p>
<h3>é…ç½® GitHub Actions</h3>
<h4>åˆ›å»º GitHub ä»“åº“</h4>
<p>å› ä¸º GitHub Actions åªå¯¹ GitHub ä»“åº“æœ‰æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnew" title="https://github.com/new">åˆ›å»º GitHub ä»“åº“</a>æ¥æ‰˜ç®¡é¡¹ç›®ä»£ç ã€‚
æˆ‘ä»¬ç”¨ï¼š</p>
<ul>
<li><code>master</code> åˆ†æ”¯å­˜å‚¨é¡¹ç›®æºä»£ç </li>
<li><code>gh-pages</code> åˆ†æ”¯å­˜å‚¨æ‰“åŒ…åçš„é™æ€æ–‡ä»¶</li>
</ul>
<blockquote>
<p><code>gh-pages</code> åˆ†æ”¯ï¼Œæ˜¯ GitHub Pages æœåŠ¡çš„å›ºå®šåˆ†æ”¯ï¼Œå¯ä»¥é€šè¿‡ HTTP çš„æ–¹å¼è®¿é—®åˆ°è¿™ä¸ªåˆ†æ”¯çš„é™æ€æ–‡ä»¶èµ„æºã€‚</p>
</blockquote>
<h4>åˆ›å»º GitHub Token</h4>
<p>åˆ›å»ºä¸€ä¸ªæœ‰ <strong>repo</strong> å’Œ <strong>workflow</strong> æƒé™çš„ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsettings%2Ftokens%2Fnew" title="https://github.com/settings/tokens/new">GitHub Token</a>
æ³¨æ„ï¼šæ–°ç”Ÿæˆçš„ Token åªä¼šæ˜¾ç¤ºä¸€æ¬¡ï¼Œä¿å­˜èµ·æ¥ï¼Œåé¢è¦ç”¨åˆ°ã€‚å¦‚æœ‰é—å¤±ï¼Œé‡æ–°ç”Ÿæˆå³å¯ã€‚</p>
<h4>åœ¨ä»“åº“ä¸­æ·»åŠ  secret</h4>
<p>å°†ä¸Šé¢æ–°åˆ›å»ºçš„ Token æ·»åŠ åˆ° GitHub ä»“åº“çš„ <code>Secrets</code> é‡Œï¼Œå¹¶å°†è¿™ä¸ªæ–°å¢çš„ <code>secret</code> å‘½åä¸º <code>VUE3_DEPLOY</code> ï¼ˆåå­—æ— æ‰€è°“ï¼Œçœ‹ä½ å–œæ¬¢ï¼‰ã€‚</p>
<p>æ­¥éª¤ï¼šä»“åº“ -&gt; <code>settings</code> -&gt; <code>Secrets</code> -&gt; <code>New repository secret</code>ã€‚
æ–°åˆ›å»ºçš„ secret <code>VUE3_DEPLOY</code> åœ¨ Actions é…ç½®æ–‡ä»¶ä¸­è¦ç”¨åˆ°ï¼Œä¸¤ä¸ªåœ°æ–¹éœ€ä¿æŒä¸€è‡´ï¼</p>
<h4>åˆ›å»º Actions é…ç½®æ–‡ä»¶</h4>
<ol>
<li>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º <code>.github</code> ç›®å½•ã€‚</li>
<li>åœ¨ <code>.github</code> ç›®å½•ä¸‹åˆ›å»º <code>workflows</code> ç›®å½•ã€‚</li>
<li>åœ¨ <code>workflows</code> ç›®å½•ä¸‹åˆ›å»º <code>deploy.yml</code> æ–‡ä»¶ã€‚
<code>deploy.yml</code> æ–‡ä»¶çš„å†…å®¹ï¼š</li>
</ol>
<pre><code>name: deploy

on:
  push:
    branches: [master] # master åˆ†æ”¯æœ‰ push æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup Node.js v14.x
        uses: actions/setup-node@v1
        with:
          node-version: '14.x'

      - name: Install
        run: npm install # å®‰è£…ä¾èµ–

      - name: Build
        run: npm run build # æ‰“åŒ…

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3 # ä½¿ç”¨éƒ¨ç½²åˆ° GitHub pages çš„ action
        with:
          publish_dir: ./dist # éƒ¨ç½²æ‰“åŒ…åçš„ dist ç›®å½•
          github_token: ${{ secrets.VUE3_DEPLOY }} # secret å
          user_name: ${{ secrets.MY_USER_NAME }}
          user_email: ${{ secrets.MY_USER_EMAIL }}
          commit_message: Update Vite2.x + Vue3.x + TypeScript Starter # éƒ¨ç½²æ—¶çš„ git æäº¤ä¿¡æ¯ï¼Œè‡ªç”±å¡«å†™

</code></pre>
<h3>è‡ªåŠ¨éƒ¨ç½²è§¦å‘åŸç†</h3>
<p>å½“æœ‰æ–°æäº¤çš„ä»£ç  <code>push</code> åˆ° GitHub ä»“åº“æ—¶ï¼Œå°±ä¼šè§¦å‘ GitHub Actionsï¼Œåœ¨ GitHub æœåŠ¡å™¨ä¸Šæ‰§è¡Œ Action é…ç½®æ–‡ä»¶é‡Œé¢çš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š<strong>å®‰è£…ä¾èµ–</strong>ã€<strong>é¡¹ç›®æ‰“åŒ…</strong>ç­‰ï¼Œç„¶åå°†æ‰“åŒ…å¥½çš„é™æ€æ–‡ä»¶éƒ¨ç½²åˆ° GitHub Pages ä¸Šï¼Œæœ€åï¼Œæˆ‘ä»¬å°±èƒ½é€šè¿‡åŸŸåè®¿é—®äº†ã€‚</p>
<h1> </h1>
<h1>ä¸€æ¬¡å¼„æ‡‚ Event Loopï¼ˆå½»åº•è§£å†³æ­¤ç±»é¢è¯•é—®é¢˜ï¼‰</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/6844903764202094606#heading-36">juejin.cn</a></p>
</blockquote>
<h3>MicroTaskï¼ˆå¾®ä»»åŠ¡ï¼‰</h3>
<ul>
<li><code>Process.nextTickï¼ˆNodeç‹¬æœ‰ï¼‰</code>ã€<code>Promise</code>ã€<code>Object.observe(åºŸå¼ƒ)</code>ã€<code>MutationObserver</code>ï¼ˆå…·ä½“ä½¿ç”¨æ–¹å¼æŸ¥çœ‹<a href="https://link.juejin.cn?target=http%3A%2F%2Fjavascript.ruanyifeng.com%2Fdom%2Fmutationobserver.html" title="http://javascript.ruanyifeng.com/dom/mutationobserver.html">è¿™é‡Œ</a>ï¼‰</li>
</ul>
<h2>æµè§ˆå™¨ä¸­çš„ Event Loop</h2>
<p><code>Javascript</code> æœ‰ä¸€ä¸ª <code>main thread</code> ä¸»çº¿ç¨‹å’Œ <code>call-stack</code> è°ƒç”¨æ ˆ (æ‰§è¡Œæ ˆ)ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šè¢«æ”¾åˆ°è°ƒç”¨æ ˆç­‰å¾…ä¸»çº¿ç¨‹æ‰§è¡Œã€‚</p>
<h3>åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡</h3>
<p><code>Javascript</code>å•çº¿ç¨‹ä»»åŠ¡è¢«åˆ†ä¸º<strong>åŒæ­¥ä»»åŠ¡</strong>å’Œ<strong>å¼‚æ­¥ä»»åŠ¡</strong>
åŒæ­¥ä»»åŠ¡ä¼šåœ¨è°ƒç”¨æ ˆä¸­æŒ‰ç…§é¡ºåºç­‰å¾…ä¸»çº¿ç¨‹ä¾æ¬¡æ‰§è¡Œï¼Œ
å¼‚æ­¥ä»»åŠ¡ä¼šåœ¨å¼‚æ­¥ä»»åŠ¡æœ‰äº†ç»“æœåï¼Œå°†æ³¨å†Œçš„å›è°ƒå‡½æ•°æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸»çº¿ç¨‹ç©ºé—²çš„æ—¶å€™ï¼ˆè°ƒç”¨æ ˆè¢«æ¸…ç©ºï¼‰ï¼Œè¢«è¯»å–åˆ°æ ˆå†…ç­‰å¾…ä¸»çº¿ç¨‹çš„æ‰§è¡Œã€‚
<img src="./Pasted image 20230814132849.png" /></p>
<h3>äº‹ä»¶å¾ªç¯çš„è¿›ç¨‹æ¨¡å‹</h3>
<ul>
<li>é€‰æ‹©å½“å‰è¦æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œé€‰æ‹©ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ€å…ˆè¿›å…¥çš„ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºå³<code>null</code>ï¼Œåˆ™æ‰§è¡Œè·³è½¬åˆ°å¾®ä»»åŠ¡ï¼ˆ<code>MicroTask</code>ï¼‰çš„æ‰§è¡Œæ­¥éª¤ã€‚</li>
<li>å°†äº‹ä»¶å¾ªç¯ä¸­çš„ä»»åŠ¡è®¾ç½®ä¸ºå·²é€‰æ‹©ä»»åŠ¡ã€‚æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>æ‰§è¡Œä»»åŠ¡åå°†äº‹ä»¶å¾ªç¯ä¸­å½“å‰è¿è¡Œä»»åŠ¡è®¾ç½®ä¸º nullã€‚</li>
<li>å°†å·²ç»è¿è¡Œå®Œæˆçš„ä»»åŠ¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚</li>
<li>microtasks æ­¥éª¤ï¼šè¿›å…¥ microtask æ£€æŸ¥ç‚¹ã€‚</li>
<li>æ›´æ–°ç•Œé¢æ¸²æŸ“ã€‚</li>
<li>è¿”å›ç¬¬ä¸€æ­¥ã€‚</li>
</ul>
<h3>æ‰§è¡Œè¿›å…¥ microtask æ£€æŸ¥ç‚¹æ—¶ï¼Œç”¨æˆ·ä»£ç†ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</h3>
<ul>
<li>è®¾ç½® microtask æ£€æŸ¥ç‚¹æ ‡å¿—ä¸º trueã€‚</li>
<li>å½“äº‹ä»¶å¾ªç¯<code>microtask</code>æ‰§è¡Œä¸ä¸ºç©ºæ—¶ï¼šé€‰æ‹©ä¸€ä¸ªæœ€å…ˆè¿›å…¥çš„<code>microtask</code>é˜Ÿåˆ—çš„<code>microtask</code>ï¼Œå°†äº‹ä»¶å¾ªç¯çš„<code>microtask</code>è®¾ç½®ä¸ºå·²é€‰æ‹©çš„<code>microtask</code>ï¼Œè¿è¡Œ<code>microtask</code>ï¼Œ</li>
<li>è¿è¡Œå®Œä¹‹åå°†å·²ç»æ‰§è¡Œå®Œæˆçš„<code>microtask</code>ä¸º<code>null</code>ï¼Œç§»å‡º<code>microtask</code>ä¸­çš„<code>microtask</code>ã€‚</li>
<li>æ¸…ç† IndexDB äº‹åŠ¡</li>
<li>è®¾ç½®è¿›å…¥ microtask æ£€æŸ¥ç‚¹çš„æ ‡å¿—ä¸º falseã€‚</li>
</ul>
<hr>
<p>æ‰§è¡Œæ ˆåœ¨æ‰§è¡Œå®Œ<strong>åŒæ­¥ä»»åŠ¡</strong>åï¼ŒæŸ¥çœ‹<strong>æ‰§è¡Œæ ˆ</strong>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ‰§è¡Œæ ˆä¸ºç©ºï¼Œå°±ä¼šå»æ£€æŸ¥<strong>å¾®ä»»åŠ¡</strong> (<code>microTask</code>) é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºçš„è¯ï¼Œå°±æ‰§è¡Œ<code>Task</code>ï¼ˆå®ä»»åŠ¡ï¼‰ï¼Œå¦åˆ™å°±ä¸€æ¬¡æ€§æ‰§è¡Œå®Œæ‰€æœ‰å¾®ä»»åŠ¡ã€‚<br>
æ¯æ¬¡å•ä¸ª<strong>å®ä»»åŠ¡</strong>æ‰§è¡Œå®Œæ¯•åï¼Œæ£€æŸ¥<strong>å¾®ä»»åŠ¡</strong> (<code>microTask</code>) é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯ï¼Œä¼šæŒ‰ç…§<strong>å…ˆå…¥å…ˆ</strong>å‡ºçš„è§„åˆ™å…¨éƒ¨æ‰§è¡Œå®Œ<strong>å¾®ä»»åŠ¡</strong> (<code>microTask</code>) åï¼Œè®¾ç½®<strong>å¾®ä»»åŠ¡</strong> (<code>microTask</code>) é˜Ÿåˆ—ä¸º<code>null</code>ï¼Œç„¶åå†æ‰§è¡Œ<strong>å®ä»»åŠ¡</strong>ï¼Œå¦‚æ­¤å¾ªç¯ã€‚</p>
<h2>å†ä¸¾ä¸ªä¾‹å­</h2>
<pre><code>console.log('script start')

async function async1() {
  await async2()
  console.log('async1 end')
}
async function async2() {
  console.log('async2 end') 
  //await async2ç›¸å½“äº promiseï¼Œè¿™é‡Œç®—æ˜¯new promiseï¼ˆasync2()ï¼Œå±äºåŒæ­¥ä»£ç 
}
async1()

setTimeout(function() {
  console.log('setTimeout')
}, 0)

new Promise(resolve =&gt; {
  console.log('Promise')
  resolve()
})
  .then(function() {
    console.log('promise1')
  })
  .then(function() {
    console.log('promise2')
  })

console.log('script end')
</code></pre>
<ul>
<li>åœ¨è€ç‰ˆæœ¬ç‰ˆæœ¬ä»¥ä¸‹ï¼Œå…ˆæ‰§è¡Œ<code>promise1</code>å’Œ<code>promise2</code>ï¼Œå†æ‰§è¡Œ<code>async1</code>ã€‚</li>
<li>åœ¨ 73 ç‰ˆæœ¬ï¼Œå…ˆæ‰§è¡Œ<code>async1</code>å†æ‰§è¡Œ<code>promise1</code>å’Œ<code>promise2</code>ã€‚</li>
</ul>
<hr>
<p>æ¯æ¬¡æˆ‘ä»¬ä½¿ç”¨ <code>await</code>, è§£é‡Šå™¨éƒ½åˆ›å»ºä¸€ä¸ª <code>promise</code> å¯¹è±¡ï¼Œç„¶åæŠŠå‰©ä¸‹çš„ <code>async</code> å‡½æ•°ä¸­çš„æ“ä½œæ”¾åˆ° <code>then</code> å›è°ƒå‡½æ•°ä¸­ã€‚</p>
<p>**ä¸»è¦åŸå› æ˜¯å› ä¸ºåœ¨è°·æ­Œ (é‡‘ä¸é›€)73 ç‰ˆæœ¬ä¸­æ›´æ”¹äº†è§„èŒƒï¼ŒåŒºåˆ«åœ¨äº<code>RESOLVE(thenable)</code>å’Œä¹‹é—´çš„åŒºåˆ«<code>Promise.resolve(thenable)</code>ã€‚</p>
<hr>
<h3><strong>åœ¨è€ç‰ˆæœ¬ä¸­</strong></h3>
<ul>
<li>é¦–å…ˆï¼Œä¼ é€’ç»™ <code>await</code> çš„å€¼è¢«åŒ…è£¹åœ¨ä¸€ä¸ª <code>Promise</code> ä¸­ã€‚ç„¶åï¼Œå¤„ç†ç¨‹åºé™„åŠ åˆ°è¿™ä¸ªåŒ…è£…çš„ <code>Promise</code>ï¼Œä»¥ä¾¿åœ¨ <code>Promise</code> å˜ä¸º <code>fulfilled</code> åæ¢å¤è¯¥å‡½æ•°ï¼Œå¹¶ä¸”æš‚åœæ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œä¸€æ—¦ <code>promise</code> å˜ä¸º <code>fulfilled</code>ï¼Œæ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œã€‚</li>
<li>æ¯ä¸ª <code>await</code> å¼•æ“å¿…é¡»åˆ›å»ºä¸¤ä¸ªé¢å¤–çš„ Promiseï¼ˆå³ä½¿å³ä¾§å·²ç»æ˜¯ä¸€ä¸ª <code>Promise</code>ï¼‰å¹¶ä¸”å®ƒéœ€è¦è‡³å°‘ä¸‰ä¸ª <code>microtask</code> é˜Ÿåˆ— <code>ticks</code>ï¼ˆ<code>tick</code>ä¸ºç³»ç»Ÿçš„ç›¸å¯¹æ—¶é—´å•ä½ï¼Œä¹Ÿè¢«ç§°ä¸ºç³»ç»Ÿçš„æ—¶åŸºï¼Œæ¥æºäºå®šæ—¶å™¨çš„å‘¨æœŸæ€§ä¸­æ–­ï¼ˆè¾“å‡ºè„‰å†²ï¼‰ï¼Œä¸€æ¬¡ä¸­æ–­è¡¨ç¤ºä¸€ä¸ª<code>tick</code>ï¼Œä¹Ÿè¢«ç§°åšä¸€ä¸ª â€œæ—¶é’Ÿæ»´ç­”â€ã€æ—¶æ ‡ã€‚ï¼‰ã€‚</li>
</ul>
<h3><strong>å¼•ç”¨è´ºè€å¸ˆçŸ¥ä¹ä¸Šçš„ä¸€ä¸ªä¾‹å­</strong></h3>
<pre><code>async function f() {
  await p
  console.log('ok')
}
</code></pre>
<p>ç®€åŒ–ç†è§£ä¸ºï¼š</p>
<pre><code>function f() {
  return RESOLVE(p).then(() =&gt; {
    console.log('ok')
  })
}
</code></pre>
<ul>
<li>å¦‚æœ <code>RESOLVE(p)</code> å¯¹äº <code>p</code> ä¸º <code>promise</code> ç›´æ¥è¿”å› <code>p</code> çš„è¯ï¼Œé‚£ä¹ˆ <code>p</code>çš„ <code>then</code> æ–¹æ³•å°±ä¼šè¢«é©¬ä¸Šè°ƒç”¨ï¼Œå…¶å›è°ƒå°±ç«‹å³è¿›å…¥ <code>job</code> é˜Ÿåˆ—ã€‚</li>
<li>è€Œå¦‚æœ <code>RESOLVE(p)</code> ä¸¥æ ¼æŒ‰ç…§æ ‡å‡†ï¼Œåº”è¯¥æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„ <code>promise</code>ï¼Œå°½ç®¡è¯¥ <code>promise</code>ç¡®å®šä¼š <code>resolve</code> ä¸º <code>p</code>ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹æœ¬èº«æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨è¿›å…¥ <code>job</code> é˜Ÿåˆ—çš„æ˜¯æ–° <code>promise</code> çš„ <code>resolve</code>è¿‡ç¨‹ï¼Œæ‰€ä»¥è¯¥ <code>promise</code> çš„ <code>then</code> ä¸ä¼šè¢«ç«‹å³è°ƒç”¨ï¼Œè€Œè¦ç­‰åˆ°å½“å‰ <code>job</code> é˜Ÿåˆ—æ‰§è¡Œåˆ°å‰è¿° <code>resolve</code> è¿‡ç¨‹æ‰ä¼šè¢«è°ƒç”¨ï¼Œç„¶åå…¶å›è°ƒï¼ˆä¹Ÿå°±æ˜¯ç»§ç»­ <code>await</code> ä¹‹åçš„è¯­å¥ï¼‰æ‰åŠ å…¥ <code>job</code> é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ—¶åºä¸Šå°±æ™šäº†ã€‚</li>
</ul>
<h3><strong>è°·æ­Œï¼ˆé‡‘ä¸é›€ï¼‰73 ç‰ˆæœ¬ä¸­</strong></h3>
<ul>
<li>ä½¿ç”¨å¯¹<code>PromiseResolve</code>çš„è°ƒç”¨æ¥æ›´æ”¹<code>await</code>çš„è¯­ä¹‰ï¼Œä»¥å‡å°‘åœ¨å…¬å…±<code>awaitPromise</code>æƒ…å†µä¸‹çš„è½¬æ¢æ¬¡æ•°ã€‚</li>
<li>å¦‚æœä¼ é€’ç»™ <code>await</code> çš„å€¼å·²ç»æ˜¯ä¸€ä¸ª <code>Promise</code>ï¼Œé‚£ä¹ˆè¿™ç§ä¼˜åŒ–é¿å…äº†å†æ¬¡åˆ›å»º <code>Promise</code> åŒ…è£…å™¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»æœ€å°‘ä¸‰ä¸ª <code>microtick</code> åˆ°åªæœ‰ä¸€ä¸ª <code>microtick</code>ã€‚</li>
</ul>
<h2>NodeJS çš„ Event Loop</h2>
<p><code>Node</code>ä¸­çš„<code>Event Loop</code>æ˜¯åŸºäº<code>libuv</code>å®ç°çš„ï¼Œè€Œ<code>libuv</code>æ˜¯ <code>Node</code> çš„æ–°è·¨å¹³å°æŠ½è±¡å±‚ï¼Œlibuv ä½¿ç”¨å¼‚æ­¥ï¼Œäº‹ä»¶é©±åŠ¨çš„ç¼–ç¨‹æ–¹å¼ï¼Œæ ¸å¿ƒæ˜¯æä¾›<code>i/o</code>çš„äº‹ä»¶å¾ªç¯å’Œå¼‚æ­¥å›è°ƒã€‚libuv çš„<code>API</code>åŒ…å«æœ‰æ—¶é—´ï¼Œéé˜»å¡çš„ç½‘ç»œï¼Œå¼‚æ­¥æ–‡ä»¶æ“ä½œï¼Œå­è¿›ç¨‹ç­‰ç­‰ã€‚ <code>Event Loop</code>å°±æ˜¯åœ¨<code>libuv</code>ä¸­å®ç°çš„ã€‚</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/1/18/16860f8f8f7f053d~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p>
<h3><code>Node</code>çš„<code>Event loop</code>ä¸€å…±åˆ†ä¸º 6 ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªç»†èŠ‚å…·ä½“å¦‚ä¸‹ï¼š</h3>
<ul>
<li><code>timers</code>: æ‰§è¡Œ<code>setTimeout</code>å’Œ<code>setInterval</code>ä¸­åˆ°æœŸçš„<code>callback</code>ã€‚</li>
<li><code>pending callback</code>: ä¸Šä¸€è½®å¾ªç¯ä¸­å°‘æ•°çš„<code>callback</code>ä¼šæ”¾åœ¨è¿™ä¸€é˜¶æ®µæ‰§è¡Œã€‚</li>
<li><code>idle, prepare</code>: ä»…åœ¨å†…éƒ¨ä½¿ç”¨ã€‚</li>
<li><code>poll</code>: æœ€é‡è¦çš„é˜¶æ®µï¼Œæ‰§è¡Œ<code>pending callback</code>ï¼Œåœ¨é€‚å½“çš„æƒ…å†µä¸‹å›é˜»å¡åœ¨è¿™ä¸ªé˜¶æ®µã€‚</li>
<li><code>check</code>: æ‰§è¡Œ<code>setImmediate</code>(<code>setImmediate()</code>æ˜¯å°†äº‹ä»¶æ’å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—å°¾éƒ¨ï¼Œä¸»çº¿ç¨‹å’Œäº‹ä»¶é˜Ÿåˆ—çš„å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åç«‹å³æ‰§è¡Œ<code>setImmediate</code>æŒ‡å®šçš„å›è°ƒå‡½æ•°) çš„<code>callback</code>ã€‚</li>
<li><code>close callbacks</code>: æ‰§è¡Œ<code>close</code>äº‹ä»¶çš„<code>callback</code>ï¼Œä¾‹å¦‚<code>socket.on('close'[,fn])</code>æˆ–è€…<code>http.server.on('close, fn)</code>ã€‚</li>
</ul>
<p>å…·ä½“ç»†èŠ‚å¦‚ä¸‹ï¼š</p>
<h3>timers</h3>
<p>æ‰§è¡Œ<code>setTimeout</code>å’Œ<code>setInterval</code>ä¸­åˆ°æœŸçš„<code>callback</code>ï¼Œæ‰§è¡Œè¿™ä¸¤è€…å›è°ƒéœ€è¦è®¾ç½®ä¸€ä¸ªæ¯«ç§’æ•°ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œåº”è¯¥æ˜¯æ—¶é—´ä¸€åˆ°å°±ç«‹å³æ‰§è¡Œ callback å›è°ƒï¼Œä½†æ˜¯ç”±äº<code>system</code>çš„è°ƒåº¦å¯èƒ½ä¼šå»¶æ—¶ï¼Œè¾¾ä¸åˆ°é¢„æœŸæ—¶é—´ã€‚</p>
<hr>
<p>timerså®˜ç½‘æ–‡æ¡£è§£é‡Šå»¶è¿Ÿçš„ä¾‹å­ï¼š</p>
<p>å½“è¿›å…¥äº‹ä»¶å¾ªç¯æ—¶ï¼Œå®ƒæœ‰ä¸€ä¸ªç©ºé˜Ÿåˆ—ï¼ˆ<code>fs.readFile()</code>å°šæœªå®Œæˆï¼‰ï¼Œå› æ­¤å®šæ—¶å™¨å°†ç­‰å¾…å‰©ä½™æ¯«ç§’æ•°ï¼Œå½“åˆ°è¾¾ 95ms æ—¶ï¼Œ<code>fs.readFile()</code>å®Œæˆè¯»å–æ–‡ä»¶å¹¶ä¸”å…¶å®Œæˆéœ€è¦ 10 æ¯«ç§’çš„å›è°ƒè¢«æ·»åŠ åˆ°è½®è¯¢é˜Ÿåˆ—å¹¶æ‰§è¡Œã€‚<br>
å½“å›è°ƒç»“æŸæ—¶ï¼Œé˜Ÿåˆ—ä¸­ä¸å†æœ‰å›è°ƒï¼Œå› æ­¤äº‹ä»¶å¾ªç¯å°†çœ‹åˆ°å·²è¾¾åˆ°æœ€å¿«å®šæ—¶å™¨çš„<strong>é˜ˆå€¼</strong>ï¼Œç„¶åå›åˆ° <strong>timers é˜¶æ®µ</strong>ä»¥æ‰§è¡Œå®šæ—¶å™¨çš„å›è°ƒã€‚</p>
<pre><code>const fs = require('fs');

function someAsyncOperation(callback) {
  // Assume this takes 95ms to complete
  fs.readFile('/path/to/file', callback);
}

const timeoutScheduled = Date.now();

setTimeout(() =&gt; {
  const delay = Date.now() - timeoutScheduled;

  console.log(`${delay}ms have passed since I was scheduled`);
}, 100);


// do someAsyncOperation which takes 95 ms to complete
someAsyncOperation(() =&gt; {
  const startCallback = Date.now();

  // do something that will take 10ms...
  while (Date.now() - startCallback &lt; 10) {
    // do nothing
  }
});
</code></pre>
<h3>pending callbacks</h3>
<p>æ­¤é˜¶æ®µæ‰§è¡ŒæŸäº›ç³»ç»Ÿæ“ä½œï¼ˆä¾‹å¦‚ TCP é”™è¯¯ç±»å‹ï¼‰çš„å›è°ƒã€‚ ä¾‹å¦‚ï¼Œå¦‚æœ<code>TCP socket ECONNREFUSED</code>åœ¨å°è¯• connect æ—¶ receivesï¼Œåˆ™æŸäº› * nix ç³»ç»Ÿå¸Œæœ›ç­‰å¾…æŠ¥å‘Šé”™è¯¯ã€‚ è¿™å°†åœ¨<code>pending callbacks</code>é˜¶æ®µæ‰§è¡Œã€‚</p>
<h3>poll</h3>
<p><strong>è¯¥ poll é˜¶æ®µæœ‰ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼š</strong></p>
<ul>
<li>æ‰§è¡Œ<code>I/O</code>å›è°ƒã€‚</li>
<li>å¤„ç†è½®è¯¢é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ã€‚</li>
</ul>
<hr>
<p><strong>å½“äº‹ä»¶å¾ªç¯è¿›å…¥<code>poll</code>é˜¶æ®µå¹¶ä¸”åœ¨<code>timers</code>ä¸­æ²¡æœ‰å¯ä»¥æ‰§è¡Œå®šæ—¶å™¨æ—¶ï¼Œå°†å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€</strong></p>
<p>å¦‚æœ<code>poll</code>é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™äº‹ä»¶å¾ªç¯å°†éå†å…¶åŒæ­¥æ‰§è¡Œå®ƒä»¬çš„<code>callback</code>é˜Ÿåˆ—ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…è¾¾åˆ°<code>system-dependent</code>ï¼ˆç³»ç»Ÿç›¸å…³é™åˆ¶ï¼‰ã€‚</p>
<p><strong>å¦‚æœ<code>poll</code>é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šå‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€</strong></p>
<ul>
<li>å¦‚æœæœ‰<code>setImmediate()</code>å›è°ƒéœ€è¦æ‰§è¡Œï¼Œåˆ™ä¼šç«‹å³åœæ­¢æ‰§è¡Œ<code>poll</code>é˜¶æ®µå¹¶è¿›å…¥æ‰§è¡Œ<code>check</code>é˜¶æ®µä»¥æ‰§è¡Œå›è°ƒã€‚</li>
<li>å¦‚æœæ²¡æœ‰<code>setImmediate()</code>å›åˆ°éœ€è¦æ‰§è¡Œï¼Œpoll é˜¶æ®µå°†ç­‰å¾…<code>callback</code>è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åç«‹å³æ‰§è¡Œã€‚</li>
</ul>
<hr>
<p><strong>å½“ç„¶è®¾å®šäº† timer çš„è¯ä¸” poll é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ timer è¶…æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ä¼šå›åˆ° timer é˜¶æ®µæ‰§è¡Œå›è°ƒã€‚</strong></p>
<h3>check</h3>
<p><strong>æ­¤é˜¶æ®µå…è®¸äººå‘˜åœ¨ poll é˜¶æ®µå®Œæˆåç«‹å³æ‰§è¡Œå›è°ƒã€‚</strong><br>
å¦‚æœ<code>poll</code>é˜¶æ®µé—²ç½®å¹¶ä¸”<code>script</code>å·²æ’é˜Ÿ<code>setImmediate()</code>ï¼Œåˆ™äº‹ä»¶å¾ªç¯åˆ°è¾¾ check é˜¶æ®µæ‰§è¡Œè€Œä¸æ˜¯ç»§ç»­ç­‰å¾…ã€‚</p>
<hr>
<p><code>setImmediate()</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¡æ—¶å™¨ï¼Œå®ƒåœ¨äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå•ç‹¬é˜¶æ®µè¿è¡Œã€‚
å®ƒä½¿ç”¨<code>libuv API</code>æ¥è°ƒåº¦åœ¨<code>poll</code>é˜¶æ®µå®Œæˆåæ‰§è¡Œçš„å›è°ƒã€‚</p>
<p>é€šå¸¸ï¼Œå½“ä»£ç è¢«æ‰§è¡Œæ—¶ï¼Œäº‹ä»¶å¾ªç¯æœ€ç»ˆå°†è¾¾åˆ°<code>poll</code>é˜¶æ®µï¼Œå®ƒå°†ç­‰å¾…ä¼ å…¥è¿æ¥ï¼Œè¯·æ±‚ç­‰ã€‚<br>
ä½†æ˜¯ï¼Œå¦‚æœå·²ç»è°ƒåº¦äº†å›è°ƒ<code>setImmediate()</code>ï¼Œå¹¶ä¸”è½®è¯¢é˜¶æ®µå˜ä¸ºç©ºé—²ï¼Œåˆ™å®ƒå°†ç»“æŸå¹¶ä¸”åˆ°è¾¾<code>check</code>é˜¶æ®µï¼Œè€Œä¸æ˜¯ç­‰å¾…<code>poll</code>äº‹ä»¶ã€‚</p>
<pre><code>console.log('start')
setTimeout(() =&gt; {
  console.log('timer1')
  Promise.resolve().then(function() {
    console.log('promise1')
  })
}, 0)
setTimeout(() =&gt; {
  console.log('timer2')
  Promise.resolve().then(function() {
    console.log('promise2')
  })
}, 0)
Promise.resolve().then(function() {
  console.log('promise3')
})
console.log('end')
</code></pre>
<p>å¦‚æœ<code>node</code>ç‰ˆæœ¬ä¸º<code>v11.x</code>ï¼Œ å…¶ç»“æœä¸æµè§ˆå™¨ä¸€è‡´ã€‚</p>
<pre><code>start
end
promise3
timer1
promise1
timer2
promise2
</code></pre>
<p>å¦‚æœ v10 ç‰ˆæœ¬ä¸Šè¿°ç»“æœå­˜åœ¨ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœ time2 å®šæ—¶å™¨å·²ç»åœ¨æ‰§è¡Œé˜Ÿåˆ—ä¸­äº†</li>
</ul>
<pre><code>start
end
promise3
timer1
timer2
promise1
promise2
</code></pre>
<ul>
<li>å¦‚æœ time2 å®šæ—¶å™¨æ²¡æœ‰åœ¨æ‰§è¡Œå¯¹åˆ—ä¸­ï¼Œæ‰§è¡Œç»“æœä¸º</li>
</ul>
<pre><code>start
end
promise3
timer1
promise1
timer2
promise2
</code></pre>
<h2>setImmediate() çš„ setTimeout() çš„åŒºåˆ«</h2>
<p><strong><code>setImmediate</code>å’Œ<code>setTimeout()</code>æ˜¯ç›¸ä¼¼çš„ï¼Œä½†æ ¹æ®å®ƒä»¬è¢«è°ƒç”¨çš„æ—¶é—´ä»¥ä¸åŒçš„æ–¹å¼è¡¨ç°ã€‚</strong></p>
<ul>
<li><code>setImmediate()</code>è®¾è®¡ç”¨äºåœ¨å½“å‰<code>poll</code>é˜¶æ®µå®Œæˆå check é˜¶æ®µæ‰§è¡Œè„šæœ¬ ã€‚</li>
<li><code>setTimeout()</code> å®‰æ’åœ¨ç»è¿‡æœ€å°ï¼ˆmsï¼‰åè¿è¡Œçš„è„šæœ¬ï¼Œåœ¨<code>timers</code>é˜¶æ®µæ‰§è¡Œã€‚</li>
</ul>
<h3>setImmediate() çš„ setTimeout() çš„åŒºåˆ«ä¾‹å­</h3>
<p>**æ‰§è¡Œå®šæ—¶å™¨çš„é¡ºåºå°†æ ¹æ®è°ƒç”¨å®ƒä»¬çš„ä¸Šä¸‹æ–‡è€Œæœ‰æ‰€ä¸åŒã€‚ å¦‚æœä»ä¸»æ¨¡å—ä¸­è°ƒç”¨ä¸¤è€…ï¼Œé‚£ä¹ˆæ—¶é—´å°†å—åˆ°è¿›ç¨‹æ€§èƒ½çš„é™åˆ¶ã€‚**<strong>å…¶ç»“æœä¹Ÿä¸ä¸€è‡´</strong>
<strong>å¦‚æœåœ¨<code>I / O</code>å‘¨æœŸå†…ç§»åŠ¨ä¸¤ä¸ªè°ƒç”¨ï¼Œåˆ™å§‹ç»ˆé¦–å…ˆæ‰§è¡Œç«‹å³å›è°ƒï¼š</strong></p>
<pre><code>const fs = require('fs');

fs.readFile(__filename, () =&gt; {
  setTimeout(() =&gt; {
    console.log('timeout');
  }, 0);
  setImmediate(() =&gt; {
    console.log('immediate');
  });
});
</code></pre>
<p>å…¶ç»“æœå¯ä»¥ç¡®å®šä¸€å®šæ˜¯<code>immediate =&gt; timeout</code>ã€‚<br>
ä¸»è¦åŸå› æ˜¯åœ¨<code>I/Oé˜¶æ®µ</code>è¯»å–æ–‡ä»¶åï¼Œäº‹ä»¶å¾ªç¯ä¼šå…ˆè¿›å…¥<code>poll</code>é˜¶æ®µï¼Œå‘ç°æœ‰<code>setImmediate</code>éœ€è¦æ‰§è¡Œï¼Œä¼šç«‹å³è¿›å…¥<code>check</code>é˜¶æ®µæ‰§è¡Œ<code>setImmediate</code>çš„å›è°ƒã€‚</p>
<p>ç„¶åå†è¿›å…¥<code>timers</code>é˜¶æ®µï¼Œæ‰§è¡Œ<code>setTimeout</code>ï¼Œæ‰“å°<code>timeout</code>ã€‚</p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€&gt;â”‚           timers          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚&lt;â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2>Process.nextTick()</h2>
<p><strong><code>process.nextTick()</code>è™½ç„¶å®ƒæ˜¯å¼‚æ­¥ API çš„ä¸€éƒ¨åˆ†ï¼Œä½†æœªåœ¨å›¾ä¸­æ˜¾ç¤ºã€‚è¿™æ˜¯å› ä¸º<code>process.nextTick()</code>ä»æŠ€æœ¯ä¸Šè®²ï¼Œå®ƒä¸æ˜¯äº‹ä»¶å¾ªç¯çš„ä¸€éƒ¨åˆ†ã€‚</strong></p>
<hr>
<p><code>process.nextTick()</code>æ–¹æ³•å°† <code>callback</code> æ·»åŠ åˆ°<code>next tick</code>é˜Ÿåˆ—ã€‚ ä¸€æ—¦å½“å‰äº‹ä»¶è½®è¯¢é˜Ÿåˆ—çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œåœ¨<code>next tick</code>é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰<code>callbacks</code>ä¼šè¢«ä¾æ¬¡è°ƒç”¨ã€‚</p>
<p><strong>æ¢ç§ç†è§£æ–¹å¼ï¼š</strong>  å½“æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¦‚æœå­˜åœ¨ <code>nextTick</code> é˜Ÿåˆ—ï¼Œå°±ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä¼˜å…ˆäºå…¶ä»– <code>microtask</code> æ‰§è¡Œã€‚</p>
<h3>Process.nextTick()ä¾‹å­</h3>
<pre><code>let bar;

setTimeout(() =&gt; {
  console.log('setTimeout');
}, 0)

setImmediate(() =&gt; {
  console.log('setImmediate');
})
function someAsyncApiCall(callback) {
  process.nextTick(callback);
}

someAsyncApiCall(() =&gt; {
  console.log('bar', bar); // 1
});

bar = 1;
</code></pre>
<p>åœ¨ NodeV10 ä¸­ä¸Šè¿°ä»£ç æ‰§è¡Œå¯èƒ½æœ‰ä¸¤ç§ç­”æ¡ˆï¼Œä¸€ç§ä¸ºï¼š</p>
<pre><code>bar 1
setTimeout
setImmediate
</code></pre>
<p>å¦ä¸€ç§ä¸ºï¼š</p>
<pre><code>bar 1
setImmediate
setTimeout
</code></pre>
<p>æ— è®ºå“ªç§ï¼Œå§‹ç»ˆéƒ½æ˜¯å…ˆæ‰§è¡Œ<code>process.nextTick(callback)</code>ï¼Œæ‰“å°<code>bar 1</code>ã€‚</p>
<h1> </h1>
<h1>ä¸€ç¯‡æ–‡ç« æ€»ç»“ reduxã€react-reduxã€redux-saga</h1><blockquote>
<p>åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/6844903846666321934?searchId=202307221642455A486F0EE437F36B080F">juejin.cn</a></p>
</blockquote>
<p>React æœ‰ props å’Œ state:</p>
<ol>
<li>props æ„å‘³ç€çˆ¶çº§åˆ†å‘ä¸‹æ¥çš„å±æ€§</li>
<li>state æ„å‘³ç€ç»„ä»¶å†…éƒ¨å¯ä»¥è‡ªè¡Œç®¡ç†çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ•´ä¸ª React æ²¡æœ‰æ•°æ®å‘ä¸Šå›æº¯çš„èƒ½åŠ›ï¼Œè¿™å°±æ˜¯ react çš„å•å‘æ•°æ®æµ</li>
</ol>
<h2>æœ‰æ—¶å€™å‘ç° <strong>React æ ¹æœ¬æ— æ³•è®©ä¸¤ä¸ªç»„ä»¶äº’ç›¸äº¤æµ</strong>ï¼Œä½¿ç”¨å¯¹æ–¹çš„æ•°æ®ï¼Œreact çš„é€šè¿‡å±‚çº§ä¼ é€’æ•°æ®çš„è¿™ç§æ–¹æ³•æ˜¯éå¸¸éš¾å—çš„ï¼Œ
redux<strong>æŠŠæ‰€æœ‰çš„ state é›†ä¸­åˆ°ç»„ä»¶é¡¶éƒ¨ï¼Œèƒ½å¤Ÿçµæ´»çš„å°†æ‰€æœ‰ state å„å–æ‰€éœ€çš„åˆ†å‘ç»™æ‰€æœ‰çš„ç»„ä»¶</strong>
redux æ˜¯çš„è¯ç”Ÿæ˜¯ä¸ºäº†ç»™ React åº”ç”¨æä¾›ã€Œå¯é¢„æµ‹åŒ–çš„çŠ¶æ€ç®¡ç†ã€æœºåˆ¶ã€‚
reduxç®€ä»‹</h2>
<p>Redux ä¼šå°†**æ•´ä¸ªåº”ç”¨çŠ¶æ€ (å…¶å®ä¹Ÿå°±æ˜¯æ•°æ®) å­˜å‚¨åˆ°åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œç§°ä¸º store,è¿™ä¸ª store é‡Œé¢ä¿å­˜ä¸€æ£µçŠ¶æ€æ ‘ (state tree)</p>
<hr>
<p>ç»„ä»¶æ”¹å˜ state çš„å”¯ä¸€æ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨ store çš„ dispatch æ–¹æ³•ï¼Œè§¦å‘ä¸€ä¸ª actionï¼Œè¿™ä¸ª action è¢«å¯¹åº”çš„ reducer å¤„ç†ï¼Œäºæ˜¯ state å®Œæˆæ›´æ–°</p>
<hr>
<p>ç»„ä»¶å¯ä»¥æ´¾å‘ (dispatch) è¡Œä¸º (action) ç»™ store, è€Œä¸æ˜¯ç›´æ¥é€šçŸ¥å…¶å®ƒç»„ä»¶,å…¶å®ƒç»„ä»¶**å¯ä»¥é€šè¿‡è®¢é˜… store ä¸­çš„çŠ¶æ€ (state) æ¥åˆ·æ–°è‡ªå·±çš„è§†å›¾</p>
<hr>
<p>æµç¨‹å›¾ï¼Œæ–¹ä¾¿ç†è§£ redux çš„å·¥ä½œæµç¨‹
<img src="./Pasted image 20230814120443.png" /></p>
<h2>ä½¿ç”¨æ­¥éª¤</h2>
<ol>
<li><strong>åˆ›å»º reducer</strong></li>
<li><strong>åˆ›å»º action</strong></li>
<li><strong>åˆ›å»ºçš„ storeï¼Œä½¿ç”¨ createStore æ–¹æ³•</strong></li>
</ol>
<hr>
<ol>
<li><strong>åˆ›å»º reducer</strong>
<ul>
<li>å¯ä»¥ä½¿ç”¨å•ç‹¬çš„ä¸€ä¸ª reducer, ä¹Ÿå¯ä»¥å°†å¤šä¸ª reducer åˆå¹¶ä¸ºä¸€ä¸ª reducerï¼Œå³ï¼š<code>combineReducers()</code></li>
<li>action å‘å‡ºå‘½ä»¤åå°† state æ”¾å…¥ reucer åŠ å·¥å‡½æ•°ä¸­ï¼Œè¿”å›æ–°çš„ state, å¯¹ state è¿›è¡ŒåŠ å·¥å¤„ç†</li>
</ul>
</li>
</ol>
<hr>
<ol start="2">
<li><strong>åˆ›å»º action</strong>
<ul>
<li>ç”¨æˆ·æ˜¯æ¥è§¦ä¸åˆ° state çš„ï¼Œåªèƒ½æœ‰ view è§¦å‘ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ª action å¯ä»¥ç†è§£ä¸ºæŒ‡ä»¤ï¼Œéœ€è¦å‘å‡ºå¤šå°‘åŠ¨ä½œå°±æœ‰å¤šå°‘æŒ‡ä»¤</li>
<li>action æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªå« type çš„å‚æ•°ï¼Œå®šä¹‰ action ç±»å‹</li>
</ul>
</li>
</ol>
<hr>
<ol start="3">
<li><strong>åˆ›å»ºçš„ storeï¼Œä½¿ç”¨ createStore æ–¹æ³•</strong>
<ul>
<li>store å¯ä»¥ç†è§£ä¸ºæœ‰å¤šä¸ªåŠ å·¥æœºå™¨çš„æ€»å·¥å‚</li>
<li>æä¾› subscribeï¼Œdispatchï¼ŒgetState è¿™äº›æ–¹æ³•ã€‚</li>
</ul>
</li>
</ol>
<h2>æŒ‰æ­¥éª¤æ‰‹æŠŠæ‰‹å®æˆ˜ã€‚</h2>
<p>ä¸Šè¿°æ­¥éª¤ï¼Œå¯¹åº”çš„åºå·ï¼Œæˆ‘ä¼šåœ¨ç›¸å…³ä»£ç æ ‡å‡º</p>
<ol>
<li><strong>åˆ›å»º reducer</strong></li>
<li><strong>åˆ›å»º action</strong></li>
<li><strong>åˆ›å»ºçš„ storeï¼Œä½¿ç”¨ createStore æ–¹æ³•</strong></li>
</ol>
<pre><code>npm install redux -S // å®‰è£…

import { createStore } from 'redux' // å¼•å…¥

const reducer = (state = {count: 0}, action) =&gt; {----------&gt; â‘´
  switch (action.type){
    case 'INCREASE': return {count: state.count + 1};
    case 'DECREASE': return {count: state.count - 1};
    default: return state;
  }
}

const actions = {----------&gt;â‘µ
  increase: () =&gt; ({type: 'INCREASE'}),
  decrease: () =&gt; ({type: 'DECREASE'})
}

const store = createStore(reducer);----------&gt;â‘¶

store.subscribe(() =&gt;
  console.log(store.getState())
);

store.dispatch(actions.increase()) // {count: 1}
store.dispatch(actions.increase()) // {count: 2}
store.dispatch(actions.increase()) // {count: 3}
</code></pre>
<h1>react-redux</h1>
<p>åˆšå¼€å§‹å°±è¯´äº†ï¼Œå¦‚æœæŠŠ store ç›´æ¥é›†æˆåˆ° React åº”ç”¨çš„é¡¶å±‚ props é‡Œé¢ï¼Œåªè¦å„ä¸ªå­ç»„ä»¶èƒ½è®¿é—®åˆ°é¡¶å±‚ props å°±è¡Œäº†ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p>
<pre><code>&lt;é¡¶å±‚ç»„ä»¶ store={store}&gt;
  &lt;App /&gt;
&lt;/é¡¶å±‚ç»„ä»¶&gt;
</code></pre>
<h2>è¿™å°±æ˜¯ react-reduxã€‚Redux å®˜æ–¹æä¾›çš„ React ç»‘å®šåº“ã€‚ å…·æœ‰é«˜æ•ˆä¸”çµæ´»çš„ç‰¹æ€§ã€‚
<strong>React Redux å°†ç»„ä»¶åŒºåˆ†ä¸º å®¹å™¨ç»„ä»¶ å’Œ UI ç»„ä»¶</strong></h2>
<ol>
<li>å®¹å™¨ç»„ä»¶ä¼šå¤„ç†é€»è¾‘</li>
<li>UI ç»„ä»¶åªè´Ÿè´£æ˜¾ç¤ºå’Œäº¤äº’ï¼Œå†…éƒ¨ä¸å¤„ç†é€»è¾‘ï¼ŒçŠ¶æ€å®Œå…¨ç”±å¤–éƒ¨æŒæ§</li>
</ol>
<h2>**React Redux ä¸¤ä¸ªæ ¸å¿ƒ</h2>
<p>Providerå’Œ connect</p>
<ul>
<li>
<h3>Provider</h3>
</li>
</ul>
<p>çœ‹æˆ‘ä¸Šè¾¹é‚£ä¸ªä»£ç çš„<strong>é¡¶å±‚ç»„ä»¶</strong>è¿™ä¸ªé¡¶çº§ç»„ä»¶å°±æ˜¯ Provider, ä¸€èˆ¬æˆ‘ä»¬éƒ½å°†
é¡¶å±‚ç»„ä»¶åŒ…è£¹åœ¨ Provider ç»„ä»¶ä¹‹ä¸­ï¼Œå› ä¸ºè¿™ä¸ªç»„ä»¶çš„ç›®çš„æ˜¯è®©æ‰€æœ‰ç»„ä»¶éƒ½èƒ½å¤Ÿè®¿é—®åˆ°Reduxä¸­çš„æ•°æ®ã€‚
store å¿…é¡»ä½œä¸ºå‚æ•°æ”¾åˆ° Provider ç»„ä»¶ä¸­å»</p>
<pre><code>&lt;Provider store = {store}&gt;
	&lt;App /&gt;
&lt;Provider&gt;
</code></pre>
<ul>
<li>
<h3>connect</h3>
</li>
</ul>
<p>è¿™æ˜¯ react-redux ä¸­æ¯”è¾ƒéš¾çš„éƒ¨åˆ†</p>
<p>é¦–å…ˆï¼Œå…ˆè®°ä½ä¸‹è¾¹çš„è¿™è¡Œä»£ç ï¼š</p>
<pre><code>connect(mapStateToProps, mapDispatchToProps)(MyComponent)
</code></pre>
<h4>mapStateToProps</h4>
<p>è¿™ä¸ªå•è¯ç¿»è¯‘è¿‡æ¥å°±æ˜¯<strong>æŠŠ state æ˜ å°„åˆ° props ä¸­å»</strong> , å°±æ˜¯<strong>æŠŠ Redux ä¸­çš„æ•°æ®æ˜ å°„åˆ° React ä¸­çš„ props ä¸­å»ã€‚</strong></p>
<pre><code>const mapStateToProps = (state) =&gt; {
      return {
      	// prop : state.xxx  | æ„æ€æ˜¯å°†stateä¸­çš„æŸä¸ªæ•°æ®æ˜ å°„åˆ°propsä¸­
        foo: state.bar
      }
    }
</code></pre>
<p>ç„¶åæ¸²æŸ“çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ this.props.foo</p>
<pre><code>class Foo extends Component {
    constructor(props){
        super(props);
    }
    render(){
        return(
        	// è¿™æ ·å­æ¸²æŸ“çš„å…¶å®å°±æ˜¯state.barçš„æ•°æ®äº†
            &lt;div&gt;this.props.foo&lt;/div&gt;
        )
    }
}
Foo = connect()(Foo);
export default Foo;
</code></pre>
<p>ç„¶åè¿™æ ·å°±å¯ä»¥å®Œæˆæ¸²æŸ“äº†</p>
<h4>mapDispatchToProps</h4>
<p>è¿™ä¸ªå•è¯ç¿»è¯‘è¿‡æ¥å°±æ˜¯å°±æ˜¯<strong>æŠŠå„ç§ dispatch ä¹Ÿå˜æˆäº† props è®©ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨</strong></p>
<pre><code>const mapDispatchToProps = (dispatch) =&gt; { // é»˜è®¤ä¼ é€’å‚æ•°å°±æ˜¯dispatch
  return {
    onClick: () =&gt; {
      dispatch({
        type: 'increatment'
      });
    }
  };
}
</code></pre>
<pre><code>class Foo extends Component {
    constructor(props){
        super(props);
    }
    render(){
        return(
        	
             &lt;button onClick = {this.props.onClick}&gt;ç‚¹å‡»increase&lt;/button&gt;
        )
    }
}
Foo = connect()(Foo);
export default Foo;
</code></pre>
<p>ç»„ä»¶ä¹Ÿå°±æ”¹æˆäº†ä¸Šè¾¹è¿™æ ·ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ this.props.onClickï¼Œæ¥è°ƒç”¨ dispatch, è¿™æ ·å­å°±ä¸éœ€è¦åœ¨ä»£ç ä¸­æ¥è¿›è¡Œ store.dispatch äº†</p>
<p>react-redux çš„åŸºæœ¬ä»‹ç»å°±åˆ°è¿™é‡Œäº†</p>
<h1>redux-saga</h1>
<p>å¦‚æœæŒ‰ç…§åŸå§‹çš„ redux å·¥ä½œæµç¨‹ï¼Œå½“ç»„ä»¶ä¸­äº§ç”Ÿä¸€ä¸ª action åä¼šç›´æ¥è§¦å‘ reducer ä¿®æ”¹ stateï¼Œreducer åˆæ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½å† reducer ä¸­è¿›è¡Œå¼‚æ­¥æ“ä½œï¼›</p>
<p><strong>è€Œå¾€å¾€å®é™…ä¸­ï¼Œç»„ä»¶ä¸­å‘ç”Ÿçš„ action åï¼Œåœ¨è¿›å…¥ reducer ä¹‹å‰éœ€è¦å®Œæˆä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡, æ¯”å¦‚å‘é€ ajax è¯·æ±‚åæ‹¿åˆ°æ•°æ®åï¼Œå†è¿›å…¥ reducer, æ˜¾ç„¶åŸç”Ÿçš„ redux æ˜¯ä¸æ”¯æŒè¿™ç§æ“ä½œçš„</strong></p>
<p>è¿™ä¸ªæ—¶å€™æ€¥éœ€ä¸€ä¸ªä¸­é—´ä»¶æ¥å¤„ç†è¿™ç§ä¸šåŠ¡åœºæ™¯ï¼Œç›®å‰æœ€ä¼˜é›…çš„å¤„ç†æ–¹å¼è‡ªç„¶å°±æ˜¯ redux-saga</p>
<h2>redux-sagaæ ¸å¿ƒè®²è§£</h2>
<ul>
<li>Saga è¾…åŠ©å‡½æ•°</li>
<li>Effect Creators</li>
</ul>
<h3><strong>1ã€Saga è¾…åŠ©å‡½æ•°</strong></h3>
<p>redux-saga æä¾›äº†ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œç”¨æ¥åœ¨ä¸€äº›ç‰¹å®šçš„ action è¢«å‘èµ·åˆ° Store æ—¶æ´¾ç”Ÿä»»åŠ¡ï¼Œä¸‹é¢æˆ‘å…ˆæ¥è®²è§£ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼š<code>takeEvery</code> å’Œ <code>takeLatest</code></p>
<h4>takeEvery</h4>
<p><strong>takeEvery å°±åƒä¸€ä¸ªæµæ°´çº¿çš„æ´—ç¢—å·¥ï¼Œè¿‡æ¥ä¸€ä¸ªè„ç›˜å­å°±ç›´æ¥æ‰§è¡Œåé¢çš„æ´—ç¢—å‡½æ•°ï¼Œä¸€æ—¦ä½ è¯·äº†è¿™ä¸ªæ´—ç¢—å·¥ä»–ä¼šä¸€ç›´æ‰§è¡Œè¿™ä¸ªå·¥ä½œï¼Œç»å¯¹ä¸ä¼šåœæ­¢æ¥ç›˜å­çš„ç›‘å¬è¿‡ç¨‹å’Œè§¦å‘æ´—ç›˜å­å‡½æ•°</strong></p>
<h4>takeEveryä¾‹å­</h4>
<p>ä¾‹å¦‚ï¼šæ¯æ¬¡ç‚¹å‡» æŒ‰é’®å» Fetch è·å–æ•°æ®æ—¶æ—¶ï¼Œæˆ‘ä»¬å‘èµ·ä¸€ä¸ª FETCH_REQUESTED çš„ actionã€‚
æˆ‘ä»¬æƒ³é€šè¿‡å¯åŠ¨ä¸€ä¸ªä»»åŠ¡ä»æœåŠ¡å™¨è·å–ä¸€äº›æ•°æ®ï¼Œæ¥å¤„ç†è¿™ä¸ª actionï¼Œç±»ä¼¼äº</p>
<pre><code>window.addEventLister('xxx',fn)
</code></pre>
<p>å½“ dispatch xxx çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œ fn æ–¹æ³•ï¼Œ</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå°†æ‰§è¡Œå¼‚æ­¥ action çš„ä»»åŠ¡ (ä¹Ÿå°±æ˜¯ä¸Šè¾¹çš„ fnï¼‰ï¼Œç„¶ååœ¨æ¯æ¬¡ FETCH_REQUESTED action è¢«å‘èµ·æ—¶å¯åŠ¨ä¸Šé¢çš„ä»»åŠ¡, ä¹Ÿå°±<strong>ç›¸å½“äºæ¯æ¬¡è§¦å‘ä¸€ä¸ªåå­—ä¸º FETCH_REQUESTED çš„ action å°±ä¼šæ‰§è¡Œä¸Šè¾¹çš„ä»»åŠ¡</strong></p>
<p>åˆ›å»ºå°†æ‰§è¡Œå¼‚æ­¥ action çš„ä»»åŠ¡</p>
<pre><code>// putï¼šä½ å°±è®¤ä¸ºputå°±ç­‰äº dispatchå°±å¯ä»¥äº†ï¼›

// callï¼šå¯ä»¥ç†è§£ä¸ºå®è¡Œä¸€ä¸ªå¼‚æ­¥å‡½æ•°,æ˜¯é˜»å¡å‹çš„ï¼Œåªæœ‰è¿è¡Œå®Œåé¢çš„å‡½æ•°ï¼Œæ‰ä¼šç»§ç»­å¾€ä¸‹ï¼›
// åœ¨è¿™é‡Œå¯ä»¥ç‰‡é¢çš„ç†è§£ä¸ºasyncä¸­çš„awaitï¼ä½†å†™æ³•ç›´è§‚å¤šäº†ï¼
import { call, put } from 'redux-saga/effects'

export function* fetchData(action) {
   try {
      const apiAjax = (params) =&gt; fetch(url, params);
      const data = yield call(apiAjax);
      yield put({type: &quot;FETCH_SUCCEEDED&quot;, data});
   } catch (error) {
      yield put({type: &quot;FETCH_FAILED&quot;, error});
   }
}
</code></pre>
<p>æ¯æ¬¡è§¦å‘ä¸€ä¸ªåå­—ä¸º FETCH_REQUESTED çš„ action å°±ä¼šæ‰§è¡Œä¸Šè¾¹çš„ä»»åŠ¡, ä»£ç å¦‚ä¸‹</p>
<pre><code>import { takeEvery } from 'redux-saga'

function* watchFetchData() {

  yield* takeEvery(&quot;FETCH_REQUESTED&quot;, fetchData)
}
</code></pre>
<p>takeEvery å‡½æ•°å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å†™æ³•æ›¿æ¢</p>
<pre><code>function* watchFetchData() {
  
   while(true){
     yield take('FETCH_REQUESTED');
     yield fork(fetchData);
   }
}
</code></pre>
<h4>takeLatest</h4>
<p>takeEvery <strong>å…è®¸å¤šä¸ª fetchData å®ä¾‹åŒæ—¶å¯åŠ¨</strong>ï¼Œåœ¨æŸä¸ªç‰¹å®šæ—¶åˆ»ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä¸€ä¸ªæ–°çš„ fetchData ä»»åŠ¡ï¼Œ å°½ç®¡ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª fetchData å°šæœªç»“æŸ</p>
<p>å¦‚æœæˆ‘ä»¬<strong>åªæƒ³å¾—åˆ°æœ€æ–°é‚£ä¸ªè¯·æ±‚çš„å“åº”</strong>ï¼ˆä¾‹å¦‚ï¼Œå§‹ç»ˆæ˜¾ç¤ºæœ€æ–°ç‰ˆæœ¬çš„æ•°æ®ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ takeLatest è¾…åŠ©å‡½æ•°</p>
<pre><code>import { takeLatest } from 'redux-saga'

function* watchFetchData() {
  yield* takeLatest('FETCH_REQUESTED', fetchData)
}
</code></pre>
<p><strong>å’Œ takeEvery ä¸åŒï¼Œåœ¨ä»»ä½•æ—¶åˆ» takeLatest åªå…è®¸æ‰§è¡Œä¸€ä¸ª fetchData ä»»åŠ¡ï¼Œå¹¶ä¸”è¿™ä¸ªä»»åŠ¡æ˜¯æœ€åè¢«å¯åŠ¨çš„é‚£ä¸ªï¼Œå¦‚æœä¹‹å‰å·²ç»æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œé‚£ä¹‹å‰çš„è¿™ä¸ªä»»åŠ¡ä¼šè‡ªåŠ¨è¢«å–æ¶ˆ</strong></p>
<h3><strong>2ã€Effect Creators</strong></h3>
<p>redux-saga æ¡†æ¶æä¾›äº†å¾ˆå¤šåˆ›å»º effect çš„å‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥ç®€å•çš„ä»‹ç»ä¸‹å¼€å‘ä¸­æœ€å¸¸ç”¨çš„å‡ ç§</p>
<ul>
<li>take(pattern)</li>
<li>put(action)</li>
<li>call(fn, ...args)</li>
<li>fork(fn, ...args)</li>
<li>select(selector, ...args)</li>
</ul>
<h4><strong>take(pattern)</strong></h4>
<p>take å‡½æ•°å¯ä»¥ç†è§£ä¸ºç›‘å¬æœªæ¥çš„ actionï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªå‘½ä»¤å¯¹è±¡ï¼Œå‘Šè¯‰ middleware ç­‰å¾…ä¸€ä¸ªç‰¹å®šçš„ actionï¼Œ Generator ä¼šæš‚åœï¼Œç›´åˆ°ä¸€ä¸ªä¸ pattern åŒ¹é…çš„ action è¢«å‘èµ·ï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œtake æ˜¯ä¸€ä¸ªé˜»å¡çš„ effect</p>
<p>ç”¨æ³•ï¼š</p>
<pre><code>function* watchFetchData() {
   while(true) {
   // ç›‘å¬ä¸€ä¸ªtypeä¸º 'FETCH_REQUESTED' çš„actionçš„æ‰§è¡Œï¼Œç›´åˆ°ç­‰åˆ°è¿™ä¸ªActionè¢«è§¦å‘ï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œä¸‹é¢çš„ 		yield fork(fetchData)  è¯­å¥
     yield take('FETCH_REQUESTED');
     yield fork(fetchData);
   }
}
</code></pre>
<h4><strong>put(action)</strong></h4>
<p>put å‡½æ•°æ˜¯ç”¨æ¥å‘é€ action çš„ effectï¼Œä½ å¯ä»¥ç®€å•çš„<strong>æŠŠå®ƒç†è§£æˆä¸º redux æ¡†æ¶ä¸­çš„ dispatch å‡½æ•°</strong>ï¼Œå½“ put ä¸€ä¸ª action åï¼Œreducer ä¸­å°±ä¼šè®¡ç®—æ–°çš„ state å¹¶è¿”å›ï¼Œ<strong>æ³¨æ„ï¼š</strong> <strong>put ä¹Ÿæ˜¯é˜»å¡ effect</strong></p>
<p>ç”¨æ³•ï¼š</p>
<pre><code>export function* toggleItemFlow() {
    let list = []
    // å‘é€ä¸€ä¸ªtypeä¸º 'UPDATE_DATA' çš„Actionï¼Œç”¨æ¥æ›´æ–°æ•°æ®ï¼Œå‚æ•°ä¸º `dataï¼šlist`
    yield put({
      type: actionTypes.UPDATE_DATA,
      data: list
    })
}
</code></pre>
<h4><strong>call(fn, ...args)</strong></h4>
<p><strong>call å‡½æ•°ä½ å¯ä»¥æŠŠå®ƒç®€å•çš„ç†è§£ä¸ºå°±æ˜¯å¯ä»¥è°ƒç”¨å…¶ä»–å‡½æ•°çš„å‡½æ•°</strong>ï¼Œå®ƒå‘½ä»¤ middleware æ¥è°ƒç”¨ fn å‡½æ•°ï¼Œ args ä¸ºå‡½æ•°çš„å‚æ•°ï¼Œ<strong>æ³¨æ„ï¼š</strong> <strong>fn å‡½æ•°å¯ä»¥æ˜¯ä¸€ä¸ª Generator å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¿”å› Promise çš„æ™®é€šå‡½æ•°</strong>ï¼Œcall å‡½æ•°ä¹Ÿæ˜¯<strong>é˜»å¡ effect</strong></p>
<p>ç”¨æ³•ï¼š</p>
<pre><code>export const delay = ms =&gt; new Promise(resolve =&gt; setTimeout(resolve, ms))

export function* removeItem() {
  try {
    // è¿™é‡Œcall å‡½æ•°å°±è°ƒç”¨äº† delay å‡½æ•°ï¼Œdelay å‡½æ•°ä¸ºä¸€ä¸ªè¿”å›promise çš„å‡½æ•°
    return yield call(delay, 500)
  } catch (err) {
    yield put({type: actionTypes.ERROR})
  }
}
</code></pre>
<h4><strong>fork(fn, ...args)</strong></h4>
<p>fork å‡½æ•°å’Œ call å‡½æ•°å¾ˆåƒï¼Œ<strong>éƒ½æ˜¯ç”¨æ¥è°ƒç”¨å…¶ä»–å‡½æ•°çš„ï¼Œä½†æ˜¯ fork å‡½æ•°æ˜¯éé˜»å¡å‡½æ•°</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ç¨‹åºæ‰§è¡Œå®Œ <code>yield fork(fnï¼Œ args)</code> è¿™ä¸€è¡Œä»£ç åï¼Œä¼šç«‹å³æ¥ç€æ‰§è¡Œä¸‹ä¸€è¡Œä»£ç è¯­å¥ï¼Œè€Œä¸ä¼šç­‰å¾… fn å‡½æ•°è¿”å›ç»“æœå</strong>ï¼Œåœ¨æ‰§è¡Œä¸‹é¢çš„è¯­å¥</p>
<p>ç”¨æ³•ï¼š</p>
<pre><code>import { fork } from 'redux-saga/effects'

export default function* rootSaga() {
  // ä¸‹é¢çš„å››ä¸ª Generator å‡½æ•°ä¼šä¸€æ¬¡æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡æ‰§è¡Œ
  yield fork(addItemFlow)
  yield fork(removeItemFlow)
  yield fork(toggleItemFlow)
  yield fork(modifyItem)
}
</code></pre>
<h4><strong>select(selector, ...args)</strong></h4>
<p>select å‡½æ•°æ˜¯ç”¨æ¥æŒ‡ç¤º middleware è°ƒç”¨æä¾›çš„é€‰æ‹©å™¨è·å– Store ä¸Šçš„ state æ•°æ®ï¼Œä½ ä¹Ÿå¯ä»¥ç®€å•çš„æŠŠå®ƒç†è§£ä¸º <strong>redux æ¡†æ¶ä¸­è·å– store ä¸Šçš„ state æ•°æ®ä¸€æ ·çš„åŠŸèƒ½</strong> ï¼š<code>store.getState()</code></p>
<p>ç”¨æ³•ï¼š</p>
<pre><code>export function* toggleItemFlow() {
     // é€šè¿‡ select effect æ¥è·å– å…¨å±€ stateä¸Šçš„ `getTodoList` ä¸­çš„ list
     let tempList = yield select(state =&gt; state.getTodoList.list)
}
</code></pre>
<h1>ä¸€ä¸ªå…·ä½“çš„å®ä¾‹</h1>
<p>**index.js **</p>
<pre><code>import React from 'react';
import ReactDOM from 'react-dom';
import {createStore, applyMiddleware} from 'redux'
import createSagaMiddleware from 'redux-saga'

import rootSaga from './sagas'
import Counter from './Counter'
import rootReducer from './reducers'

const sagaMiddleware = createSagaMiddleware() // åˆ›å»ºäº†ä¸€ä¸ªsagaä¸­é—´ä»¶å®ä¾‹

// ä¸‹è¾¹è¿™å¥è¯å’Œä¸‹è¾¹çš„ä¸¤è¡Œä»£ç åˆ›å»ºstoreçš„æ–¹å¼æ˜¯ä¸€æ ·çš„
// const store = createStore(reducers,applyMiddlecare(middlewares))

const createStoreWithMiddleware = applyMiddleware(middlewares)(createStore)
const store = createStoreWithMiddleware(rootReducer)

sagaMiddleware.run(rootSaga)

const action = type =&gt; store.dispatch({ type })

function render() {
  ReactDOM.render(
    &lt;Counter
      value={store.getState()}
      onIncrement={() =&gt; action('INCREMENT')}
      onDecrement={() =&gt; action('DECREMENT')}
      onIncrementAsync={() =&gt; action('INCREMENT_ASYNC')} /&gt;,
    document.getElementById('root')
  )
}

render()

store.subscribe(render)
</code></pre>
<p><strong>sagas.js</strong></p>
<pre><code>import { put, call, take,fork } from 'redux-saga/effects';
import { takeEvery, takeLatest } from 'redux-saga'

export const delay = ms =&gt; new Promise(resolve =&gt; setTimeout(resolve, ms));

function* incrementAsync() {
  // å»¶è¿Ÿ 1s åœ¨æ‰§è¡Œ + 1æ“ä½œ
  yield call(delay, 1000);
  yield put({ type: 'INCREMENT' });
}

export default function* rootSaga() {
  // while(true){
  //   yield take('INCREMENT_ASYNC');
  //   yield fork(incrementAsync);
  // }

  // ä¸‹é¢çš„å†™æ³•ä¸ä¸Šé¢çš„å†™æ³•ä¸Šç­‰æ•ˆ
  yield* takeEvery(&quot;INCREMENT_ASYNC&quot;, incrementAsync)
}
</code></pre>
<p><strong>reducer.js</strong></p>
<pre><code>export default function counter(state = 0, action) {
  switch (action.type) {
    case 'INCREMENT':
      return state + 1
    case 'DECREMENT':
      return state - 1
    case 'INCREMENT_ASYNC':
      return state
    default:
      return state
  }
}
</code></pre>
<p>ä»ä¸Šé¢çš„ä»£ç ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œredux-saga çš„ä½¿ç”¨æ–¹å¼è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç›¸æ¯”è¾ƒä¹‹å‰çš„ redux æ¡†æ¶çš„ CounterAppï¼Œå¤šäº†ä¸€ä¸ª sagas çš„æ–‡ä»¶ï¼Œreducers æ–‡ä»¶è¿˜æ˜¯ä¹‹å‰çš„ä½¿ç”¨æ–¹å¼</p>
<h3>redux-saga åŸºæœ¬ç”¨æ³•æ€»ç»“ï¼š</h3>
<ol>
<li><strong>ä½¿ç”¨ createSagaMiddleware æ–¹æ³•åˆ›å»º saga çš„ Middleware ï¼Œç„¶ååœ¨åˆ›å»ºçš„ redux çš„ store æ—¶ï¼Œä½¿ç”¨ applyMiddleware å‡½æ•°å°†åˆ›å»ºçš„ saga Middleware å®ä¾‹ç»‘å®šåˆ° store ä¸Šï¼Œæœ€åå¯ä»¥è°ƒç”¨ saga Middleware çš„ run å‡½æ•°æ¥æ‰§è¡ŒæŸä¸ªæˆ–è€…æŸäº› Middleware ã€‚</strong></li>
<li><strong>åœ¨ saga çš„ Middleware ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ takeEvery æˆ–è€… takeLatest ç­‰ API æ¥ç›‘å¬æŸä¸ª action ï¼Œå½“æŸä¸ª action è§¦å‘åï¼Œ saga å¯ä»¥ä½¿ç”¨ call å‘èµ·å¼‚æ­¥æ“ä½œï¼Œæ“ä½œå®Œæˆåä½¿ç”¨ put å‡½æ•°è§¦å‘ action ï¼ŒåŒæ­¥æ›´æ–° state ï¼Œä»è€Œå®Œæˆæ•´ä¸ª State çš„æ›´æ–°ã€‚</strong></li>
</ol>
<h1> </h1>
<h1>å‰ç«¯é¢è¯•æŸ¥æ¼è¡¥ç¼º --å‰ç«¯åŠ å¯†</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://juejin.cn/post/6844903781704925192?searchId=20230722164117366D8610A656DA70F4E6">juejin.cn</a></p>
</blockquote>
<h2>å‰ç«¯åŠ å¯†çš„æ„ä¹‰</h2>
<p>åœ¨ HTTP åè®®ä¸‹ï¼Œæ•°æ®æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œä¼ è¾“è¿‡ç¨‹ä¸­ç½‘ç»œå—…æ¢å¯ç›´æ¥è·å–å…¶ä¸­çš„æ•°æ®ã€‚ å¦‚ç”¨æˆ·çš„å¯†ç å’Œä¿¡ç”¨å¡ç›¸å…³çš„èµ„æ–™ï¼Œä¸€æ—¦è¢«ä¸­é—´äººè·å–ï¼Œä¼šç»™ç”¨æˆ·å¸¦æ¥æå¤§çš„å®‰å…¨éšæ‚£ã€‚å¦ä¸€æ–¹é¢åœ¨éåŠ å¯†çš„ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œæ”»å‡»è€…å¯æ›´æ”¹æ•°æ®æˆ–æ’å…¥æ¶æ„çš„ä»£ç ç­‰ã€‚</p>
<p>å‰ç«¯åŠ å¯†çš„æ„ä¹‰: å³åœ¨æ•°æ®å‘é€å‰å°†æ•°æ®è¿›è¡Œå“ˆå¸Œæˆ–ä½¿ç”¨å…¬é’¥åŠ å¯†ã€‚å¦‚æœæ•°æ®è¢«ä¸­é—´äººè·å–ï¼Œæ‹¿åˆ°çš„åˆ™ä¸å†æ˜¯æ˜æ–‡ã€‚
å…¶ä»–ä¸€äº›ä¼˜ç‚¹: ä¾‹å¦‚é¿å…åç«¯ç­‰æ‰“å°æ—¥å¿—ç›´æ¥æš´éœ²æ˜æ–‡å¯†ç , è¿˜å¯ä»¥é¿å…æ˜æ–‡æ’åº“ç­‰.</p>
<p><strong>æ²¡æœ‰ &quot;æ„ä¹‰&quot;:</strong> å‰ç«¯åŠ å¯†ï¼Œå…¶å®åªèƒ½<strong>é˜²å›å­ä¸èƒ½é˜²å°äººã€‚</strong> å‰ç«¯ç³»ç»Ÿçš„æ§åˆ¶æƒæ˜¯å®Œå…¨åœ¨ç”¨æˆ·æ‰‹é‡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‰ç«¯åšä»€ä¹ˆäº‹æƒ…ï¼Œç”¨æˆ·æœ‰å®Œå…¨çš„æ§åˆ¶æƒã€‚å³ä½¿å‰ç«¯åŠ å¯†ä¸å¯ä»¥é˜²èŒƒä¸­é—´äººæ”»å‡», åŒ…æ‹¬ HTTPS, å› ä¸ºä¸­é—´è¿˜æ˜¯å­˜åœ¨ç€å„ç§ä»£ç†, å®¢æˆ·ç«¯ä»£ç†, æœåŠ¡ç«¯ä»£ç†. æ˜¯å¾ˆéš¾åšåˆ°ä¸è¢«åŠ«æŒçš„.</p>
<p>è¿™é‡Œç®€å•è¯´ä¸‹:</p>
<ul>
<li>åŠ å¯†äº†ä¹Ÿæ— æ³•è§£å†³é‡æ”¾çš„é—®é¢˜ï¼Œä½ å‘ç»™æœåŠ¡å™¨ç«¯çš„è™½ç„¶æ˜¯åŠ å¯†åçš„æ•°æ®ï¼Œä½†æ˜¯é»‘å®¢æ‹¦æˆªä¹‹åï¼ŒæŠŠåŠ å¯†ä¹‹åçš„æ•°æ®é‡å‘ä¸€éï¼Œä¾ç„¶æ˜¯éªŒè¯é€šè¿‡çš„ã€‚</li>
<li>æ”»å‡»è€…é€šè¿‡æŸ¥çœ‹æºç å°±èƒ½å¾—åˆ°ç®—æ³•å’Œå¯†é’¥ã€‚é™¤éä½ æ˜¯é€šè¿‡åšæµè§ˆå™¨æ’ä»¶ï¼Œå°†ç®—æ³•å’Œå¯†é’¥å°è£…åœ¨æ’ä»¶ä¸­ï¼Œç„¶ååŠ å¯†çš„æ—¶å€™æ˜æ–‡æ··æ·†ä¸Šæ—¶é—´æˆ³ï¼Œè¿™æ ·å³ä½¿é»‘å®¢æ‹¦æˆªåˆ°äº†è¯·æ±‚æ•°æ®ï¼Œè¿›è¡Œé‡æ”¾è¿‡ç¨‹æ—¶ï¼Œä¹Ÿä¼šå¾ˆå¿«å¤±æ•ˆã€‚</li>
</ul>
<p><strong>æ€»ç»“ä¸€ä¸‹:</strong></p>
<ul>
<li>1, å®‰å…¨æ˜¯å‰åç«¯éƒ½éœ€è¦åšçš„äº‹, ä¸èƒ½å‰ç«¯åŠ å¯†äº†, åç«¯å°±ä¸ç®¡äº†.</li>
<li>2,HTTPS è¿˜æ˜¯æœ‰å¿…è¦çš„, åªè¦æ­£ç¡®ä½¿ç”¨äº† HTTPS è¿æ¥å’ŒæœåŠ¡å™¨ç«¯å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Œå¯†ç ç³»ç»Ÿéƒ½å¯ä»¥æ˜¯å¾ˆå®‰å…¨çš„ã€‚</li>
</ul>
<h2>å‰ç«¯åŠ å¯†çš„å‡ ç§åšæ³•</h2>
<p>â€¢ JavaScript åŠ å¯†åä¼ è¾“ (å…·ä½“å¯ä»¥å‚è€ƒåé¢çš„å¸¸è§åŠ å¯†æ–¹æ³•)
â€¢ æµè§ˆå™¨æ’ä»¶å†…è¿›è¡ŒåŠ å¯†ä¼ è¾“ (è¿™ä¸ªç”¨å¾—ä¸æ˜¯å¾ˆå¤š, è¿™é‡Œæš‚ä¸ç»†ç©¶)
â€¢ Https ä¼ è¾“</p>
<h2>åŠ å¯†ç®—æ³•</h2>
<p>ä¸åŒäºå“ˆå¸Œ (åé¢ä¼šæåˆ°)ï¼ŒåŠ å¯†ï¼ˆEncryptï¼‰æ˜¯å°†ç›®æ ‡æ–‡æœ¬è½¬æ¢æˆå…·æœ‰ä¸åŒé•¿åº¦çš„ã€<strong>å¯é€†çš„å¯†æ–‡</strong>ã€‚
åœ¨åŠ å¯†ç®—æ³•ä¸­åˆåˆ†ä¸ºå¯¹ç§°åŠ å¯†ï¼ˆsymmetric encryptionï¼‰å’Œéå¯¹ç§°åŠ å¯†ï¼ˆasymmetric encryptionï¼‰ã€‚</p>
<p><strong>æ³¨æ„:</strong> å› ä¸ºå‰ç«¯çš„é€æ˜æ€§ï¼Œ<strong>å¯¹äºç™»å½•å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯, å°±ä¸è¦ä½¿ç”¨ JavaScript æ¥è¿›è¡Œå¯¹ç§°åŠ å¯†.</strong> å› ä¸ºåˆ«äººå¯ä»¥ä»å‰ç«¯å¾—åˆ°å¯†åŒ™å, å¯ä»¥ç›´æ¥å¯¹ä¿¡æ¯è¿›è¡Œè§£å¯†!</p>
<h2>å“ˆå¸ŒåŠ å¯†ç®—æ³•</h2>
<h3><strong>å“ˆå¸Œç®—æ³•ï¼ˆHashï¼‰</strong></h3>
<p>åŸºäºå“ˆå¸Œç®—æ³•çš„ç‰¹æ€§ï¼Œå…¶é€‚ç”¨äºè¯¥åœºæ™¯ï¼šè¢«ä¿æŠ¤æ•°æ®ä»…ä»…ç”¨ä½œæ¯”è¾ƒéªŒè¯ä¸”ä¸éœ€è¦è¿˜åŸæˆæ˜æ–‡å½¢å¼ã€‚<strong>æ¯”è¾ƒå¸¸ç”¨çš„å“ˆå¸Œç®—æ³•æ˜¯ MD5 å’Œ SHA1 ã€‚</strong></p>
<p>æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ä½¿ç”¨å“ˆå¸Œå­˜å‚¨æ•°æ®çš„ä¾‹å­æ˜¯ï¼šå½“æˆ‘ä»¬ç™»å½•æŸä¸ªå·²æ³¨å†Œç½‘ç«™æ—¶ï¼Œåœ¨å¿˜è®°å¯†ç çš„æƒ…å†µä¸‹éœ€è¦é‡ç½®å¯†ç ï¼Œæ­¤æ—¶ç½‘ç«™ä¼šç»™ä½ å‘ä¸€ä¸ªéšæœºçš„å¯†ç æˆ–è€…ä¸€ä¸ªé‚®ç®±æ¿€æ´»é“¾æ¥ï¼Œè€Œä¸æ˜¯å°†ä¹‹å‰çš„å¯†ç å‘ç»™ä½ ï¼Œè¿™å°±æ˜¯å› ä¸ºå“ˆå¸Œç®—æ³•æ˜¯ä¸å¯é€†çš„ã€‚</p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼šåœ¨ Web åº”ç”¨ä¸­ï¼Œ<strong>åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨å“ˆå¸ŒåŠ å¯†çš„åŒæ—¶ä¹Ÿè¦åœ¨æœåŠ¡ç«¯ä¸Šè¿›è¡Œå“ˆå¸ŒåŠ å¯†
æœåŠ¡ç«¯å“ˆå¸ŒåŠ å¯†åŸå› :</strong> ä¸€æ–¹é¢å› ä¸ºä¸éœ€è¦å°†å¯†æ–‡è§£å¯†æˆæ˜æ–‡æ¥æ¯”å¯¹å¯†ç ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä¸€æ—¦åŠ å¯†ç®—æ³•å’Œå¯†é’¥æ³„éœ²ï¼Œé‚£ä¹ˆæ•´ä¸ªç”¨æˆ·èµ„æ–™åº“å°±ç›¸å½“äºæ˜æ–‡å­˜å‚¨äº†ã€‚å¦‚æœå‰ç«¯ä¼ è¿‡æ¥çš„æ˜¯æ˜æ–‡ï¼Œé‚£ä¹ˆåœ¨æ³¨å†Œæ—¶å°†å…¶å“ˆå¸Œï¼Œå­˜å…¥æ•°æ®åº“ã€‚ç™»å½•æ—¶ï¼Œå°†å¯†ç å“ˆå¸Œå’Œæ•°æ®åº“å¯¹åº”çš„æ•°æ®æ¯”å¯¹ï¼Œè‹¥ä¸€è‡´åˆ™è¯´æ˜å¯†ç æ­£ç¡®ã€‚</p>
<p>ç°åœ¨ï¼Œå¯¹äºç®€å•çš„å“ˆå¸Œç®—æ³•çš„æ”»å‡»æ–¹æ³•ä¸»è¦æœ‰ï¼šå¯»æ‰¾ç¢°æ’æ³•å’Œç©·ä¸¾æ³•ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œå¯ä»¥<strong>åœ¨å“ˆå¸Œç®—æ³•çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥çš„åŠ å¯†ï¼Œå¸¸è§çš„æ–¹æ³•æœ‰ï¼šåŠ ç›ã€æ…¢å“ˆå¸Œã€å¯†é’¥å“ˆå¸Œã€XOR ç­‰ã€‚</strong></p>
<h3><strong>åŠ ç›ï¼ˆAdding Saltï¼‰</strong></h3>
<p>åŠ ç›åŠ å¯†æ˜¯ä¸€ç§å¯¹ç³»ç»Ÿç™»å½•å£ä»¤çš„åŠ å¯†æ–¹å¼ï¼Œå®ƒå®ç°çš„æ–¹å¼æ˜¯å°†æ¯ä¸€ä¸ªå£ä»¤åŒä¸€ä¸ªå«åš â€œç›â€ï¼ˆsaltï¼‰çš„ n ä½éšæœºæ•°ç›¸å…³è”ã€‚</p>
<p>ä½¿ç”¨ salt åŠ å¯†ï¼Œå®ƒçš„åŸºæœ¬æƒ³æ³•æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>
<ol>
<li>ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œåœ¨å¯†ç ä¸Šæ’’ä¸€äº›ç›ã€‚ç”Ÿæˆä¸€ç§å‘³é“ï¼Œè®°ä½å‘³é“ã€‚</li>
</ol>
</li>
<li>
<ol start="2">
<li>ç”¨æˆ·å†æ¬¡ç™»é™†æ—¶ï¼Œåœ¨è¾“å…¥çš„å¯†ç ä¸Šæ’’ç›ï¼Œé—»ä¸€é—»ï¼Œåˆ¤æ–­æ˜¯å¦å’ŒåŸæ¥çš„å‘³é“ç›¸åŒï¼Œç›¸åŒå°±è®©ä½ åƒé¥­ã€‚</li>
</ol>
</li>
</ul>
<p>ç”±äºéªŒè¯å¯†ç æ—¶å’Œæœ€åˆæ•£åˆ—å¯†ç æ—¶ä½¿ç”¨ç›¸åŒçš„ç›å€¼ï¼Œæ‰€ä»¥ <strong>salt çš„å­˜å‚¨åœ¨æ•°æ®åº“</strong>ã€‚
å¹¶ä¸”<strong>è¿™ä¸ªå€¼æ˜¯ç”±ç³»ç»Ÿéšæœºäº§ç”Ÿçš„</strong>ï¼Œè€Œéç¡¬ç¼–ç ã€‚è¿™å°±ä¿è¯äº†æ‰€è¦ä¿æŠ¤å¯¹è±¡çš„æœºå¯†æ€§ã€‚</p>
<h3>åŠ ç›å®ä¾‹</h3>
<p><strong>æ³¨å†Œæ—¶:</strong></p>
<ul>
<li>
<ol>
<li>ç”¨æˆ·æ³¨å†Œï¼Œç³»ç»Ÿéšæœºäº§ç”Ÿ salt å€¼ã€‚</li>
</ol>
</li>
<li>
<ol start="2">
<li>å°† salt å€¼å’Œå¯†ç è¿æ¥èµ·æ¥ï¼Œç”Ÿäº§ Hash å€¼ã€‚</li>
</ol>
</li>
<li>
<ol start="3">
<li>å°† Hash å€¼å’Œ salt å€¼åˆ†åˆ«å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚</li>
</ol>
</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccc99da52c424818aef40e99b3007f3b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p><strong>ç™»é™†æ—¶:</strong></p>
<ul>
<li>
<ol>
<li>ç³»ç»Ÿæ ¹æ®ç”¨æˆ·åæ‰¾åˆ°ä¸ä¹‹å¯¹åº”çš„å¯†ç  Hashã€‚</li>
</ol>
</li>
<li>
<ol start="2">
<li>å°†ç”¨æˆ·è¾“å…¥å¯†ç å’Œ salt å€¼è¿›è¡Œæ•£åˆ—ã€‚</li>
</ol>
</li>
<li>
<ol start="3">
<li>åˆ¤æ–­ç”Ÿæˆçš„ Hash å€¼æ˜¯å¦å’Œæ•°æ®åº“ä¸­ Hash ç›¸åŒã€‚</li>
</ol>
</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a19b1f2457494ebfbd695c9b519e6961~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p>
<p><strong>PS:</strong> å…¶å®å›¾ä¸­çš„è¿™ç§ç™»å½•ä¹Ÿæ˜¯ä¸å®‰å…¨çš„. åŸå› æ˜¯åé¢è¦æåˆ°çš„ç›å€¼å¤ç”¨</p>
<h3>åŠ ç›åŠ å¯†æ³¨æ„</h3>
<p>ä½¿ç”¨åŠ ç›åŠ å¯†æ—¶éœ€è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ul>
<li><strong>çŸ­ç›å€¼ï¼ˆShort Slatï¼‰</strong></li>
</ul>
<p>å¦‚æœç›å€¼å¤ªçŸ­ï¼Œæ”»å‡»è€…å¯ä»¥é¢„å…ˆåˆ¶ä½œé’ˆå¯¹æ‰€æœ‰å¯èƒ½çš„ç›å€¼çš„æŸ¥è¯¢è¡¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç›å€¼åªæœ‰ä¸‰ä¸ª ASCII å­—ç¬¦ï¼Œé‚£ä¹ˆåªæœ‰ 95x95x95=857,375 ç§å¯èƒ½æ€§ï¼ŒåŠ å¤§äº†è¢«æ”»å‡»çš„å¯èƒ½æ€§ã€‚è¿˜æœ‰ï¼Œä¸è¦ä½¿ç”¨å¯é¢„æµ‹çš„ç›å€¼ï¼Œæ¯”å¦‚ç”¨æˆ·åï¼Œå› ä¸ºé’ˆå¯¹æŸç³»ç»Ÿç”¨æˆ·åæ˜¯å”¯ä¸€çš„ä¸”è¢«ç»å¸¸ç”¨äºå…¶ä»–æœåŠ¡ã€‚</p>
<ul>
<li><strong>ç›å€¼å¤ç”¨ï¼ˆSalt Reuseï¼‰</strong>
åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œæœ‰æ—¶ä¼šé‡åˆ°å°†ç›å€¼å†™æ­»åœ¨ç¨‹åºé‡Œæˆ–è€…åªæœ‰ç¬¬ä¸€æ¬¡æ˜¯éšæœºç”Ÿæˆçš„ï¼Œä¹‹åéƒ½ä¼šè¢«é‡å¤ä½¿ç”¨ï¼Œè¿™ç§åŠ ç›æ–¹æ³•æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚ä»¥ç™»å½•å¯†ç ä¸ºä¾‹ï¼Œå¦‚æœä¸¤ä¸ªç”¨æˆ·æœ‰ç›¸åŒçš„å¯†ç ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šæœ‰ç›¸åŒçš„å“ˆå¸Œå€¼ï¼Œæ”»å‡»è€…å°±å¯ä»¥ä½¿ç”¨åå‘æŸ¥è¡¨æ³•å¯¹æ¯ä¸ªå“ˆå¸Œå€¼è¿›è¡Œå­—å…¸æ”»å‡»ï¼Œä½¿å¾—è¯¥å“ˆå¸Œå€¼æ›´å®¹æ˜“è¢«ç ´è§£ã€‚</li>
</ul>
<p><strong>æ‰€ä»¥æ­£ç¡®çš„åŠ ç›æ–¹æ³•å¦‚ä¸‹ï¼š</strong>
ï¼ˆ1ï¼‰ç›å€¼åº”è¯¥ä½¿ç”¨åŠ å¯†çš„å®‰å…¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆ Cryptographically Secure Pseudo-Random Number Generatorï¼ŒCSPRNG ï¼‰äº§ç”Ÿï¼Œæ¯”å¦‚ C è¯­è¨€çš„ rand() å‡½æ•°ï¼Œè¿™æ ·ç”Ÿæˆçš„éšæœºæ•°é«˜åº¦éšæœºã€å®Œå…¨ä¸å¯é¢„æµ‹ï¼›
ï¼ˆ2ï¼‰ç›å€¼æ··å…¥ç›®æ ‡æ–‡æœ¬ä¸­ï¼Œä¸€èµ·ä½¿ç”¨æ ‡å‡†çš„åŠ å¯†å‡½æ•°è¿›è¡ŒåŠ å¯†ï¼›</p>
<p>ï¼ˆ3ï¼‰ç›å€¼è¦è¶³å¤Ÿé•¿ï¼ˆç»éªŒè¡¨æ˜ï¼šç›å€¼è‡³å°‘è¦è·Ÿå“ˆå¸Œå‡½æ•°çš„è¾“å‡ºä¸€æ ·é•¿ï¼‰ä¸”æ°¸ä¸é‡å¤ï¼›</p>
<p>ï¼ˆ4ï¼‰ç›å€¼æœ€å¥½ç”±æœåŠ¡ç«¯æä¾›ï¼Œå‰ç«¯å–å€¼ä½¿ç”¨ã€‚</p>
<h3><strong>æ…¢å“ˆå¸Œå‡½æ•°ï¼ˆSlow Hash Functionï¼‰</strong></h3>
<p>é¡¾åæ€ä¹‰ï¼Œæ…¢å“ˆå¸Œå‡½æ•°æ˜¯å°†å“ˆå¸Œå‡½æ•°å˜å¾—éå¸¸æ…¢ï¼Œä½¿å¾—æ”»å‡»æ–¹æ³•ä¹Ÿå˜å¾—å¾ˆæ…¢ï¼Œæ…¢åˆ°è¶³ä»¥ä»¤æ”»å‡»è€…æ”¾å¼ƒï¼Œè€Œå¾€å¾€ç”±æ­¤å¸¦æ¥çš„å»¶è¿Ÿä¹Ÿä¸ä¼šå¼•èµ·ç”¨æˆ·çš„æ³¨æ„ã€‚é™ä½æ”»å‡»æ•ˆç‡ç”¨åˆ°äº†å¯†é’¥æ‰©å±•ï¼ˆ key stretchingï¼‰çš„æŠ€æœ¯ï¼Œè€Œå¯†é’¥æ‰©å±•çš„å®ç°ä½¿ç”¨äº†ä¸€ç§ CPU å¯†é›†å‹å“ˆå¸Œå‡½æ•°ï¼ˆ CPU-intensive hash functionï¼‰ã€‚çœ‹èµ·æ¥æœ‰ç‚¹æ™•~ è¿˜æ˜¯å…³æ³¨ä¸‹è¯¥å‡½æ•°æ€ä¹ˆç”¨å§ï¼</p>
<p>å¦‚æœæƒ³åœ¨ä¸€ä¸ª Web åº”ç”¨ä¸­ä½¿ç”¨å¯†é’¥æ‰©å±•ï¼Œåˆ™éœ€è¦è®¾å®šè¾ƒä½çš„è¿­ä»£æ¬¡æ•°æ¥é™ä½é¢å¤–çš„è®¡ç®—æˆæœ¬ã€‚æˆ‘ä»¬ä¸€èˆ¬ç›´æ¥é€‰æ‹©ä½¿ç”¨æ ‡å‡†çš„ç®—æ³•æ¥å®Œæˆï¼Œæ¯”å¦‚ PBKDF2 æˆ– bcrypt ã€‚PHPã€æ–¯å¦ç¦å¤§å­¦çš„ JavaScript åŠ å¯†åº“éƒ½åŒ…å«äº† PBKDF2 çš„å®ç°ï¼Œæµè§ˆå™¨ä¸­åˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨ JavaScript å®Œæˆï¼Œå¦åˆ™è¿™éƒ¨åˆ†å·¥ä½œåº”è¯¥ç”±æœåŠ¡ç«¯è¿›è¡Œè®¡ç®—ã€‚</p>
<h3><strong>å¯†é’¥å“ˆå¸Œ</strong></h3>
<p>å¯†é’¥å“ˆå¸Œæ˜¯å°†å¯†é’¥æ·»åŠ åˆ°å“ˆå¸ŒåŠ å¯†ï¼Œè¿™æ ·åªæœ‰çŸ¥é“å¯†é’¥çš„äººæ‰å¯ä»¥è¿›è¡ŒéªŒè¯ã€‚ç›®å‰æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼šä½¿ç”¨ ASE ç®—æ³•å¯¹å“ˆå¸Œå€¼åŠ å¯†ã€ä½¿ç”¨å¯†é’¥å“ˆå¸Œç®—æ³• HMAC å°†å¯†é’¥åŒ…å«åˆ°å“ˆå¸Œå­—ç¬¦ä¸²ä¸­ã€‚ä¸ºäº†ä¿è¯å¯†é’¥çš„å®‰å…¨ï¼Œéœ€è¦å°†å…¶å­˜å‚¨åœ¨å¤–éƒ¨ç³»ç»Ÿï¼ˆæ¯”å¦‚ä¸€ä¸ªç‰©ç†ä¸Šéš”ç¦»çš„æœåŠ¡ç«¯ï¼‰ã€‚</p>
<p>å³ä½¿é€‰æ‹©äº†å¯†é’¥å“ˆå¸Œï¼Œåœ¨å…¶åŸºç¡€ä¸Šè¿›è¡ŒåŠ ç›æˆ–è€…å¯†é’¥æ‰©å±•å¤„ç†ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦ã€‚ç›®å‰å¯†é’¥å“ˆå¸Œç”¨äºæœåŠ¡ç«¯æ¯”è¾ƒå¤šï¼Œä¾‹å¦‚æ¥åº”å¯¹å¸¸è§çš„ SQL æ³¨å…¥æ”»å‡»ã€‚</p>
<h3><strong>XOR</strong></h3>
<p>XOR å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œå®ƒæŒ‡çš„æ˜¯é€»è¾‘è¿ç®—ä¸­çš„ â€œå¼‚æˆ–è¿ç®—â€ã€‚ä¸¤ä¸ªå€¼ç›¸åŒæ—¶ï¼Œè¿”å› falseï¼Œå¦åˆ™è¿”å› trueï¼Œç”¨æ¥åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ä¸åŒã€‚</p>
<p>JavaScript è¯­è¨€çš„äºŒè¿›åˆ¶è¿ç®—ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨çš„ XOR è¿ç®—ç¬¦ï¼Œå†™ä½œ ^ã€‚</p>
<p>XOR è¿ç®—æœ‰ä¸€ä¸ªç‰¹æ€§ï¼š<strong>å¦‚æœå¯¹ä¸€ä¸ªå€¼è¿ç»­åšä¸¤æ¬¡ XORï¼Œä¼šè¿”å›è¿™ä¸ªå€¼æœ¬èº«ã€‚è¿™ä¹Ÿæ˜¯å…¶å¯ä»¥ç”¨äºä¿¡æ¯åŠ å¯†çš„æ ¹æœ¬ã€‚</strong></p>
<pre><code>message XOR key // cipherText
cipherText XOR key // message

</code></pre>
<p>ç›®æ ‡æ–‡æœ¬ messageï¼Œkey æ˜¯å¯†é’¥ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œ XOR ä¼šå¾—åˆ°åŠ å¯†æ–‡æœ¬ï¼›åœ¨åŠ å¯†æ–‡æœ¬ä¸Šå†ç”¨ key åšä¸€æ¬¡ XOR å°±ä¼šè¿˜åŸç›®æ ‡æ–‡æœ¬ messageã€‚ä¸ºäº†ä¿è¯ XOR çš„å®‰å…¨ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<p>ï¼ˆ1ï¼‰key çš„é•¿åº¦å¤§äºç­‰äº message ï¼›
ï¼ˆ2ï¼‰key å¿…é¡»æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸”æ¯æ¬¡éƒ½è¦éšæœºäº§ç”Ÿã€‚</p>
<h2>XOR åŠ å¯†ä½¿ç”¨</h2>
<p>ä¸‹é¢ä»¥ç™»å½•å¯†ç åŠ å¯†ä¸ºä¾‹ä»‹ç»ä¸‹ XOR çš„ä½¿ç”¨ï¼š
ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨ MD5 ç®—æ³•ï¼Œè®¡ç®—å¯†ç çš„å“ˆå¸Œï¼›</p>
<pre><code>const message = md5(password);

</code></pre>
<p>ç¬¬äºŒæ­¥ï¼šç”Ÿæˆä¸€ä¸ªéšæœº key å€¼ï¼›
ç¬¬ä¸‰æ­¥ï¼šè¿›è¡Œ XOR è¿ç®—ï¼Œæ±‚å‡ºåŠ å¯†åçš„ messageã€‚</p>
<pre><code>function getXOR(message, key) 

const arr = [];

//å‡è®¾ key æ˜¯32ä½çš„

for (let i = 0; i &lt; 32; i++) {
 Â const Â m = parseInt(message.substr(i, 1), 16);
 Â const k = parseInt(key.substr(i, 1), 16);
 Â arr.push((m ^ k).toString(16));
}

return arr.join('');

}

</code></pre>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œä½¿ç”¨ XOR å’Œä¸€æ¬¡æ€§çš„å¯†é’¥ key å¯¹å¯†ç è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œåªè¦ key æ²¡æœ‰æ³„éœ²ï¼Œç›®æ ‡æ–‡æœ¬å°±ä¸ä¼šè¢«ç ´è§£ã€‚</p>
<p>ä¸Šé¢è¯´äº†é‚£ä¹ˆå¤šï¼Œé—®é¢˜å°±æ¥äº†ï¼šæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ ·çš„å“ˆå¸Œç®—æ³•å‘¢ï¼Ÿ</p>
<p>ï¼ˆ1ï¼‰é€‰æ‹©ç»è¿‡éªŒè¯çš„æˆç†Ÿç®—æ³•ï¼Œå¦‚ PBKDF2 ç­‰ ï¼›</p>
<p>ï¼ˆ2ï¼‰crypt çš„å®‰å…¨ç‰ˆæœ¬ï¼›</p>
<p>ï¼ˆ3ï¼‰é¿å…ä½¿ç”¨è‡ªå·±è®¾è®¡çš„åŠ å¯†ç®—æ³•ã€‚</p>
<h3><strong>HMAC</strong></h3>
<p>å¯¹äº HMAC ç®—æ³•, æˆ‘ä¹Ÿä¸æ˜¯å¤ªäº†è§£. çœ‹äº†å‡ ç¯‡æ–‡ç« , æ„Ÿè§‰å’ŒåŠ ç›å¾ˆåƒ, å°±æ˜¯ salt æ¢æˆåç«¯éšæœºç”Ÿæˆçš„ (å¥½åƒå¯ä»¥é˜²æ­¢é‡æ”¾æ”»å‡»). ç„¶åå†é€šè¿‡ HMAC ç®—æ³•, å¾—åˆ°æ‘˜è¦.</p>
<p>å…³äº HMAC ç®—æ³•éƒ¨åˆ†å¯ä»¥è¯¦ç»†çœ‹è¿™ç¯‡<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaix.me%2Fji-yu-hashhan-shu-de-mac-hmac%2F" title="https://xiaix.me/ji-yu-hashhan-shu-de-mac-hmac/">æ–‡ç« </a>, æˆ‘æ˜¯å­¦æ¸£, çœ‹äº†åŠå¤©ä¹Ÿä¸æ˜¯å¤ªæ‡‚.=.=</p>
<p><strong>å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹:</strong></p>
<ul>
<li>
<ol>
<li>å®¢æˆ·ç«¯å‘å‡ºç™»å½•è¯·æ±‚</li>
</ol>
</li>
<li>
<ol start="2">
<li>æœåŠ¡å™¨è¿”å›ä¸€ä¸ªéšæœºå€¼ï¼Œåœ¨ä¼šè¯è®°å½•ä¸­ä¿å­˜è¿™ä¸ªéšæœºå€¼</li>
</ol>
</li>
<li>
<ol start="3">
<li>å®¢æˆ·ç«¯å°†è¯¥éšæœºå€¼ä½œä¸ºå¯†é’¥ï¼Œç”¨æˆ·å¯†ç è¿›è¡Œ hmac è¿ç®—ï¼Œé€’äº¤ç»™æœåŠ¡å™¨</li>
</ol>
</li>
<li>
<ol start="4">
<li>æœåŠ¡å™¨è¯»å–æ•°æ®åº“ä¸­çš„ç”¨æˆ·å¯†ç ï¼Œåˆ©ç”¨å¯†é’¥åšå’Œå®¢æˆ·ç«¯ä¸€æ ·çš„ hmac è¿ç®—ï¼Œç„¶åä¸ç”¨æˆ·å‘é€çš„ç»“æœæ¯”è¾ƒï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™ç”¨æˆ·èº«ä»½åˆæ³•ã€‚</li>
</ol>
</li>
</ul>
<p><strong>å¥½å¤„:</strong></p>
<ul>
<li>ä¸è‡ªå®šä¹‰çš„åŠ  salt ç®—æ³•ä¸åŒï¼ŒHmac ç®—æ³•é’ˆå¯¹æ‰€æœ‰å“ˆå¸Œç®—æ³•éƒ½é€šç”¨ï¼Œæ— è®ºæ˜¯ MD5 è¿˜æ˜¯ SHA-1ã€‚é‡‡ç”¨ Hmac æ›¿ä»£æˆ‘ä»¬è‡ªå·±çš„ salt ç®—æ³•ï¼Œå¯ä»¥ä½¿ç¨‹åºç®—æ³•æ›´æ ‡å‡†åŒ–ï¼Œä¹Ÿæ›´å®‰å…¨ã€‚(æ‘˜è‡ªé›ªå³°å¤§ä½¬çš„<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.liaoxuefeng.com%2Fwiki%2F0014316089557264a6b348958f449949df42a6d3a2e542c000%2F0015108777177966ef0f4f8510a41b3b8c48cdcf7047b2d000" title="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0015108777177966ef0f4f8510a41b3b8c48cdcf7047b2d000">è¿™ç¯‡æ–‡ç« </a>)</li>
<li>å¦å¤–ä¸€ä¸ªå°±æ˜¯å¯†ç çš„å®‰å…¨æ€§, ç”±äºä¸çŸ¥é“å¯†é’¥ï¼Œæ‰€ä»¥ä¸å¯èƒ½è·å–åˆ°ç”¨æˆ·å¯†ç </li>
</ul>
<h3><strong>è¡¥å…… 1: ç»“åˆéªŒè¯ç è¿›è¡Œå‰ç«¯åŠ å¯†</strong> (å…¶å®å°±æ˜¯ä¸€ç§åŠ¨æ€åŠ ç›å“ˆå¸Œ)</h3>
<p>å‰ç«¯å…ˆå°†å¯†ç å“ˆå¸Œï¼Œç„¶åå’Œç”¨æˆ·è¾“å…¥çš„éªŒè¯ç è¿›è¡Œå“ˆå¸Œï¼Œå¾—åˆ°çš„ç»“æœä½œä¸ºå¯†ç å­—æ®µå‘é€ç»™æœåŠ¡å™¨ã€‚æœåŠ¡å™¨å…ˆç¡®è®¤éªŒè¯ç æ­£ç¡®ï¼Œç„¶åå†è¿›è¡Œå¯†ç éªŒè¯ï¼Œå¦åˆ™ç›´æ¥è¿”å›éªŒè¯ç é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>è¿™ç§å®è·µä¿è¯äº†å¯†ç åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„èµ„æ–™å®‰å…¨ï¼Œå³ä½¿æ”»å‡»è€…æ‹¿åˆ°äº†æ•°æ®ä¹Ÿæ— æ³•é‡æ”¾ã€‚å›¾å½¢åŒ–éªŒè¯ç æ›´æ˜¯å¢åŠ äº†éš¾åº¦ã€‚å¦ä¸€æ–¹é¢è¯¥å®è·µå¤§å¤§å¢åŠ äº†æ’åº“çš„æˆæœ¬ã€‚</p>
<p>å‰ç«¯åŠ å¯†ä¸€å®šç¨‹åº¦ä¿éšœäº†ä¼ è¾“è¿‡ç¨‹ä¸­çš„èµ„æ–™å®‰å…¨ï¼Œé‚£ä¹ˆä¼šä¸ä¼šæœ‰å¯¹ä¸¤ç«¯ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼‰æœ‰å®‰å…¨å¸®åŠ©å‘¢ï¼Ÿ</p>
<p>æœ‰å¸®åŠ©ï¼Œä½¿ç”¨ä¸€äº›å‰ç«¯åŠ å¯†æ‰‹æ®µï¼Œå¯ä»¥å¢åŠ æ‹–åº“åçš„æ•°æ®ç ´è§£éš¾åº¦ã€‚ä½†æ˜¯éªŒè¯ç æ–¹æ³•ä¸å…·æœ‰è¿™æ ·çš„åŠŸèƒ½ï¼Œå› ä¸ºæ•°æ®åº“å­˜çš„ä»æ˜¯æ˜æ–‡å¯†ç å“ˆå¸Œåçš„ç»“æœï¼Œé‚£ä¹ˆæ”»å‡»è€…å¯ä»¥ç»•è¿‡å‰ç«¯åŠ å¯†ï¼Œå¯ä»¥ç›´æ¥æš´åŠ›ç ´è§£ã€‚</p>
<h3><strong>è¡¥å…… 2: Base64 ç¼–ç </strong></h3>
<p>å¤§å®¶ç»å¸¸è¯´çš„æ˜¯ Base64 åŠ å¯†ï¼Œæœ‰ Base64 åŠ å¯†å—ï¼Ÿ<strong>çœŸæœ¨æœ‰ï¼Œåªæœ‰ Base64 ç¼–ç ã€‚</strong></p>
<p>Base64 æ˜¯ä¸€ç§åŸºäº 64 ä¸ªå¯æ‰“å°å­—ç¬¦æ¥è¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®çš„è¡¨ç¤ºæ–¹æ³•ã€‚å¸¸ç”¨äºåœ¨é€šå¸¸å¤„ç†æ–‡æœ¬æ•°æ®çš„åœºåˆï¼Œè¡¨ç¤ºã€ä¼ è¾“ã€å­˜å‚¨ä¸€äº›äºŒè¿›åˆ¶æ•°æ®, åŒ…æ‹¬ MIME çš„ emailï¼Œemail via MIMEï¼Œåœ¨ XML ä¸­å­˜å‚¨å¤æ‚æ•°æ®ï¼›ä¸»è¦ç”¨æ¥è§£å†³æŠŠä¸å¯æ‰“å°çš„å†…å®¹å¡è¿›å¯æ‰“å°å†…å®¹çš„éœ€æ±‚ã€‚js ä¸­ base64 æ–¹æ³•ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<pre><code>//1.ç¼–ç 
var result = Base.encode('shotCatå¥½å¸…!');  //--&gt; &quot;c2hvdENhdOWlveW4hSE=&quot;

//2.è§£ç 
var result2 = Base.decode(result); //--&gt; 'shotCatå¥½å¸…!' æ²¡é”™,æˆ‘å°±æ˜¯è¿™ä¹ˆä¸è¦è„¸!!!

</code></pre>
<p>å› æ­¤ï¼ŒBase64 é€‚ç”¨äºå°æ®µå†…å®¹çš„ç¼–ç ï¼Œæ¯”å¦‚æ•°å­—è¯ä¹¦ç­¾åã€Cookie çš„å†…å®¹ç­‰ï¼›è€Œä¸” Base64 ä¹Ÿæ˜¯ä¸€ç§é€šè¿‡æŸ¥è¡¨çš„ç¼–ç æ–¹æ³•ï¼Œä¸èƒ½ç”¨äºåŠ å¯†ï¼Œå¦‚æœéœ€è¦åŠ å¯†ï¼Œè¯·ä½¿ç”¨ä¸“ä¸šçš„åŠ å¯†ç®—æ³•ã€‚</p>
<p><strong>PS:</strong> å¯¹äºå‰ç«¯æ¥è¯´, base64 ç”¨å¾—æœ€å¤šçš„ä¹Ÿå°±æ˜¯å›¾ç‰‡è½¬ç å§.</p>
<h3><strong>è¡¥å…… 3: æ•°å­—ç­¾å</strong></h3>
<p>æ•°å­—ç­¾åä¸»è¦ç”¨äº: <strong>ç¡®è®¤ä¿¡æ¯æ¥æºäºç‰¹å®šçš„ä¸»ä½“ä¸”ä¿¡æ¯å®Œæ•´ã€æœªè¢«ç¯¡æ”¹ï¼Œå‘é€æ–¹ç”Ÿæˆç­¾åï¼Œæ¥æ”¶æ–¹éªŒè¯ç­¾åã€‚</strong></p>
<p><strong>å‘é€æ–¹:</strong> é¦–å…ˆè®¡ç®—ç›®æ ‡æ–‡æœ¬çš„æ‘˜è¦ï¼ˆå“ˆå¸Œå€¼ï¼‰ï¼Œé€šè¿‡ç§é’¥å¯¹æ‘˜è¦è¿›è¡Œç­¾åï¼Œå°†ç›®æ ‡æ–‡æœ¬å’Œç”µå­ç­¾åå‘é€ç»™æ¥æ”¶æ–¹ã€‚</p>
<p><strong>æ¥æ”¶æ–¹:</strong> éªŒè¯ç­¾åçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>1, é€šè¿‡å…¬é’¥ç ´è§£ç”µå­ç­¾åï¼Œå¾—åˆ°æ‘˜è¦ D1 (å¦‚æœå¤±è´¥ï¼Œåˆ™ä¿¡æ¯æ¥æºä¸»ä½“æ ¡éªŒå¤±è´¥)ï¼›</li>
<li>2, è®¡ç®—ç›®æ ‡æ–‡æœ¬æ‘˜è¦ D2ï¼›</li>
<li>3, è‹¥ D1 === D2ï¼Œåˆ™è¯´æ˜ç›®æ ‡æ–‡æœ¬å®Œæ•´ã€æœªè¢«ç¯¡æ”¹ã€‚</li>
</ul>
<p><strong>æ•°å­—ç­¾åä¸éå¯¹ç§°åŠ å¯†åŒºåˆ«:</strong></p>
<ul>
<li>éå¯¹ç§°åŠ å¯†ï¼ˆåŠ å¯† / è§£å¯†ï¼‰ï¼šå…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ã€‚</li>
<li>æ•°å­—ç­¾åï¼ˆç­¾å / éªŒè¯ï¼‰ï¼šç§é’¥ç­¾åï¼Œå…¬é’¥éªŒè¯ã€‚</li>
</ul>
<h1> </h1>
<h1>é¡¾å‡¡åŠä¸¨è„‘ç§‘å­¦çš„èŒƒå¼é©å‘½</h1><blockquote>
<p>æœ¬æ–‡ç”± <a href="http://ksria.com/simpread/">ç®€æ‚¦ SimpRead</a> è½¬ç ï¼Œ åŸæ–‡åœ°å€ <a href="https://mp.weixin.qq.com/s/ZHGnBWWQdUrnyYCYMYCfPg">mp.weixin.qq.com</a></p>
</blockquote>
<h1><strong>Imaging Brain Function With EEG</strong></h1>
<p>å¾·å›½è¯—äººå’Œç§‘å­¦å®¶æ­Œå¾·æ›¾è¯´è¿‡ï¼šâ€œé™¤éæˆ‘ä»¬è®¾æ³•çŸ¥é“å‰äººæ‡‚å¾—äº†ä»€ä¹ˆï¼Œå¦åˆ™æˆ‘ä»¬å°±æ— æ³•æ¸…æ¥šåœ°æ˜ç™½æˆ‘ä»¬ç©¶ç«Ÿæ‡‚å¾—äº†å“ªäº›ä¸œè¥¿ã€‚å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“æ€æ ·æ¬£èµå¾€æ—¥çš„æˆå°±ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå°±ä¸èƒ½çœŸæ­£ç†è§£å¦‚ä»Šçš„è¿›å±•ã€‚â€
å› æ­¤ï¼Œä»ç§‘å­¦å²çš„è§’åº¦æ¢³ç†äººç±»åœ¨è®¤è¯†è„‘çš„è¿‡ç¨‹ä¸­æ‰€å‘ç”Ÿçš„èŒƒå¼é©å‘½ï¼Œæ˜¯éå¸¸æœ‰æ„ä¹‰çš„</p>
<hr>
<p>â€œèŒƒå¼é©å‘½â€ æ˜¯ç”±æ‰˜é©¬æ–¯ Â· åº“æ©æå‡ºçš„æ¦‚å¿µï¼Œæ„æŒ‡æŸé—¨å­¦ç§‘ä¸­åŸºæœ¬æ¦‚å¿µå’Œç ”ç©¶æ–¹æ³•çš„æ ¹æœ¬æ€§å˜åŒ–
ç”±æ­¤å‡ºå‘ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ€è€ƒå¯èƒ½é¢ä¸´ä»€ä¹ˆæ ·çš„æ–°èŒƒå¼é©å‘½ï¼Œä»¥ä¾¿æ›´è‡ªè§‰åœ°åšå‡ºåº”å¯¹ã€‚</p>
<hr>
<p>åœ¨ç§‘å­¦çš„å‘å±•ä¸­ï¼ŒæŸäº›å…³é”®ç ”ç©¶æŠ€æœ¯çš„çªç ´ä¹Ÿèµ·åˆ°ä¸¾è¶³è½»é‡çš„ä½œç”¨â€”â€”è™½ç„¶è¿™äº›æŠ€æœ¯è¿˜ä¸èƒ½è¢«å½’å…¥è¯¥å­¦ç§‘çš„èŒƒå¼é©å‘½ï¼Œå´æ˜¯èŒƒå¼é©å‘½å¿…ä¸å¯å°‘çš„å‚¬åŒ–å‰‚å’Œå‰ææ¡ä»¶ã€‚
èŒƒå¼é©å‘½çš„å‘ç”Ÿå¾€å¾€æ˜¯ç”±é—®é¢˜é©±åŠ¨çš„ï¼Œå³å½“å­¦ç§‘å‘å±•é­é‡æŸä¸ªéè§£å†³ä¸å¯çš„å…³é”®é—®é¢˜æ—¶ï¼Œæˆ–è¿Ÿæˆ–æ—©ä¼šæœ‰å¤©æ‰ç§‘å­¦å®¶æå‡ºçŸ³ç ´å¤©æƒŠçš„æ–°æ€æƒ³ï¼Œåšå‡ºé¢ è¦†æ€§çš„å‘ç°ï¼Œå¼•å‘èŒƒå¼é©å‘½</p>
<hr>
<p>å¤å¸Œè…ŠåŒ»ç”Ÿå¸Œæ³¢å…‹æ‹‰åº•æ—©åœ¨å…¬å…ƒå‰ 5 ä¸–çºªå°±æ ¹æ®è„‘æŸä¼¤ç—…äººçš„ç—‡çŠ¶æå‡º â€œè„‘æ˜¯æˆ‘ä»¬ç²¾ç¥ç”Ÿæ´»çš„æ‰€åœ¨åœ°â€
ä½†ç”±äºšé‡Œå£«å¤šå¾·åœ¨å…¬å…ƒ 4 ä¸–çºªæå‡ºçš„â€œå¿ƒè„ä¸­å¿ƒè®ºâ€ ä»ç»Ÿæ²»äº†æ¬§æ´²åå‡ ä¸ªä¸–çºªã€‚è¿™æ˜¯å› ä¸ºå½“æ—¶å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è¡€ç®¡ï¼Œä½†æ˜¯å´çœ‹ä¸æ¸…ç¥ç»</p>
<hr>
<p>å¿ƒæ™ºåŠŸèƒ½çš„å®ç°éœ€è¦å…¨è„‘è¿˜æ˜¯å±€éƒ¨è„‘ï¼Ÿ
æœ€æ—©æå‡º â€œå¿ƒæ™ºåŠŸèƒ½ä½äºç‰¹å®šå±€éƒ¨çš®å±‚åŒºåŸŸâ€ çš„æ˜¯ 18 ä¸–çºªæœ«çš„å¾·å›½è§£å‰–å­¦å®¶å’Œç”Ÿç†å­¦å®¶å¼—æœ—å…¹ Â· çº¦ç‘Ÿå¤« Â· åŠ å°”ï¼ˆFranz Joseph Gallï¼‰ï¼Œä½†ä»–çš„è®ºæ®å´æ˜¯é”™è¯¯çš„ã€‚
åŠ å°”æƒ³å½“ç„¶åœ°è®¤ä¸ºï¼Œå¦‚æœæŸä¸ªåŒºåŸŸçš„çš®å±‚ç‰¹åˆ«å‘è¾¾ï¼Œé‚£ä¹ˆå…¶ä¸Šçš„é¢…éª¨å°±ä¼šéš†èµ·ã€‚
ä»–è®¤ä¸ºåªè¦æ ¹æ®é¢…éª¨å½¢çŠ¶å°±å¯ä»¥åˆ¤æ–­äººçš„å“æ€§ï¼Œè¿™ä¸€å‡è¯´è¢«ç§°ä¸ºâ€œé¢…ç›¸å­¦â€ï¼Œå¹¶æ›¾é£è¡Œä¸€æ—¶ã€‚</p>
<h1> </h1>