

### 一、为什么需要前端监控

前端监控的目的是：

_**获取用户行为以及跟踪产品在用户端的使用情况，并以监控数据为基础，指明产品优化的方向**_。

前端监控可以分为三类：数据监控、性能监控和异常监控。下面我们来一一的了解。


### 三、前端埋点方案选型和前端上报方案设计


#### (1) 监控数据

首先我们需要明确一个产品或者网页，普遍需要监控和上报的数据。监控的分为三个阶段：用户进入网页首页、用户在网页内部交互和交互中报错。每一个阶段需要监控和上报的数据如下图所示：

![[../_resources/前端监控和前端埋点方案设计/198e424559d99162965d913cd76e56ab_MD5.png]]

#### (2) 埋点方案

在实际项目中考虑到上报数据的灵活定制，以及减少数据传输和服务器的压力，在所需埋点处不多的情况下，常用的方式是代码埋点。

以用户进入首页为例，我们在首页渲染完成后会发送事件类型和类型相关的数据给 server 端，告知首页的监控信息。

![[../_resources/前端监控和前端埋点方案设计/fdbd6819642571008f55abedc645da62_MD5.png]]

#### (3) 上报周期和上报数据类型

如果埋点的事件不是很多，上报可以时时进行，比如监控用户的交互事件，可以在用户触发事件后，立刻上报用户所触发的事件类型。如果埋点的事件较多，或者说网页内部交互频繁，可以通过本地存储的方式先缓存上报信息，然后定期上报。

接着来确定需要埋点上报的数据，上报的信息包括用户个人信息以及用户行为，主要数据可以分为：

*   who: appid(系统或者应用的 id),userAgent(用户的系统、网络等信息)
    
*   when: timestamp(上报的时间戳)
    
*   from where: currentUrl(用户当前 url)，fromUrl(从哪一个页面跳转到当前页面)，type(上报的事件类型),element(触发上报事件的元素）
    
*   what: 上报的自定义扩展数据 data:{}, 扩展数据中可以按需求定制，比如包含 uid 等信息
    

上报数据的对象为：

```
{   
    ----------------上报接口本身提供--------------------
    currentUrl,  
    fromUrl,
    timestamp,
    userAgent:{
       os,
       netWord,
    }
    ----------------业务代码配置和自定义上报数据------------
    type,
    appid,
    element,
    data:{
        uid,
        uname
    }
}


```

#### (4) 埋点和上报举例

我们以上报首屏加载事件为例，DOM 提供了 document 的 DOMContentLoaded 事件来监听 dom 挂载，提供了 window 的 load 事件来监听页面所有资源加载渲染完毕。

```
<script type="text/javascript">
  var start=Date.now();
  document.addEventListener('DOMContentLoaded', function() {
     fetch('some api',{
         type:'dom complete',
         data:{
           domCompletedTime:Date.now()-start
         }
     })
  });
  window.addEventListener('load', function() {
     fetch('some api',{
         type:'load complete',
         data:{
           LoadCompletedTime:Date.now()-start
         }
     })
  });
</script>


```

#### (5) 前端埋点系统的前后端通信加密

在上报数据的前后端通信中，需要和 server 端协商加密机制，利用 OpenSSL 库来实现的加密，OpenSSL 已经是一个广泛被采用的加密算法。前端可以采用 node 的 crypto 模块。

首先来看 hash 算法，crypto.createHash() 来创建一个 Hash 实例，可利用的 hash 算法如下：

*   md5
    
*   sha1
    
*   sha256
    
*   sha512
    
*   ripemd160
    

以 sha256 算法加密为例：

```
const str="123445";//需要加密的字段
const hash=crypto.createHash('sha256');//指定加密算法
hash.update(str); //通过算法加密相应的字段
const result=hash.digest('hex');//转化成十六进制


```

### 四、前端监控结果可视化展示系统的设计

当后端得到前端上报的信息之后，经过数据分析和处理，需要前端可视化的展示数据分析后的结果。

可以在开源中后台系统 ant-design-pro 的基础上进行二次开发，首先要明确展示信息。展示的信息包括单个用户和整体应用。

对于单个用户来说需要展示的监控信息为：

*   单个用户，在交互过程中触发各个埋点事件的次数
*   单个用户，在某个时间周期内，访问本网页的入口来源
*   单个用户，在每一个子页面的停留时间

对于全体用户需要展示的信息为：

*   某一个时间段内网页的 PV 和 UV
*   全体用户访问网页的设备和操作系统分析
*   某一个时间段内访问本网页的入口来源分析
*   全体用户在访问本网页时，在交互过程中触发各个埋点事件的总次数
*   全体用户在访问本网页时，网页上报异常的集合

删选功能集合：

*   时间筛选：提供今日（00 点到当前时间）、本周、本月和全年
*   用户删选：提供根据用户 id 删选出用户行为的统计信息
*   设备删选：删选不同系统的整体展示信息