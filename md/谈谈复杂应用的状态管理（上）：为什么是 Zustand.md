> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [juejin.cn](https://juejin.cn/post/7177216308843380797?searchId=20240126153450902039BAB3C63517BA67)

> ğŸ™‹ğŸ»â€â™€ï¸ ç¼–è€…æŒ‰ï¼šæœ¬æ–‡ä½œè€…æ˜¯èš‚èšé›†å›¢ä½“éªŒè®¾è®¡å¸ˆé—»å†°ï¼ˆç¤¾åŒºç§°å‘¼ï¼šç©ºè°·ï¼‰ ï¼Œæœ¬ç¯‡ä¸­ï¼Œé—»å†°é¦–å…ˆä»‹ç»äº†é‚£äº›å¤æ‚åº”ç”¨çš„çŠ¶æ€ç®¡ç†å¤©å‘ï¼Œè®¤ä¸º zustand æ˜¯å½“ä¸‹å¤æ‚çŠ¶æ€ç®¡ç†çš„æœ€ä½³é€‰æ‹©ï¼Œå¹¶ä»çŠ¶æ€å…±äº«ã€çŠ¶æ€å˜æ›´ã€çŠ¶æ€æ´¾ç”Ÿã€æ€§èƒ½ä¼˜åŒ–ç­‰ 6 ä¸ªæ–¹é¢è¯ é‡Šäº†é€‰æ‹©å®ƒçš„ç†ç”±ã€‚æœ¬ç¯‡ä¸ºä¸Šç¯‡ï¼Œä¸‹ç¯‡å°†ä»‹ç» Zustand çš„æ¸è¿›å¼çŠ¶æ€ç®¡ç†å®è·µï¼Œæ•¬è¯·æœŸå¾…ï½

ä½œä¸ºä¸€åä¸»ä¸šåšè®¾è®¡ï¼Œä¸šä½™æå‰ç«¯çš„å°èœé¸¡ï¼Œåˆ° 2020 å¹´åº•ä¸ºæ­¢éƒ½æ˜¯ç”¨äº‘è°¦å¤§ä½¬çš„ dva ä¸€æŠŠæ¢­ã€‚å½“æ—¶æ•´ä½“çš„ä½¿ç”¨ä½“éªŒè¿˜æ˜¯æŒºå¥½çš„ï¼Œå¯¹äºæˆ‘è¿™æ ·çš„å‰ç«¯èœé¸¡ä¸Šæ‰‹é—¨æ§›ä½ï¼Œè€Œä¸”å­¦ä¸€æ¬¡å“ªéƒ½å¯ç”¨ï¼Œå½“æ—¶ä»æ¥æ²¡æ„è¿‡çŠ¶æ€ç®¡ç†ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12eff08fce9c4b8480ccd323cc39939b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

è‡³ä»Š Kitchen3 é‡Œä»ç„¶èººç€ç”¨ dva åšçŠ¶æ€ç®¡ç†çš„åŠŸèƒ½æ¨¡å—ï¼Œå†™äº 2020 å¹´

ç›´åˆ° hooks æ¨ªç©ºå‡ºä¸–ï¼Œ TypeScript é€æ­¥æµè¡Œã€‚ä¸€æ–¹é¢ï¼Œä» react hooks å‡ºæ¥ä»¥åï¼Œå¤§é‡çš„æ–‡ç« å¼€å§‹é¼“å¹ã€Œä½ ä¸éœ€è¦ Reduxã€ã€ã€ŒuseState + Contextã€å®Œå…¨å¯ç”¨ã€ã€Œnext-unstatedã€YYDS ç­‰ç­‰ã€‚å¦ä¸€æ–¹é¢ï¼Œç”±äº Dva ä¸å†ç»´æŠ¤ï¼Œå…¶åœ¨ ts ä¸‹çš„éƒ½æ²¡æœ‰ä»»ä½•æç¤ºçš„é—®é¢˜ä¹Ÿé€æ­¥æš´éœ²ã€‚

åœ¨å°è¯•ä¸€äº›å°é¡¹ç›®ä¸­ä½¿ç”¨ hooks åæ„Ÿè§‰è¿˜è¡Œä¹‹åï¼Œä½œä¸ºå°èŒæ–°çš„æˆ‘ä¹Ÿå…¨é¢è½¬å‘äº† hooks çš„æ€€æŠ±ã€‚ä¸­é—´å…¶å®ä¸€ç›´æ²¡æ€ä¹ˆé‡åˆ°é—®é¢˜ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å‰ç«¯åº”ç”¨çš„å¤æ‚åº¦ä¹Ÿå°±é‚£æ ·ï¼Œhooks é—®é¢˜ä¸å¤§ã€‚ç„¶åå‘¢ï¼Ÿç„¶åä»å»å¹´å¼€å§‹å°±åœ¨å¤æ‚åº”ç”¨é‡Œè¸©å‘äº†ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cc649612605344b4815dea9812c275d5~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å¤æ‚åº”ç”¨çš„çŠ¶æ€ç®¡ç†å¤©å‘
-----------

> ProEditor æ˜¯å†…éƒ¨ç»„ä»¶åº“ TechUI Studio çš„ç¼–è¾‘å™¨ç»„ä»¶ã€‚

ä¸šåŠ¡ç»„ä»¶ ProEditor å°±æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„ä¾‹å­ã€‚ç”±äº ProEditor æ˜¯ä¸ªç¼–è¾‘å™¨ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ç¼–è¾‘ä½“éªŒéå¸¸é‡è¦ï¼Œæ˜¯ä¸€ä¸ªé‡äº¤äº’æ“ä½œçš„åº”ç”¨ï¼Œè¿™å°±ä¼šç‰µæ‰¯åˆ°å¤§é‡çš„çŠ¶æ€ç®¡ç†éœ€æ±‚ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bb4844cdb434a6596981a6b766ed93a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å…ˆç®€å•æ¥åˆ—ä¸‹ ProEditor çš„çŠ¶æ€ç®¡ç†éœ€æ±‚æœ‰å“ªäº›ï¼š

**â¶ Editor å®¹å™¨çŠ¶æ€ç®¡ç†ä¸ç»„ä»¶ï¼ˆTableï¼‰çŠ¶æ€ç®¡ç†æ‹†åˆ†ï¼Œä½†å¯è”åŠ¨æ¶ˆè´¹ï¼›**

å®¹å™¨çŠ¶æ€è´Ÿè´£äº†ä¸€äº›åå…¨å±€é…ç½®çš„çŠ¶æ€ç»´æŠ¤ï¼Œæ¯”å¦‚ç”»å¸ƒã€ä»£ç é¡µçš„åˆ‡æ¢ï¼Œæ˜¯å¦æ¿€æ´»ç”»å¸ƒäº¤äº’ç­‰ç­‰ï¼Œè€Œç»„ä»¶çš„çŠ¶æ€åˆ™æ˜¯ä¿å­˜äº†ç»„ä»¶æœ¬èº«çš„æ‰€æœ‰é…ç½®å’ŒçŠ¶æ€ã€‚

è¿™ä¹ˆåšçš„å¥½å¤„åœ¨äºä¸åŒç»„ä»¶å¯èƒ½ä¼šæœ‰ä¸åŒçš„çŠ¶æ€ï¼Œè€Œ Editor çš„å®¹å™¨çŠ¶æ€å¯ä»¥å¤ç”¨ï¼Œæ¯”å¦‚åš ProForm çš„æ—¶å€™ï¼ŒEditor çš„å®¹å™¨ä»ç„¶å¯ä»¥æ˜¯åŒä¸€ä¸ªï¼Œç»„ä»¶çŠ¶æ€åªéœ€é¢å¤–å®ç° ProForm çš„ Store å³å¯ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d40903358744ccaa4c5a29e7f0d5436~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼ŒTable çš„çŠ¶æ€å°±æ˜¯ Editor çš„ config å­—æ®µï¼Œå½“ Table æ”¹æ—¶ï¼Œä¼šè§¦å‘ Editor çš„ config å­—æ®µåŒæ­¥æ›´æ–°ã€‚å½“ Editor æ›´æ–°æ—¶ï¼Œä¹Ÿä¼šè§¦å‘è¯¥æ•°æ®æ›´æ–°ã€‚

æœ€åˆçš„ç‰ˆæœ¬ï¼Œæˆ‘ä½¿ç”¨äº† Provider + Context çš„æ–¹å¼æ¥åšå…¨å±€çŠ¶æ€ç®¡ç†ã€‚å¤§æ¦‚çš„å†™æ³•æ˜¯è¿™æ ·çš„ï¼š

```
// å®šä¹‰
export const useStudioStore = (props?: ProEditorProps) => {
  // ...
  const tableStore = useTableStore(props?.value);
  const [tabKey, switchTab] = useState(TabKey.canvas);
  const [activeConfigTab, switchConfigTab] = useState<TableConfigGroup>(TableConfigGroup.Table);
  // ...
}

export const StudioStore = createContextStore(useStudioStore, {});

// æ¶ˆè´¹ 
const NavBar: FC<NavBarProps> = ({ logo }) => {
  const { tabKey } = useContext(StudioStore);
  return ...
}
```

ç”±äºè¿™ä¸€ç‰ˆæ˜¯ Context ä¸€æ†æ¨åˆ°åº•ï¼Œè¿™é€ æˆäº†ä¸€äº›å¾ˆç¦»è°±çš„äº¤äº’åé¦ˆï¼Œå°±æ˜¯æ¯ä¸€æ¬¡ç‚¹å‡»å…¶ä»–ä»»ä½•åœ°æ–¹ï¼ˆä¾‹å¦‚ç”»å¸ƒä»£ç ã€ç»„ä»¶çš„é…ç½®é¡¹ï¼‰ï¼Œéƒ½ä¼šé€ æˆé¢æ¿çš„ Tabs é‡æ–°æ¸²æŸ“ï¼ˆå·¦ä¸‹å›¾ï¼‰ã€‚å³ä¸‹å›¾æ˜¯ç›¸åº”çš„é‡æ¸²æŸ“åˆ†æå›¾ï¼Œå¯ä»¥çœ‹åˆ°ä»»ä½•åŠ¨ä½œéƒ½é€ æˆäº†é‡æ–°æ‰€æœ‰é¡µé¢å…ƒç´ çš„é‡æ¸²æŸ“ã€‚è€Œè¿™è¿˜æ˜¯æœ€æ—©æœŸçš„ demo ç‰ˆæœ¬ï¼ŒåŠŸèƒ½å’Œæ•°æ®é‡çš„æ‰å®ç°åˆ° 20% å·¦å³ã€‚æ‰€ä»¥å¯ä»¥é¢„è§åˆ°å¦‚æœä¸åšä»»ä½•ä¼˜åŒ–ï¼Œä½¿ç”¨ä½“éªŒä¼šå·®åˆ°ä»€ä¹ˆç¨‹åº¦ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a41a3b18a92741bcb0d235962eb67c9d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6803d4a47aaf4d2898c7d00ddf329027~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

**â· éœ€è¦è¿›è¡Œå¤æ‚çš„æ•°æ®å¤„ç†**

ProEditor é’ˆå¯¹è¡¨æ ¼ç¼–è¾‘ï¼Œåšäº†å¤§é‡çš„æ•°æ®å˜æ¢æ“ä½œã€‚æ¯”å¦‚ ProTable ä¸­é’ˆå¯¹ `columns` è¿™ä¸ªå­—æ®µçš„æ›´æ–°å°±æœ‰ 14 ç§æ“ä½œã€‚æ¯”å¦‚å…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“è¢«æ„ŸçŸ¥çš„`updateColumnByOneAPI` å°±æ˜¯åŸºäº oneAPI çš„å­—æ®µä¿¡æ¯æ›´æ–°ï¼Œç»†é¢—ç²’åº¦åœ°è°ƒæ•´ columns é‡Œçš„å­—æ®µä¿¡æ¯ã€‚è€Œè¿™æ ·çš„å­—æ®µä¿®æ”¹ç±»å‹çš„ storeï¼Œåœ¨ ProEditor ä¸­é™¤äº† `columns` è¿˜æœ‰ä¸€ä¸ª `data`ã€‚

å½“æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®å˜æ›´æ–¹æ³•çš„å¯ç»´æŠ¤æ€§ä¸ action çš„ä¸å˜æ€§ï¼Œæˆ‘é‡‡ç”¨äº† userReducer åšå˜æ›´æ–¹æ³•çš„ç®¡ç†ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d1285d8364e74def85bedd8494cf46bd~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å› ä¸ºä¸€æ—¦é‡‡ç”¨è‡ªå®šä¹‰ hooks ï¼Œå°±å¾—å†™æˆä¸‹é¢è¿™æ ·æ‰èƒ½ä¿è¯ä¸ä¼šé‡å¤æ¸²æŸ“ï¼Œä¼šé€ æˆæå¤§çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œä¸€æ—¦å‡ºç°æ•°æ®ä¸å¯¹çš„æƒ…å†µï¼Œå¾ˆéš¾æ’æŸ¥åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•æˆ–è€…ä¾èµ–æœ‰é—®é¢˜ã€‚

```
// è‡ªå®š hook çš„å†™æ³•
const useDataColumns = () => {
  const createOrUpdateColumnsByMockData = useCallback(()=>{
    // ...
  },[a,b]);
  const createColumnsByOneAPI = useCallback(()=>{
    // ...
  },[c,d]);
  const updateColumnsByOneAPI = useCallback(()=>{
    // ...
  },[a,b,c,d]);
  // ...
}
```

ä½† useReducer ä¹Ÿæœ‰å¾ˆå¤§çš„å±€é™æ€§ï¼Œä¾‹å¦‚ä¸æ”¯æŒå¼‚æ­¥å‡½æ•°ã€ä¸æ”¯æŒå†…éƒ¨çš„ reducer äº’ç›¸è°ƒç”¨ï¼Œä¸æ”¯æŒå’Œå…¶ä»– state è”åŠ¨ï¼ˆæ¯”å¦‚è¦å½“å‚æ•°ç©¿è¿›å»æ‰å¯ç”¨ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯æœ€ä¼˜è§£ã€‚

**â¸ æ˜¯ä¸ªå¯è¢«å¤–éƒ¨æ¶ˆè´¹çš„ç»„ä»¶**

ä¸€æ—¦æåˆ°ç»„ä»¶ï¼ŒåŠ¿å¿…è¦æéå—æ§æ¨¡å¼å’Œå—æ§æ¨¡å¼ã€‚ä¸ºäº†æ”¯æŒå¥½æˆ‘ä»¬è‡ªå·±çš„åœºæ™¯ï¼Œä¸”å¸Œæœ›æŠŠ ProEditor å˜æˆä¸€ä¸ªå¥½ç”¨çš„ä¸šåŠ¡ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åšäº†å—æ§æ¨¡å¼ï¼Œæ¯•ç«Ÿä¸€ä¸ªå¥½ç”¨çš„ç»„ä»¶ä¸€å®šæ˜¯è¦èƒ½åŒæ—¶æ”¯æŒå¥½è¿™ä¸¤ç§æ¨¡å¼çš„ã€‚

åœ¨å®é™…åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æ—¢éœ€è¦é…ç½®é¡¹ï¼ˆ`config`ï¼‰å—æ§ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦ç”»å¸ƒäº¤äº’çŠ¶æ€ï¼ˆ`interaction`ï¼‰å—æ§ï¼Œä¾‹å¦‚ä¸‹é¢çš„åœºæ™¯ï¼šåœ¨æ¿€æ´»æŸä¸ªå•å…ƒæ ¼çŠ¶æ€æ—¶ç‚¹å‡»ç”Ÿæˆï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªé€‰ä¸­çŠ¶æ€è¿›è¡Œé‡ç½®ï¼Œæ‰èƒ½ç”Ÿæˆç¬¦åˆé¢„æœŸçš„è®¾è®¡ç¨¿ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d956e82cfde4af7a7110f9b16fb70e4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

æ‰€ä»¥ä¸ºäº†æ”¯æŒç»†é¢—ç²’åº¦çš„å—æ§èƒ½åŠ›ï¼Œæˆ‘ä»¬æä¾›äº†å¤šä¸ªå—æ§å€¼ï¼Œä¾›å¤–éƒ¨å—æ§æ¨¡å¼ã€‚

```
// ProEditor å¤–éƒ¨æ¶ˆè´¹çš„ Demo ç¤ºæ„
export default () => {
  const [status, setStatus] = useState();
  const { config, getState } = useState();

  return  (
    <ProEditor
      // config å’Œ onConfigChange æ˜¯ä¸€å¯¹
      config={config}
      onConfigChange={({ config }) => {
        setConfig(config);
      }}
      // interaction å’Œ onInteractionChange æ˜¯å¦ä¸€å¯¹å—æ§
      interaction={status}
      onInteractionChange={(s) => {
        setStatus(s);
      }}
      />
  );
}
```

ä½†å½“æˆ‘ä»¬ä¸€å¼€å§‹å†™å¥½è¿™ä¸ªå—æ§ apiï¼Œå¾—åˆ°ç»“æœæ˜¯è¿™æ ·çš„ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05cd7d43378e4147a51e47f4dd14b009~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œ**æ­»å¾ªç¯äº†**ã€‚ é‡åˆ°è¿™ä¸ªé—®é¢˜æ—¶è®©äººå¤´æåº¦ç§ƒï¼Œå› ä¸ºåŸæœ¬ä»¥ä¸ºæ˜¯ä¸ªå¾ˆç®€å•çš„åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨ React ç”Ÿå‘½å‘¨æœŸé‡Œçš„è¡¨ç°è®©äººè´¹è§£ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨ useEffect åšçŠ¶æ€ç®¡ç†çš„æ—¶å€™ã€‚

```
// å¯¼è‡´æ­»å¾ªç¯çš„å†™æ³•
const useTableStore = (state: Partial<Omit<ProTableConfigStore, 'columns' | 'data'>>) => {
  const { defaultConfig, config: outsourceValue, mode } = props;
  const { columns, isEmptyColumns, dispatchColumns } = useColumnStore(defaultConfig?.columns, mode);
  // å—æ§æ¨¡å¼ å†…éƒ¨å€¼ä¸å¤–éƒ¨åŒå‘é€šä¿¡
  useEffect(() => {
    // æ²¡æœ‰å¤–éƒ¨å€¼å’Œå˜æ›´æ—¶ä¸æ›´æ”¹
    if (!outsourceValue) return;
    // ç›¸ç­‰å€¼çš„æ—¶å€™ä¸åšæ›´æ–°
    if (isEqual(dataStore, outsourceValue)) return;
    if (outsourceValue.columns) {
      dispatchColumns({ type: 'setAll', columns: outsourceValue.columns });
    }
  }, [dataStore, outsourceValue]);

  const dataStore = useMemo(() => {
    const v = { ...store, data, columns } as ProTableConfigStore;
    // dataStore å˜æ›´æ—¶éœ€è¦å¯¹å¤–å˜æ›´ä¸€æ¬¡
    if (props.onChange && !isEqual(v, outsourceValue)) {
      props.onChange?.({
        config: v,
        props: tableAsset.generateProps(v),
        isEmptyColumns,
      });
    }
    return v;
  }, [data, store, columns, outsourceValue]);

  // ...
}
```

é€ æˆä¸Šè¿°é—®é¢˜çš„åŸå› å¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸ºç»„ä»¶å†… onChange çš„æ—¶æœºè®¾ç½®ã€‚ä¸€æ—¦ä»£ç é‡Œç”¨ useEffect çš„æ–¹å¼å»ç›‘å¬å˜æ›´è§¦å‘ onChangeï¼Œæœ‰å¾ˆå¤§çš„æ¦‚ç‡ä¼šé€ æˆæ­»å¾ªç¯ã€‚

**â¹ æœªæ¥è¿˜å¸Œæœ›èƒ½æ”¯æŒæ’¤é”€é‡åšã€å¿«æ·é”®ç­‰èƒ½åŠ›**

æ¯•ç«Ÿï¼Œç°ä»£çš„ç¼–è¾‘å™¨éƒ½æ˜¯æ”¯æŒå¿«æ·é”®ã€å†å²è®°å½•ã€å¤šäººååŒç­‰å¢å¼ºå‹çš„åŠŸèƒ½çš„ã€‚è¿™äº›èƒ½åŠ›æ€ä¹ˆåœ¨ç¼–è¾‘å™¨çš„çŠ¶æ€ç®¡ç†ä¸­ä»¥ä½æˆæœ¬ã€æ˜“ç»´æŠ¤çš„æ–¹å¼è¿›è¡Œå®æ–½ï¼Œä¹Ÿéå¸¸é‡è¦ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2763a112eae948bbb361906a382cccba~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

æ€»ä¹‹ï¼Œå¼€å‘ ProEditor çš„ç»å†ï¼Œä¸€å¥è¯çš„è¡€æ³ªæ•™è®­å°±æ˜¯ï¼š

**å¤æ‚åº”ç”¨çš„çŠ¶æ€ç®¡ç†çœŸçš„ä¸èƒ½è£¸å†™ hooksï¼**

**å¤æ‚åº”ç”¨çš„çŠ¶æ€ç®¡ç†çœŸçš„ä¸èƒ½è£¸å†™ hooksï¼**

**å¤æ‚åº”ç”¨çš„çŠ¶æ€ç®¡ç†çœŸçš„ä¸èƒ½è£¸å†™ hooksï¼**

é‚£äº›é¼“å¹è£¸å†™ hooks çš„äººå¤§æ¦‚ç‡æ˜¯æ²¡é‡åˆ°è¿‡å¤æ‚ caseï¼Œæ€§èƒ½ä¼˜åŒ–ã€å—æ§ã€action äº’è°ƒã€æ•°æ®åˆ‡ç‰‡ã€çŠ¶æ€è°ƒè¯•ç­‰å‘ï¼Œæ¯ä¸€é¡¹éƒ½ä¸æ˜¯å¥½æƒ¹çš„ä¸»ï¼Œå¤Ÿäººå–ä¸Šä¸€å£¶ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ce7332514c043668eb2d9f1ef7580d6~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

ä¸ºä»€ä¹ˆæ˜¯ Zustand ï¼Ÿ
--------------

å…¶å®ï¼Œå¤æ‚åº”ç”¨åªæ˜¯å¼€å‘è€…çŠ¶æ€ç®¡ç†éœ€æ±‚çš„é›†ä¸­ä½“ç°ã€‚å¦‚æœæˆ‘ä»¬æŠŠçŠ¶æ€ç®¡ç†å½“æˆä¸€æ¬¾äº§å“æ¥è®¾è®¡ï¼Œæˆ‘ä»¬ä¸å¦¨çœ‹çœ‹å¼€å‘è€…åœ¨çŠ¶æ€ç®¡ç†ä¸‹çš„æ ¸å¿ƒéœ€æ±‚æ˜¯ä»€ä¹ˆã€‚

æˆ‘ç›¸ä¿¡é€šè¿‡ä»¥ä¸‹è¿™ä¸€ä¸²åˆ†æï¼Œä½ ä¼šå‘ç° zustand æ˜¯çœŸçœŸæ­£æ­£æ»¡è¶³ã€Œå‡ ä¹æ‰€æœ‰ã€çŠ¶æ€ç®¡ç†éœ€æ±‚çš„å·¥å…·ï¼Œå¹¶ä¸”åœ¨å¾ˆå¤šç»†èŠ‚ä¸Šåšåˆ°äº†ä½“éªŒæ›´ä¼˜ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60cc9ae660a64052941e7d800a39b5a1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å®˜ç½‘ï¼š [zustand-demo.pmnd.rs/](https://link.juejin.cn?target=https%3A%2F%2Fzustand-demo.pmnd.rs%2F "https://zustand-demo.pmnd.rs/")

### â¶ çŠ¶æ€å…±äº«

**çŠ¶æ€ç®¡ç†æœ€å¿…è¦çš„ä¸€ç‚¹å°±æ˜¯çŠ¶æ€å…±äº«**ã€‚è¿™ä¹Ÿæ˜¯ context å‡ºæ¥ä»¥åï¼Œå¤§éƒ¨åˆ†æ–‡ç« è¯´ä¸éœ€è¦ redux çš„æ ¹æœ¬åŸå› ã€‚å› ä¸º context å¯ä»¥å®ç°æœ€æœ€åŸºç¡€çš„çŠ¶æ€å…±äº«ã€‚ä½†è¿™ç§æ–¹æ³•ï¼ˆåŒ…æ‹¬ redux åœ¨å†…ï¼‰ï¼Œéƒ½éœ€è¦åœ¨æœ€å¤–å±‚åŒ…ä¸€ä¸ª Providerã€‚ Context ä¸­çš„å€¼éƒ½åœ¨ Provider çš„ä½œç”¨åŸŸä¸‹æœ‰æ•ˆã€‚

```
// Context çŠ¶æ€å…±äº«

// store.ts
export const StoreContext = createStoreContext(() => { ... });

// index.tsx
import { appState, StoreContext } from './store';

root.render(
    <StoreContext.Provider value={appState}>
      <App />
    </StoreContext.Provider>
);

// icon.tsx
import { StoreContext } from './store';

const ReplaceGuide: FC = () => {
  const { i18n, hideGuide, settings } = useContext(StoreContext);

  // ...
  return ...
}
```

è€Œ zustand åšåˆ°çš„ç¬¬ä¸€ç‚¹åˆ›æ–°å°±æ˜¯ï¼š**é»˜è®¤ä¸éœ€è¦ Provider**ã€‚ç›´æ¥å£°æ˜ä¸€ä¸ª hooks å¼çš„ useStore åå°±å¯ä»¥åœ¨ä¸åŒç»„ä»¶ä¸­è¿›è¡Œè°ƒç”¨ã€‚å®ƒä»¬çš„çŠ¶æ€ä¼šç›´æ¥å…±äº«ï¼Œç®€å•è€Œç¾å¥½ã€‚

```
// Zustand çŠ¶æ€å…±äº«

// store.ts
import create from 'zustand'

export const useStore = create(set => ({
  count: 1,
  inc: () => set(state => ({ count: state.count + 1 })),
}))

// Control.tsx
import { useStore } from './store';

function Control() {
  return <button onClick={()=>{
    useStore.setState((s)=>({...s,count: s.count - 5 }))
    }}>ï¼5</button>
}

// AnotherControl.tsx
import { useStore } from './store';

function AnotherControl() {
  const inc = useStore(state => state.inc)
  return <button onClick={inc}> +1 </button>
}

// Counter.tsx
import { useStore } from './store';

function Counter() {
  const { count } = useStore()
  return <h1>{count}</h1>  
}
```

ç”±äºæ²¡æœ‰ Provider çš„å­˜åœ¨ï¼Œæ‰€ä»¥å£°æ˜çš„ useStore é»˜è®¤éƒ½æ˜¯å•å®ä¾‹ï¼Œå¦‚æœéœ€è¦å¤šå®ä¾‹çš„è¯ï¼Œzustand ä¹Ÿæä¾›äº†å¯¹åº”çš„ Provider çš„[ä¹¦å†™æ–¹å¼](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpmndrs%2Fzustand%23react-contexthttps%3A%2F%2Fgithub.com%2Fpmndrs%2Fzustand%23react-context "https://github.com/pmndrs/zustand#react-contexthttps://github.com/pmndrs/zustand#react-context")ï¼Œè¿™ç§æ–¹å¼åœ¨ç»„ä»¶åº“ä¸­æ¯”è¾ƒå¸¸ç”¨ã€‚ ProEditor ä¹Ÿæ˜¯ç”¨çš„è¿™ç§æ–¹å¼åšåˆ°äº†å¤šå®ä¾‹ã€‚

æ­¤å¤–ï¼Œzustand çš„ store çŠ¶æ€æ—¢å¯ä»¥åœ¨ react ä¸–ç•Œä¸­æ¶ˆè´¹ï¼Œä¹Ÿå¯ä»¥åœ¨ react ä¸–ç•Œå¤–æ¶ˆè´¹ã€‚

### â· çŠ¶æ€å˜æ›´

çŠ¶æ€ç®¡ç†é™¤äº†çŠ¶æ€å…±äº«å¤–ï¼Œå¦å¤–ç¬¬äºŒä¸ªæå…¶å¿…è¦çš„èƒ½åŠ›å°±æ˜¯çŠ¶æ€å˜æ›´ã€‚åœ¨å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦è‡ªè¡Œç»„ç»‡ç›¸åº”çš„çŠ¶æ€å˜æ›´æ–¹æ³•ï¼Œä¸ç„¶ä¸å¥½ç»´æŠ¤ã€‚è¿™ä¹Ÿæ˜¯è€ƒéªŒä¸€ä¸ªçŠ¶æ€ç®¡ç†åº“å¥½ä¸å¥½ç”¨çš„ä¸€ä¸ªå¿…è¦æŒ‡æ ‡ã€‚

hooks çš„ `setState` æ˜¯åŸå­çº§çš„å˜æ›´çŠ¶æ€ï¼Œhold ä¸ä½å¤æ‚é€»è¾‘ï¼›è€Œ `useReducer` çš„ hooks å€Ÿé‰´äº† redux çš„æ€æƒ³ï¼Œæä¾›äº† dispatch å˜æ›´çš„æ–¹å¼ï¼Œä½†å’Œ redux çš„ reducer ä¸€æ ·ï¼Œè¿™ç§æ–¹å¼æ²¡æ³•å¤„ç†å¼‚æ­¥ï¼Œä¸”æ²¡æ³•äº’ç›¸è°ƒç”¨ï¼Œä¸€æ—¦é‡ä¸Šå°±å®¹æ˜“æ‰è¥Ÿè§è‚˜ã€‚

è‡³äº redux ï¼Œå“ªæ€•æ˜¯æœ€æ–°çš„ `redux-toolkit` ä¸­ä¼˜åŒ–å¤§é‡ redux çš„æ¨¡æ¿ä»£ç ï¼Œé’ˆå¯¹åŒæ­¥å¼‚æ­¥æ–¹æ³•çš„ä¹¦å†™ä»ç„¶è®©äººå¿ƒç”Ÿç•æƒ§ã€‚

```
// redux-toolkit çš„ç”¨æ³•

import { createAsyncThunk, createSlice } from '@reduxjs/toolkit'
import { userAPI } from './userAPI'

// 1. åˆ›å»ºå¼‚æ­¥å‡½æ•°
const fetchUserById = createAsyncThunk(
  'users/fetchByIdStatus',
  async (userId, thunkAPI) => {
    const response = await userAPI.fetchById(userId)
    return response.data
  }
)

const usersSlice = createSlice({
  name: 'users',
  initialState: { entities: [], loading: 'idle' },
  // åŒæ­¥çš„ reducer æ–¹æ³•
  reducers: {

  },
  // å¼‚æ­¥çš„ AsyncThunk æ–¹æ³•
  extraReducers: (builder) => {
    // 2. å°†å¼‚æ­¥å‡½æ•°æ·»åŠ åˆ° Slice ä¸­
    builder.addCase(fetchUserById.fulfilled, (state, action) => {
      state.entities.push(action.payload)
    })
  },
})

// 3. è°ƒç”¨å¼‚æ­¥æ–¹æ³•
dispatch(fetchUserById(123))
```

è€Œåœ¨ zustand ä¸­ï¼Œå‡½æ•°å¯ä»¥ç›´æ¥å†™ï¼Œå®Œå…¨ä¸ç”¨åŒºåˆ†åŒæ­¥æˆ–è€…å¼‚æ­¥ï¼Œä¸€ä¸‹å­æŠŠåŒºåˆ†åŒæ­¥å¼‚æ­¥çš„å¿ƒæ™ºè´Ÿæ‹…é™åˆ°äº† 0ã€‚

```
// zustand store å†™æ³•

// store.ts
import create from 'zustand';

const initialState = {
 // ...
};

export const useStore = create((set, get) => ({
  ...initialState,
  createNewDesignSystem: async () => {
    const { params, toggleLoading } = get();

    toggleLoading();
    const res = await dispatch('/hitu/remote/create-new-ds', params);
    toggleLoading();

    if (!res) return;

    set({ created: true, designId: res.id });
  },
  toggleLoading: () => {
    set({ loading: !get().loading });
  }
}));

// CreateForm.tsx
import { useStore } from './store';

const CreateForm: FC = () => {
  const { createNewDesignSystem } = useStore();

  // ...
}
```

å¦å¤–ä¸€ä¸ªè®©äººéå¸¸èˆ’å¿ƒçš„ç‚¹åœ¨äºï¼Œ**zustand ä¼šé»˜è®¤å°†æ‰€æœ‰çš„å‡½æ•°ä¿æŒåŒä¸€å¼•ç”¨**ã€‚æ‰€ä»¥ç”¨ zustand å†™çš„æ–¹æ³•ï¼Œé»˜è®¤éƒ½ä¸ä¼šé€ æˆé¢å¤–çš„é‡å¤æ¸²æŸ“ã€‚ï¼ˆPSï¼šè¿™é‡Œå†é¡ºå¸¦å¹ä¸€ä¸‹ WebStorm å¯¹äºå‡½æ•°å’Œå˜é‡çš„è¯†åˆ«èƒ½åŠ›ï¼Œéå¸¸å¥½ç”¨ï¼‰

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab9dfe01735b4b9b959e314a0e13f704~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

åœ¨ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰ zustand çš„ useStore å‡ºæ¥çš„å€¼æˆ–è€…æ–¹æ³•ï¼Œéƒ½æ˜¯æ©™è‰²çš„å˜é‡ï¼Œå…·æœ‰ç¨³å®šå¼•ç”¨ï¼Œä¸ä¼šé€ æˆä¸å¿…è¦çš„é‡å¤æ¸²æŸ“ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/783010b27d144859b244e6464a1c21b1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

è€ŒçŠ¶æ€å˜æ›´å‡½æ•°çš„æœ€åä¸€ä¸ªå¾ˆé‡è¦ï¼Œä½†å¾€å¾€åˆä¼šè¢«å¿½ç•¥çš„ä¸€ç‚¹ï¼Œå°±æ˜¯**æ–¹æ³•éœ€è¦è°ƒç”¨å½“å‰å¿«ç…§ä¸‹çš„å€¼æˆ–æ–¹æ³•**ã€‚

åœ¨å¸¸è§„çš„å¼€å‘å¿ƒæ™ºä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šåœ¨å¼‚æ­¥æ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨å½“å‰å¿«ç…§çš„å€¼æ¥å‘èµ·è¯·æ±‚ï¼Œæˆ–ä½¿ç”¨åŒæ­¥æ–¹æ³•è¿›è¡ŒçŠ¶æ€å˜æ›´ï¼Œè¿™ä¼šæœ‰æå¥½çš„çŠ¶æ€å†…èšæ€§ã€‚

æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ–¹æ³•å«ã€ŒåºŸå¼ƒè‰ç¨¿ã€ï¼Œéœ€è¦è·å–å½“å‰çš„ä¸€ä¸ª id ï¼Œå‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚åšæ•°æ®å˜æ›´ï¼ŒåŒæ—¶ä¸ºäº†ä¿è¯å½“å‰ç•Œé¢çš„æ•°æ®æ˜¾ç¤ºæœ‰æ•ˆæ€§ï¼Œå˜æ›´å®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è·å–æ•°æ®ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ hooks ç‰ˆæœ¬å’Œ zustand çš„å†™æ³•å¯¹æ¯”ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
// hooks ç‰ˆæœ¬

export const useStore = () => {
  const [designId, setDesignId] = useState();
  const [loading, setLoading] = useState(false);

  const refetch = useCallback(() => {
    if (designId) {
      mutateKitchenSWR('/hitu/remote/ds/versions', designId);
    }
  }, [designId]);

  const deprecateDraft = useCallback(async () => {
    setLoading(true);
    const res = await dispatch('/hitu/remote/ds/deprecate-draft', designId);
    setLoading(false);

    if (res) {
      message.success('è‰ç¨¿åˆ é™¤æˆåŠŸ');
    }

    // é‡æ–°è·å–ä¸€éæ•°æ®
    refetch();
  }, [designId, refetch]);

  return {
    designId,
    setDesignId,
    loading,
    deprecateDraft,
    refetch,
  }
};
```

```
// zustand å†™æ³•

const initialState = { designId: undefined, loading: false };

export const useStore = create((set, get) => ({
  ...initialState,
  deprecateDraft: async () => {
    set({ loading: true });
    const res = await dispatch('/hitu/remote/ds/deprecate-draft', get().designId);
    set({ loading: false });

    if (res) {
      message.success('è‰ç¨¿åˆ é™¤æˆåŠŸ');
    }

    // é‡æ–°è·å–ä¸€éæ•°æ®
    get().refetch();
  },
  refetch: () => {
    if (get().designId) {
      mutateKitchenSWR('/hitu/remote/ds/versions', get().designId);
    }
  },
})
```

å¯ä»¥æ˜æ˜¾çœ‹åˆ°ï¼Œå…‰æ˜¯ä»ä»£ç é‡ä¸Š zustand çš„ store æ¯” hooks å‡å°‘äº† 30% ã€‚ä¸è¿‡å¦å¤–å®¹æ˜“è¢«å¤§å®¶å¿½ç•¥ï¼Œä½†å…¶å®æ›´é‡è¦çš„æ˜¯ï¼Œ **hooks ç‰ˆæœ¬ä¸­äº’è°ƒå¸¦æ¥äº†å¼•ç”¨å˜æ›´çš„é—®é¢˜**ã€‚

ç”±äº `deprecateDraft` å’Œ `refetch` éƒ½è°ƒç”¨äº† `designId`ï¼Œè¿™å°±ä¼šä½¿å¾—å½“ `designId` å‘ç”Ÿå˜æ›´æ—¶ï¼Œ`deprecateDraft` å’Œ `refetch` çš„å¼•ç”¨ä¼šå‘ç”Ÿå˜æ›´ï¼Œè‡´ä½¿ react è§¦å‘åˆ·æ–°ã€‚è€Œè¿™åœ¨æœ‰æ€§èƒ½ä¼˜åŒ–éœ€æ±‚çš„åœºæ™¯ä¸‹éå¸¸é˜´é—´ï¼Œä¼šè®©ä¸è¯¥æ¸²æŸ“çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚é‚£è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ react è¦æä¸€ä¸ª `useEvent` çš„åŸå› ï¼ˆ[RFC](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freactjs%2Frfcs%2Fblob%2Fuseevent%2Ftext%2F0000-useevent.md "https://github.com/reactjs/rfcs/blob/useevent/text/0000-useevent.md")ï¼‰ã€‚

è€Œ zustand åˆ™æŠŠè¿™ä¸ªé—®é¢˜è§£æ‰äº†ã€‚ç”±äº zustand åœ¨ create æ–¹æ³•ä¸­æä¾›äº† `get` å¯¹è±¡ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨ get æ–¹æ³•ç›´æ¥æ‹¿åˆ°å½“å‰ store ä¸­æœ€æ–°çš„ state å¿«ç…§ã€‚è¿™æ ·ä¸€æ¥ï¼Œå˜æ›´å‡½æ•°çš„å¼•ç”¨å§‹ç»ˆä¸å˜ï¼Œè€Œå‡½æ•°æœ¬èº«å´ä¸€ç›´å¯ä»¥æ‹¿åˆ°æœ€æ–°çš„å€¼ã€‚

åœ¨è¿™ä¸€è¶´ï¼Œæœ€åä¸€ç‚¹è¦å¤¸ zustand çš„æ˜¯ï¼Œå®ƒå¯ä»¥ç›´æ¥é›†æˆ useReducer çš„æ¨¡å¼ï¼Œè€Œä¸”ç›´æ¥åœ¨å®˜ç½‘æä¾›äº†[ç¤ºä¾‹](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpmndrs%2Fzustand%23cant-live-without-redux-like-reducers-and-action-types "https://github.com/pmndrs/zustand#cant-live-without-redux-like-reducers-and-action-types")ã€‚è¿™æ ·å°±æ„å‘³ç€ä¹‹å‰åœ¨ ProEditor ä¸­çš„é‚£ä¹ˆå¤š action å¯ä»¥æä½æˆæœ¬å®Œæˆè¿ç§»ã€‚

```
// columns çš„ reducer è¿ç§»

import { columnsConfigReducer } from './columns';

const createStore = create((set,get)=>({
  /**
   * æ§åˆ¶ Columns çš„å¤æ‚æ•°æ®å˜æ›´æ–¹æ³•
   */
  dispatchColumns: (payload) => {
    const { columns, internalUpdateTableConfig, updateDataByColumns } = get();
    // æ—§çš„ useReducer ç›´æ¥å¤ç”¨è¿‡æ¥
    const nextColumns = columnsConfigReducer(columns, payload);

    internalUpdateTableConfig({ columns: nextColumns }, 'Columns é…ç½®');

    updateDataByColumns(nextColumns);
  },
})
```

### â¸ çŠ¶æ€æ´¾ç”Ÿ

çŠ¶æ€æ´¾ç”Ÿæ˜¯çŠ¶æ€ç®¡ç†ä¸­ä¸€ä¸ªä¸è¢«é‚£ä¹ˆå¤šäººæèµ·ï¼Œä½†æ˜¯åœ¨å®é™…åœºæ™¯ä¸­è¢«å¤§é‡ä½¿ç”¨çš„ä¸œè¥¿ï¼Œåªæ˜¯å¤§å®¶æ²¡æœ‰æ„è¯†åˆ°ï¼Œè¿™ç†åº”ä¹Ÿæ˜¯çŠ¶æ€ç®¡ç†çš„ä¸€ç¯ã€‚

çŠ¶æ€æ´¾ç”Ÿå¯ä»¥å¾ˆç®€å•ï¼Œä¹Ÿå¯ä»¥éå¸¸å¤æ‚ã€‚ç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚åŸºäºä¸€ä¸ª`name` å­—æ®µï¼Œæ‹¼æ¥å‡ºå¯¹åº”çš„ url ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a294d2590db4a53b49b2103d45e0a53~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å¤æ‚çš„ä¾‹å­ï¼Œæ¯”å¦‚åŸºäº rgb ã€hsl å€¼å’Œè‰²å½©æ¨¡å¼ï¼Œå¾—åˆ°ä¸€ä¸ªåŒ…å«è‰²å½©ç©ºé—´çš„å¯¹è±¡ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a9a2dcc3720843dfbcec9d30f37da3d1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å¦‚æœä¸è€ƒè™‘ä¼˜åŒ–ï¼Œå…¶å®éƒ½å¯ä»¥å†™ä¸€ä¸ªä¸­é—´çš„å‡½æ•°ä½œä¸ºæ´¾ç”Ÿæ–¹æ³•ï¼Œä½†ä½œä¸ºçŠ¶æ€ç®¡ç†çš„ä¸€ç¯ï¼Œæˆ‘ä»¬å¿…é¡»è¦è€ƒè™‘ç›¸åº”çš„ä¼˜åŒ–ã€‚

åœ¨ hooks åœºæ™¯ä¸‹ï¼ŒçŠ¶æ€æ´¾ç”Ÿçš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ `useMemo`ï¼Œä¾‹å¦‚ï¼š

```
// hooks å†™æ³•

const App = () => {
  const [name,setName]=useState('')
  const url = useMemo(() => URL_HITU_DS_BASE(name || ''),[name])
  // ...
}
```

è€Œ zustand ç”¨äº†ç±»ä¼¼ redux selector çš„æ–¹æ³•ï¼Œå®ç°ç›¸åº”çš„çŠ¶æ€æ´¾ç”Ÿï¼Œè¿™ä¸ªæ–¹å¼ä½¿å¾— useStore çš„ç”¨æ³•å˜å¾—æå…¶çµæ´»å’Œå®ç”¨ã€‚è€Œè¿™ç§ selector çš„æ–¹å¼ä½¿å¾— zustand ä¸‹ç»†é¢—ç²’åº¦çš„æ€§èƒ½ä¼˜åŒ–å˜ä¸ºå¯èƒ½ï¼Œä¸”ä¼˜åŒ–æˆæœ¬å¾ˆä½ã€‚

```
// zustand çš„ selector ç”¨æ³•

// å†™æ³•1
const App = () => {
  const url = useStore( s => URL_HITU_DS_BASE(s.name || ''));
  // ...
}

// å†™æ³•2 å°† selector å•ç‹¬æŠ½ä¸ºå‡½æ•°
export const dsUrlSelector = (s) => URL_HITU_DS_BASE(s.name || '');
const App = () => {
  const url = useStore(dsUrlSelector);
  // ...
}
```

ç”±äºå†™æ³• 2 å¯ä»¥å°† selector æŠ½ä¸ºç‹¬ç«‹å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†å…¶æ‹†åˆ†åˆ°ç‹¬ç«‹æ–‡ä»¶æ¥ç®¡ç†æ´¾ç”ŸçŠ¶æ€ã€‚ç”±äºè¿™äº› selector éƒ½æ˜¯çº¯å‡½æ•°ï¼Œæ‰€ä»¥èƒ½è½»æ¾å®ç°æµ‹è¯•è¦†ç›–ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/506b74bef6304015b9433c161572db9a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

### â¹ æ€§èƒ½ä¼˜åŒ–

è®²å®ŒçŠ¶æ€æ´¾ç”ŸåæŠŠ zustand çš„ selector èƒ½åŠ›åï¼Œç›´æ¥å¾ˆé¡ºåœ°å°±èƒ½æ¥è®²è®² zustand çš„æ€§èƒ½ä¼˜åŒ–äº†ã€‚

åœ¨è£¸ hooks çš„çŠ¶æ€ç®¡ç†ä¸‹ï¼Œè¦åšæ€§èƒ½ä¼˜åŒ–å¾—ä¸“é—¨èµ·ä¸€ä¸ªä¸“é¡¹æ¥åˆ†æä¸å®æ–½ã€‚ä½†åŸºäº zustand çš„ useStore å’Œ selector ç”¨æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä½æˆæœ¬ã€æ¸è¿›å¼çš„æ€§èƒ½ä¼˜åŒ–ã€‚

æ¯”å¦‚ ProEditor ä¸­ä¸€ä¸ªå« `TableConfig` çš„é¢æ¿ç»„ä»¶ï¼Œå¯¹åº”çš„å·¦ä¸‹å›¾ä¸­åœˆèµ·æ¥çš„éƒ¨åˆ†ã€‚è€Œå³ä¸‹å›¾åˆ™æ˜¯ç›¸åº”çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªç»„ä»¶ä» `useStore` ä¸­ è§£æ„äº† `tabKey` å’Œ `internalSetState` çš„æ–¹æ³•ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2ee62c7afa24f4e87ae47c62a6bb932~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

ç„¶åæˆ‘ä»¬ç”¨ `useWhyDidYouUpdate` æ¥æ£€æŸ¥ä¸‹ï¼Œå¦‚æœç›´æ¥ç”¨è§£æ„å¼•å…¥ï¼Œä¼šé€ æˆä»€ä¹ˆæ ·çš„æƒ…å†µï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/515f1380f22a4b42a3b547607874f8d3~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

åœ¨ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ `tabs`ã€`internalSetState` æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯å…¶ä¸­çš„ config æ•°æ®é¡¹ï¼ˆdataã€columns ç­‰ï¼‰å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿›è€Œä½¿å¾— `TableConfig` ç»„ä»¶è§¦å‘é‡æ¸²æŸ“ã€‚

è€Œæˆ‘ä»¬çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦åˆ©ç”¨ zustand çš„ selectorï¼Œå°†å¾—åˆ°çš„å¯¹è±¡èšç„¦åˆ°æˆ‘ä»¬éœ€è¦çš„å¯¹è±¡ï¼Œåªç›‘å¬è¿™å‡ ä¸ªå¯¹è±¡çš„å˜åŒ–å³å¯ã€‚

```
// æ€§èƒ½ä¼˜åŒ–æ–¹æ³•

import shallow from 'zustand/shallow'; // zustand æä¾›çš„å†…ç½®æµ…æ¯”è¾ƒæ–¹æ³•
import { useStore, ProTableStore } from './store'

const selector = (s: ProTableStore) => ({
  tabKey: s.tabKey,
  internalSetState: s.internalSetState,
});

const TableConfig: FC = () => {
  const { tabKey, internalSetState } = useStore(selector, shallow);
}
```

è¿™æ ·ä¸€æ¥ï¼ŒTableConfig çš„æ€§èƒ½ä¼˜åŒ–å°±åšå¥½äº†~

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e47d49444b6d4c3b90b3e1ec6493e487~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

åŸºäºè¿™ç§æ¨¡å¼ï¼Œæ€§èƒ½ä¼˜åŒ–å°±ä¼šå˜æˆæå…¶ç®€å•æ— è„‘çš„æ“ä½œï¼Œè€Œä¸”å¯¹äºå‰æœŸçš„åŠŸèƒ½å®ç°çš„ä¾µå…¥æ€§æå°ï¼Œä»£ç çš„åç»­å¯ç»´æŠ¤æ€§æé«˜ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7c9142d626e462fa002c9c47a1e4fab~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å‰©ä¸‹çš„æ—¶é—´å°±å¯ä»¥å’Œå°ä¼™ä¼´å»å¹å’±ä¼˜é›…çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§äº†~ï¼ˆï¿£ï¸¶ï¿£ï¼‰â†—

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c557b94668b44a0ab0454033ca4b3058~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å°±æˆ‘ä¸ªäººçš„æ„Ÿå—ä¸Šï¼Œ zustand ä½¿ç”¨ selector æ¥ä½œä¸ºæ€§èƒ½ä¼˜åŒ–çš„æ€è·¯çœŸçš„å¾ˆç²¾å·§ï¼Œå°±åƒæ˜¯ç»™å‡½æ•°å¼çš„æ•°æ®æµåŠ ä¸Šäº†ä¸€ç‚¹ç‚¹ä¸»è§‚æ„æ„¿ä¸Šçš„å“åº”å¼èƒ½åŠ›ï¼Œå ªç§°ä¼˜é›…ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4cc622c7d14e49dca8e5705968478b85~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

### âº æ•°æ®åˆ†å½¢ä¸çŠ¶æ€ç»„åˆ

å¦‚æœå­ç»„ä»¶èƒ½å¤Ÿä»¥åŒæ ·çš„ç»“æ„ï¼Œä½œä¸ºä¸€ä¸ªåº”ç”¨ä½¿ç”¨ï¼Œè¿™æ ·çš„ç»“æ„å°±æ˜¯åˆ†å½¢æ¶æ„ã€‚

æ•°æ®åˆ†å½¢åœ¨çŠ¶æ€ç®¡ç†é‡Œæˆ‘è§‰å¾—æ˜¯ä¸ªæ¯”è¾ƒé«˜çº§çš„æ¦‚å¿µã€‚ä½†ä»åº”ç”¨ä¸Šæ¥è¯´å¾ˆç®€å•ï¼Œå°±æ˜¯æ›´å®¹æ˜“æ‹†åˆ†å¹¶ç»„ç»‡ä»£ç ï¼Œè€Œä¸”å…·æœ‰æ›´åŠ çµæ´»çš„ä½¿ç”¨æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºæ˜¯æ‹†åˆ†ä»£ç çš„æ–¹å¼ã€‚ä½†è¿™ç§æ–¹å¼å…¶å®æˆ‘è¿˜æ²¡å¤§ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸å¤šå±•å¼€äº†ã€‚

```
// æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„ç¤ºä¾‹

// https://github.com/pmndrs/zustand/blob/main/docs/typescript.md#slices-pattern

import create, { StateCreator } from 'zustand'

interface BearSlice {
  bears: number
  addBear: () => void
  eatFish: () => void
}
const createBearSlice: StateCreator<
  BearSlice & FishSlice,
  [],
  [],
  BearSlice
> = (set) => ({
  bears: 0,
  addBear: () => set((state) => ({ bears: state.bears + 1 })),
  eatFish: () => set((state) => ({ fishes: state.fishes - 1 })),
})

interface FishSlice {
  fishes: number
  addFish: () => void
}
const createFishSlice: StateCreator<
  BearSlice & FishSlice,
  [],
  [],
  FishSlice
> = (set) => ({
  fishes: 0,
  addFish: () => set((state) => ({ fishes: state.fishes + 1 })),
})

const useBoundStore = create<BearSlice & FishSlice>()((...a) => ({
  ...createBearSlice(...a),
  ...createFishSlice(...a),
}))
```

**æˆ‘ç”¨çš„æ›´å¤šçš„æ˜¯åŸºäºè¿™ç§åˆ†å½¢æ¶æ„ä¸‹çš„å„ç§ä¸­é—´ä»¶**ã€‚ç”±äºè¿™ç§åˆ†å½¢æ¶æ„ï¼ŒçŠ¶æ€å°±å…·æœ‰äº†å¾ˆçµæ´»çš„ç»„åˆæ€§ï¼Œä¾‹å¦‚å°†å½“å‰çŠ¶æ€ç›´æ¥ç¼“å­˜åˆ° localStorageã€‚åœ¨ zustand çš„æ¶æ„ä¸‹ï¼Œ ä¸ç”¨é¢å¤–æ”¹é€ ï¼Œç›´æ¥åŠ ä¸ª `persist` ä¸­é—´ä»¶å°±å¥½ã€‚

```
// ä½¿ç”¨è‡ªå¸¦çš„ Persist Middleware

import create from 'zustand'
import {  persist } from 'zustand/middleware'

interface BearState {
  bears: number
  increase: (by: number) => void
}

const useBearStore = create<BearState>(
  persist((set) => ({
    bears: 0,
    increase: (by) => set((state) => ({ bears: state.bears + by })),
  }))
)
```

åœ¨ ProEditor ä¸­ï¼Œæˆ‘ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯ `devtools` è¿™ä¸ªä¸­é—´ä»¶ã€‚è¿™ä¸ªä¸­é—´ä»¶å…·æœ‰çš„åŠŸèƒ½å°±æ˜¯ï¼šå°†è¿™ä¸ª Store å’Œ Redux Devtools ç»‘å®šã€‚

```
// devtools ä¸­é—´ä»¶

// store é€»è¾‘
const vanillaStore = (set,get)=> ({ 
  syncOutSource: (nextState) => {
    set({ ...get(), ...nextState }, false, `å—æ§æ›´æ–°ï¼š${Object.keys(nextState).join(' ')}`);
  },
  syncOutSourceConfig: ({ config }) => {
    // ...
    set({ ...get(), ...config }, false, `å—æ§æ›´æ–°ï¼šğŸ›  ç»„ä»¶é…ç½®`);
    // ...
  },
}); 

const createStore = create(
  devtools(vanillaStore, { name: 'ProTableStore' })
);
```

ç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨ redux-devtools ä¸­æ„‰å¿«åœ°æŸ¥çœ‹æ•°æ®å˜æ›´äº†ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16c7513f38f8494ea256992e93b92738~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å¯èƒ½æœ‰å°ä¼™ä¼´ä¼šæ³¨æ„åˆ°ï¼Œä¸ºä»€ä¹ˆæˆ‘è¿™è¾¹çš„çŠ¶æ€å˜æ›´è¿˜æœ‰ä¸­æ–‡åï¼Œé‚£æ˜¯å› ä¸º `devtools` ä¸­é—´ä»¶ä¸º zustand çš„ set æ–¹æ³•ï¼Œæä¾›äº†ä¸€ä¸ªé¢å¤–å‚æ•°ã€‚åªè¦è®¾ç½®å¥½ç›¸åº”çš„ set å€¼çš„æœ€åä¸€ä¸ªå˜é‡ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨ devtools ä¸­çœ‹åˆ°ç›¸åº”çš„å˜æ›´äº‹ä»¶åç§°ã€‚

æ­£æ˜¯è¿™æ ·å¼ºå¤§çš„åˆ†å½¢èƒ½åŠ›ï¼Œæˆ‘ä»¬åŸºäºç¤¾åŒºé‡Œåšçš„ä¸€ä¸ª [zundo](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcharkour%2Fzundo "https://github.com/charkour/zundo") ä¸­é—´ä»¶ï¼Œåœ¨ ProEditor ä¸­æä¾›äº†ä¸€ä¸ªç®€æ˜“çš„æ’¤é”€é‡åš çš„ Demo ç¤ºä¾‹ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/601ca078bcc741c6b2996cd839fbcd9a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

è€Œå®ç°æ ¸å¿ƒåŠŸèƒ½çš„ä»£ç å°±åªæœ‰ä¸€è¡Œ~ ğŸ˜†

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0292fe96b44374bc4f5c077093c230~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

PSï¼šè‡³äºä¸€å¼€å§‹æåˆ°çš„ååŒèƒ½åŠ›ï¼Œæˆ‘åœ¨ç¤¾åŒºä¸­ä¹Ÿæœ‰å‘ç°ä¸­é—´ä»¶ [zustand-middleware-yjs](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjoebobmiles%2Fzustand-middleware-yjs "https://github.com/joebobmiles/zustand-middleware-yjs") ï¼ˆä¸è¿‡è¿˜æ²¡å°è¯•ï¼‰ã€‚

### â» å¤šç¯å¢ƒé›†æˆï¼ˆ react å†…å¤–ç¯å¢ƒè”åŠ¨ ï¼‰

å®é™…çš„å¤æ‚åº”ç”¨ä¸­ï¼Œä¸€å®šä¼šå­˜åœ¨æŸäº›ä¸åœ¨ react ç¯å¢ƒå†…çš„çŠ¶æ€æ•°æ®ï¼Œä»¥å›¾è¡¨ã€ç”»å¸ƒã€3D åœºæ™¯æœ€å¤šã€‚ä¸€æ—¦è¦æ¶‰åŠåˆ°å¤šç¯å¢ƒä¸‹çš„çŠ¶æ€ç®¡ç†ï¼Œå¯ä»¥è®©äººæ‰æ— æ•°å¤´å‘ã€‚

è€Œ zustand è¯´äº†ï¼Œä¸æ…Œï¼Œæˆ‘å·²ç»è€ƒè™‘åˆ°äº†ï¼Œ`useStore` ä¸Šç›´æ¥å¯ä»¥æ‹¿å€¼ï¼Œæ˜¯ä¸æ˜¯å¾ˆè´´å¿ƒ~

```
// å®˜æ–¹ç¤ºä¾‹

// 1. åˆ›å»ºStore
const useDogStore = create(() => ({ paw: true, snout: true, fur: true }))

// 2. react ç¯å¢ƒå¤–ç›´æ¥æ‹¿å€¼
const paw = useDogStore.getState().paw

// 3. æä¾›å¤–éƒ¨äº‹ä»¶è®¢é˜…
const unsub1 = useDogStore.subscribe(console.log)

// 4. react ä¸–ç•Œå¤–æ›´æ–°å€¼
useDogStore.setState({ paw: false })

const Component = () => {
  // 5. åœ¨ react ç¯å¢ƒå†…ä½¿ç”¨
  const paw = useDogStore((state) => state.paw)
  ...
```

è™½ç„¶è¿™ä¸ªåœºæ™¯æˆ‘è¿˜æ²¡é‡åˆ°ï¼Œä½†æ˜¯ä¸€æƒ³åˆ° zustand åœ¨è¿™ç§åœºæ™¯ä¸‹ä¹Ÿèƒ½æ”¯æŒï¼ŒçœŸçš„æ˜¯è®©äººååˆ†å¿ƒå®‰ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f5adafbecfa46399728ca9b4d66650d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å…¶å®è¿˜æœ‰å…¶ä»–ä¸å¤ªå€¼å¾—å•ç‹¬æçš„ç‚¹ï¼Œæ¯”å¦‚ zustand åœ¨æµ‹è¯•ä¸Šä¹Ÿç›¸å¯¹æ¯”è¾ƒå®¹æ˜“åšï¼Œç›´æ¥ç”¨ test-library/react-hooks å³å¯ã€‚ç±»å‹å®šä¹‰æ–¹é¢åšçš„éå¸¸é½å…¨â€¦â€¦ ä½†åˆ°ç°åœ¨æ´‹æ´‹æ´’æ´’å·²ç»å†™äº† 6k å¤šå­—äº†ï¼Œå°±ä¸å†å±•å¼€äº†ã€‚

æ€»ç»“ï¼šzustand æ˜¯å½“ä¸‹å¤æ‚çŠ¶æ€ç®¡ç†çš„æœ€ä½³é€‰æ‹©
-------------------------

å¤§æ¦‚ä»å»å¹´ 12 æœˆä»½å¼€å§‹ï¼Œæˆ‘å°±ä¸€ç›´åœ¨æç‚¼ç¬¦åˆæˆ‘ç†æƒ³çš„çŠ¶æ€ç®¡ç†åº“çš„éœ€æ±‚ï¼Œåˆ°çœ‹åˆ° zustand è®©æˆ‘çœ¼å‰ä¸€äº®ã€‚è€Œé€šè¿‡åœ¨ `pro-editor` ä¸­å¤§åŠå¹´çš„å®è·µéªŒè¯ï¼Œæˆ‘å¾ˆç¬ƒå®šåœ°è®¤ä¸ºï¼Œ**zustand å°±æ˜¯æˆ‘å½“ä¸‹çŠ¶æ€ç®¡ç†çš„æœ€ä½³é€‰æ‹©ï¼Œç”šè‡³æ˜¯å¤§éƒ¨åˆ†å¤æ‚åº”ç”¨çš„çŠ¶æ€ç®¡ç†çš„æœ€ä½³é€‰æ‹©**ã€‚

æœ¬æ¥æœ€åè¿˜æƒ³è®²è®²ï¼Œæˆ‘æ˜¯æ€ä¹ˆæ ·åŸºäº Zustand æ¥åšæ¸è¿›å¼çš„çŠ¶æ€ç®¡ç†çš„ï¼ˆä»å°åº”ç”¨åˆ°å¤æ‚åº”ç”¨çš„æ¸è¿›å¼ç”Ÿé•¿æ–¹æ¡ˆï¼‰ã€‚ç„¶åè¿˜æƒ³æ‹¿ ProEditor ä¸ºä¾‹è®²è®² ProEditor å…·ä½“çš„çŠ¶æ€ç®¡ç†æ˜¯å¦‚ä½•é€æ­¥ç”Ÿé•¿çš„ï¼ŒåŒ…æ‹¬å¦‚ä½•ç»„ç»‡çš„å—æ§æ¨¡å¼ã€å¦‚ä½•é›†æˆ RxJS å¤„ç†å¤æ‚äº¤äº’ç­‰ç­‰ï¼Œç®—æ˜¯å‡ ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„ç‚¹ã€‚ä¸è¿‡é™äºç¯‡å¹…åŸå› ï¼Œè¿™äº›å†…å®¹ä¼°è®¡å°±å¾—ç•™åˆ°ä¸‹æ¬¡äº†ã€‚