%%begin highlights%%
很多以太坊上的应用都需要用到随机数，例如NFT随机抽取tokenId、抽盲盒

由于以太坊上所有数据都是公开透明（public）且确定性（deterministic）的，它没法像其他编程语言一样给开发者提供生成随机数的方法

链上随机数生成​

将一些链上的全局变量作为种子，利用keccak256()哈希函数来获取伪随机数

注意:，这个方法并不安全

先，block.number，msg.sender和blockhash(block.timestamp-1)这些变量都是公开的，使用者可以预测出用这些种子生成出的随机数，并挑出他们想要的随机数执行合约。
其次，矿工可以操纵blockhash和block.timestamp，使得生成的随机数符合他的利益

链下随机数生成​

在链下生成随机数，然后通过预言机把随机数上传到链上

Chainlink提供VRF（可验证随机函数）服务，链上开发者可以支付LINK代币来获取随机数

Chainlink VRF使用步骤

用一个简单的合约介绍使用Chainlink VRF的步骤。RandomNumberConsumer合约可以向VRF请求一个随机数，并存储在状态变量randomResult中。

1. 用户合约继承VRFConsumerBase并转入LINK代币

为了使用VRF获取随机数，合约需要继承VRFConsumerBase合约，并在构造函数中初始化VRF Coordinator地址，LINK代币地址，唯一标识符Key Hash，和使用费用fee

我们使用Rinkeby测试网。部署好合约后，用户需要向合约转一些LINK代币

2. 用户合约申请随机数

用户可以调用从VRFConsumerBase合约继承来的requestRandomness()申请随机数，并返回申请标识符requestId。这个申请会传递给VRF合约。

function getRandomNumber() public returns (bytes32 requestId) {
// 合约中需要有足够的LINK
require(LINK.balanceOf(address(this)) >= fee, "Not enough LINK - fill contract with faucet");
return requestRandomness(keyHash, fee);
}

Chainlink节点链下生成随机数和数字签名，并发送给VRF合约

4. VRF合约验证签名有效性

5. 用户合约接收并使用随机数

在VRF合约验证签名有效之后，会自动调用用户合约的回退函数fulfillRandomness()，将链下生成的随机数发送过来。用户要把消耗随机数的逻辑写在这里。

注意: 用户申请随机数时调用的requestRandomness()和VRF合约返回随机数时调用的回退函数fulfillRandomness()是两笔交易，调用者分别是用户合约和VRF合约，后者比前者晚几分钟（不同链延迟不一样）

tokenId随机铸造的NFT​

状态变量​

NFT相关
totalSupply：NFT总供给。
ids：数组，用于计算可供mint的tokenId，见pickRandomUniqueId()函数。
mintCount：已经mint的数量。

Chainlink VRF相关
keyHash:VRF唯一标识符。
fee：VRF手续费。
requestToSender：记录申请VRF用于铸造的用户地址。

初始化继承的VRFConsumerBase和ERC721合约的相关变量

除了构造函数以外，合约里还定义了5个函数

pickRandomUniqueId()：输入随机数，获取可供mint的tokenId。
getRandomOnchain()：获取链上随机数（不安全）。
mintRandomOnchain()：利用链上随机数铸造NFT，调用了getRandomOnchain()和pickRandomUniqueId()。
mintRandomVRF()：申请Chainlink VRF用于铸造随机数。由于使用随机数铸造的逻辑在回调函数fulfillRandomness()，而回调函数的调用者是VRF合约，而非铸造NFT的用户，这里必须利用requestToSender状态变量记录VRF申请标识符对应的用户地址。
fulfillRandomness()：VRF的回调函数，由VRF合约在验证随机数真实性后自动调用，用返回的链下随机数铸造NFT。
%%end highlights%%

!!!PAGE NOTE!!!
%%begin pagenote%%

%%end pagenote%%

 #五彩插件 [原文](https://www.wtf.academy/solidity-application/Random/#%E9%93%BE%E4%B8%8A%E9%9A%8F%E6%9C%BA%E6%95%B0%E7%94%9F%E6%88%90)
更新时间: 2023-07-28 15:20