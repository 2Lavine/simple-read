> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [juejin.cn](https://juejin.cn/post/7248235392284721209?utm_source=gold_browser_extension)

强缓存和协商缓存
========
浏览器缓存是浏览器在本地磁盘对用户最近请求过的文档进行存储, 当访问者再次访问同一页面时, 浏览器就可以直接从本地磁盘加载文档, 其中浏览器缓存就分为 `强缓存` 和 `协商缓存`:


强缓存
---
强缓存就是文件直接从本地缓存中获取, 不需要发送请求。
当资源首次被请求时，服务器会在响应头中添加一个属性，即"Cache-Control"或"Expires"来标记资源为强缓存。

例如，
- 设置为"Cache-Control: max-age=3600"表示资源在客户端缓存中存储1小时
- 设置为"Expires: Fri, 01 Jan 2022 00:00:00 GMT"表示资源在客户端缓存中的有效期截止到2022年1月1日

当下一次请求该资源时，客户端会先检查缓存中是否存在该资源，并且检查缓存是否过期。如果缓存中的资源未过期，客户端不会像服务器发送任何请求，直接从本地缓存中读取文件并返回 Status Code: 200 OK

强缓存有过期时间, 如果失效了, 那么它就会像首次请求中一样, 重新向服务器发起请求, 之后服务器会再次返回资源和 `Cache-Control` 的值。

### cache-control 和 expires 的区别
"Cache-Control"是HTTP/1.1引入的缓存控制指令
- 指令包括max-age：指定资源在客户端缓存中的最大存储时间，单位为秒。
"Expires"是HTTP/1.0引入的缓存控制字段，它指定了资源的过期时间点
- 但他它使用的是服务器的时间，如果服务器时间与客户端时间不一致，就会导致缓存失效的问题
最后"max-age"和"Expires"可以同时使用，但"max-age"优先级更高，

### max-age 的使用
客户端接收到响应后，会将该资源存储在缓存中，并记录下缓存的时间戳
当下一次请求该资源时，用当前时间减去缓存时间戳小于等于"max-age"的值来计算

### cache-control的其他属性
no-cache：指示客户端不要使用缓存的副本，而是发送请求到服务器进行验证。
no-store：指示客户端不要缓存响应的副本。
public：指示响应可以被任何缓存存储，包括中间代理服务器。
private：指示响应只能被客户端缓存，中间代理服务器不能缓存。

### 如果没有 cache-control和 expires
如果没有设置"Cache-Control"或"Expires"，则服务器没有明确指定缓存的行为，这种情况下，客户端通常会默认使用强缓存。

在缺乏缓存控制指令的情况下，浏览器会根据自身的缓存策略来确定是否使用缓存。一般情况下，浏览器会对静态资源进行缓存，例如图片、CSS、JavaScript等。
然而，没有明确指定缓存的过期时间或验证机制，缓存的资源可能会一直被使用，直到浏览器关闭或清除缓存。这可能导致客户端无法获取到最新的资源，特别是在服务器更新了资源

协商缓存
----
如果设置"Cache-Control: no-cache"表示客户端需要与服务器进行协商验证缓存的有效性，这是协商缓存。
如果服务器返回的响应头中包含了"Cache-Control"属性且指令为"no-cache"，或者包含了ETag和Last-Modified属性，那么客户端在请求该资源时就会进行协商缓存，

如果客户端是第一次向服务器发出请求, 则服务器返回资源和对应的资源标识给浏览器, 标识可以是 `ETag` 或者是 `Last-Modified`。

之后如果浏览器再次发送请求是, 浏览器就会带上这个标识, 此时服务端就会通过这个资源标识, 可以判断出浏览器的资源跟服务器此时的资源是否一致,
如果一致则返回`304 Not Modified`, 并在响应头中清除实际的响应头;
如果不一致, 则返回 `200`, 并返回资源以及新的资源标识。

协商缓存中的两个字段
---
1.  如果资源未被标记为强缓存或缓存验证失败, 服务器进行协商缓存的判断:
协商缓存中第一次向服务器发出请求, 会同时接收到资源和资源标识，标识可以是 `ETag` 或者是 `Last-Modified`。

后续请求会用到这两个标识用来验证资源是否变换。
使用 last-Modified标识： 发送字段`If-Modified-Since`，他的值为 last-Modified
使用 ETag 表示： 发送字段 `If-None-Match` ，他的值为 ETag

最后Etag 优先级是高于 Last-Modifed 的，所以服务器会优先验证 Etag

不同刷新方式对强制缓存和协商缓存的影响
======================

不同的刷新操作方式对于强制缓存和写上缓存的影响如下:

1.  普通刷新 (`F5` 或 `刷新按钮`):
    *   强制缓存的影响: 浏览器忽略强制缓存, 直接向服务器发送请求, 获取最新的资源, 也就是强制缓存失效;
    *   协商缓存的影响: 浏览器放带有缓存验证的字段的请求, 浏览器会根据验证结果返回新的资源或者 `304 Not Modified`;
2.  强制刷新 (`Ctrl+F5` 或 `Shift+刷新按钮`):
    *   强制缓存的影响: 同上, 强制缓存失效;
    *   协商缓存的影响: 浏览器发送不带缓存验证字段的请求, 服务器返回新的资源, 不进行验证, 也就是协商缓存失效;
3.  禁用缓存刷新 (`DevTools` 中的 `Disable cache` 或 `Network` 勾选 `Disable cache`):
    *   强制缓存的影响: 同上, 强制缓存失效;
    *   协商缓存的影响: 浏览器会发送带有缓存验证字段的请求, 服务器会根据验证结果返回新的资源或 `304 Not Modified`;



