> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [juejin.cn](https://juejin.cn/post/6844903623583891469?searchId=202310111123315FDEED241D604A6A6DA2)

## 解析
首先浏览器会对这个 html 文件进行编译，转化成节点树结构
浏览器会对转化后的数据结构自上而下进行分析：
首先开启下载线程，对所有的资源进行优先级排序下载（注意，这里仅仅是下载）。
同时主线程会对文档进行解析：

*   遇到 script 标签时，首先阻塞后续内容的解析，同时检查该 script 是否已经下载下来，如果已下载，便执行代码。
*   遇到 link 标签时，不会阻塞后续内容的解析（比如 DOM 构建），检查 link 资源是否已下载，如果已下载，则构建 cssom。
*   遇到 DOM 标签时，执行 DOM 构建，将该 DOM 元素添加到文档树中。

> 有一点要注意的是，在 body 中第一个 script 资源下载完成之前，浏览器会进行首次渲染，将该 script 标签前面的 DOM 树和 CSSOM 合并成一棵 Render 树，渲染到页面中。**这是页面从白屏到首次渲染的时间节点，比较关键**。

#### DOM 构建

DOM 构建的意思是，将文档中的所有 DOM 元素构建成一个树型结构。
> 注意，DOM 构建是自上而下进行构建的，会受到 js 执行的干扰。

#### CSS 构建
将文档中的所有 css 资源合并。

#### render 树
将 DOM 树和 CSS 合并成一棵渲染树，render 树在合适的时机会被渲染到页面中。（比如遇到 script 时, 该 script 还没有下载到本地时）。

### HTML 文档的加载与页面的首次渲染

当我们输入一个页面地址时，发生了哪些事情呢？

  1、浏览器首先下载该地址所对应的 html 页面。
  2、浏览器解析 html 页面的 DOM 结构。
  3、开启下载线程对文档中的所有资源按优先级排序下载。
  4、主线程继续解析文档，到达 head 节点 ，head 里的外部资源无非是外链样式表和外链 js。
  发现有外链 css 或者外链 js，如果是外链 js ，则停止解析后续内容，等待该资源下载，下载完后立刻执行。如果是外链 css，继续解析后续内容。
  5、解析到 body
 6、文档解析完毕，页面重新渲染。当页面引用的所有 js 同步代码执行完毕，触发 DOMContentLoaded 事件。
  7、html 文档中的图片资源，js 代码中有异步加载的 css、js 、图片资源都加载完毕之后，load 事件触发。

## 解析 body
body 里的情况比较多，body 里可能只有 DOM 元素，可能既有 DOM、也有 css、js 等资源，js 资源又有可能异步加载 图片、css、js 等。DOM 结构不同，浏览器的解析机制也不同，我们分开来讨论。

*   只有 DOM 元素
	*   这种情况比较简单了，DOM 树构建完，页面首次渲染。
*   有 DOM 元素、外链 js。
	*   当解析到外链 js 的时候，该 js 尚未下载到本地，则 js 之前的 DOM 会被渲染到页面上，同时 js 会阻止后面 DOM 的构建，即后面的 DOM 节点并不会添加到文档的 DOM 树中。所以，js 执行完之前，我们在页面上看不到该 js 后面的 DOM 元素。
*   有 DOM 元素、外链 css
	*   外链 css 不会影响 css 后面的 DOM 构建，但是会阻碍渲染。简单点说，外链 css 加载完之前，页面还是白屏。
*   有 DOM 元素、外链 js、外链 css
	*   外链 js 和外链 css 的顺序会影响页面渲染，这点尤为重要。当 body 中 js 之前的外链 css 未加载完之前，页面是不会被渲染的。
	*   当 body 中 js 之前的 外链 css 加载完之后，js 之前的 DOM 树和 css 合并渲染树，页面渲染出该 js 之前的 DOM 结构。


### head 中资源的加载

*   head 中 js 资源加载都会停止后面 DOM 的构建，但是不影响后面资源的下载。
*   css 资源不会阻碍后面 DOM 的构建，但是会阻碍页面的首次渲染。

### body 中资源的加载

*   body 中 js 资源加载都会停止后面 DOM 的构建，但是不影响后面资源的下载。
*   css 资源不会阻碍后面 DOM 的构建，但是会阻碍页面的首次渲染。

### DomContentLoaded 事件的触发

上面只是讲了 html 文档的加载与渲染，并没有讲 DOMContentLoaded 事件的触发时机。直截了当地结论是，DOMContentLoaded 事件在 **html 文档加载完毕，并且 html 所引用的内联 js、以及外链 js 的同步代码都执行完毕后触发**。

大家可以自己写一下测试代码，分别引用内联 js 和外链 js 进行测试。

### load 事件的触发

当页面 DOM 结构中的 js、css、图片，以及 js 异步加载的 js、css 、图片都加载完成之后，才会触发 load 事件。

注意：

*   页面中引用的 js 代码如果有异步加载的 js、css、图片，是会影响 load 事件触发的。
*   video、audio、flash 不会影响 load 事件触发。

大家可以在 chrome 中试一下。

### 浏览器对同一域名下的资源并发下载线程数，chrome 为 6 个。

*   浏览器对**同一域名**下的下载并发不超过 6 个。超过 6 个的话，剩余的将会在队列中等待，这就是为什么我们要将资源收敛到不同的域名下，也是为了充分利用该机制，最大程度的并发下载所需资源，尽快的完成页面的渲染。

> 这里要注意关键词：**同一域名**。如果 n 个不同域名的话，在浏览器设置的最大并发上限以内 (默认是 10 个)，是可以达到 n * 6 个的最大并发的下载的。

