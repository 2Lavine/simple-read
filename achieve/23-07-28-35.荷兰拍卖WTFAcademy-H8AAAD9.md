%%begin highlights%%
## 荷兰拍卖

荷兰拍卖（Dutch Auction）是一种特殊的拍卖形式。 亦称“减价拍卖”，
指拍卖标的的竞价由高到低依次递减直到第一个竞买人应价（达到或超过底价）时击槌成交的一种拍卖

项目方非常喜欢这种拍卖形式，主要有两个原因
荷兰拍卖的价格由最高慢慢下降，能让项目方获得最大的收入。
拍卖持续较长时间（通常6小时以上），可以避免gas war。

## DutchAuction合约

DucthAuction合约继承了之前介绍的ERC721和Ownable合约

### DutchAuction状态变量​

一共有9个状态变量，其中有6个和拍卖相关
COLLECTOIN_SIZE：NFT总量。
AUCTION_START_PRICE：荷兰拍卖起拍价，也是最高价。
AUCTION_END_PRICE：荷兰拍卖结束价，也是最低价/地板价。
AUCTION_TIME：拍卖持续时长。
AUCTION_DROP_INTERVAL：每过多久时间，价格衰减一次。
auctionStartTime：拍卖起始时间（区块链时间戳，block.timestamp）。

### DutchAuction函数

设定拍卖起始时间：我们在构造函数中会声明当前区块时间为起始时间，项目方也可以通过setAuctionStartTime()函数来调整：

### DutchAuction获取拍卖实时价格：
getAuctionPrice()函数通过当前区块时间以及拍卖相关的状态变量来计算实时拍卖价格。

当block.timestamp小于起始时间，价格为最高价AUCTION_START_PRICE；
当block.timestamp大于结束时间，价格为最低价AUCTION_END_PRICE；
当block.timestamp处于两者之间时，则计算出当前的衰减价格

```js
else {
	uint256 steps = (block.timestamp - auctionStartTime) /AUCTION_DROP_INTERVAL;
	return AUCTION_START_PRICE - (steps * AUCTION_DROP_PER_STEP);
```


### DutchAuction 用户拍卖并铸造NFT：
用户通过调用auctionMint()函数，支付ETH参加荷兰拍卖并铸造NFT
首先检查拍卖是否开始/铸造是否超出NFT总量
接着，合约通过getAuctionPrice()和铸造数量计算拍卖成本，并检查用户支付的ETH是否足够
如果足够，则将NFT铸造给用户，并退回超额的ETH


```js
// 拍卖mint函数
function auctionMint(uint256 quantity) external payable{
    uint256 _saleStartTime = uint256(auctionStartTime); // 建立local变量，减少gas花费
    require(
        _saleStartTime != 0 && block.timestamp >= _saleStartTime,
        "sale has not started yet"
    ); // 检查是否设置起拍时间，拍卖是否开始
    require(
        totalSupply() + quantity <= COLLECTOIN_SIZE,
        "not enough remaining reserved for auction to support desired mint amount"
    ); // 检查是否超过NFT上限
    uint256 totalCost = getAuctionPrice() * quantity; // 计算mint成本
    require(msg.value >= totalCost, "Need to send more ETH."); // 检查用户是否支付足够ETH
    // Mint NFT
    for (uint256 i = 0; i < quantity; i++) {
    uint256 mintIndex = totalSupply();
        _mint(msg.sender, mintIndex);
        _addTokenToAllTokensEnumeration(mintIndex);
    }
    // 多余ETH退款
    if (msg.value > totalCost) {
        payable(msg.sender).transfer(msg.value - totalCost); //注意一下这里是否有重入的风险
    }
}
```


目方取出筹集的ETH：项目方可以通过withdrawMoney()函数提走拍卖筹集的ETH
%%end highlights%%

!!!PAGE NOTE!!!
%%begin pagenote%%

%%end pagenote%%

 #五彩插件 [原文](https://www.wtf.academy/solidity-application/DutchAuction/)
更新时间: 2023-07-28 14:39